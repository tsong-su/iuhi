<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é«˜é›„å¸‚38å€æ–°èˆŠåœ°åäº’å‹•åœ°åœ– â€” åˆä½µè¦–è¦ºç‰ˆ (v2)</title>
<style>
  :root{ --bg:#f9f6ef; --title-color:#222; --new-color:#c0392b; --old-color:#555;
         --label-font:"Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,Arial; }
  html,body{height:100%;margin:0;background:var(--bg);font-family:var(--label-font);color:var(--title-color)}
  .page{display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px;box-sizing:border-box}
  h1{margin:8px 0 0 0;font-size:1.25rem;text-align:center}
  .subtitle{margin:0;font-size:.95rem;color:#666;text-align:center}

  .toolbar{margin:8px 0;display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center}
  .toolbar button{padding:6px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}

  .map-stage{width:100%;max-width:980px;height:calc(100vh - 210px);max-height:1200px;background:transparent;border-radius:10px;overflow:hidden;position:relative;box-shadow:0 8px 20px rgba(0,0,0,.06);}
  #svgHost{width:100%;height:100%;}
  #svgHost svg{width:100%;height:100%;display:block;}

  /* HTML overlay æ¨™ç±¤ï¼ˆé¿å…å·¦ä¸Šåç§»ï¼‰ */
  #labelsLayer{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none;z-index:30}
  .label{position:absolute;transform:translate(-50%,-50%);text-align:center;white-space:nowrap;pointer-events:none;line-height:1.05;}
  .label .new{font-weight:700;color:var(--new-color);font-size:13px;text-shadow:0 1px 0 rgba(255,255,255,.2);}
  .label .old{font-weight:400;color:var(--old-color);font-size:13px;margin-top:2px;text-shadow:0 1px 0 rgba(255,255,255,.2);}

  .popup{position:absolute;display:none;min-width:220px;max-width:320px;background:#fff;border-radius:10px;box-shadow:0 8px 28px rgba(0,0,0,.18);border:1px solid rgba(0,0,0,.08);padding:10px 12px;z-index:60;}
  .popup h3{margin:0 0 6px 0;font-size:1rem}
  .muted{color:#666;font-size:.95rem}
  .audioRow{display:flex;gap:10px;margin-top:8px}
  .audioBtn{background:#ddd;border-radius:8px;padding:8px 10px;border:none;color:#666;cursor:not-allowed}

  .note{margin-top:6px;color:#555;font-size:.90rem;text-align:center}
  @media (max-width:640px){ .map-stage{height:calc(100vh - 170px);} .label .new,.label .old{font-size:14px} .popup{min-width:72%;left:14%!important;right:auto} }
</style>
</head>
<body>
  <div class="page">
    <h1>é«˜é›„å¸‚38å€æ–°èˆŠåœ°åäº’å‹•åœ°åœ– â€” åˆä½µè¦–è¦ºç‰ˆ</h1>
    <div class="subtitle">ğŸ“± å»ºè­°ç›´å¼è§€çœ‹æ•ˆæœæœ€ä½³</div>

    <div class="toolbar">
      <button id="mergeBtn">å•Ÿç”¨åˆä½µè¦–è¦ºæ¨¡å¼</button>
      <span style="color:#666;font-size:.9rem">ï¼ˆå°‡å››å¤§ç¾¤å¡Šè‡ªå‹•æ”¶æ”ã€æ‹¼æˆä¸€å¼µå®Œæ•´åœ°åœ–ï¼›åƒ…è¦–è¦ºä½ç§»ï¼Œä¸æ›´å‹•è³‡æ–™ï¼‰</span>
    </div>

    <div class="map-stage" id="stage">
      <div id="svgHost">
        <!-- æ–¹å¼ Aï¼ˆå»ºè­°ï¼‰ï¼šè‡ªå‹•æŠ“å–ä½ ç¾æœ‰çš„ SVG -->
        <!-- è‹¥è¦100%é›¢ç·šï¼šæŠŠ SVG åŸå§‹ç¢¼è²¼é€²ä¸‹æ–¹ <div id="inlineSvg"> è£¡ï¼Œç¨‹å¼æœƒå„ªå…ˆæ¡ç”¨ -->
      </div>
      <div id="inlineSvg" style="display:none;">
        <!-- å°‡ä¿®å¥½çš„ Blank_Kaohsiung_map.svg çš„ <svg>â€¦</svg> å…¨éƒ¨è²¼åˆ°é€™è£¡ï¼Œå°±æœƒã€ŒçœŸæ­£ã€å…§åµŒ -->
      </div>

      <div id="labelsLayer"></div>

      <div id="popup" class="popup" role="dialog" aria-live="polite">
        <h3 id="popupNew">æ–°åœ°å</h3>
        <div id="popupOld" class="muted">èˆŠåœ°å</div>
        <div class="audioRow">
          <button class="audioBtn" id="btnNew">ğŸ”ˆ æ–°åœ°åï¼ˆé ç•™ï¼‰</button>
          <button class="audioBtn" id="btnOld">ğŸ”ˆ èˆŠåœ°åï¼ˆé ç•™ï¼‰</button>
        </div>
      </div>
    </div>

    <div class="note">â€» å·²ä»¥å››ç¾¤è‰²ç³»ä¸Šè‰²ä¸¦å…§åµŒè™•ç†ã€‚åˆä½µè¦–è¦ºæ¨¡å¼æœƒæŠŠå››ç¾¤è‡ªå‹•é æ”ï¼Œæ¨™ç±¤ç”¨ç•«é¢åº§æ¨™å®šä½é¿å…å·¦ä¸Šåç§»ã€‚</div>
  </div>

<script>
/* â€”â€” ä½ çš„ SVG è·¯å¾‘ï¼ˆèˆ‡ HTML åŒå±¤ï¼‰ï¼šè‹¥ inlineSvg æ²’è²¼ï¼Œå°±ç”¨é€™å€‹è¼‰å…¥ â€”â€” */
const SVG_URL = 'map_assets/Blank_Kaohsiung_map.svg';

/* â€”â€” å››ç¾¤èˆ‡é¡è‰² â€”â€” */
const groups = {
  center: ["æ¥ æ¢“","å·¦ç‡Ÿ","é¼“å±±","ä¸‰æ°‘","é¹½åŸ•","å‰é‡‘","æ–°èˆˆ","è‹“é›…","æ——æ´¥","å‰é®","å°æ¸¯"],
  east:   ["å¤§æ¨¹","å¤§å¯®","æ—åœ’","å¤§ç¤¾","ä»æ­¦","é³¥æ¾","é³³å±±"],
  north:  ["èŒ„è£","æ°¸å®‰","å½Œé™€","æ¢“å®˜","æ¹–å…§","è·¯ç«¹","å²¡å±±","æ©‹é ­","é˜¿è“®","ç”°å¯®","ç‡•å·¢"],
  mount:  ["å…§é–€","æ——å±±","æ‰æ—","ç¾æ¿ƒ","ç”²ä»™","å…­é¾œ","é‚£ç‘ªå¤","æ¡ƒæº","èŒ‚æ—"]
};
const groupColor = { center:'#ffb3b3', east:'#d1b3ff', north:'#d4f5b3', mount:'#b3e6e6' };

/* â€”â€” æ¯å€æ–°/èˆŠï¼ˆä¸­æ–‡ï¼‰ â€”â€” */
const placeData = {
  "æ¥ æ¢“": { new_ch:"æ¥ æ¢“", old_ch:"æ¥ ä»”å‘" },
  "å·¦ç‡Ÿ": { new_ch:"å·¦ç‡Ÿ", old_ch:"èˆˆéš†é‡Œ" },
  "é¼“å±±": { new_ch:"é¼“å±±", old_ch:"æ‰“ç‹—å±±" },
  "ä¸‰æ°‘": { new_ch:"ä¸‰æ°‘", old_ch:"ä¸‰å¡Šå" },
  "é¹½åŸ•": { new_ch:"é¹½åŸ•", old_ch:"é¹½åŸ•åŸ”" },
  "å‰é‡‘": { new_ch:"å‰é‡‘", old_ch:"å‰è¡¿" },
  "æ–°èˆˆ": { new_ch:"æ–°èˆˆ", old_ch:"é€®æ¸¯åŸ”" },
  "è‹“é›…": { new_ch:"è‹“é›…", old_ch:"ç¬­ä»”å¯®" },
  "æ——æ´¥": { new_ch:"æ——æ´¥", old_ch:"æ——å¾Œ" },
  "å‰é®": { new_ch:"å‰é®", old_ch:"å‰é®" },
  "å°æ¸¯": { new_ch:"å°æ¸¯", old_ch:"æ¸¯ä»”å¢˜" },

  "å¤§æ¨¹": { new_ch:"å¤§æ¨¹", old_ch:"å¤§æ¨¹è·¤" },
  "å¤§å¯®": { new_ch:"å¤§å¯®", old_ch:"å¤§è—”" },
  "æ—åœ’": { new_ch:"æ—åœ’", old_ch:"é ‚æ—ä»”é‚Š" },
  "å¤§ç¤¾": { new_ch:"å¤§ç¤¾", old_ch:"ä¸‰å¥¶å£‡" },
  "ä»æ­¦": { new_ch:"ä»æ­¦", old_ch:"ä»æ­¦é®" },
  "é³¥æ¾": { new_ch:"é³¥æ¾", old_ch:"é³¥æ¾è·¤" },
  "é³³å±±": { new_ch:"é³³å±±", old_ch:"ä¸‹åŸ¤é ­" },

  "èŒ„è£": { new_ch:"èŒ„è£", old_ch:"èŒ„è‹³è£ä»”" },
  "æ°¸å®‰": { new_ch:"æ°¸å®‰", old_ch:"çƒæ¨¹æ—" },
  "å½Œé™€": { new_ch:"å½Œé™€", old_ch:"å½Œé™€æ¸¯" },
  "æ¢“å®˜": { new_ch:"æ¢“å®˜", old_ch:"æ¢“å®˜" },
  "æ¹–å…§": { new_ch:"æ¹–å…§", old_ch:"å¤§æ¹–" },
  "è·¯ç«¹": { new_ch:"è·¯ç«¹", old_ch:"åŠè·¯ç«¹" },
  "å²¡å±±": { new_ch:"å²¡å±±", old_ch:"é˜¿å…¬åº—" },
  "æ©‹é ­": { new_ch:"æ©‹é ­", old_ch:"æ©‹ä»”é ­" },
  "é˜¿è“®": { new_ch:"é˜¿è“®", old_ch:"é˜¿å—¹ç¤¾" },
  "ç”°å¯®": { new_ch:"ç”°å¯®", old_ch:"ç”°è—”" },
  "ç‡•å·¢": { new_ch:"ç‡•å·¢", old_ch:"æ´å‰¿å³" },

  "å…§é–€": { new_ch:"å…§é–€", old_ch:"ç¾…æ¼¢å…§é–€" },
  "æ——å±±": { new_ch:"æ——å±±", old_ch:"è•ƒè–¯è—”" },
  "æ‰æ—": { new_ch:"æ‰æ—", old_ch:"æ¥ æ¢“ä»™" },
  "ç¾æ¿ƒ": { new_ch:"ç¾æ¿ƒ", old_ch:"ç€°æ¿ƒ" },
  "ç”²ä»™": { new_ch:"ç”²ä»™", old_ch:"é˜¿é‡Œé—œ" },
  "å…­é¾œ": { new_ch:"å…­é¾œ", old_ch:"å…­é¾œé‡Œç¤¾" },
  "é‚£ç‘ªå¤": { new_ch:"é‚£ç‘ªå¤", old_ch:"èšŠå­åª" },
  "æ¡ƒæº": { new_ch:"æ¡ƒæº", old_ch:"é›…çˆ¾" },
  "èŒ‚æ—": { new_ch:"èŒ‚æ—", old_ch:"å±¯ä»”" }
};

function findGroup(name){ for(const k in groups) if(groups[k].includes(name)) return k; return null; }

const labelsLayer = document.getElementById('labelsLayer');
const stage = document.getElementById('stage');
const popup = document.getElementById('popup');
const popupNew = document.getElementById('popupNew');
const popupOld = document.getElementById('popupOld');
const mergeBtn = document.getElementById('mergeBtn');

async function loadSVGIntoHost(){
  const inline = document.querySelector('#inlineSvg');
  const host = document.querySelector('#svgHost');
  if(inline && inline.textContent.trim().length > 0){
    host.innerHTML = inline.textContent;  // çœŸæ­£å…§åµŒï¼ˆé›¢ç·šå¯ç”¨ï¼‰
    return;
  }
  // ç·šä¸ŠæŠ“å–ä½ ç¾æœ‰çš„ SVG
  const res = await fetch(SVG_URL, {mode:'cors'});
  const txt = await res.text();
  host.innerHTML = txt;
}

function colorAndBind(svg, targetEls){
  // viewBox / preserve
  if(!svg.getAttribute('viewBox')){
    const w = parseFloat(svg.getAttribute('width')||'1000')||1000;
    const h = parseFloat(svg.getAttribute('height')||'1000')||1000;
    svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  }
  svg.setAttribute('preserveAspectRatio','xMidYMid meet');

  // å»é™¤å·¨å‹é»‘æ¡†ï¼ˆé¿å…èª¤è“‹ä½ï¼‰
  Array.from(svg.querySelectorAll('path,rect')).forEach(el=>{
    try{
      const bb = el.getBBox();
      const vb = svg.viewBox.baseVal;
      const svgArea = vb.width*vb.height;
      const area = bb.width*bb.height;
      const stroke = (el.getAttribute('stroke')||'').toLowerCase();
      const sw = parseFloat(el.getAttribute('stroke-width')||0);
      if(svgArea && area/svgArea>0.5 && (stroke.includes('black')||stroke==='#000') && sw>=3){
        el.style.display='none';
      }
    }catch(e){}
  });

  // é¡è‰² + äº’å‹•
  targetEls.forEach(el=>{
    let titleText=''; try{const t=el.querySelector&&el.querySelector('title'); if(t) titleText=t.textContent.trim();}catch(e){}
    let name='';
    if(titleText){ const m=titleText.match(/^[\u4e00-\u9fff]+/); if(m&&m[0]) name=m[0].replace(/å€$/,''); }
    if(!name) name=(el.id||'').replace(/^_+/,'');

    el.dataset.name = name;

    const g = findGroup(name);
    if(g){
      const base = groupColor[g];
      const curFill = (el.getAttribute('fill')||'').toLowerCase();
      if(!curFill || curFill==='none' || curFill==='#ffffff' || curFill==='white') el.setAttribute('fill', base);
    }
    el.setAttribute('stroke','#ffffff');
    el.setAttribute('stroke-width','1');

    el.addEventListener('click', ev=>{ ev.stopPropagation(); showPopup(name, ev); });
    el.addEventListener('mouseenter', ()=> el.style.filter='brightness(1.06)');
    el.addEventListener('mouseleave', ()=> el.style.filter='');
  });
}

function placeLabels(svg, targetEls){
  labelsLayer.innerHTML='';
  const stageRect = stage.getBoundingClientRect();
  targetEls.forEach(el=>{
    try{
      const bbox = el.getBoundingClientRect();
      if(bbox.width<6 && bbox.height<6) return;
      const cx = bbox.left + bbox.width/2;
      const cy = bbox.top + bbox.height/2;
      const lx = cx - stageRect.left;
      const ly = cy - stageRect.top;

      const name = el.dataset.name || '';
      const pd = placeData[name] || {};
      const div = document.createElement('div');
      div.className='label';
      div.style.left = lx+'px';
      div.style.top  = ly+'px';
      div.innerHTML = `<div class="new">${pd.new_ch || name}</div><div class="old">${pd.old_ch || ''}</div>`;
      labelsLayer.appendChild(div);
    }catch(e){}
  });
}

function showPopup(name, ev){
  const pd = placeData[name] || {};
  popupNew.textContent = pd.new_ch || name;
  popupOld.textContent = pd.old_ch || '';
  const rect = stage.getBoundingClientRect();
  let clientX = ev.clientX || (ev.touches && ev.touches[0] && ev.touches[0].clientX) || (rect.left + rect.width/2);
  let clientY = ev.clientY || (ev.touches && ev.touches[0] && ev.touches[0].clientY) || (rect.top + rect.height/2);
  let left = clientX - rect.left + 8;
  let top  = clientY - rect.top + 8;
  const pw = Math.min(320, rect.width - 16), ph = 160;
  if(left + pw > rect.width) left = Math.max(8, clientX - rect.left - pw - 8);
  if(top + ph > rect.height) top = Math.max(8, clientY - rect.top - ph - 8);
  popup.style.left = left + 'px';
  popup.style.top  = top  + 'px';
  popup.style.display='block';
}

function visualMerge(svg, targetEls){
  // å…ˆå»ºç«‹å››å€‹ wrapperï¼ŒæŠŠå±¬æ–¼å„ç¾¤çš„å…ƒç´ è£é€²å»
  const NS = "http://www.w3.org/2000/svg";
  const wrappers = {};
  Object.keys(groups).forEach(k=>{
    const g = document.createElementNS(NS,'g');
    g.setAttribute('id','__grp_'+k);
    g.setAttribute('data-merge-group', k);
    svg.appendChild(g);
    wrappers[k]=g;
  });
  const others = document.createElementNS(NS,'g');
  others.setAttribute('id','__grp_others');
  svg.appendChild(others);

  targetEls.forEach(el=>{
    const name = el.dataset.name || '';
    const grp = findGroup(name);
    (grp?wrappers[grp]:others).appendChild(el);
  });

  // ä»¥ viewBox è¨ˆç®—ä½ç§»ï¼ˆæ¯”ä¾‹åŒ–ï¼Œä¸åƒå›ºå®šåƒç´ ï¼‰
  const vb = svg.viewBox.baseVal || {width:1000,height:1000};
  const w = vb.width, h = vb.height;
  // é€™çµ„ offset æ˜¯é è¨­ã€Œæ”¶æ”ã€å€¼ï¼šä½ è‹¥è¦ºå¾—ç¸«éš™é‚„å¤§ï¼Œæˆ‘å†å¹«ä½ åŠ å¤§æ”¶æ”é‡
  const mergeOffsets = {
    center: { x: 0,           y: 0 },
    north:  { x: 0,           y: 0.14*h },   // å‘ä¸‹é è¿‘å¸‚ä¸­å¿ƒ
    east:   { x: -0.22*w,     y: 0 },        // å‘å·¦é è¿‘å¸‚ä¸­å¿ƒ
    mount:  { x: -0.28*w,     y: 0.08*h }    // å‘å·¦ä¸‹ï¼Œé è¿‘åŒ—/æ±
  };

  let merged = false;
  function applyMerge(on){
    merged = !!on;
    Object.keys(wrappers).forEach(k=>{
      const off = merged ? mergeOffsets[k] : {x:0,y:0};
      wrappers[k].setAttribute('transform', `translate(${off.x}, ${off.y})`);
    });
    // é‡æ–°å®šä½æ¨™ç±¤
    setTimeout(()=>placeLabels(svg, targetEls), 150);
  }

  // ç¶å®šæŒ‰éˆ•
  const btn = document.getElementById('mergeBtn');
  btn.addEventListener('click', ()=>{
    applyMerge(!merged);
    btn.textContent = merged ? 'å–æ¶ˆåˆä½µè¦–è¦ºæ¨¡å¼' : 'å•Ÿç”¨åˆä½µè¦–è¦ºæ¨¡å¼';
  });

  // åˆæ¬¡å°±æ‰“é–‹åˆä½µï¼ˆä½ è¦æ”¹æˆé è¨­é—œé–‰ä¹Ÿå¯ä»¥ï¼‰
  applyMerge(true);
}

(async function main(){
  await loadSVGIntoHost();
  const svg = document.querySelector('#svgHost svg');
  if(!svg){ document.querySelector('#svgHost').innerHTML = '<div style="padding:12px;color:#900;background:#fff;border-radius:8px">è¼‰å…¥åœ°åœ–å¤±æ•—</div>'; return; }

  // æ‰¾å‡ºè¡Œæ”¿å€å…ƒç´ ï¼ˆå„ªå…ˆæœ‰ <title> çš„ï¼‰
  const candidates = Array.from(svg.querySelectorAll('path,polygon,rect,g'));
  const areas = candidates.filter(el=>{
    const t = el.querySelector && el.querySelector('title');
    return (t && t.textContent && t.textContent.trim()) || (el.id && el.id.trim());
  });
  const targetEls = areas.length ? areas : Array.from(svg.querySelectorAll('path'));

  colorAndBind(svg, targetEls);
  visualMerge(svg, targetEls);

  // åˆæ¬¡èˆ‡å¾ŒçºŒè¦–çª—è®Šå‹•æ™‚é‡ç®—æ¨™ç±¤
  setTimeout(()=>placeLabels(svg, targetEls), 250);
  window.addEventListener('resize', ()=> setTimeout(()=>placeLabels(svg, targetEls),120));
  window.addEventListener('scroll', ()=> setTimeout(()=>placeLabels(svg, targetEls),120));

  // é»èƒŒæ™¯é—œé–‰æµ®çª—
  document.addEventListener('click', ()=> popup.style.display='none');
})();
</script>
</body>
</html>
