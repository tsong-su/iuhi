<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>é«˜é›„å¸‚38å€æ–°èˆŠåœ°åäº’å‹•åœ°åœ–</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#111827; --muted:#6b7280; --bg:#fafafa;
    --red:#f87171;      /* å¸‚ä¸­å¿ƒ */
    --purple:#c4b5fd;   /* æ±å€   */
    --ylg:#9FDF72;      /* åŒ—å€   (åŠ æ·±) */
    --cyan:#99f6e4;     /* å±±å€   */
    --card:rgba(255,255,255,.96);
    --stroke:#ffffff;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,Arial}
  .app{display:flex;flex-direction:column;min-height:100vh}
  header{padding:12px 16px 6px}
  h1{margin:0 0 6px;font-size:18px}
  .hint{margin:0;color:var(--muted);font-size:14px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:8px 12px}
  .btn{padding:8px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer;font-size:14px}
  .btn.center{background:var(--red);color:#111}
  .btn.east{background:var(--purple);color:#111}
  .btn.north{background:var(--ylg);color:#111}
  .btn.mount{background:var(--cyan);color:#111}
  .mapwrap{position:relative;flex:1;min-height:0;border-top:1px solid #e5e7eb}
  svg#stage{display:block;width:100vw;height:calc(100vh - 168px);background:#fff}
  @media (max-width:768px){ svg#stage{height:calc(100vh - 186px)} }
  /* æµ®çª— */
  .tip{
    position:absolute;min-width:240px;max-width:86vw;pointer-events:auto;z-index:10;
    background:var(--card);backdrop-filter:saturate(140%) blur(6px);
    border:1px solid rgba(0,0,0,.06);border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.18);
    padding:12px;opacity:0;transform:translate(-50%,-10px) scale(.98);
    transition:opacity .22s ease, transform .22s ease;
  }
  .tip.show{opacity:1;transform:translate(-50%,-14px) scale(1)}
  .tip h3{margin:0 0 2px;color:#b91c1c;font-size:16px;font-weight:700}
  .tip h4{margin:0 0 6px;color:#111827;font-size:15px;font-weight:600}
  .py{margin:0;color:#334155;font-size:14px;line-height:1.25}
  .btns{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
  .btnplay{padding:6px 10px;font-size:13px;border-radius:10px;border:1px solid #d1d5db;background:#ffffff;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
  .btnplay svg{width:14px;height:14px}
  .btnplay[disabled]{opacity:.45;cursor:not-allowed}
  /* é»æ“Šå›é¥‹ */
  @keyframes ringPulse{0%{filter:brightness(1);stroke-width:1}40%{filter:brightness(1.55);stroke-width:2.5}100%{filter:brightness(1);stroke-width:1}}
  .hoverable{transition:filter .25s ease}
  .hoverable:hover{filter:brightness(1.12)}
  /* åˆå§‹é›™è¡Œæ¨™ç±¤ï¼ˆä¸Šæ–°/ä¸‹èˆŠï¼‰ */
  .label{ font-size:13px; paint-order:stroke; stroke:#fff; stroke-width:3px; stroke-linejoin:round; text-anchor:middle; pointer-events:none }
  .label-new{ fill:#b91c1c; font-weight:700 }
  .label-old{ fill:#111827; font-weight:600 }
  /* åº•éƒ¨å·¥å…·åˆ— */
  .footerbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;padding:10px 12px}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>é«˜é›„å¸‚38å€æ–°èˆŠåœ°åäº’å‹•åœ°åœ–</h1>
    <p class="hint">ğŸ“± å»ºè­°ç›´å¼è§€çœ‹æ•ˆæœæœ€ä½³</p>
  </header>

  <div class="toolbar">
    <button class="btn center" data-group="center">å¸‚ä¸­å¿ƒ</button>
    <button class="btn east"   data-group="east">å¸‚éƒŠâ€“æ±</button>
    <button class="btn north"  data-group="north">å¸‚éƒŠâ€“åŒ—</button>
    <button class="btn mount"  data-group="mount">å±±å€</button>
  </div>

  <div class="mapwrap">
    <!-- æµ®çª— -->
    <div id="tip" class="tip" role="dialog" aria-live="polite">
      <h3 id="tipNew"></h3>
      <h4 id="tipOld"></h4>
      <p id="tipPyNew" class="py"></p>
      <p id="tipPyOld" class="py"></p>
      <div class="btns">
        <button id="btnPlayNew" class="btnplay"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> æ–°åœ°å</button>
        <button id="btnPlayOld" class="btnplay"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> èˆŠåœ°å</button>
      </div>
      <audio id="aud" preload="none"></audio>
    </div>

    <!-- ä¸»ç•«å¸ƒï¼ˆç¨‹å¼æœƒæŠŠå¤–éƒ¨ SVG å…§å®¹æŠ“å›ä¾†ã€Œå…§åµŒæ³¨å…¥ã€åœ¨ #svgHost è£¡ï¼Œå†è¨ˆç®—å…¨åœ–ï¼‰ -->
    <svg id="stage" viewBox="0 0 1143.062 1440.995" preserveAspectRatio="xMidYMid meet" aria-label="é«˜é›„å¸‚è¡Œæ”¿å€äº’å‹•åœ°åœ–">
      <g id="svgHost"></g>
      <g id="labelsLayer"></g>
    </svg>
  </div>

  <div class="footerbar">
    <button id="btnReset" class="btn">ğŸ”„ å…¨éƒ¨é¡¯ç¤º</button>
  </div>
</div>

<script>
/* =========================
   0) åŸºæœ¬è¨­å®š
========================= */
const SVG_URL = 'map_assets/Blank_Kaohsiung_map.svg'; // ä½ å·²ç§»é™¤é»‘æ¡†çš„é‚£ä¸€ä»½

/* åˆ†ç¾¤èˆ‡è‰²ç³» */
const GROUPS = {
  center: ["æ¥ æ¢“","å·¦ç‡Ÿ","é¼“å±±","ä¸‰æ°‘","é¹½åŸ•","å‰é‡‘","æ–°èˆˆ","è‹“é›…","æ——æ´¥","å‰é®","å°æ¸¯"],
  east:   ["å¤§æ¨¹","å¤§å¯®","æ—åœ’","å¤§ç¤¾","ä»æ­¦","é³¥æ¾","é³³å±±"],
  north:  ["èŒ„è£","æ°¸å®‰","å½Œé™€","æ¢“å®˜","æ¹–å…§","è·¯ç«¹","å²¡å±±","æ©‹é ­","é˜¿è“®","ç”°å¯®","ç‡•å·¢"],
  mount:  ["å…§é–€","æ——å±±","æ‰æ—","ç¾æ¿ƒ","ç”²ä»™","å…­é¾œ","é‚£ç‘ªå¤","æ¡ƒæº","èŒ‚æ—"]
};
const COLOR = { center:'var(--red)', east:'var(--purple)', north:'var(--ylg)', mount:'var(--cyan)' };
const whichGroup = n => GROUPS.center.includes(n)?'center':GROUPS.east.includes(n)?'east':GROUPS.north.includes(n)?'north':GROUPS.mount.includes(n)?'mount':null;

/* æ–°/èˆŠåç¨± + å°èªæ‹¼éŸ³ï¼ˆæµ®çª—é¡¯ç¤ºç”¨ï¼›åˆå§‹ä¸é¡¯ç¤ºæ‹¼éŸ³ï¼‰ */
const D = {
  "æ¥ æ¢“":{old:"æ¥ ä»”å‘",      pyNew:"LÃ¢m-tsÃº",        pyOld:"LÃ¢m-Ã¡-khenn"},
  "å·¦ç‡Ÿ":{old:"åŸ¤ä»”é ­",      pyNew:"TsÃ³-iÃ¢nn",       pyOld:"Pi-Ã¡-thÃ¢u"},
  "é¼“å±±":{old:"æ‰“ç‹—å±±",      pyNew:"KÃ³o-san",        pyOld:"TÃ¡nn-kÃ³o-san"},
  "ä¸‰æ°‘":{old:"ä¸‰å¡Šå",      pyNew:"Sam-bÃ®n",        pyOld:"Sann-tÃ¨-tshÃ¹"},
  "é¹½åŸ•":{old:"é¹½åŸ•åŸ”",      pyNew:"IÃ¢m-tiÃ¢nn",      pyOld:"IÃ¢m-tiÃ¢nn-poo"},
  "å‰é‡‘":{old:"å‰è¡¿",        pyNew:"TsiÃ¢n-kim",      pyOld:"TsiÃ¢n-khim"},
  "æ–°èˆˆ":{old:"é€®æ¸¯åŸ”",      pyNew:"Sin-hing",       pyOld:"TÄi-kÃ¡ng-poo"},
  "è‹“é›…":{old:"ç¬­ä»”å¯®",      pyNew:"LÃ®ng-ngÃ¡",       pyOld:"LÃ®ng-Ã¡-liÃ¢u"},
  "æ——æ´¥":{old:"æ——å¾Œ",        pyNew:"KÃ®-tin",         pyOld:"KÃ®-Äu"},
  "å‰é®":{old:"å‰é®",        pyNew:"TsiÃ¢n-tÃ¬n",      pyOld:"TsiÃ¢n-tÃ¬n"},
  "å°æ¸¯":{old:"æ¸¯ä»”å¢˜",      pyNew:"SiÃ³-kÃ¡ng",       pyOld:"KÃ¡ng-Ã¡ kÃ®nn"},
  "å¤§æ¨¹":{old:"å¤§æ¨¹è·¤",      pyNew:"TuÄ-tshiÅ«",      pyOld:"TuÄ-tshiÅ«-kha"},
  "å¤§å¯®":{old:"å¤§è—”",        pyNew:"TuÄ-liÃ¢u",       pyOld:"TuÄ-liÃ¢u"},
  "æ—åœ’":{old:"é ‚æ—ä»”é‚Š",    pyNew:"LÃ®m-hnÌ‚g",        pyOld:"TÃ­ng-nÃ¢-Ã¡-pinn"},
  "å¤§ç¤¾":{old:"ä¸‰å¥¶å£‡",      pyNew:"TuÄ-siÄ",        pyOld:"Sam-nÃ¡i-tuÃ¢nn"},
  "ä»æ­¦":{old:"ä»æ­¦åº„",      pyNew:"JÃ®n-bÃº",         pyOld:"JÃ®n-bÃº-tsng"},
  "é³¥æ¾":{old:"é³¥æ¾è·¤",      pyNew:"TsiÃ¡u-tshÃ®ng",   pyOld:"TsiÃ¡u-tshÃ®ng-kha"},
  "é³³å±±":{old:"ä¸‹åŸ¤é ­",      pyNew:"HÅng-suann",     pyOld:"Ä’-pi-thÃ¢u"},
  "èŒ„è£":{old:"èŒ„è‹³è£ä»”",    pyNew:"Ka-tiÄnn",       pyOld:"Ka-tang-tiÄnn-Ã¡"},
  "æ°¸å®‰":{old:"çƒæ¨¹æ—",      pyNew:"Ãng-an",         pyOld:"Oo-tshiÅ«-nÃ¢"},
  "å½Œé™€":{old:"å½Œé™€æ¸¯",      pyNew:"MÃ®-tÃ´",          pyOld:"BÃ®-lÃ´-kÃ¡ng"},
  "æ¢“å®˜":{old:"æ¢“å®˜",        pyNew:"TsÃº-kuann",      pyOld:"TsÃº-kuann"},
  "æ¹–å…§":{old:"å¤§æ¹–",        pyNew:"Ã”o-lÄi",         pyOld:"TuÄ-Ã´o"},
  "è·¯ç«¹":{old:"åŠè·¯ç«¹",      pyNew:"LÅo-tik",        pyOld:"PuÃ nn-lÅo-tik"},
  "å²¡å±±":{old:"é˜¿å…¬åº—",      pyNew:"Kong-san",       pyOld:"A-kong-tiÃ m"},
  "æ©‹é ­":{old:"æ©‹ä»”é ­",      pyNew:"KiÃ´-thÃ¢u",       pyOld:"KiÃ´-Ã¡-thÃ¢u"},
  "é˜¿è“®":{old:"é˜¿å—¹ç¤¾",      pyNew:"A-lian",         pyOld:"A-lian-siÄ"},
  "ç”°å¯®":{old:"ç”°è—”",        pyNew:"TshÃ¢n-liÃ¢u",     pyOld:"TshÃ¢n-liÃ¢u"},
  "ç‡•å·¢":{old:"æ´å‰¿å³",      pyNew:"IÃ n-tsÃ¢u",       pyOld:"UÄn-tsÃ¢u-iÅ«"},
  "å…§é–€":{old:"ç¾…æ¼¢å…§é–€",    pyNew:"LÄi-bÃ»n",        pyOld:"LÃ´-hÃ n-lÄi-bÃ»n"},
  "æ——å±±":{old:"è•ƒè–¯è—”",      pyNew:"KÃ®-san",         pyOld:"Han-tsÃ®-liÃ¢u"},
  "æ‰æ—":{old:"æ¥ æ¢“ä»™",      pyNew:"Sam-nÃ¢",         pyOld:"LÃ¢m-tsÃº-sian"},
  "ç¾æ¿ƒ":{old:"ç€°æ¿ƒ",        pyNew:"Bi-long",        pyOld:"BÃ®-long"},
  "ç”²ä»™":{old:"é˜¿é‡Œé—œ",      pyNew:"Kah-sian",       pyOld:"A-lÃ­-kuan"},
  "å…­é¾œ":{old:"å…­é¾œé‡Œç¤¾",    pyNew:"LaÌk-ku",         pyOld:"LaÌk-ku-lÃ­-siÄ"},
  "é‚£ç‘ªå¤":{old:"èšŠå­åª",     pyNew:"Na-mÃ¡-siah",     pyOld:"Mangacun/BÃ¡ng-Ã¡-tsÃ­"},
  "æ¡ƒæº":{old:"é›…çˆ¾",        pyNew:"ThÃ´-guÃ¢n",       pyOld:"Ngani/NgÃ¡-nÃ­"},
  "èŒ‚æ—":{old:"å¤šç´",        pyNew:"BÅo-lÃ®m",        pyOld:"TÅ-na"}
};
/* éŸ³æª”é †åºï¼ˆ01â€“38ï¼‰ */
const ORDER = [
  "æ¥ æ¢“","å·¦ç‡Ÿ","é¼“å±±","ä¸‰æ°‘","é¹½åŸ•","å‰é‡‘","æ–°èˆˆ","è‹“é›…","æ——æ´¥","å‰é®","å°æ¸¯",
  "å¤§æ¨¹","å¤§å¯®","æ—åœ’","å¤§ç¤¾","ä»æ­¦","é³¥æ¾","é³³å±±",
  "èŒ„è£","æ°¸å®‰","å½Œé™€","æ¢“å®˜","æ¹–å…§","è·¯ç«¹","å²¡å±±","æ©‹é ­","é˜¿è“®","ç”°å¯®","ç‡•å·¢",
  "å…§é–€","æ——å±±","æ‰æ—","ç¾æ¿ƒ","ç”²ä»™","å…­é¾œ","é‚£ç‘ªå¤","æ¡ƒæº","èŒ‚æ—"
];
const IDX = Object.fromEntries(ORDER.map((n,i)=>[n,String(i+1).padStart(2,'0')]));

/* =========================
   1) è®€å…¥ SVG ä¸¦ã€Œå…§åµŒæ³¨å…¥ã€
========================= */
const stage  = document.getElementById('stage');
const host   = document.getElementById('svgHost');
const labels = document.getElementById('labelsLayer');
const tip    = document.getElementById('tip');
const tNew   = document.getElementById('tipNew');
const tOld   = document.getElementById('tipOld');
const tPyN   = document.getElementById('tipPyNew');
const tPyO   = document.getElementById('tipPyOld');
const btnN   = document.getElementById('btnPlayNew');
const btnO   = document.getElementById('btnPlayOld');
const aud    = document.getElementById('aud');
const btnReset = document.getElementById('btnReset');
const grpBtns  = document.querySelectorAll('.toolbar .btn');

let allZones = [];
let fullBBox = null;

(async function init(){
  // è®€å…¥ SVG æ–‡å­—
  const raw = await fetch(SVG_URL, {mode:'cors'}).then(r=>r.text());
  // å»æ‰æœ€å¤–å±¤ <svg ...>...</svg> å¤–æ®¼ï¼Œåªä¿ç•™å…§éƒ¨ç¯€é»ï¼ˆé¿å… svg å¥— svg å°è‡´è¦–çª—éŒ¯ä½ï¼‰
  const inner = raw
    .replace(/^[\s\S]*?<svg[^>]*>/i,'')
    .replace(/<\/svg>\s*$/i,'')
    .trim();
  host.innerHTML = inner;

  // æ¸…æ‰åŸ SVG å…§å»ºæ–‡å­—ï¼Œé¿å…èˆ‡æˆ‘å€‘çš„æ¨™ç±¤é‡ç–Š
  host.querySelectorAll('text').forEach(t=>t.setAttribute('display','none'));

  // æ”¶é›†è¡Œæ”¿å€ path/polygonï¼Œä¾ <title> æŠ“ä¸­æ–‡å
  allZones = [];
  host.querySelectorAll('path,polygon').forEach(el=>{
    const t = el.querySelector('title');
    let name = t && t.textContent ? t.textContent.trim() : '';
    name = name.replace(/å€.*$/,'').replace(/\s*\(.+?\)\s*$/,'').replace(/\s*[A-Za-z].*$/,'');
    if(!name || !D[name]) return;
    const grp = whichGroup(name); if(!grp) return;

    // è‘—è‰²èˆ‡æé‚Š
    el.classList.add('hoverable');
    el.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue(
      {center:'--red', east:'--purple', north:'--ylg', mount:'--cyan'}[grp]
    ).trim());
    el.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--stroke').trim());
    el.setAttribute('stroke-width','1');

    // äº’å‹•
    el.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      el.style.animation='none'; void el.offsetWidth; el.style.animation='ringPulse 1s ease';
      autoPlayNew(name);
      showTip(name, el);
    });

    allZones.push({name, grp, el});
  });

  // åˆå§‹é›™è¡Œæ¨™ç±¤ï¼ˆä¸Šæ–°/ä¸‹èˆŠï¼‰
  renderLabels();

  // è¨­å®šã€Œå…¨åœ– viewBoxã€
  fullBBox = unionBBoxOf(host);
  fitTo(fullBBox, 1.0);

  // é»ç©ºç™½æ”¶åˆæµ®çª—
  document.addEventListener('click', hideTip, {capture:true});

  // å››ç¾¤åˆ‡æ›
  grpBtns.forEach(b=>{
    b.addEventListener('click', ()=>{
      const g = b.dataset.group;
      grpBtns.forEach(x=>x.dataset.active = (x===b?'1':'0'));
      showOnlyGroup(g);
    });
  });
  btnReset.addEventListener('click', ()=>{
    grpBtns.forEach(x=>x.dataset.active='0');
    allZones.forEach(z=>z.el.style.display='');  // å…¨é¡¯ç¤º
    fitTo(fullBBox, 1.0);                        // å›å…¨åœ–
  });
})();

/* =========================
   2) æ¨™ç±¤ã€æµ®çª—ã€æ’­æ”¾ã€è¦–çª—
========================= */
function renderLabels(){
  labels.innerHTML = '';
  for(const {name, el} of allZones){
    const info = D[name]; if(!info) continue;
    try{
      const b = el.getBBox();
      const cx = b.x + b.width/2;
      const cy = b.y + b.height/2;
      const t1 = document.createElementNS('http://www.w3.org/2000/svg','text');
      t1.setAttribute('x', cx);
      t1.setAttribute('y', cy - 4);
      t1.setAttribute('class','label label-new');
      t1.textContent = name;

      const t2 = document.createElementNS('http://www.w3.org/2000/svg','text');
      t2.setAttribute('x', cx);
      t2.setAttribute('y', cy + 14);
      t2.setAttribute('class','label label-old');
      t2.textContent = info.old || '';

      labels.appendChild(t1); labels.appendChild(t2);
    }catch(_){}
  }
}

function showTip(name, elem){
  const d = D[name] || {};
  tNew.textContent = d.pyNew ? `${name} ${d.pyNew}` : name;   // ä¸åŠ æ‹¬è™Ÿ
  tOld.textContent = d.old ? (d.pyOld ? `${d.old} ${d.pyOld}` : d.old) : '';
  tPyN.textContent = d.pyNew || '';
  tPyO.textContent = d.pyOld || '';

  // æ’­æ”¾éµï¼ˆé‡æ’­ï¼‰
  const idx = IDX[name];
  const newSrc = idx ? `map_assets/${idx}${name}_new.mp3` : '';
  const oldSrc = (idx && d.old) ? `map_assets/${idx}${d.old}_old.mp3` : '';
  btnN.disabled = !newSrc; btnO.disabled = !oldSrc;
  btnN.onclick = ()=> play(newSrc);
  btnO.onclick = ()=> play(oldSrc);

  placeTipBeside(elem);
  tip.classList.add('show');
}
function hideTip(){ tip.classList.remove('show'); }

function autoPlayNew(name){
  const idx = IDX[name];
  if(!idx) return;
  const src = `map_assets/${idx}${name}_new.mp3`;
  play(src);
}
function play(src){
  aud.pause(); aud.src = src; aud.play().catch(()=>{});
}

/* æµ®çª—è²¼æ—é‚Šã€é‚Šç•Œé¿è®“ */
function placeTipBeside(elem){
  const hostRect = stage.getBoundingClientRect();
  const r = elem.getBoundingClientRect();
  const cx = r.left + r.width/2;
  const cy = r.top  + r.height/2;

  const onLeft = cx < (hostRect.left + hostRect.width/2);
  const onTop  = cy < (hostRect.top  + hostRect.height/2);

  let dx = onLeft ? +110 : -110;
  let dy = onTop  ? +46  : -46;

  let left = cx - hostRect.left + dx + window.scrollX;
  let top  = cy - hostRect.top  + dy + window.scrollY;

  const pad = 12;
  left = Math.max(pad, Math.min(left, hostRect.width - pad));
  top  = Math.max(pad, Math.min(top,  hostRect.height - pad));

  tip.style.left = `${left}px`;
  tip.style.top  = `${top}px`;
}

/* å››ç¾¤åªé¡¯ç¤ºï¼‹æ”¾å¤§ */
let curViewBox = {...stage.viewBox.baseVal};
function showOnlyGroup(g){
  const targets = allZones.filter(z=>z.grp===g);
  const others  = allZones.filter(z=>z.grp!==g);
  targets.forEach(z=>z.el.style.display='');
  others.forEach(z=>z.el.style.display='none');
  const bb = unionBBox(targets.map(z=>z.el.getBBox()));
  fitTo(bb, 1.6);
}

/* viewBox ç½®ä¸­ç¸®æ”¾åˆ°æŒ‡å®š bboxï¼ˆscale>1 æ”¾å¤§ï¼‰ */
function fitTo(bb, scale){
  const pad = 0.06;
  const x = bb.x - bb.width*pad;
  const y = bb.y - bb.height*pad;
  const w = bb.width*(1+2*pad);
  const h = bb.height*(1+2*pad);
  const vw = w/scale;
  const vh = h/scale;
  const cx = x + w/2;
  const cy = y + h/2;
  const vx = cx - vw/2;
  const vy = cy - vh/2;
  stage.setAttribute('viewBox', [vx,vy,vw,vh].join(' '));
  curViewBox = {x:vx,y:vy,width:vw,height:vh};
}

/* æ‹–æ›³ç§»å‹•ï¼ˆç¾¤çµ„æ”¾å¤§æ™‚ä½¿ç”¨ï¼‰ */
let dragging=false, last={x:0,y:0};
stage.addEventListener('pointerdown', e=>{
  dragging=true; last={x:e.clientX, y:e.clientY}; stage.setPointerCapture(e.pointerId);
});
stage.addEventListener('pointermove', e=>{
  if(!dragging) return;
  const dx = e.clientX - last.x;
  const dy = e.clientY - last.y;
  last = {x:e.clientX, y:e.clientY};
  const rect = stage.getBoundingClientRect();
  const kx = curViewBox.width / rect.width;
  const ky = curViewBox.height/ rect.height;
  curViewBox.x -= dx * kx;
  curViewBox.y -= dy * ky;
  stage.setAttribute('viewBox', [curViewBox.x,curViewBox.y,curViewBox.width,curViewBox.height].join(' '));
});
stage.addEventListener('pointerup',   ()=>dragging=false);
stage.addEventListener('pointercancel',()=>dragging=false);

/* bbox å·¥å…· */
function unionBBoxOf(container){
  let bb=null;
  container.querySelectorAll('path,polygon').forEach(el=>{
    try{ const b=el.getBBox(); if(b && b.width>0 && b.height>0) bb = bb? unionBBox(bb,b):b; }catch(_){}
  });
  return bb || {x:0,y:0,width:1143.062,height:1440.995};
}
function unionBBox(list){ return list.reduce((acc,b)=>acc?{x:Math.min(acc.x,b.x),y:Math.min(acc.y,b.y),width:Math.max(acc.x+acc.width,b.x+b.width)-Math.min(acc.x,b.x),height:Math.max(acc.y+acc.height,b.y+b.height)-Math.min(acc.x,b.x)}:b, null); }
</script>
</body>
</html>
