<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é«˜é›„å¸‚38å€æ–°èˆŠåœ°åäº’å‹•åœ°åœ– v6.8</title>
<style>
  :root{
    --core:#3A7BD5;      /* å¸‚ä¸­å¿ƒ */
    --east:#56ab2f;      /* å¸‚éƒŠ-æ±å€ */
    --north:#ff9966;     /* å¸‚éƒŠ-åŒ—å€ */
    --mountain:#6a83f7;  /* å±±å€ */
    --ink:#0f172a; --card:#fff; --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:"Noto Sans TC",system-ui,"Microsoft JhengHei",sans-serif;background:#f6f7f9;color:var(--ink);text-align:center}

  header{padding:10px 12px 6px}
  h1{margin:6px 0 4px;font-size:1.5rem;font-weight:800}
  .notice{margin:2px 0;color:#444}

  /* å››é¡†ç¾¤çµ„æŒ‰éˆ•ï¼šæ»¿ç‰ˆå››ç­‰åˆ†ï¼Œä¸æ›è¡Œï¼ˆæ‰‹æ©Ÿä¹Ÿä¸€åˆ—ï¼‰ */
  .groupbar{
    display:grid; grid-template-columns:repeat(4,1fr); gap:10px;
    max-width:980px; margin:10px auto 10px; padding:0 12px;
  }
  .groupbar button{
    border:0;border-radius:14px;padding:10px 6px;font-size:1rem;color:#fff;cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,.25);transition:filter .2s, transform .02s; position:relative; line-height:1.1;
  }
  @media (max-width:420px){
    .groupbar button{font-size:.95rem; padding:10px 4px}
  }
  .groupbar button:hover{filter:brightness(1.08)} .groupbar button:active{transform:translateY(1px)}
  .groupbar button.is-on{outline:2px solid #fff}
  .btn-core{background:linear-gradient(145deg,#3A7BD5,#00d2ff)}
  .btn-east{background:linear-gradient(145deg,#56ab2f,#a8e063)}
  .btn-north{background:linear-gradient(145deg,#ff9966,#ff5e62)}
  .btn-mount{background:linear-gradient(145deg,#6a83f7,#9aa8ff)}
  .badge{
    position:absolute;top:-6px;right:-8px;border-radius:999px;min-width:22px;height:22px;padding:0 6px;
    display:inline-flex;align-items:center;justify-content:center;font-size:.78rem;font-weight:700;color:#000;box-shadow:0 2px 6px rgba(0,0,0,.28);
    background:rgba(255,255,255,.92)
  }
  .btn-core  .badge{background:#a9d4ff}
  .btn-east  .badge{background:#c9f7b6}
  .btn-north .badge{background:#ffd1b8}
  .btn-mount .badge{background:#dcd9ff}

  main{max-width:980px;margin:0 auto;padding:0 12px 10px}
  #mapbox{
    width:100%; height:calc(100vh - 230px);
    min-height:420px;
    position:relative; background:#fff; border-radius:14px; border:1px solid var(--border);
    box-shadow:0 8px 18px rgba(0,0,0,.06); overflow:hidden;
  }
  object{width:100%;height:100%}

  .dim{opacity:.35; transition:opacity .25s ease}

  /* é»é¸å€å¡Šçš„é–ƒå…‰è¨»è¨˜ï¼ˆåŠ ç²—é‚Š + ç™½è‰²å…‰æšˆï¼‰ */
  @keyframes glow {0%{filter:drop-shadow(0 0 0 rgba(255,255,255,0))}
    30%{filter:drop-shadow(0 0 6px rgba(255,255,255,.9))}
    60%{filter:drop-shadow(0 0 10px rgba(255,255,255,1))}
    100%{filter:drop-shadow(0 0 0 rgba(255,255,255,0))}}
  .glow{animation:glow 1.6s ease; stroke:#111; stroke-width:1.8 !important}
  .flash{animation:flash .8s ease} @keyframes flash{0%{fill-opacity:.5}100%{fill-opacity:1}}

  /* æµ®æ¡†ï¼šå°å·§ã€äº®è‰²æŒ‰éˆ• */
  .popup{
    position:absolute; display:none; min-width:180px; max-width:min(300px, 85%);
    background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.08);
    box-shadow:0 10px 28px rgba(0,0,0,.18); padding:10px; z-index:60
  }
  .popup h3{margin:0 0 4px; font-size:1.02rem}
  .newP{color:#00796b;font-weight:800} .old{color:#374151;margin-top:4px} .oldP{color:#6a1b9a}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{padding:6px 10px;border-radius:10px;border:0;color:#fff;cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,.22)}
  .btn.play{background:linear-gradient(145deg,#42a5f5,#0d47a1)}
  .btn.old {background:linear-gradient(145deg,#ff8a65,#d84315)}

  footer{padding:12px 0}
  footer a{display:inline-block;text-decoration:none;color:#fff;background:linear-gradient(145deg,#4CAF50,#2e7d32);padding:8px 16px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.22)}
</style>
</head>
<body>
  <header>
    <h1>é«˜é›„å¸‚38å€æ–°èˆŠåœ°åäº’å‹•åœ°åœ–</h1>
    <p class="notice">ğŸ“± å»ºè­°ç›´å¼è§€çœ‹æ•ˆæœæœ€ä½³</p>
    <p class="notice">ğŸ‘† é»è¡Œæ”¿å€çœ‹æ–°èˆŠåœ°åä¸¦æ’­æ”¾éŸ³æª”</p>
  </header>

  <div class="groupbar" id="groupbar">
    <button class="btn-core is-on"  data-group="core">å¸‚ä¸­å¿ƒ<span class="badge">11</span></button>
    <button class="btn-east"         data-group="east">å¸‚éƒŠ-æ±å€<span class="badge">7</span></button>
    <button class="btn-north"        data-group="north">å¸‚éƒŠ-åŒ—å€<span class="badge">11</span></button>
    <button class="btn-mount"        data-group="mountain">å±±å€<span class="badge">9</span></button>
  </div>

  <main>
    <div id="mapbox">
      <object id="svgMap" data="map_assets/Blank_Kaohsiung_map.svg" type="image/svg+xml" aria-label="Kaohsiung Map"></object>

      <!-- æµ®æ¡†ï¼ˆè³‡æ–™ï¼‹é‡è½ï¼‰ -->
      <div class="popup" id="popup">
        <h3 id="pop-new">â€”</h3>
        <div class="newP" id="pop-new-poj">â€”</div>
        <div class="old"  id="pop-old">â€”</div>
        <div class="oldP" id="pop-old-poj">â€”</div>
        <div class="row">
          <button class="btn play" id="btn-new">æ’­æ”¾æ–°åœ°å</button>
          <button class="btn old"  id="btn-old">æ’­æ”¾èˆŠåœ°å</button>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <a href="https://tsong-su.github.io/iuhi/index.html">ğŸ  å›éŠæˆ²é¦–é </a>
  </footer>

<script>
/* å°å·¥å…· */
const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>Array.from(e.querySelectorAll(s));
function stripQu(s){return (s||"").replace(/å€$/,'');}
function onlyHan(t){const m=(t||'').match(/[\u4E00-\u9FFF]+/g); return m? m.join(''): '';}
function getNameFromShape(el){
  // 1) è®€è‡ªèº« <title>ï¼›2) çˆ¶å±¤ <g> çš„ <title>ï¼›3) id/labelã€‚
  const selfT = el.querySelector && el.querySelector('title');
  if(selfT && selfT.textContent) return onlyHan(selfT.textContent.trim());
  const p = el.parentNode;
  if(p && p.querySelector){
    const pT = p.querySelector('title');
    if(pT && pT.textContent) return onlyHan(pT.textContent.trim());
  }
  const idName = el.getAttribute('data-name') || el.getAttribute('inkscape:label') || el.getAttribute('id') || '';
  return onlyHan(idName);
}

/* 38 å€ç¾¤çµ„ï¼ˆä¾ä½ ç¢ºèªï¼‰ */
const GROUPS={
  core:["æ¥ æ¢“","å·¦ç‡Ÿ","é¼“å±±","ä¸‰æ°‘","é¹½åŸ•","å‰é‡‘","æ–°èˆˆ","è‹“é›…","æ——æ´¥","å‰é®","å°æ¸¯"],
  east:["å¤§æ¨¹","å¤§å¯®","æ—åœ’","å¤§ç¤¾","ä»æ­¦","é³¥æ¾","é³³å±±"],
  north:["èŒ„è£","æ°¸å®‰","å½Œé™€","æ¢“å®˜","æ¹–å…§","è·¯ç«¹","å²¡å±±","æ©‹é ­","é˜¿è“®","ç”°å¯®","ç‡•å·¢"],
  mountain:["å…§é–€","æ——å±±","æ‰æ—","ç¾æ¿ƒ","ç”²ä»™","å…­é¾œ","é‚£ç‘ªå¤","æ¡ƒæº","èŒ‚æ—"]
};
/* æ–°èˆŠåœ°å + POJï¼ˆä¾ä½ ç¢ºèªï¼›ä¸å‹•ï¼‰ */
const DATA={
  "æ¥ æ¢“":{old:"æ¥ ä»”å‘", newPoj:"LÃ¢m-tsÃº", oldPoj:"LÃ¢m-Ã¡-khenn"},
  "å·¦ç‡Ÿ":{old:"åŸ¤ä»”é ­", newPoj:"TsÃ³-iÃ¢nn", oldPoj:"Pi-Ã¡-thÃ¢u"},
  "é¼“å±±":{old:"æ‰“é¼“å±±", newPoj:"KÃ³o-san", oldPoj:"TÃ¡nn-kÃ³o-san"},
  "ä¸‰æ°‘":{old:"ä¸‰å¡Šå", newPoj:"Sam-bÃ®n", oldPoj:"Sann-tÃ¨-tshÃ¹"},
  "é¹½åŸ•":{old:"é¹½åŸ•åŸ”", newPoj:"IÃ¢m-tiÃ¢nn", oldPoj:"IÃ¢m-tiÃ¢nn-poo"},
  "å‰é‡‘":{old:"å‰è¡¿", newPoj:"TsiÃ¢n-kim", oldPoj:"TsiÃ¢n-khim"},
  "æ–°èˆˆ":{old:"é€®æ¸¯åŸ”", newPoj:"Sin-hing", oldPoj:"TÄi-kÃ¡ng-poo"},
  "è‹“é›…":{old:"ç¬­ä»”å¯®", newPoj:"LÃ®ng-ngÃ¡", oldPoj:"LÃ®ng-Ã¡-liÃ¢u"},
  "æ——æ´¥":{old:"æ——å¾Œ", newPoj:"KÃ®-tin", oldPoj:"KÃ®-Äu"},
  "å‰é®":{old:"å‰é®", newPoj:"TsiÃ¢n-tÃ¬n", oldPoj:"TsiÃ¢n-tÃ¬n"},
  "å°æ¸¯":{old:"æ¸¯ä»”å¢˜", newPoj:"SiÃ³-kÃ¡ng", oldPoj:"KÃ¡ng-Ã¡ kÃ®nn"},
  "å¤§æ¨¹":{old:"å¤§æ¨¹è·¤", newPoj:"TuÄ-tshiÅ«", oldPoj:"TuÄ-tshiÅ«-kha"},
  "å¤§å¯®":{old:"å¤§è—”", newPoj:"TuÄ-liÃ¢u", oldPoj:"TuÄ-liÃ¢u"},
  "æ—åœ’":{old:"é ‚æ—ä»”é‚Š", newPoj:"LÃ®m-hnÌ‚g", oldPoj:"TÃ­ng-nÃ¢-Ã¡-pinn"},
  "å¤§ç¤¾":{old:"ä¸‰å¥¶å£‡", newPoj:"TuÄ-siÄ", oldPoj:"Sam-nÃ¡i-tuÃ¢nn"},
  "ä»æ­¦":{old:"ä»æ­¦åº„", newPoj:"JÃ®n-bÃº", oldPoj:"JÃ®n-bÃº-tsng"},
  "é³¥æ¾":{old:"é³¥æ¾è·¤", newPoj:"TsiÃ¡u-tshÃ®ng", oldPoj:"TsiÃ¡u-tshÃ®ng-kha"},
  "é³³å±±":{old:"ä¸‹åŸ¤é ­", newPoj:"HÅng-suann", oldPoj:"Ä’-pi-thÃ¢u"},
  "èŒ„è£":{old:"èŒ„è‹³è£ä»”", newPoj:"Ka-tiÄnn", oldPoj:"Ka-tang-tiÄnn-Ã¡"},
  "æ°¸å®‰":{old:"çƒæ¨¹æ—", newPoj:"Ãng-an", oldPoj:"Oo-tshiÅ«-nÃ¢"},
  "å½Œé™€":{old:"å½Œé™€æ¸¯", newPoj:"MÃ®-tÃ´", oldPoj:"BÃ®-lÃ´-kÃ¡ng"},
  "æ¢“å®˜":{old:"æ¢“å®˜", newPoj:"TsÃº-kuann", oldPoj:"TsÃº-kuann"},
  "æ¹–å…§":{old:"å¤§æ¹–", newPoj:"Ã”o-lÄi", oldPoj:"TuÄ-Ã´o"},
  "è·¯ç«¹":{old:"åŠè·¯ç«¹", newPoj:"LÅo-tik", oldPoj:"PuÃ nn-lÅo-tik"},
  "å²¡å±±":{old:"é˜¿å…¬åº—", newPoj:"Kong-san", oldPoj:"A-kong-tiÃ m"},
  "æ©‹é ­":{old:"æ©‹ä»”é ­", newPoj:"KiÃ´-thÃ¢u", oldPoj:"KiÃ´-Ã¡-thÃ¢u"},
  "é˜¿è“®":{old:"é˜¿å—¹ç¤¾", newPoj:"A-lian", oldPoj:"A-lian-siÄ"},
  "ç”°å¯®":{old:"ç”°è—”", newPoj:"TshÃ¢n-liÃ¢u", oldPoj:"TshÃ¢n-liÃ¢u"},
  "ç‡•å·¢":{old:"æ´å‰¿å³", newPoj:"IÃ n-tsÃ¢u", oldPoj:"UÄn-tsÃ¢u-iÅ«"},
  "å…§é–€":{old:"ç¾…æ¼¢å…§é–€", newPoj:"LÄi-bÃ»n", oldPoj:"LÃ´-hÃ n-lÄi-bÃ»n"},
  "æ——å±±":{old:"è•ƒè–¯è—”", newPoj:"KÃ®-san", oldPoj:"Han-tsÃ®-liÃ¢u"},
  "æ‰æ—":{old:"æ¥ æ¢“ä»™", newPoj:"Sam-nÃ¢", oldPoj:"LÃ¢m-tsÃº-sian"},
  "ç¾æ¿ƒ":{old:"ç€°æ¿ƒ", newPoj:"Bi-long", oldPoj:"BÃ®-long"},
  "ç”²ä»™":{old:"é˜¿é‡Œé—œ", newPoj:"Kah-sian", oldPoj:"A-lÃ­-kuan"},
  "å…­é¾œ":{old:"å…­é¾œé‡Œç¤¾", newPoj:"LaÌk-ku", oldPoj:"LaÌk-ku-lÃ­-siÄ"},
  "é‚£ç‘ªå¤":{old:"èšŠå­åª", newPoj:"Na-mÃ¡-siah", oldPoj:"Mangacun"},
  "æ¡ƒæº":{old:"é›…çˆ¾", newPoj:"ThÃ´-guÃ¢n", oldPoj:"Ngani"},
  "èŒ‚æ—":{old:"å¤šç´", newPoj:"BÅo-lÃ®m", oldPoj:"TÅ-na"}
};
const GROUP_COLOR={ core:"var(--core)", east:"var(--east)", north:"var(--north)", mountain:"var(--mountain)" };

let svgDoc=null, items=[], currentGroup="core";
const popup=$("#popup"), popNew=$("#pop-new"), popNewPoj=$("#pop-new-poj"), popOld=$("#pop-old"), popOldPoj=$("#pop-old-poj");
const btnNew=$("#btn-new"), btnOld=$("#btn-old");
const audioNew=new Audio(), audioOld=new Audio();

/* è¼‰å…¥ SVG å¾Œï¼šæŠ“æ‰€æœ‰ path/polygon/polylineï¼Œå¾ <title> or çˆ¶å±¤<title> å–ä¸­æ–‡åï¼Œä¸Šè‰²ä¸¦ç¶äº‹ä»¶ */
$("#svgMap").addEventListener("load",()=>{
  svgDoc=$("#svgMap").contentDocument;
  if(!svgDoc) return;

  const svgEl=svgDoc.querySelector("svg");
  try{
    if(svgEl && !svgEl.getAttribute("viewBox")){
      const b=svgEl.getBBox();
      svgEl.setAttribute("viewBox",`${b.x} ${b.y} ${b.width} ${b.height}`);
    }
  }catch(e){}
  if(svgEl){ svgEl.setAttribute("preserveAspectRatio","xMidYMid meet"); svgEl.setAttribute("width","100%"); svgEl.setAttribute("height","100%"); }

  items=[];
  const shapes = svgDoc.querySelectorAll("path, polygon, polyline");
  shapes.forEach(el=>{
    const raw = getNameFromShape(el);
    if(!raw) return;
    const nm = stripQu(raw);              // e.g. ã€Œå°æ¸¯å€ã€â†’ã€Œå°æ¸¯ã€
    if(!DATA[nm]) return;                 // åƒ…æ”¶éŒ„ 38 å€
    const group = Object.entries(GROUPS).find(([g,list])=>list.includes(nm))?.[0];
    if(!group) return;

    // åˆå§‹ä¸Šè‰²ï¼ˆå››è‰²åˆ†å€ï¼‰ï¼‹é‚Šç·š
    // ç”¨ style.fill å¯è¦†è“‹çˆ¶å±¤ <g fill="#ddd">
    el.style.fill = getComputedStyle(document.documentElement)
                    .getPropertyValue(GROUP_COLOR[group].replace('var','').replace(/[()]/g,'').trim()) || "";
    el.setAttribute("fill", GROUP_COLOR[group]);      // é›™ä¿éšª
    el.setAttribute("stroke", "#1f2937");
    el.setAttribute("stroke-width", "0.8");
    el.style.cursor="pointer";

    el.addEventListener("click",(evt)=>onDistrictClick(evt, {
      el, newName:nm, oldName:DATA[nm].old, newPoj:DATA[nm].newPoj, oldPoj:DATA[nm].oldPoj, group
    }));

    items.push({el, newName:nm, oldName:DATA[nm].old, newPoj:DATA[nm].newPoj, oldPoj:DATA[nm].oldPoj, group});
  });

  updateGroup(); // åˆå§‹é¡¯ç¤ºå››è‰²ï¼Œä¸”è®“éç•¶å‰ç¾¤çµ„æ·¡åŒ–
});

/* ç¾¤çµ„åˆ‡æ›ï¼šé¡è‰²ä¿ç•™ï¼Œéç•¶å‰ç¾¤çµ„åŠ  .dim */
function updateGroup(){
  items.forEach(d=>{
    d.el.classList.toggle("dim", d.group!==currentGroup);
    d.el.setAttribute("fill", GROUP_COLOR[d.group]); // å†ä¿éšªä¸€æ¬¡é¡è‰²
  });
  $$("#groupbar button").forEach(b=> b.classList.toggle("is-on", b.dataset.group===currentGroup));
}

/* è‡ªå‹•æ’­æ”¾ï¼šæ–° â†’ 0.6 ç§’ â†’ èˆŠ */
function autoPlaySequence(d){
  stopAll();
  const idx = GROUPS[d.group].indexOf(d.newName)+1;
  const prefix = String(idx).padStart(2,"0");
  const newSrc = "map_assets/"+prefix+d.newName+"_new.mp3";
  const oldSrc = "map_assets/"+prefix+d.oldName+"_old.mp3";
  audioNew.src = encodeURI(newSrc);
  audioOld.src = encodeURI(oldSrc);
  audioNew.onended = ()=> setTimeout(()=> audioOld.play().catch(()=>{}), 600);
  audioOld.onended = null;
  audioNew.play().catch(()=>{ /* éœé»˜å¤±æ•— */ });
}

/* é‡è½ï¼ˆå–®æ’­ï¼‰ */
function playNewOnly(d){
  stopAll();
  const idx = GROUPS[d.group].indexOf(d.newName)+1;
  const prefix = String(idx).padStart(2,"0");
  const src = "map_assets/"+prefix+d.newName+"_new.mp3";
  audioNew.onended=null; audioNew.src=encodeURI(src); audioNew.play().catch(()=>{});
}
function playOldOnly(d){
  stopAll();
  const idx = GROUPS[d.group].indexOf(d.newName)+1;
  const prefix = String(idx).padStart(2,"0");
  const src = "map_assets/"+prefix+d.oldName+"_old.mp3";
  audioOld.onended=null; audioOld.src=encodeURI(src); audioOld.play().catch(()=>{});
}
function stopAll(){ [audioNew,audioOld].forEach(a=>{try{a.pause();}catch{} a.currentTime=0;}); }

/* é»å€å¡Šï¼šé¡¯ç¤ºæµ®æ¡† + é–ƒå…‰è¨»è¨˜ + è‡ªå‹•æ’­æ”¾ */
function onDistrictClick(evt,d){
  d.el.classList.add("glow","flash");
  setTimeout(()=>d.el.classList.remove("glow"), 2000);

  $("#pop-new").textContent=d.newName;      $("#pop-new-poj").textContent=d.newPoj||"";
  $("#pop-old").textContent=d.oldName;      $("#pop-old-poj").textContent=d.oldPoj||"";

  $("#btn-new").onclick=()=>playNewOnly(d);
  $("#btn-old").onclick=()=>playOldOnly(d);

  const box=$("#mapbox").getBoundingClientRect();
  popup.style.display="block";
  const w=popup.offsetWidth, h=popup.offsetHeight;
  let left=evt.clientX - box.left + 10, top=evt.clientY - box.top + 10;
  if(left + w > box.width) left = box.width - w - 8;
  if(top + h > box.height) top = box.height - h - 8;
  if(left < 8) left = 8; if(top < 8) top = 8;
  popup.style.left=left+"px"; popup.style.top=top+"px";

  autoPlaySequence(d);
}

/* ä¸Šæ–¹ 4 é¡†æŒ‰éˆ•ï¼šåˆ‡æ›ç¾¤çµ„ï¼ˆåœ°åœ–å³æ™‚é€£å‹•ï¼‰ */
$$("#groupbar button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    currentGroup=btn.dataset.group; updateGroup();
    popup.style.display="none";
  });
});

/* é»åœ°åœ–å¤–é—œé–‰æµ®æ¡† */
document.addEventListener("click",(e)=>{
  if(!e.target.closest("#mapbox") || e.target.closest("#groupbar")) popup.style.display="none";
});
</script>
</body>
</html>
