<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>高雄 38 區地圖合併工具 v3（刪背景＋行動優先＋匯出含標籤層）</title>
<style>
  :root{--bg:#faf7f1;--ink:#222;--muted:#666;--chip:#eee}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,Arial}
  header{padding:12px 16px}
  h1{font-size:1.1rem;margin:0 0 6px 0}
  .sub{color:var(--muted);margin:0}
  .toolbar{padding:8px 12px;display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer}
  .stage{height:calc(100vh - 150px);min-height:520px;padding:0 12px 12px}
  .box{height:100%;background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.06);overflow:hidden;position:relative}
  svg{width:100%;height:100%;display:block}
  .legend{padding:0 12px 8px 12px;color:#444}
  .legend .chip{display:inline-block;margin-right:8px;margin-bottom:6px;padding:4px 8px;background:var(--chip);border:1px solid #ddd;border-radius:999px}
  .loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#666;font-size:.95rem;background:linear-gradient(180deg,#fff,transparent)}
</style>
</head>
<body>
<header>
  <h1>高雄 38 區地圖合併工具 v3</h1>
  <p class="sub">v3：徹底刪除大矩形背景、行動裝置優先全圖顯示、匯出含空白標籤層。</p>
</header>

<div class="toolbar">
  <button id="btnLoad" class="btn">重新載入 SVG</button>
  <button id="btnColor" class="btn">套用四群色系</button>
  <button id="btnReset" class="btn">重置位置</button>
  <button id="btnZoomFit" class="btn">適應視窗</button>
  <button id="btnZoomIn" class="btn">放大</button>
  <button id="btnZoomOut" class="btn">縮小</button>
  <button id="btnExport" class="btn">匯出乾淨 SVG（含 labelsLayer）</button>
</div>
<div class="legend">
  <span class="chip" style="background:#ffb3b3;border-color:#ffb3b3">市中心（暖紅）</span>
  <span class="chip" style="background:#d1b3ff;border-color:#d1b3ff">市郊–東（紫）</span>
  <span class="chip" style="background:#d4f5b3;border-color:#d4f5b3">市郊–北（黃綠）</span>
  <span class="chip" style="background:#b3e6e6;border-color:#b3e6e6">山區（藍綠）</span>
</div>

<div class="stage">
  <div class="box">
    <div id="loading" class="loading">載入地圖中…</div>
    <svg id="ed" viewBox="0 0 1143.062 1440.995" preserveAspectRatio="xMidYMid meet" aria-label="高雄市行政區地圖編輯器">
      <g id="base"></g>
      <g id="grp_center"></g>
      <g id="grp_east"></g>
      <g id="grp_north"></g>
      <g id="grp_mount"></g>
    </svg>
  </div>
</div>

<script>
/** ▼▼▼ 設定：你的 SVG 路徑（與本檔同層） ▼▼▼ **/
const SVG_URL = 'map_assets/Blank_Kaohsiung_map.svg';
/** ▲▲▲ 需要改路徑時，改這裡即可 ▲▲▲ **/

const groups = {
  center: ["楠梓","左營","鼓山","三民","鹽埕","前金","新興","苓雅","旗津","前鎮","小港"],
  east:   ["大樹","大寮","林園","大社","仁武","鳥松","鳳山"],
  north:  ["茄萣","永安","彌陀","梓官","湖內","路竹","岡山","橋頭","阿蓮","田寮","燕巢"],
  mount:  ["內門","旗山","杉林","美濃","甲仙","六龜","那瑪夏","桃源","茂林"]
};
const colors = { center:'#ffb3b3', east:'#d1b3ff', north:'#d4f5b3', mount:'#b3e6e6' };

const svg = document.getElementById('ed');
const base = document.getElementById('base');
const wrap = {
  center: document.getElementById('grp_center'),
  east:   document.getElementById('grp_east'),
  north:  document.getElementById('grp_north'),
  mount:  document.getElementById('grp_mount')
};
const loading = document.getElementById('loading');

function clearAllGroups(){
  [base, wrap.center, wrap.east, wrap.north, wrap.mount].forEach(g=>g.innerHTML='');
}

async function loadSVG(){
  clearAllGroups();
  loading.style.display='flex';
  try{
    const res = await fetch(SVG_URL, {mode:'cors'});
    const txt = await res.text();
    base.innerHTML = txt;
  }catch(e){
    base.innerHTML = '<text x="20" y="40" fill="#900">載入失敗：請確認 ' + SVG_URL + '</text>';
  }finally{
    loading.style.display='none';
  }
}

function removeBigBackgrounds(){
  // 以 viewBox 面積為基準，刪除 >25% 的 rect/path/polygon（無視 title）
  const vb = svg.viewBox.baseVal;
  const totalArea = vb.width * vb.height || 1;
  base.querySelectorAll('rect,path,polygon').forEach(el=>{
    try{
      const bb = el.getBBox();
      const area = bb.width * bb.height;
      if(area/totalArea > 0.25){
        el.parentNode && el.parentNode.removeChild(el);
      }
    }catch(_){}
  });
}

function distribute(){
  const cand = base.querySelectorAll('path,polygon,rect,g');
  const areas = Array.from(cand).filter(el=>{
    const t = el.querySelector && el.querySelector('title');
    return (t && t.textContent && t.textContent.trim()) || (el.id && el.id.trim());
  });
  areas.forEach(el=>{
    let titleText=''; try{const t=el.querySelector&&el.querySelector('title'); if(t) titleText=t.textContent.trim();}catch(_){}
    let name='';
    if(titleText){ const m=titleText.match(/^[\u4e00-\u9fff]+/); if(m&&m[0]) name=m[0].replace(/區$/,''); }
    if(!name) name=(el.id||'').replace(/^_+/,'');

    el.dataset.name = name;
    let target=null;
    if(groups.center.includes(name)) target=wrap.center;
    else if(groups.east.includes(name)) target=wrap.east;
    else if(groups.north.includes(name)) target=wrap.north;
    else if(groups.mount.includes(name)) target=wrap.mount;
    if(target) target.appendChild(el);
  });
  base.innerHTML = "";
}

function applyColors(){
  Object.entries(wrap).forEach(([k,g])=>{
    const fill = colors[k];
    g.querySelectorAll('path,polygon,rect').forEach(el=>{
      const curFill = (el.getAttribute('fill')||'').toLowerCase();
      if(!curFill || curFill==='none' || curFill==='#ffffff' || curFill==='white') el.setAttribute('fill', fill);
      el.setAttribute('stroke','#ffffff'); el.setAttribute('stroke-width','1');
    });
  });
}

let active=null, start={x:0,y:0}, cur={x:0,y:0};
function onDown(e){
  const tgt = e.target.closest('g[id^="grp_"]');
  if(!tgt) return;
  active = tgt;
  const t = active.getAttribute('transform') || 'translate(0,0)';
  const m = t.match(/translate\(([-\d\.]+)[ ,]([-\d\.]+)\)/);
  cur.x = m?parseFloat(m[1]):0;
  cur.y = m?parseFloat(m[2]):0;
  start.x = (e.touches?e.touches[0].clientX:e.clientX);
  start.y = (e.touches?e.touches[0].clientY:e.clientY);
  e.preventDefault();
}
function onMove(e){
  if(!active) return;
  const cx = (e.touches?e.touches[0].clientX:e.clientX);
  const cy = (e.touches?e.touches[0].clientY:e.clientY);
  const dx = cx - start.x, dy = cy - start.y;
  active.setAttribute('transform', `translate(${cur.x+dx}, ${cur.y+dy})`);
}
function onUp(){ active=null; }
svg.addEventListener('mousedown', onDown);
svg.addEventListener('touchstart', onDown, {passive:false});
window.addEventListener('mousemove', onMove);
window.addEventListener('touchmove', onMove, {passive:false});
window.addEventListener('mouseup', onUp);
window.addEventListener('touchend', onUp);

let view = {x:0,y:0,w:1143.062,h:1440.995};
function setView(v){ svg.setAttribute('viewBox', v.x+" "+v.y+" "+v.w+" "+v.h); }

function bboxOf(el){ try{ return el.getBBox(); }catch(_){ return null; } }
function unionBBox(a,b){
  if(!a) return b; if(!b) return a;
  const x = Math.min(a.x,b.x), y = Math.min(a.y,b.y);
  const r = Math.max(a.x+a.width, b.x+b.width);
  const bt= Math.max(a.y+a.height,b.y+b.height);
  return {x, y, width: r-x, height: bt-y};
}

function fitAll(){
  let bb=null;
  Object.values(wrap).forEach(g=>{
    const b=bboxOf(g);
    if(b && b.width>0 && b.height>0) bb=unionBBox(bb,b);
  });
  if(bb){
    const pad = 0.06; // 6% 留白
    let nx = bb.x - bb.width*pad;
    let ny = bb.y - bb.height*pad;
    let nw = bb.width * (1+2*pad);
    let nh = bb.height* (1+2*pad);

    // 行動裝置優先：若是橫式寬螢幕，再放大視窗盒（相當於縮小 0.85 倍以免裁切）
    const isLandscape = window.innerWidth > window.innerHeight;
    if(isLandscape) { nx -= bb.width*0.1; ny -= bb.height*0.1; nw *= 1.2; nh *= 1.2; }

    view = {x:nx,y:ny,w:nw,h:nh};
    setView(view);
  }else{
    view = {x:0,y:0,w:1143.062,h:1440.995};
    setView(view);
  }
}

function download(name, text){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type:'image/svg+xml'}));
  a.download = name; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

function exportSVG(){
  const clone = svg.cloneNode(true);

  // 清掉 base（已分發）
  const cbase = clone.querySelector('#base');
  if(cbase) cbase.remove();

  // 刪除空群組
  ['grp_center','grp_east','grp_north','grp_mount'].forEach(id=>{
    const g = clone.querySelector('#'+id);
    if(g && !g.querySelector('path,polygon,rect')) g.remove();
  });

  // 確保有空白標籤層（供日後放新/舊地名）
  if(!clone.querySelector('#labelsLayer')){
    const NS="http://www.w3.org/2000/svg";
    const layer = document.createElementNS(NS,'g');
    layer.setAttribute('id','labelsLayer');
    layer.setAttribute('data-purpose','place labels here');
    clone.appendChild(layer);
  }

  // 插入 title
  const title = document.createElementNS('http://www.w3.org/2000/svg','title');
  title.textContent = '高雄市 38 區空白地圖（合併版 v3，行動裝置優先，含 labelsLayer）';
  clone.insertBefore(title, clone.firstChild);

  download('kaohsiung_blank_merged.svg', new XMLSerializer().serializeToString(clone));
}

document.getElementById('btnZoomFit').addEventListener('click', fitAll);
document.getElementById('btnZoomIn').addEventListener('click', ()=>{ view.w/=1.2; view.h/=1.2; setView(view); });
document.getElementById('btnZoomOut').addEventListener('click', ()=>{ view.w*=1.2; view.h*=1.2; setView(view); });
document.getElementById('btnReset').addEventListener('click', ()=>{
  ['grp_center','grp_east','grp_north','grp_mount'].forEach(id=>document.getElementById(id).setAttribute('transform','translate(0,0)'));
  fitAll();
});
document.getElementById('btnExport').addEventListener('click', exportSVG);
document.getElementById('btnLoad').addEventListener('click', async ()=>{
  await loadSVG(); removeBigBackgrounds(); distribute(); applyColors(); fitAll();
});

(async function init(){
  await loadSVG();            // 抓 SVG
  removeBigBackgrounds();     // 刪除大矩形背景（>25%）
  distribute();               // 分發到四群
  applyColors();              // 上色（保留你指定的四群色系）
  fitAll();                   // 自動全圖顯示（行動優先）
})();
</script>
</body>
</html>
