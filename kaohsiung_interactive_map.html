<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é«˜é›„å¸‚äº’å‹•åœ°åœ–ï¼ˆè‡ºèª æ–°/èˆŠåœ°å - æµ®å‹•è³‡è¨Šç¤ºç¯„ï¼‰</title>
<style>
  :root{
    --map-max-width:1200px;
    --popup-bg: #ffffff;
    --popup-border: rgba(0,0,0,0.12);
    --shadow: 0 8px 24px rgba(0,0,0,0.12);
  }
  body{font-family:"Noto Sans TC", system-ui,-apple-system, "Helvetica Neue", Arial; margin:18px; display:flex; flex-direction:column; align-items:center; gap:16px; color:#222; background:#f5f6f8;}
  h1{margin:0; font-size:1.1rem}
  #mapWrapper{width:100%; max-width:var(--map-max-width); position:relative}
  #mapContainer{width:100%; aspect-ratio: 5/7; background:transparent; border-radius:6px; overflow:hidden; border:2px solid #111;}
  /* inline SVG will fill container */
  #mapContainer svg{width:100%; height:100%; display:block;}

  /* popup */
  .popup{
    position:absolute;
    min-width:220px;
    max-width:320px;
    background:var(--popup-bg);
    border:1px solid var(--popup-border);
    box-shadow:var(--shadow);
    padding:10px 12px;
    border-radius:8px;
    z-index:40;
    transform-origin: left top;
  }
  .popup h3{margin:0 0 6px 0; font-size:1rem}
  .popup p{margin:4px 0; color:#333; font-size:0.95rem}
  .popup .muted{color:#666; font-size:0.86rem}
  .popup .row{display:flex; gap:8px; align-items:center}
  .speaker{
    width:36px; height:36px; border-radius:6px; display:inline-flex; align-items:center; justify-content:center;
    background:#eee; color:#999; border:1px solid #ddd; cursor:default;
  }
  .speaker.disabled{opacity:.55}
  /* highlight style for selected area */
  .map-area { transition: filter .12s, opacity .12s, stroke-width .12s; cursor:pointer; }
  .map-area:hover{ filter:brightness(1.12); }
  .selected-area{ stroke:#000 !important; stroke-width:2 !important; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.15)); }

  /* legend */
  .legend{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
  .legend .item{display:flex; gap:6px; align-items:center; font-size:0.9rem}
  .sw{width:26px; height:14px; border-radius:3px; border:1px solid rgba(0,0,0,0.12)}

  @media (max-width:760px){
    #mapContainer{aspect-ratio: 4/6}
    .popup{min-width:180px}
  }
</style>
</head>
<body>
  <h1>é«˜é›„å¸‚äº’å‹•åœ°åœ–ï¼ˆç¤ºç¯„ï¼‰</h1>

  <div id="mapWrapper">
    <div id="mapContainer">è¼‰å…¥åœ°åœ–â€¦</div>

    <!-- popupï¼ˆåˆå§‹éš±è—ï¼‰ -->
    <div id="popup" class="popup" style="display:none;">
      <h3 id="popupTitle">åœ°å</h3>
      <p id="popupNew" class="muted">æ–°åœ°åï¼ˆè‡ºç¾…ï¼‰ï¼š</p>
      <p id="popupOld" class="muted">èˆŠåœ°åï¼ˆè‡ºç¾…ï¼‰ï¼š</p>
      <div class="row" style="margin-top:6px">
        <!-- å…©å€‹ç°è‰²å–‡å­ï¼ˆæš«ä¸é€£çµï¼‰ -->
        <div class="speaker disabled" title="æ–°åœ°åèªéŸ³ï¼ˆé ç•™ï¼‰">ğŸ”ˆ</div>
        <div style="font-size:0.9rem; color:#555">æ–°åœ°åèªéŸ³ï¼ˆé ç•™ï¼‰</div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="speaker disabled" title="èˆŠåœ°åèªéŸ³ï¼ˆé ç•™ï¼‰">ğŸ”ˆ</div>
        <div style="font-size:0.9rem; color:#555">èˆŠåœ°åèªéŸ³ï¼ˆé ç•™ï¼‰</div>
      </div>
    </div>
  </div>

  <div class="legend" aria-hidden="true" style="max-width:var(--map-max-width)">
    <div class="item"><span class="sw" style="background:linear-gradient(90deg,#ffb3a7,#ff6f61)"></span> å¸‚ä¸­å¿ƒï¼ˆæš–ç´…ï¼‰</div>
    <div class="item"><span class="sw" style="background:linear-gradient(90deg,#d3b8ff,#9c6ade)"></span> å¸‚éƒŠâ€“æ±ï¼ˆç´«ï¼‰</div>
    <div class="item"><span class="sw" style="background:linear-gradient(90deg,#c6e48b,#9acd32)"></span> å¸‚éƒŠâ€“åŒ—ï¼ˆé»ƒç¶ ï¼‰</div>
    <div class="item"><span class="sw" style="background:linear-gradient(90deg,#9ad9db,#2e8b57)"></span> å±±å€ï¼ˆè—ç¶ ï¼‰</div>
  </div>

<script>
/* -------------- è¨­å®šå€ -------------- */
/* æ‚¨æä¾›çš„ raw SVG URLï¼ˆè‹¥æ”¹ç‚ºç›¸å°è·¯å¾‘ï¼Œä¿®æ”¹é€™è£¡ï¼‰ */
const RAW_SVG_URL = 'https://raw.githubusercontent.com/tsong-su/iuhi/refs/heads/main/map_assets/Blank_Kaohsiung_map.svg';

/* å››ç¾¤åˆ†å€ï¼ˆå»æ‰ã€Œå€ã€å­—ï¼‰ */
const groups = {
  "å¸‚ä¸­å¿ƒ": ["æ¥ æ¢“","å·¦ç‡Ÿ","é¼“å±±","ä¸‰æ°‘","é¹½åŸ•","å‰é‡‘","æ–°èˆˆ","è‹“é›…","æ——æ´¥","å‰é®","å°æ¸¯"],
  "å¸‚éƒŠ-æ±": ["å¤§æ¨¹","å¤§å¯®","æ—åœ’","å¤§ç¤¾","ä»æ­¦","é³¥æ¾","é³³å±±"],
  "å¸‚éƒŠ-åŒ—": ["èŒ„è£","æ°¸å®‰","å½Œé™€","æ¢“å®˜","æ¹–å…§","è·¯ç«¹","å²¡å±±","æ©‹é ­","é˜¿è“®","ç”°å¯®","ç‡•å·¢"],
  "å±±å€": ["å…§é–€","æ——å±±","æ‰æ—","ç¾æ¿ƒ","ç”²ä»™","å…­é¾œ","é‚£ç‘ªå¤","æ¡ƒæº","èŒ‚æ—"]
};

/* å°æ‡‰ç¾¤çµ„çš„ä¸»è¦è‰²å¸¶ï¼ˆæœƒåœ¨æ¯ç¾¤å…§è‡ªå‹•å¾®èª¿ï¼‰ */
const groupPalettes = {
  "å¸‚ä¸­å¿ƒ": ["#FFB3A7","#FF8A78","#FF6F61"],
  "å¸‚éƒŠ-æ±": ["#D3B8FF","#B999FF","#9C6ADE"],
  "å¸‚éƒŠ-åŒ—": ["#C6E48B","#B5DA6C","#9ACD32"],
  "å±±å€": ["#9AD9DB","#5FC6B9","#2E8B57"]
};

/* èˆŠåœ°å & è‡ºç¾…å°ç…§è³‡æ–™ï¼ˆç¤ºç¯„ï¼šå…ˆå…§å»ºæ‚¨çµ¦çš„è³‡æ–™ï¼›å¯æ“´å……ï¼‰ */
const placeData = {
  /* å¸‚ä¸­å¿ƒ 11 */
  "æ¥ æ¢“": { new_tl: "LÃ¢m-tsÃº", old_tl: "LÃ¢m-Ã¡-khenn" },
  "å·¦ç‡Ÿ": { new_tl: "TsÃ³-iÃ¢nn", old_tl: "Hing-liÃ´ng-lÃ­" },
  "é¼“å±±": { new_tl: "KÃ³o-san", old_tl: "TÃ¡nn-kÃ³o-san" },
  "ä¸‰æ°‘": { new_tl: "Sam-bÃ®n", old_tl: "Sann-tÃ¨-tshÃ¹" },
  "é¹½åŸ•": { new_tl: "IÃ¢m-tiann", old_tl: "IÃ¢m-tiann-poo" },
  "å‰é‡‘": { new_tl: "TsiÃ¢n-kim", old_tl: "TsiÃ¢n-khim" },
  "æ–°èˆˆ": { new_tl: "Sin-hing", old_tl: "TÄi-kÃ¡ng-poo" },
  "è‹“é›…": { new_tl: "LÃ®ng-ngÃ¡", old_tl: "LÃ®ng-Ã¡-liÃ¢u" },
  "æ——æ´¥": { new_tl: "KÃ®-tin", old_tl: "KÃ®-Äu" },
  "å‰é®": { new_tl: "TsiÃ¢n-tÃ¬n", old_tl: "TsiÃ¢n-tÃ¬n" },
  "å°æ¸¯": { new_tl: "SiÃ³-kÃ¡ng", old_tl: "KÃ¡ng-Ã¡ kÃ®nn" },

  /* å¸‚éƒŠ-æ± 7 */
  "å¤§æ¨¹": { new_tl: "TuÄ-tshiÅ«", old_tl: "TuÄ-tshiÅ«-kha" },
  "å¤§å¯®": { new_tl: "TuÄ-liÃ¢u", old_tl: "TuÄ-liÃ¢u" },
  "æ—åœ’": { new_tl: "LÃ®m-hnÌ‚g", old_tl: "TÃ­ng-nÃ¢-Ã¡-pinn" },
  "å¤§ç¤¾": { new_tl: "TuÄ-siÄ", old_tl: "Sam-nÃ¡i-tuÃ¢nn" },
  "ä»æ­¦": { new_tl: "JÃ®n-bÃº", old_tl: "JÃ®n-bÃº-tÃ¬n" },
  "é³¥æ¾": { new_tl: "TsiÃ¡u-tshÃ¬ng", old_tl: "TsiÃ¡u-tshÃ¬ng-kha" },
  "é³³å±±": { new_tl: "HÅng-suann", old_tl: "Ä’-pi-thÃ¢u" },

  /* å¸‚éƒŠ-åŒ— 11 */
  "èŒ„è£": { new_tl: "Ka-tiÄnn", old_tl: "Ka-tang-tiÄnn-Ã¡" },
  "æ°¸å®‰": { new_tl: "Ãng-an", old_tl: "Oo-tshiÅ«-nÃ¢" },
  "å½Œé™€": { new_tl: "MÃ®-tÃ´", old_tl: "BÃ®-lÃ´-kÃ¡ng" },
  "æ¢“å®˜": { new_tl: "TsÃº-kuann", old_tl: "TsÃº-kuann" },
  "æ¹–å…§": { new_tl: "Ã”o-lÄi", old_tl: "TuÄ-Ã´o" },
  "è·¯ç«¹": { new_tl: "LÅo-tik", old_tl: "PuÃ nn-lÅo-tik" },
  "å²¡å±±": { new_tl: "Kong-san", old_tl: "A-kong-tiÃ m" },
  "æ©‹é ­": { new_tl: "KiÃ´-thÃ¢u", old_tl: "KiÃ´-Ã¡-thÃ¢u" },
  "é˜¿è“®": { new_tl: "A-lian", old_tl: "lian-siÄ" },
  "ç”°å¯®": { new_tl: "TshÃ¢n-liÃ¢u", old_tl: "TshÃ¢n-liÃ¢u" },
  "ç‡•å·¢": { new_tl: "IÃ n-tsÃ¢u", old_tl: "UÄn-tsÃ¢u-iÅ«" },

  /* å±±å€ 9 */
  "å…§é–€": { new_tl: "LÄi-bÃ»n", old_tl: "LÃ´-hÃ n-lÄi-bÃ»n" },
  "æ——å±±": { new_tl: "KÃ®-san", old_tl: "Han-tsÃ®-liÃ¢u" },
  "æ‰æ—": { new_tl: "Sam-nÃ¢", old_tl: "LÃ¢m-tsÃº-sian" },
  "ç¾æ¿ƒ": { new_tl: "Bi-long", old_tl: "BÃ®-long" },
  "ç”²ä»™": { new_tl: "Kah-sian", old_tl: "A-lÃ­-kuan" },
  "å…­é¾œ": { new_tl: "LaÌk-ku", old_tl: "LaÌk-ku-lÃ­-siÄ" },
  "é‚£ç‘ªå¤": { new_tl: "Na-mÃ¡-siah", old_tl: "Mangacun" },
  "æ¡ƒæº": { new_tl: "ThÃ´-guÃ¢n", old_tl: "Ngani" },
  "èŒ‚æ—": { new_tl: "BÅo-lÃ®m", old_tl: "TÅ«n-Ã¡" }
};

/* -------------- åŠ©æ‰‹å‡½å¼ -------------- */
/* è®“åŒä¸€ç¾¤å…§ä¸Šè‰²æ™‚æœ‰è®ŠåŒ– */
function pickColorFor(name){
  for(const groupName in groups){
    if(groups[groupName].includes(name)){
      const pal = groupPalettes[groupName];
      // ç°¡å–® hash name -> index
      let sum = 0; for(let i=0;i<name.length;i++) sum += name.charCodeAt(i);
      return pal[sum % pal.length];
    }
  }
  return '#e0e0e0';
}

/* æ“·å– title å…§çš„ä¸­æ–‡åœ°åä¸¦å»æ‰ã€Œå€ã€å­—ï¼ˆè‹¥æ²’æœ‰ä¸­æ–‡å‰‡å› idï¼‰ */
function parseTitleToName(titleText, id){
  if(!titleText) return id || 'æœªçŸ¥';
  // title ç¯„ä¾‹: "å°æ¸¯å€ Xiaogang District"
  // å–é–‹é ­é€£çºŒä¸­æ–‡å­—ï¼ˆå«ã€Œå€ã€ï¼‰ï¼Œæˆ–å– id é€€è£œ
  const m = titleText.match(/^[\u4e00-\u9fff]+/);
  if(m && m[0]){
    let s = m[0].replace(/å€$/, ''); // å»æ‰å°¾ç«¯ã€Œå€ã€
    return s;
  }
  // è‹¥æ²’ä¸­æ–‡ï¼Œç”¨ idï¼ˆä¸¦å»æ‰å¯èƒ½çš„ä¸‹åŠƒç·šï¼‰
  return (id || 'æœªçŸ¥').replace(/^_+/, '');
}

/* -------------- ä¸»æµç¨‹ï¼šè¼‰å…¥ SVG ä¸¦ç¶å®šäº’å‹• -------------- */
const container = document.getElementById('mapContainer');
const popup = document.getElementById('popup');
const popupTitle = document.getElementById('popupTitle');
const popupNew = document.getElementById('popupNew');
const popupOld = document.getElementById('popupOld');

let currentSelectedEl = null;

async function loadSVG(){
  try{
    const res = await fetch(RAW_SVG_URL);
    if(!res.ok) throw new Error('SVG è®€å–å¤±æ•—ï¼š' + res.status);
    const svgText = await res.text();

    // æŠŠ svg ç›´æ¥æ’å…¥ containerï¼ˆä»¥å…§è¯æ–¹å¼ï¼‰
    container.innerHTML = svgText;

    // æ‰¾åˆ° svg å…ƒç´ 
    const svgEl = container.querySelector('svg');
    if(!svgEl) throw new Error('SVG è£¡æ‰¾ä¸åˆ° <svg>');

    // æ‰¾æ‰€æœ‰ path / polygon / gï¼ˆè¦–æƒ…æ³ï¼‰
    const candidates = Array.from(svgEl.querySelectorAll('path, polygon, rect, g'));
    // éæ¿¾ï¼šåªæŒ‘æœ‰ title æˆ– id çš„å…ƒç´ ï¼ˆé€šå¸¸è¡Œæ”¿å€æœƒæœ‰ titleï¼‰
    const areas = candidates.filter(el => {
      const t = el.querySelector && el.querySelector('title');
      return ( (t && t.textContent && t.textContent.trim()) || (el.id && el.id.trim()) );
    });

    // è‹¥æ²’æŠ“åˆ°å°±é€€å›æŠ“æ‰€æœ‰ path
    const targetEls = areas.length ? areas : Array.from(svgEl.querySelectorAll('path'));

    // å°æ¯å€‹å€å¡Šè™•ç†ï¼šå¾ title å–ä¸­æ–‡åï¼ˆå»é™¤ã€Œå€ã€ï¼‰ã€ä¸Šè‰²ã€ç¶å®šäº‹ä»¶
    targetEls.forEach(el => {
      // å– title text å„ªå…ˆ
      let titleText = '';
      try{
        const tnode = el.querySelector && el.querySelector('title');
        if(tnode) titleText = tnode.textContent || '';
      }catch(e){ titleText = ''; }
      const id = el.id || '';
      const name = parseTitleToName(titleText, id);

      // å„²å­˜ display nameï¼ˆå»æ‰ã€Œå€ã€å­—ï¼‰
      el.dataset.displayName = name;

      // å¡«è‰²ï¼ˆè‹¥ SVG å…§å·²æœ‰å¡«è‰²ï¼Œä¿ç•™ï¼›å¦å‰‡å¥—ç”¨ç¾¤çµ„è‰²ï¼‰
      const curFill = el.getAttribute('fill');
      if(!curFill || curFill === 'none' || curFill === '#ffffff' || curFill.toLowerCase() === 'white'){
        const c = pickColorFor(name);
        el.setAttribute('fill', c);
      }
      // è¨­æé‚Šï¼ˆä¸­ç­‰ç²—ï¼‰
      el.setAttribute('stroke', '#111');
      el.setAttribute('stroke-width', '0.6');

      // è¨­ class
      el.classList.add('map-area');

      // åŠ ä¸Š titleï¼ˆéŠè¦½å™¨ tooltipï¼‰
      if(!(el.querySelector && el.querySelector('title'))){
        const t = document.createElementNS('http://www.w3.org/2000/svg','title');
        t.textContent = name;
        el.appendChild && el.appendChild(t);
      }

      // é»æ“Šäº‹ä»¶ï¼ˆé¡¯ç¤ºæµ®å‹•è³‡è¨Šï¼‰
      el.style.pointerEvents = 'auto';
      el.addEventListener('click', ev => {
        ev.stopPropagation();
        showPopupForElement(el, ev.clientX, ev.clientY);
      });

      // æ”¯æ´æ‰‹æ©Ÿè§¸æ§ï¼ˆtouchend è§¸ç™¼ clickï¼‰
      el.addEventListener('touchend', e => { e.preventDefault(); el.dispatchEvent(new Event('click')); });
    });

    // é»åœ°åœ–ç©ºç™½è™•å¯é—œé–‰ popup
    document.addEventListener('click', (e)=> {
      if(popup.style.display !== 'none'){
        popup.style.display = 'none';
        if(currentSelectedEl){
          currentSelectedEl.classList.remove('selected-area');
          currentSelectedEl = null;
        }
      }
    });

  }catch(err){
    container.innerHTML = '<div style="padding:12px;color:#900;background:#fff3f3;border-radius:8px">è¼‰å…¥ SVG å¤±æ•—ï¼š'+err.message+'</div>';
    console.error(err);
  }
}

/* é¡¯ç¤º popupï¼ˆæ ¹æ“šå…ƒç´ èˆ‡é»æ“Šä½ç½®ï¼‰ */
function showPopupForElement(el, clientX, clientY){
  // å…ˆæ¸…é™¤å‰ä¸€å€‹é¸å–æ¨£å¼
  if(currentSelectedEl) currentSelectedEl.classList.remove('selected-area');
  el.classList.add('selected-area');
  currentSelectedEl = el;

  const name = el.dataset.displayName || parseTitleToName((el.querySelector && el.querySelector('title') && el.querySelector('title').textContent) || '', el.id);
  popupTitle.textContent = name;

  // å– placeData è£¡çš„ç¾…é¦¬å­—ï¼ˆè‹¥ç„¡å‰‡é¡¯ç¤ºã€Œæœªå¡«ã€ï¼‰
  const pd = placeData[name] || {};
  popupNew.innerHTML = `<strong>æ–°åœ°åï¼ˆè‡ºç¾…ï¼‰</strong>: ${pd.new_tl || 'ï¼ˆå°šæœªæä¾›ï¼‰'}`;
  popupOld.innerHTML = `<strong>èˆŠåœ°åï¼ˆè‡ºç¾…ï¼‰</strong>: ${pd.old_tl || 'ï¼ˆå°šæœªæä¾›ï¼‰'}`;

  // popup ä½ç½®ï¼šä»¥ mapWrapper ç‚ºåŸºæº–ï¼Œé¿å…è¶…å‡ºé‚Šç•Œ
  const wrapperRect = document.getElementById('mapWrapper').getBoundingClientRect();
  const popupRectApprox = { width: 300, height: 160 }; // ä¼°ç®—ï¼ŒCSS æœƒè‡ªé©
  // è¨ˆç®—é è¨­ x,yï¼ˆåœ¨ wrapper å…§ï¼‰
  let x = clientX - wrapperRect.left + 8;
  let y = clientY - wrapperRect.top + 8;

  // è‹¥æœƒè¶…å‡ºå³é‚Šï¼Œæ”¹åˆ°å·¦å´
  if(x + popupRectApprox.width > wrapperRect.width) x = Math.max(8, clientX - wrapperRect.left - popupRectApprox.width - 8);
  // è‹¥æœƒè¶…å‡ºä¸‹æ–¹ï¼Œå¾€ä¸Šç§»
  if(y + popupRectApprox.height > wrapperRect.height) y = Math.max(8, clientY - wrapperRect.top - popupRectApprox.height - 8);

  popup.style.left = x + 'px';
  popup.style.top = y + 'px';
  popup.style.display = 'block';

  // æ³¨æ„ï¼šç›®å‰å–‡å­æŒ‰éˆ•ç‚ºä½”ä½ï¼ˆç°è‰² disabledï¼‰ï¼Œè‹¥æ‚¨æœªä¾†æ”¾éŸ³æª”ï¼Œå¯æ”¹ç‚ºå¯é»æ“Šç‹€æ…‹
}

/* å•Ÿå‹• */
loadSVG();
</script>
</body>
</html>
