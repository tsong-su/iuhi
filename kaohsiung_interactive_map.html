<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>高雄市38區新舊地名互動地圖 v6.6</title>
<style>
  :root{
    --core:#3A7BD5;      /* 市中心 */
    --east:#56ab2f;      /* 市郊-東區 */
    --north:#ff9966;     /* 市郊-北區 */
    --mountain:#6a83f7;  /* 山區（鮮豔藍紫） */

    --ink:#0f172a; --card:#fff; --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:"Noto Sans TC",system-ui,"Microsoft JhengHei",sans-serif;background:#f6f7f9;color:var(--ink);text-align:center}
  h1{margin:10px 0 6px;font-size:1.5rem;font-weight:800}
  .notice{margin:2px 0;color:#444}

  /* 上方 4 顆群組按鈕：手機一列可滑動，確保不被切掉 */
  .groupbar{
    display:flex; gap:10px; justify-content:flex-start;
    margin:10px auto; padding:0 12px 0 12px; max-width:980px;
    overflow-x:auto; white-space:nowrap; scrollbar-width:none; -ms-overflow-style:none;
    scroll-padding-right:20px;
  }
  .groupbar::-webkit-scrollbar{display:none}
  .groupbar button{
    position:relative; border:0; border-radius:14px; padding:10px 22px;
    font-size:1rem; color:#fff; cursor:pointer; flex:0 0 auto; white-space:nowrap;
    box-shadow:0 4px 10px rgba(0,0,0,.25); transition:filter .2s, transform .02s;
  }
  .groupbar button:hover{filter:brightness(1.08)} .groupbar button:active{transform:translateY(1px)}
  .groupbar button.is-on{outline:2px solid #fff}
  .btn-core{background:linear-gradient(145deg,#3A7BD5,#00d2ff)}
  .btn-east{background:linear-gradient(145deg,#56ab2f,#a8e063)}
  .btn-north{background:linear-gradient(145deg,#ff9966,#ff5e62)}
  .btn-mount{background:linear-gradient(145deg,#6a83f7,#9aa8ff)}
  .badge{
    position:absolute;top:-6px;right:-8px;border-radius:999px;min-width:22px;height:22px;padding:0 6px;
    display:inline-flex;align-items:center;justify-content:center;font-size:.78rem;font-weight:700;color:#000;box-shadow:0 2px 6px rgba(0,0,0,.28);
    background:rgba(255,255,255,.92)
  }
  .btn-core  .badge{background:#a9d4ff}
  .btn-east  .badge{background:#c9f7b6}
  .btn-north .badge{background:#ffd1b8}
  .btn-mount .badge{background:#dcd9ff}

  /* 地圖容器 */
  #mapbox{
    width:100%; max-width:980px; margin:0 auto; aspect-ratio:1/1;
    position:relative; background:#fff; border-radius:14px; border:1px solid var(--border);
    box-shadow:0 8px 18px rgba(0,0,0,.06); overflow:hidden;
  }
  object{width:100%;height:100%}

  /* 非當前群組的淡化 */
  .dim{opacity:.35; transition:opacity .25s ease}

  /* 點選區塊的閃光註記（邊框加粗 + 白色光暈） */
  @keyframes glow {0%{filter:drop-shadow(0 0 0 rgba(255,255,255,0))}
    30%{filter:drop-shadow(0 0 6px rgba(255,255,255,.9))}
    60%{filter:drop-shadow(0 0 10px rgba(255,255,255,1))}
    100%{filter:drop-shadow(0 0 0 rgba(255,255,255,0))}}
  .glow{animation:glow 1.6s ease; stroke:#111; stroke-width:1.8 !important}
  .flash{animation:flash .8s ease} @keyframes flash{0%{fill-opacity:.5}100%{fill-opacity:1}}

  /* 浮框：縮小、手機最優先 */
  .popup{
    position:absolute; display:none; min-width:190px; max-width:min(300px, 85%);
    background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.08);
    box-shadow:0 10px 28px rgba(0,0,0,.18); padding:10px; z-index:60
  }
  .popup h3{margin:0 0 4px; font-size:1.02rem}
  .newP{color:#00796b;font-weight:800} .old{color:#374151;margin-top:4px} .oldP{color:#6a1b9a}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{padding:6px 10px;border-radius:10px;border:0;color:#fff;cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,.22)}
  .btn.play{background:linear-gradient(145deg,#42a5f5,#0d47a1)}
  .btn.old {background:linear-gradient(145deg,#ff8a65,#d84315)}
  @media (max-width:600px){
    .popup{min-width:170px; padding:8px}
    .popup h3{font-size:1rem}
    .row .btn{padding:6px 10px; font-size:.92rem}
  }

  footer{padding:14px 0}
  footer a{display:inline-block;text-decoration:none;color:#fff;background:linear-gradient(145deg,#4CAF50,#2e7d32);padding:8px 16px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.22)}
</style>
</head>
<body>
  <h1>高雄市38區新舊地名互動地圖</h1>
  <p class="notice">📱 建議直式觀看效果最佳</p>
  <p class="notice">👆 點行政區看新舊地名並播放音檔</p>

  <div class="groupbar" id="groupbar">
    <button class="btn-core is-on"  data-group="core">市中心區<span class="badge">11</span></button>
    <button class="btn-east"         data-group="east">市郊區–東區<span class="badge">7</span></button>
    <button class="btn-north"        data-group="north">市郊區–北區<span class="badge">11</span></button>
    <button class="btn-mount"        data-group="mountain">山區<span class="badge">9</span></button>
  </div>

  <div id="mapbox">
    <object id="svgMap" data="map_assets/Blank_Kaohsiung_map.svg" type="image/svg+xml" aria-label="Kaohsiung Map"></object>

    <!-- 浮框（資料＋重聽按鈕） -->
    <div class="popup" id="popup">
      <h3 id="pop-new">—</h3>
      <div class="newP" id="pop-new-poj">—</div>
      <div class="old"  id="pop-old">—</div>
      <div class="oldP" id="pop-old-poj">—</div>
      <div class="row">
        <button class="btn play" id="btn-new">播放新地名</button>
        <button class="btn old"  id="btn-old">播放舊地名</button>
      </div>
    </div>
  </div>

  <footer>
    <a href="https://tsong-su.github.io/iuhi/index.html">🏠 回遊戲首頁</a>
  </footer>

<script>
/* 小工具 */
const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>Array.from(e.querySelectorAll(s));
function stripQu(s){return (s||"").replace(/區$/,'');}
function zhFromAny(t){const m=(t||'').match(/[\u4E00-\u9FFF]+/g); return m? m.join(''): '';}
function getNameFromPath(el){
  // 1) 自身包含 <title> 2) 父層 <g> 的 <title> 3) 自身 id / label
  const selfTitle = el.querySelector && el.querySelector('title');
  if(selfTitle && selfTitle.textContent) return zhFromAny(selfTitle.textContent.trim());
  const parentTitle = el.parentNode && el.parentNode.querySelector && el.parentNode.querySelector('title');
  if(parentTitle && parentTitle.textContent) return zhFromAny(parentTitle.textContent.trim());
  const idName = el.getAttribute('data-name') || el.getAttribute('inkscape:label') || el.getAttribute('id') || '';
  return zhFromAny(idName);
}

/* 群組／資料（你確認的 38 區表；不改動） */
const GROUPS={
  core:["楠梓","左營","鼓山","三民","鹽埕","前金","新興","苓雅","旗津","前鎮","小港"],
  east:["大樹","大寮","林園","大社","仁武","鳥松","鳳山"],
  north:["茄萣","永安","彌陀","梓官","湖內","路竹","岡山","橋頭","阿蓮","田寮","燕巢"],
  mountain:["內門","旗山","杉林","美濃","甲仙","六龜","那瑪夏","桃源","茂林"]
};
const DATA={
  "楠梓":{old:"楠仔坑", newPoj:"Lâm-tsú", oldPoj:"Lâm-á-khenn"},
  "左營":{old:"埤仔頭", newPoj:"Tsó-iânn", oldPoj:"Pi-á-thâu"},
  "鼓山":{old:"打鼓山", newPoj:"Kóo-san", oldPoj:"Tánn-kóo-san"},
  "三民":{old:"三塊厝", newPoj:"Sam-bîn", oldPoj:"Sann-tè-tshù"},
  "鹽埕":{old:"鹽埕埔", newPoj:"Iâm-tiânn", oldPoj:"Iâm-tiânn-poo"},
  "前金":{old:"前衿", newPoj:"Tsiân-kim", oldPoj:"Tsiân-khim"},
  "新興":{old:"逮港埔", newPoj:"Sin-hing", oldPoj:"Tāi-káng-poo"},
  "苓雅":{old:"笭仔寮", newPoj:"Lîng-ngá", oldPoj:"Lîng-á-liâu"},
  "旗津":{old:"旗後", newPoj:"Kî-tin", oldPoj:"Kî-āu"},
  "前鎮":{old:"前鎮", newPoj:"Tsiân-tìn", oldPoj:"Tsiân-tìn"},
  "小港":{old:"港仔墘", newPoj:"Sió-káng", oldPoj:"Káng-á kînn"},
  "大樹":{old:"大樹跤", newPoj:"Tuā-tshiū", oldPoj:"Tuā-tshiū-kha"},
  "大寮":{old:"大藔", newPoj:"Tuā-liâu", oldPoj:"Tuā-liâu"},
  "林園":{old:"頂林仔邊", newPoj:"Lîm-hn̂g", oldPoj:"Tíng-nâ-á-pinn"},
  "大社":{old:"三奶壇", newPoj:"Tuā-siā", oldPoj:"Sam-nái-tuânn"},
  "仁武":{old:"仁武庄", newPoj:"Jîn-bú", oldPoj:"Jîn-bú-tsng"},
  "鳥松":{old:"鳥松跤", newPoj:"Tsiáu-tshîng", oldPoj:"Tsiáu-tshîng-kha"},
  "鳳山":{old:"下埤頭", newPoj:"Hōng-suann", oldPoj:"Ē-pi-thâu"},
  "茄萣":{old:"茄苳萣仔", newPoj:"Ka-tiānn", oldPoj:"Ka-tang-tiānn-á"},
  "永安":{old:"烏樹林", newPoj:"Íng-an", oldPoj:"Oo-tshiū-nâ"},
  "彌陀":{old:"彌陀港", newPoj:"Mî-tô", oldPoj:"Bî-lô-káng"},
  "梓官":{old:"梓官", newPoj:"Tsú-kuann", oldPoj:"Tsú-kuann"},
  "湖內":{old:"大湖", newPoj:"Ôo-lāi", oldPoj:"Tuā-ôo"},
  "路竹":{old:"半路竹", newPoj:"Lōo-tik", oldPoj:"Puànn-lōo-tik"},
  "岡山":{old:"阿公店", newPoj:"Kong-san", oldPoj:"A-kong-tiàm"},
  "橋頭":{old:"橋仔頭", newPoj:"Kiô-thâu", oldPoj:"Kiô-á-thâu"},
  "阿蓮":{old:"阿嗹社", newPoj:"A-lian", oldPoj:"A-lian-siā"},
  "田寮":{old:"田藔", newPoj:"Tshân-liâu", oldPoj:"Tshân-liâu"},
  "燕巢":{old:"援剿右", newPoj:"Iàn-tsâu", oldPoj:"Uān-tsâu-iū"},
  "內門":{old:"羅漢內門", newPoj:"Lāi-bûn", oldPoj:"Lô-hàn-lāi-bûn"},
  "旗山":{old:"蕃薯藔", newPoj:"Kî-san", oldPoj:"Han-tsî-liâu"},
  "杉林":{old:"楠梓仙", newPoj:"Sam-nâ", oldPoj:"Lâm-tsú-sian"},
  "美濃":{old:"瀰濃", newPoj:"Bi-long", oldPoj:"Bî-long"},
  "甲仙":{old:"阿里關", newPoj:"Kah-sian", oldPoj:"A-lí-kuan"},
  "六龜":{old:"六龜里社", newPoj:"La̍k-ku", oldPoj:"La̍k-ku-lí-siā"},
  "那瑪夏":{old:"蚊子只", newPoj:"Na-má-siah", oldPoj:"Mangacun"},
  "桃源":{old:"雅爾", newPoj:"Thô-guân", oldPoj:"Ngani"},
  "茂林":{old:"多納", newPoj:"Bōo-lîm", oldPoj:"Tō-na"}
};
const GROUP_COLOR={ core:"var(--core)", east:"var(--east)", north:"var(--north)", mountain:"var(--mountain)" };

let svgDoc=null, items=[], currentGroup="core";
const popup=$("#popup"), popNew=$("#pop-new"), popNewPoj=$("#pop-new-poj"), popOld=$("#pop-old"), popOldPoj=$("#pop-old-poj");
const btnNew=$("#btn-new"), btnOld=$("#btn-old");
const audioNew=new Audio(), audioOld=new Audio();

/* 載入 SVG 後：抓所有 path（不只限有 id），從 title 或父層 title 取區名，正確上色並綁事件 */
$("#svgMap").addEventListener("load",()=>{
  svgDoc=$("#svgMap").contentDocument;
  if(!svgDoc) return;

  const svgEl=svgDoc.querySelector("svg");
  try{
    if(svgEl && !svgEl.getAttribute("viewBox")){
      const b=svgEl.getBBox();
      svgEl.setAttribute("viewBox",`${b.x} ${b.y} ${b.width} ${b.height}`);
    }
  }catch(e){}
  if(svgEl){ svgEl.setAttribute("preserveAspectRatio","xMidYMid meet"); svgEl.setAttribute("width","100%"); svgEl.setAttribute("height","100%"); }

  items=[];
  $$("path", svgDoc).forEach(el=>{
    const rawName = getNameFromPath(el);
    if(!rawName) return;
    const nm=stripQu(rawName);
    if(!DATA[nm]) return; // 僅收錄 38 區
    const group = Object.entries(GROUPS).find(([g,list])=>list.includes(nm))?.[0];
    if(!group) return;

    // 初始上色（四色分區）＋邊線
    el.setAttribute("fill", GROUP_COLOR[group]);
    el.setAttribute("stroke", "#1f2937");
    el.setAttribute("stroke-width", "0.8");
    el.style.cursor="pointer";

    el.addEventListener("click",(evt)=>onDistrictClick(evt, {
      el, newName:nm, oldName:DATA[nm].old, newPoj:DATA[nm].newPoj, oldPoj:DATA[nm].oldPoj, group
    }));

    items.push({el, newName:nm, oldName:DATA[nm].old, newPoj:DATA[nm].newPoj, oldPoj:DATA[nm].oldPoj, group});
  });

  // 初始即顯示四色分區；同時讓非當前群組淡化
  updateGroup();
});

/* 群組切換：顏色保留，非當前群組僅「淡化」 */
function updateGroup(){
  items.forEach(d=>{
    // 保持本群組原色，其他群組加上 .dim
    d.el.classList.toggle("dim", d.group!==currentGroup);
    // 再次確保 fill 是正確群組色（避免外部樣式覆蓋）
    d.el.setAttribute("fill", GROUP_COLOR[d.group]);
  });
  $$("#groupbar button").forEach(b=> b.classList.toggle("is-on", b.dataset.group===currentGroup));
}

/* 自動播放：新 → 0.6 秒 → 舊 */
function autoPlaySequence(d){
  stopAll();
  const idx = GROUPS[d.group].indexOf(d.newName)+1;
  const prefix = String(idx).padStart(2,"0");
  const newSrc = "map_assets/"+prefix+d.newName+"_new.mp3";
  const oldSrc = "map_assets/"+prefix+d.oldName+"_old.mp3";
  audioNew.src = encodeURI(newSrc);
  audioOld.src = encodeURI(oldSrc);
  audioNew.onended = ()=> setTimeout(()=> audioOld.play().catch(()=>{}), 600);
  audioOld.onended = null;
  audioNew.play().catch(()=>{ console.warn("無法播放新名：", newSrc); });
}

/* 重聽（單播） */
function playNewOnly(d){
  stopAll();
  const idx = GROUPS[d.group].indexOf(d.newName)+1;
  const prefix = String(idx).padStart(2,"0");
  const src = "map_assets/"+prefix+d.newName+"_new.mp3";
  audioNew.onended=null; audioNew.src=encodeURI(src); audioNew.play().catch(()=>{});
}
function playOldOnly(d){
  stopAll();
  const idx = GROUPS[d.group].indexOf(d.newName)+1;
  const prefix = String(idx).padStart(2,"0");
  const src = "map_assets/"+prefix+d.oldName+"_old.mp3";
  audioOld.onended=null; audioOld.src=encodeURI(src); audioOld.play().catch(()=>{});
}
function stopAll(){ [audioNew,audioOld].forEach(a=>{try{a.pause();}catch{} a.currentTime=0;}); }

/* 點區塊：顯示浮框 + 閃光註記 + 自動播放 */
function onDistrictClick(evt,d){
  d.el.classList.add("glow","flash");
  setTimeout(()=>d.el.classList.remove("glow"), 2000);

  $("#pop-new").textContent=d.newName;      $("#pop-new-poj").textContent=d.newPoj||"";
  $("#pop-old").textContent=d.oldName;      $("#pop-old-poj").textContent=d.oldPoj||"";

  $("#btn-new").onclick=()=>playNewOnly(d);
  $("#btn-old").onclick=()=>playOldOnly(d);

  const box=$("#mapbox").getBoundingClientRect();
  popup.style.display="block";
  const w=popup.offsetWidth, h=popup.offsetHeight;
  let left=evt.clientX - box.left + 10, top=evt.clientY - box.top + 10;
  if(left + w > box.width) left = box.width - w - 8;
  if(top + h > box.height) top = box.height - h - 8;
  if(left < 8) left = 8; if(top < 8) top = 8;
  popup.style.left=left+"px"; popup.style.top=top+"px";

  autoPlaySequence(d); // 自動播放 新→0.6→舊
}

/* 上方 4 顆按鈕：切換群組（地圖即時連動） */
$$("#groupbar button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    currentGroup=btn.dataset.group; updateGroup();
    popup.style.display="none";
    // 確保最後一顆「山區」在手機不被切掉
    btn.scrollIntoView({inline:"nearest", behavior:"smooth", block:"nearest"});
  });
});

/* 點地圖外關閉浮框 */
document.addEventListener("click",(e)=>{
  if(!e.target.closest("#mapbox") || e.target.closest("#groupbar")) popup.style.display="none";
});
</script>
</body>
</html>
