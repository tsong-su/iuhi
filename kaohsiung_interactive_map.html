<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>高雄市38區新舊地名互動地圖 — 合併視覺版 (v2)</title>
<style>
  :root{ --bg:#f9f6ef; --title-color:#222; --new-color:#c0392b; --old-color:#555;
         --label-font:"Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,Arial; }
  html,body{height:100%;margin:0;background:var(--bg);font-family:var(--label-font);color:var(--title-color)}
  .page{display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px;box-sizing:border-box}
  h1{margin:8px 0 0 0;font-size:1.25rem;text-align:center}
  .subtitle{margin:0;font-size:.95rem;color:#666;text-align:center}

  .toolbar{margin:8px 0;display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center}
  .toolbar button{padding:6px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}

  .map-stage{width:100%;max-width:980px;height:calc(100vh - 210px);max-height:1200px;background:transparent;border-radius:10px;overflow:hidden;position:relative;box-shadow:0 8px 20px rgba(0,0,0,.06);}
  #svgHost{width:100%;height:100%;}
  #svgHost svg{width:100%;height:100%;display:block;}

  /* HTML overlay 標籤（避免左上偏移） */
  #labelsLayer{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none;z-index:30}
  .label{position:absolute;transform:translate(-50%,-50%);text-align:center;white-space:nowrap;pointer-events:none;line-height:1.05;}
  .label .new{font-weight:700;color:var(--new-color);font-size:13px;text-shadow:0 1px 0 rgba(255,255,255,.2);}
  .label .old{font-weight:400;color:var(--old-color);font-size:13px;margin-top:2px;text-shadow:0 1px 0 rgba(255,255,255,.2);}

  .popup{position:absolute;display:none;min-width:220px;max-width:320px;background:#fff;border-radius:10px;box-shadow:0 8px 28px rgba(0,0,0,.18);border:1px solid rgba(0,0,0,.08);padding:10px 12px;z-index:60;}
  .popup h3{margin:0 0 6px 0;font-size:1rem}
  .muted{color:#666;font-size:.95rem}
  .audioRow{display:flex;gap:10px;margin-top:8px}
  .audioBtn{background:#ddd;border-radius:8px;padding:8px 10px;border:none;color:#666;cursor:not-allowed}

  .note{margin-top:6px;color:#555;font-size:.90rem;text-align:center}
  @media (max-width:640px){ .map-stage{height:calc(100vh - 170px);} .label .new,.label .old{font-size:14px} .popup{min-width:72%;left:14%!important;right:auto} }
</style>
</head>
<body>
  <div class="page">
    <h1>高雄市38區新舊地名互動地圖 — 合併視覺版</h1>
    <div class="subtitle">📱 建議直式觀看效果最佳</div>

    <div class="toolbar">
      <button id="mergeBtn">啟用合併視覺模式</button>
      <span style="color:#666;font-size:.9rem">（將四大群塊自動收攏、拼成一張完整地圖；僅視覺位移，不更動資料）</span>
    </div>

    <div class="map-stage" id="stage">
      <div id="svgHost">
        <!-- 方式 A（建議）：自動抓取你現有的 SVG -->
        <!-- 若要100%離線：把 SVG 原始碼貼進下方 <div id="inlineSvg"> 裡，程式會優先採用 -->
      </div>
      <div id="inlineSvg" style="display:none;">
        <!-- 將修好的 Blank_Kaohsiung_map.svg 的 <svg>…</svg> 全部貼到這裡，就會「真正」內嵌 -->
      </div>

      <div id="labelsLayer"></div>

      <div id="popup" class="popup" role="dialog" aria-live="polite">
        <h3 id="popupNew">新地名</h3>
        <div id="popupOld" class="muted">舊地名</div>
        <div class="audioRow">
          <button class="audioBtn" id="btnNew">🔈 新地名（預留）</button>
          <button class="audioBtn" id="btnOld">🔈 舊地名（預留）</button>
        </div>
      </div>
    </div>

    <div class="note">※ 已以四群色系上色並內嵌處理。合併視覺模式會把四群自動靠攏，標籤用畫面座標定位避免左上偏移。</div>
  </div>

<script>
/* —— 你的 SVG 路徑（與 HTML 同層）：若 inlineSvg 沒貼，就用這個載入 —— */
const SVG_URL = 'map_assets/Blank_Kaohsiung_map.svg';

/* —— 四群與顏色 —— */
const groups = {
  center: ["楠梓","左營","鼓山","三民","鹽埕","前金","新興","苓雅","旗津","前鎮","小港"],
  east:   ["大樹","大寮","林園","大社","仁武","鳥松","鳳山"],
  north:  ["茄萣","永安","彌陀","梓官","湖內","路竹","岡山","橋頭","阿蓮","田寮","燕巢"],
  mount:  ["內門","旗山","杉林","美濃","甲仙","六龜","那瑪夏","桃源","茂林"]
};
const groupColor = { center:'#ffb3b3', east:'#d1b3ff', north:'#d4f5b3', mount:'#b3e6e6' };

/* —— 每區新/舊（中文） —— */
const placeData = {
  "楠梓": { new_ch:"楠梓", old_ch:"楠仔坑" },
  "左營": { new_ch:"左營", old_ch:"興隆里" },
  "鼓山": { new_ch:"鼓山", old_ch:"打狗山" },
  "三民": { new_ch:"三民", old_ch:"三塊厝" },
  "鹽埕": { new_ch:"鹽埕", old_ch:"鹽埕埔" },
  "前金": { new_ch:"前金", old_ch:"前衿" },
  "新興": { new_ch:"新興", old_ch:"逮港埔" },
  "苓雅": { new_ch:"苓雅", old_ch:"笭仔寮" },
  "旗津": { new_ch:"旗津", old_ch:"旗後" },
  "前鎮": { new_ch:"前鎮", old_ch:"前鎮" },
  "小港": { new_ch:"小港", old_ch:"港仔墘" },

  "大樹": { new_ch:"大樹", old_ch:"大樹跤" },
  "大寮": { new_ch:"大寮", old_ch:"大藔" },
  "林園": { new_ch:"林園", old_ch:"頂林仔邊" },
  "大社": { new_ch:"大社", old_ch:"三奶壇" },
  "仁武": { new_ch:"仁武", old_ch:"仁武鎮" },
  "鳥松": { new_ch:"鳥松", old_ch:"鳥松跤" },
  "鳳山": { new_ch:"鳳山", old_ch:"下埤頭" },

  "茄萣": { new_ch:"茄萣", old_ch:"茄苳萣仔" },
  "永安": { new_ch:"永安", old_ch:"烏樹林" },
  "彌陀": { new_ch:"彌陀", old_ch:"彌陀港" },
  "梓官": { new_ch:"梓官", old_ch:"梓官" },
  "湖內": { new_ch:"湖內", old_ch:"大湖" },
  "路竹": { new_ch:"路竹", old_ch:"半路竹" },
  "岡山": { new_ch:"岡山", old_ch:"阿公店" },
  "橋頭": { new_ch:"橋頭", old_ch:"橋仔頭" },
  "阿蓮": { new_ch:"阿蓮", old_ch:"阿嗹社" },
  "田寮": { new_ch:"田寮", old_ch:"田藔" },
  "燕巢": { new_ch:"燕巢", old_ch:"援剿右" },

  "內門": { new_ch:"內門", old_ch:"羅漢內門" },
  "旗山": { new_ch:"旗山", old_ch:"蕃薯藔" },
  "杉林": { new_ch:"杉林", old_ch:"楠梓仙" },
  "美濃": { new_ch:"美濃", old_ch:"瀰濃" },
  "甲仙": { new_ch:"甲仙", old_ch:"阿里關" },
  "六龜": { new_ch:"六龜", old_ch:"六龜里社" },
  "那瑪夏": { new_ch:"那瑪夏", old_ch:"蚊子只" },
  "桃源": { new_ch:"桃源", old_ch:"雅爾" },
  "茂林": { new_ch:"茂林", old_ch:"屯仔" }
};

function findGroup(name){ for(const k in groups) if(groups[k].includes(name)) return k; return null; }

const labelsLayer = document.getElementById('labelsLayer');
const stage = document.getElementById('stage');
const popup = document.getElementById('popup');
const popupNew = document.getElementById('popupNew');
const popupOld = document.getElementById('popupOld');
const mergeBtn = document.getElementById('mergeBtn');

async function loadSVGIntoHost(){
  const inline = document.querySelector('#inlineSvg');
  const host = document.querySelector('#svgHost');
  if(inline && inline.textContent.trim().length > 0){
    host.innerHTML = inline.textContent;  // 真正內嵌（離線可用）
    return;
  }
  // 線上抓取你現有的 SVG
  const res = await fetch(SVG_URL, {mode:'cors'});
  const txt = await res.text();
  host.innerHTML = txt;
}

function colorAndBind(svg, targetEls){
  // viewBox / preserve
  if(!svg.getAttribute('viewBox')){
    const w = parseFloat(svg.getAttribute('width')||'1000')||1000;
    const h = parseFloat(svg.getAttribute('height')||'1000')||1000;
    svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  }
  svg.setAttribute('preserveAspectRatio','xMidYMid meet');

  // 去除巨型黑框（避免誤蓋住）
  Array.from(svg.querySelectorAll('path,rect')).forEach(el=>{
    try{
      const bb = el.getBBox();
      const vb = svg.viewBox.baseVal;
      const svgArea = vb.width*vb.height;
      const area = bb.width*bb.height;
      const stroke = (el.getAttribute('stroke')||'').toLowerCase();
      const sw = parseFloat(el.getAttribute('stroke-width')||0);
      if(svgArea && area/svgArea>0.5 && (stroke.includes('black')||stroke==='#000') && sw>=3){
        el.style.display='none';
      }
    }catch(e){}
  });

  // 顏色 + 互動
  targetEls.forEach(el=>{
    let titleText=''; try{const t=el.querySelector&&el.querySelector('title'); if(t) titleText=t.textContent.trim();}catch(e){}
    let name='';
    if(titleText){ const m=titleText.match(/^[\u4e00-\u9fff]+/); if(m&&m[0]) name=m[0].replace(/區$/,''); }
    if(!name) name=(el.id||'').replace(/^_+/,'');

    el.dataset.name = name;

    const g = findGroup(name);
    if(g){
      const base = groupColor[g];
      const curFill = (el.getAttribute('fill')||'').toLowerCase();
      if(!curFill || curFill==='none' || curFill==='#ffffff' || curFill==='white') el.setAttribute('fill', base);
    }
    el.setAttribute('stroke','#ffffff');
    el.setAttribute('stroke-width','1');

    el.addEventListener('click', ev=>{ ev.stopPropagation(); showPopup(name, ev); });
    el.addEventListener('mouseenter', ()=> el.style.filter='brightness(1.06)');
    el.addEventListener('mouseleave', ()=> el.style.filter='');
  });
}

function placeLabels(svg, targetEls){
  labelsLayer.innerHTML='';
  const stageRect = stage.getBoundingClientRect();
  targetEls.forEach(el=>{
    try{
      const bbox = el.getBoundingClientRect();
      if(bbox.width<6 && bbox.height<6) return;
      const cx = bbox.left + bbox.width/2;
      const cy = bbox.top + bbox.height/2;
      const lx = cx - stageRect.left;
      const ly = cy - stageRect.top;

      const name = el.dataset.name || '';
      const pd = placeData[name] || {};
      const div = document.createElement('div');
      div.className='label';
      div.style.left = lx+'px';
      div.style.top  = ly+'px';
      div.innerHTML = `<div class="new">${pd.new_ch || name}</div><div class="old">${pd.old_ch || ''}</div>`;
      labelsLayer.appendChild(div);
    }catch(e){}
  });
}

function showPopup(name, ev){
  const pd = placeData[name] || {};
  popupNew.textContent = pd.new_ch || name;
  popupOld.textContent = pd.old_ch || '';
  const rect = stage.getBoundingClientRect();
  let clientX = ev.clientX || (ev.touches && ev.touches[0] && ev.touches[0].clientX) || (rect.left + rect.width/2);
  let clientY = ev.clientY || (ev.touches && ev.touches[0] && ev.touches[0].clientY) || (rect.top + rect.height/2);
  let left = clientX - rect.left + 8;
  let top  = clientY - rect.top + 8;
  const pw = Math.min(320, rect.width - 16), ph = 160;
  if(left + pw > rect.width) left = Math.max(8, clientX - rect.left - pw - 8);
  if(top + ph > rect.height) top = Math.max(8, clientY - rect.top - ph - 8);
  popup.style.left = left + 'px';
  popup.style.top  = top  + 'px';
  popup.style.display='block';
}

function visualMerge(svg, targetEls){
  // 先建立四個 wrapper，把屬於各群的元素裝進去
  const NS = "http://www.w3.org/2000/svg";
  const wrappers = {};
  Object.keys(groups).forEach(k=>{
    const g = document.createElementNS(NS,'g');
    g.setAttribute('id','__grp_'+k);
    g.setAttribute('data-merge-group', k);
    svg.appendChild(g);
    wrappers[k]=g;
  });
  const others = document.createElementNS(NS,'g');
  others.setAttribute('id','__grp_others');
  svg.appendChild(others);

  targetEls.forEach(el=>{
    const name = el.dataset.name || '';
    const grp = findGroup(name);
    (grp?wrappers[grp]:others).appendChild(el);
  });

  // 以 viewBox 計算位移（比例化，不吃固定像素）
  const vb = svg.viewBox.baseVal || {width:1000,height:1000};
  const w = vb.width, h = vb.height;
  // 這組 offset 是預設「收攏」值：你若覺得縫隙還大，我再幫你加大收攏量
  const mergeOffsets = {
    center: { x: 0,           y: 0 },
    north:  { x: 0,           y: 0.14*h },   // 向下靠近市中心
    east:   { x: -0.22*w,     y: 0 },        // 向左靠近市中心
    mount:  { x: -0.28*w,     y: 0.08*h }    // 向左下，靠近北/東
  };

  let merged = false;
  function applyMerge(on){
    merged = !!on;
    Object.keys(wrappers).forEach(k=>{
      const off = merged ? mergeOffsets[k] : {x:0,y:0};
      wrappers[k].setAttribute('transform', `translate(${off.x}, ${off.y})`);
    });
    // 重新定位標籤
    setTimeout(()=>placeLabels(svg, targetEls), 150);
  }

  // 綁定按鈕
  const btn = document.getElementById('mergeBtn');
  btn.addEventListener('click', ()=>{
    applyMerge(!merged);
    btn.textContent = merged ? '取消合併視覺模式' : '啟用合併視覺模式';
  });

  // 初次就打開合併（你要改成預設關閉也可以）
  applyMerge(true);
}

(async function main(){
  await loadSVGIntoHost();
  const svg = document.querySelector('#svgHost svg');
  if(!svg){ document.querySelector('#svgHost').innerHTML = '<div style="padding:12px;color:#900;background:#fff;border-radius:8px">載入地圖失敗</div>'; return; }

  // 找出行政區元素（優先有 <title> 的）
  const candidates = Array.from(svg.querySelectorAll('path,polygon,rect,g'));
  const areas = candidates.filter(el=>{
    const t = el.querySelector && el.querySelector('title');
    return (t && t.textContent && t.textContent.trim()) || (el.id && el.id.trim());
  });
  const targetEls = areas.length ? areas : Array.from(svg.querySelectorAll('path'));

  colorAndBind(svg, targetEls);
  visualMerge(svg, targetEls);

  // 初次與後續視窗變動時重算標籤
  setTimeout(()=>placeLabels(svg, targetEls), 250);
  window.addEventListener('resize', ()=> setTimeout(()=>placeLabels(svg, targetEls),120));
  window.addEventListener('scroll', ()=> setTimeout(()=>placeLabels(svg, targetEls),120));

  // 點背景關閉浮窗
  document.addEventListener('click', ()=> popup.style.display='none');
})();
</script>
</body>
</html>
