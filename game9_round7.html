<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>果子骰仔遊戲-第3回</title>
  <style>
    :root{
      --bg:#fff8f0;
      --card:#fff;
      --accent:#ff7b56;
      --text:#333;
      --btn-bg:#ff8f6b;
      --btn-color:#fff;
      --dice-size:140px; /* 若需微調，這裡改 */
      --max-width:820px;
      --shadow: 0 6px 18px rgba(0,0,0,0.08);
      font-family: "Noto Sans TC", "Helvetica Neue", Arial, sans-serif;
    }

    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);}
    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px 16px;
    }
    .card{
      width:100%;
      max-width:var(--max-width);
      background:var(--card);
      border-radius:14px;
      padding:22px;
      box-shadow:var(--shadow);
      box-sizing:border-box;
    }

    .title{
      text-align:center;
      margin-bottom:8px;
    }
    .title h1{
      margin:0;
      font-size:1.6rem;
      letter-spacing:0.6px;
    }
    .subtitle{
      margin-top:6px;
      color:#666;
      font-size:0.95rem;
    }

    /* 主體佈局：左為骰子/圖示，右為控制/文字（寬螢幕） */
    .main{
      display:flex;
      gap:18px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
    }

    .panel-left, .panel-right{
      flex:1 1 320px;
      min-width:260px;
    }

    .dice-box{
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:12px;
      padding:12px;
    }

    /* 骰子外觀（用圖） */
    .dice{
      width:var(--dice-size);
      height:var(--dice-size);
      border-radius:12px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      transform-style:preserve-3d;
      transition: transform 0.6s cubic-bezier(.2,.9,.3,1);
      overflow:hidden;
      position:relative;
    }
    .dice img{
      max-width:100%;
      max-height:100%;
      display:block;
      user-select:none;
      pointer-events:none;
    }

    /* 讓擲骰子時有旋轉動畫 */
    .rolling {
      animation: diceSpin 0.8s linear infinite;
    }
    @keyframes diceSpin {
      from { transform: rotateX(0deg) rotateY(0deg) scale(1.02); }
      to   { transform: rotateX(360deg) rotateY(360deg) scale(0.98); }
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      margin-top:6px;
      flex-wrap:wrap;
    }

    .btn{
      background:var(--btn-bg);
      color:var(--btn-color);
      border:none;
      padding:10px 18px;
      border-radius:10px;
      font-size:1rem;
      cursor:pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    }
    .btn:disabled{opacity:0.5;cursor:default;}

    .info{
      padding:12px;
      border-radius:10px;
      background:linear-gradient(180deg,#fff,#fffaf2);
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.6);
      font-size:0.98rem;
      line-height:1.45;
    }

    .fruit-name{
      text-align:center;
      margin-top:8px;
      font-size:1.15rem;
      font-weight:600;
    }
    .phonetic{
      text-align:center;
      margin-top:4px;
      color:#666;
      font-size:0.98rem;
    }

    .reset-area{ text-align:center; margin-top:12px; }

    /* 手機優化：將主體置中、文字更小 */
    @media (max-width:640px){
      .card{ padding:16px; border-radius:12px; }
      .title h1{ font-size:1.25rem; }
      .subtitle{ font-size:0.9rem; }
      :root { --dice-size:120px; }
      .controls{ gap:8px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="application" aria-label="果子骰仔遊戲 - 第3回遊戲介面">
      <div class="title" aria-hidden="false">
        <h1>果子骰仔遊戲-第3回</h1>
        <div class="subtitle">📱 建議直式觀看效果最佳</div>
      </div>

      <div class="main">
        <div class="panel-left">
          <div class="dice-box">
            <div id="dice" class="dice" aria-live="polite" aria-atomic="true">
              <img id="diceImage" src="game9_assets/fruit13.png" alt="骰子顯示的水果">
            </div>

            <div class="controls">
              <button id="rollBtn" class="btn" type="button">擲骰子</button>
              <button id="resetBtn" class="btn" type="button" style="background:#8fb6ff;color:#fff;">重置遊戲</button>
            </div>

            <div class="fruit-name" id="fruitName">準備擲骰子</div>
            <div class="phonetic" id="fruitPhonetic">請按「擲骰子」</div>
          </div>
        </div>

        <div class="panel-right">
          <div class="info" id="infoBox">
            <strong>使用說明</strong>
            <ul>
              <li>按「擲骰子」開始滾動，按鈕會在滾動期間停用。</li>
              <li>停止時會播放停止音效，並在 0.5 秒後播放該水果的台語發音。</li>
              <li>每顆水果只會顯示一次（共 6 種）。全部出過後請按「重置遊戲」。</li>
            </ul>
            <hr>
            <div>
              <strong>本回合水果清單（台語 + 拼音）</strong>
              <ol>
                <li>fruit13 → 棗仔 tsó-á</li>
                <li>fruit14 → 柚仔 iū-á</li>
                <li>fruit15 → 李仔 lí-á</li>
                <li>fruit16 → 柿仔 khī-á</li>
                <li>fruit17 → 荔枝 nāi-tsi</li>
                <li>fruit18 → 龍眼 lîng-gíng</li>
              </ol>
            </div>
          </div>
        </div>
      </div> <!-- main -->

    </div> <!-- card -->
  </div> <!-- wrap -->

  <script>
    // ---- 資源定義 ----
    const assetsBase = 'game9_assets/';
    const fruits = [
      { img: 'fruit13.png', name: '棗仔', phonetic: 'tsó-á', audio: 'https://sutian.moe.edu.tw/media/senn/mp3/imtong/subak/8/8491.mp3' },
      { img: 'fruit14.png', name: '柚仔', phonetic: 'iū-á', audio: 'https://sutian.moe.edu.tw/media/senn/mp3/imtong/subak/5/5085.mp3' },
      { img: 'fruit15.png', name: '李仔', phonetic: 'lí-á', audio: 'https://sutian.moe.edu.tw/media/senn/mp3/imtong/subak/3/3227.mp3' },
      { img: 'fruit16.png', name: '柿仔', phonetic: 'khī-á', audio: 'https://sutian.moe.edu.tw/media/senn/mp3/imtong/subak/5/5087.mp3' },
      { img: 'fruit17.png', name: '荔枝', phonetic: 'nāi-tsi', audio: 'https://sutian.moe.edu.tw/media/senn/mp3/imtong/subak/6/6646.mp3' },
      { img: 'fruit18.png', name: '龍眼', phonetic: 'lîng-gíng', audio: 'https://sutian.moe.edu.tw/media/senn/mp3/imtong/subak/12/12106.mp3' },
    ];

    const rollSound = new Audio(assetsBase + 'Roll the dice.mp3');
    rollSound.loop = true;
    const stopSound = new Audio(assetsBase + 'ding.mp3');

    // ---- UI 元件 ----
    const rollBtn = document.getElementById('rollBtn');
    const resetBtn = document.getElementById('resetBtn');
    const dice = document.getElementById('dice');
    const diceImage = document.getElementById('diceImage');
    const fruitName = document.getElementById('fruitName');
    const fruitPhonetic = document.getElementById('fruitPhonetic');

    // ---- 不重複邏輯：先隨機打亂索引陣列，再每次 pop 一個 ----
    let order = [];
    function shuffleOrder(){
      order = Array.from({length:fruits.length}, (_,i)=>i);
      for(let i=order.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [order[i], order[j]] = [order[j], order[i]];
      }
    }
    shuffleOrder();

    // ---- 擲骰子/滾動實作 ----
    let rolling = false;
    let intervalId = null;

    function startRolling(){
      if(rolling) return;
      if(order.length === 0){
        fruitName.textContent = '已經全部出過囉';
        fruitPhonetic.textContent = '請按「重置遊戲」以重新開始';
        return;
      }
      rolling = true;
      rollBtn.disabled = true;
      resetBtn.disabled = true;

      // 開始滾動動畫（CSS 3D 旋轉），並以 setInterval 快速切換圖片以模擬滾動
      dice.classList.add('rolling');
      rollSound.currentTime = 0;
      rollSound.play().catch(()=>{/* autoplay 可能被瀏覽器擋，後面交互操作允許播放 */});

      intervalId = setInterval(()=>{
        // 在滾動時隨機顯示一張圖（可重複，直到真正停止選取）
        const idx = Math.floor(Math.random()*fruits.length);
        diceImage.src = assetsBase + fruits[idx].img;
        diceImage.alt = fruits[idx].name;
      }, 80); // 切換速度
    }

    function stopRollingAndShow(){
      if(!rolling) return;
      rolling = false;

      // 停止滾動動畫及滾動音
      dice.classList.remove('rolling');
      if(intervalId) clearInterval(intervalId);
      intervalId = null;

      // pick next index from shuffled order (ensures non-repetition)
      const nextIndex = order.pop();
      const chosen = fruits[nextIndex];

      // 顯示圖片（立刻顯示），並播放停止音效
      diceImage.src = assetsBase + chosen.img;
      diceImage.alt = chosen.name;
      stopSound.currentTime = 0;
      stopSound.play().catch(()=>{});

      // 在停止音效後 0.5 秒播放台語發音（題目要求）
      setTimeout(()=>{
        // 播放對應音檔（遠端 sutian 連結）
        const pron = new Audio(chosen.audio);
        pron.play().catch(()=>{/* 若被阻擋，使用者再點擊即可 */});
      }, 500);

      // 更新文字
      fruitName.textContent = chosen.name;
      fruitPhonetic.textContent = chosen.phonetic;

      // re-enable buttons（但若已無更多水果，提示重置）
      setTimeout(()=>{
        rollBtn.disabled = false;
        resetBtn.disabled = false;
        if(order.length === 0){
          rollBtn.disabled = true;
          fruitPhonetic.textContent = chosen.phonetic + '（已出完所有水果）';
        }
      }, 700);
    }

    // 將一個完整的「擲—停」流程綁到按鈕：按一下啟動 700ms 的滾動（或任意您想的時間）
    // 我們模擬真實手動停骰：啟動後自動在 900~1300ms 間隨機停止（避免每次都同一時長）
    rollBtn.addEventListener('click', ()=> {
      startRolling();
      // 自動停止：在 800 ~ 1300 ms 隨機時間停止，模擬投擲行為
      const stopDelay = 900 + Math.floor(Math.random()*500);
      setTimeout(()=> stopRollingAndShow(), stopDelay);
    });

    resetBtn.addEventListener('click', ()=>{
      // 重新洗牌、重置顯示
      shuffleOrder();
      diceImage.src = assetsBase + fruits[0].img;
      diceImage.alt = fruits[0].name;
      fruitName.textContent = '遊戲已重置';
      fruitPhonetic.textContent = '請按「擲骰子」開始';
      rollBtn.disabled = false;
    });

    // 預載所有資源（圖片 + 音效）以減少延遲
    (function preload(){
      fruits.forEach(f=>{
        const im = new Image();
        im.src = assetsBase + f.img;
      });
      // 預載停止音（但不要自動播放）
      stopSound.load();
      rollSound.load();
    })();

    // Accessibility: 支援鍵盤空白鍵啟動擲骰（當按鈕有焦點或整個文件）
    document.addEventListener('keydown', (e)=>{
      if(e.code === 'Space' && !e.repeat){
        e.preventDefault();
        if(!rollBtn.disabled) rollBtn.click();
      }
    });

    // 初始顯示第一張圖（預覽）
    diceImage.src = assetsBase + fruits[0].img;
    diceImage.alt = fruits[0].name;

  </script>
</body>
</html>
