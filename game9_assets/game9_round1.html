<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
<meta charset="utf-8" />
<title>華台水果語詞配對 – 第1回</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --header-h:12vh;
    --footer-h:12vh;
    --grid-h: calc((100vh - var(--header-h) - var(--footer-h)) / 2);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Microsoft JhengHei",sans-serif;
    background: linear-gradient(180deg,#fff7e6 0%, #fffef9 100%);
    color:#222;
    height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  /* Header */
  header{
    height:var(--header-h);
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    padding:6px 8px;
    text-align:center;
  }
  .title-row{
    display:flex;
    align-items:center;
    gap:12px;
    font-size:clamp(18px,3.5vw,28px);
    font-weight:700;
    color:#d35400;
  }
  .title-row img{ width:44px; height:44px; object-fit:contain }
  .subtitle{ font-size:clamp(12px,2.2vw,16px); color:#2e7d32; margin-top:6px }
  .note{ font-size:clamp(14px,2.6vw,18px); color:#1565c0; font-weight:700; margin-top:4px }

  /* Grids */
  .grid-wrapper{ width:100%; display:flex; justify-content:center; align-items:center; }
  .grid {
    width:95%;
    height:var(--grid-h);
    display:grid;
    grid-template-columns:repeat(4,1fr);
    grid-template-rows:repeat(4,1fr);
    gap:8px;
  }

  .cell{
    border-radius:14px;
    border:2px solid rgba(0,0,0,0.12);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:6px;
    text-align:center;
    cursor:pointer;
    user-select:none;
    transition: all .18s ease;
    overflow:hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
    font-weight:600;
    /* font-size responsive */
    font-size: clamp(14px, 2.4vw, 20px);
  }

  /* initial zone colors */
  #chineseGrid .cell{ background:#fff3e0; color:#332211 }
  #taiwaneseGrid .cell{ background:#e8f5ff; color:#112233 }

  .cell:hover{ transform:translateY(-3px); box-shadow: 0 6px 14px rgba(0,0,0,0.06) }

  /* selection outline */
  .cell.selected{ outline:4px solid rgba(33,150,243,0.85); outline-offset: -6px; }

  /* matched state (text remains white when matched color applied inline) */
  .cell.matched{ pointer-events:none; }

  /* footer buttons */
  footer{
    height:var(--footer-h);
    width:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    padding:8px;
  }
  .btn{
    padding:10px 14px;
    border-radius:10px;
    border:none;
    font-weight:700;
    color:white;
    cursor:pointer;
    font-size:clamp(14px,2.2vw,16px);
    box-shadow: 0 6px 10px rgba(0,0,0,0.08);
  }
  .btn.restart{ background:#ff7043 } /* 活潑橘 */
  .btn.home{ background:#42a5f5 }    /* 亮藍 */
  .btn.next{ background:#66bb6a }    /* 亮綠 */

  /* victory message */
  #victoryMsg{
    position:fixed;
    left:50%;
    top:45%;
    transform:translate(-50%,-50%) scale(.3);
    font-size:clamp(28px,6vw,48px);
    color:#e91e63;
    font-weight:900;
    opacity:0;
    pointer-events:none;
    transition: all .6s cubic-bezier(.2,.9,.2,1);
  }
  #victoryMsg.show{ opacity:1; transform:translate(-50%,-50%) scale(1); }

  @media (min-width:900px){
    :root{ --header-h:10vh; --footer-h:10vh; }
  }
</style>
</head>
<body>
  <header>
    <div class="title-row">
      <img id="leftImg" src="game9_assets/fruit_left.png" alt="果左">
      華台水果語詞配對 - 第1回
      <img id="rightImg" src="game9_assets/fruit_right.png" alt="果右">
    </div>
    <div class="subtitle">tshi̍h 華文抑是台語攏會使，配對成功會有台語聲音檔喔！</div>
    <div class="note">📱 直式觀看效果最佳</div>
  </header>

  <!-- 上方 4x4: 華語 -->
  <div class="grid-wrapper">
    <div id="chineseGrid" class="grid" aria-label="華語格子"></div>
  </div>

  <!-- 下方 4x4: 台語 -->
  <div class="grid-wrapper">
    <div id="taiwaneseGrid" class="grid" aria-label="台語格子"></div>
  </div>

  <footer>
    <button id="restartBtn" class="btn restart">重新開始</button>
    <button id="homeBtn" class="btn home">回遊戲頭頁</button>
    <button id="nextBtn" class="btn next">後一回</button>
  </footer>

  <!-- sounds -->
  <audio id="wrongSound" src="game9_assets/wrong.mp3" preload="auto"></audio>
  <audio id="victorySound" src="game9_assets/victory.mp3" preload="auto"></audio>

  <div id="victoryMsg">有夠 gâu！</div>

<script>
/*
Behavior:
- load fruits_part1.json (expects array under top-level; adjust if your JSON shape differs)
- use first 16 items as pairs (index 0..15).
- build chineseGrid (in the same order) and taiwaneseGrid (shuffled).
- assign a unique color per pair (16 vivid colors).
- clicking selects cell; when both selected and ids match -> set both cells to the pair color, play pair audio once.
- if last pair matched: wait for pair audio end (or 1s if no audio), then wait 1s, then play victorySound and show "有夠 gâu" animation.
- on wrong match: play wrongSound once, briefly flash border.
*/

const COLOR_PALETTE = [
  "#FF5733","#FF8D1A","#FFC300","#DAF7A6",
  "#33FF57","#1AFF8D","#33FFF6","#3380FF",
  "#8D33FF","#FF33F6","#FF3380","#FF6666",
  "#66FF66","#66FFFF","#6666FF","#FFCC00"
];

const chineseGrid = document.getElementById('chineseGrid');
const taiwaneseGrid = document.getElementById('taiwaneseGrid');
const wrongSound = document.getElementById('wrongSound');
const victorySound = document.getElementById('victorySound');
const victoryMsg = document.getElementById('victoryMsg');

let pairs = []; // {id, chinese, taiwanese, audio, color}
let selected = {type:null, el:null, id:null};
let matchedCount = 0;
let lastMatchedAudioSrc = null;
let lastMatchedAudio = null;
let lastMatchIsFinal = false;

// pick random decorative images from 2 options each
function pickHeaderImgs(){
  const left = ["fruit_left.png","fruit_left1.png"];
  const right = ["fruit_right.png","fruit_right1.png"];
  document.getElementById('leftImg').src = "game9_assets/" + left[Math.floor(Math.random()*left.length)];
  document.getElementById('rightImg').src = "game9_assets/" + right[Math.floor(Math.random()*right.length)];
}

pickHeaderImgs();

// load JSON (expects structure: { fruits: [ {id:, chinese:, taiwanese:, audio: } ] } ).
// If your JSON is an array at root, adjust accordingly.
async function loadRound1(){
  let res = await fetch('game9_assets/fruits_part1.json');
  if(!res.ok){ console.error('Cannot load fruits_part1.json'); return; }
  let json = await res.json();
  // try common shapes:
  let arr = Array.isArray(json) ? json : (json.fruits || json.items || []);
  // take first 16 entries (1..16)
  let selectedArr = arr.slice(0,16);
  // build pairs and assign color
  pairs = selectedArr.map((it,i)=>({
    id: it.id ?? i+1,
    chinese: it.chinese ?? it.name ?? ("水果"+(i+1)),
    taiwanese: it.taiwanese ?? it.taiwaneseName ?? it.taiwanese ?? ("台語"+(i+1)),
    audio: (it.audio && it.audio.length>0) ? it.audio : (it.audioPath || it.sound || null),
    color: COLOR_PALETTE[i % COLOR_PALETTE.length]
  }));
  renderGrids();
}

function renderGrids(){
  chineseGrid.innerHTML = "";
  taiwaneseGrid.innerHTML = "";
  matchedCount = 0;
  // Chinese: show in order
  pairs.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'cell';
    div.textContent = p.chinese;
    div.dataset.id = p.id;
    div.addEventListener('click', ()=>onCellClick(div,'chinese'));
    chineseGrid.appendChild(div);
  });
  // Taiwanese: shuffled
  const shuffled = [...pairs].sort(()=>Math.random()-0.5);
  shuffled.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'cell';
    div.textContent = p.taiwanese;
    div.dataset.id = p.id;
    div.addEventListener('click', ()=>onCellClick(div,'taiwanese'));
    taiwaneseGrid.appendChild(div);
  });
}

function onCellClick(el,type){
  if(el.classList.contains('matched')) return;
  // selection logic
  if(!selected.el){
    selected = {type, el, id: el.dataset.id};
    el.classList.add('selected');
    return;
  }
  // if clicked same cell to deselect
  if(selected.el === el){
    el.classList.remove('selected');
    selected = {type:null, el:null, id:null};
    return;
  }
  // second selection
  const first = selected;
  const second = {type, el, id: el.dataset.id};
  // highlight second briefly
  el.classList.add('selected');
  // check match
  if(first.id === second.id && first.type !== second.type){
    // correct
    const pairIndex = pairs.findIndex(p=>String(p.id) === String(first.id));
    const color = pairs[pairIndex].color;
    // apply color to both elements
    first.el.style.background = color;
    first.el.style.color = '#fff';
    first.el.classList.add('matched');
    second.el.style.background = color;
    second.el.style.color = '#fff';
    second.el.classList.add('matched');
    matchedCount++;
    // play pair audio if any
    const audioSrc = pairs[pairIndex].audio;
    // ensure not double-play
    if(matchedCount === pairs.length){
      // final match flow: play pair audio once, then after it ends wait 1s, then play victory + show message
      if(audioSrc){
        lastMatchedAudioSrc = audioSrc;
        lastMatchedAudio = new Audio(audioSrc);
        lastMatchedAudio.play();
        lastMatchedAudio.onended = ()=> {
          setTimeout(()=> {
            victorySound.play();
            showVictoryMsg();
          }, 1000);
        };
      } else {
        // no pair audio - wait 1s then victory
        setTimeout(()=> {
          victorySound.play();
          showVictoryMsg();
        }, 1000);
      }
    } else {
      // non-final: play pair audio once if exists, otherwise no sound
      if(audioSrc){
        const au = new Audio(audioSrc);
        au.play();
      }
    }
    // clear selection
    first.el.classList.remove('selected');
    second.el.classList.remove('selected');
    selected = {type:null, el:null, id:null};
    return;
  } else {
    // wrong
    wrongSound.currentTime = 0;
    wrongSound.play().catch(()=>{});
    // flash border
    first.el.classList.add('shake');
    second.el.classList.add('shake');
    setTimeout(()=> {
      first.el.classList.remove('shake');
      second.el.classList.remove('shake');
      first.el.classList.remove('selected');
      second.el.classList.remove('selected');
      selected = {type:null, el:null, id:null};
    }, 350);
    return;
  }
}

function showVictoryMsg(){
  victoryMsg.classList.add('show');
  // animate (pop) is CSS transition
  setTimeout(()=> {
    victoryMsg.classList.remove('show');
  }, 3500);
}

// buttons
document.getElementById('restartBtn').addEventListener('click', ()=> {
  // simply re-render (reshuffle)
  renderGrids();
});
document.getElementById('homeBtn').addEventListener('click', ()=> {
  location.href = 'index.html';
});
document.getElementById('nextBtn').addEventListener('click', ()=> {
  location.href = 'game9_round2.html';
});

// initialize
loadRound1();
</script>
</body>
</html>
