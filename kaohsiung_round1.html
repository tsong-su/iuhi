<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>é«˜é›„å¸‚ï¼å¸‚ä¸­å¿ƒå€æ–°èˆŠåœ°åé…å°</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;800&display=swap">
<style>
:root{
  --ink:#7b341e; --ink2:#5a3000; --bg:#fff7f2; --card:#fff; --border:#e5e7eb;
  --chip:#ffe0b2; --chipBorder:#ff9800; --good:#22c55e; --bad:#ef4444;
}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,Arial}
h1{margin:.6rem 0 .2rem;text-align:center;font-weight:800;font-size:clamp(20px,3.6vw,30px);color:var(--ink)}
.p{text-align:center;margin:.1rem 0;color:var(--ink);font-size:14px}
.wrapper{max-width:1100px;margin:0 auto;padding:0 10px 14px}
.board{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.08);overflow:hidden}
.mapbox{position:relative;width:100%;height:72vh;min-height:520px;background:#fff}
.mapbox svg{width:100%;height:100%;display:block}
.mapbox svg path,.mapbox svg polygon,.mapbox svg polyline{vector-effect:non-scaling-stroke;stroke-linejoin:round;stroke-linecap:round}
.non-core{display:none !important}
.core-district{fill:url(#coreGrad);stroke:#ffffff;stroke-width:1.2}
.core-district.glow{filter:url(#glow)}
svg text.label{font-weight:900;fill:var(--ink2);paint-order:stroke;stroke:#fff;stroke-width:2.2px;stroke-linejoin:round;letter-spacing:.4px;font-size:12px}
svg text.label tspan{fill:#8a4b00;font-weight:800;font-size:10px}

.tray{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:12px;background:#fff;border-top:1px dashed var(--border)}
.chip{
  user-select:none;touch-action:none;padding:10px 12px;border-radius:14px;
  border:2px solid var(--chipBorder);background:var(--chip);
  box-shadow:0 3px 8px rgba(0,0,0,.12);
  font-weight:900;color:var(--ink2);
  display:inline-flex;flex-direction:column;align-items:center;gap:2px
}
.chip .poj{font-size:12px;color:#8a4b00}
.chip.dragging{opacity:.9;box-shadow:0 10px 24px rgba(0,0,0,.24)}
.chip.correct{border-color:var(--good)}
.chip.wrong{border-color:var(--bad);animation:shake .28s linear 1}
@keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}}

.footer{text-align:center;padding:12px}
.btn{display:inline-block;margin:0 6px;background:linear-gradient(145deg,#ffa96e,#ffcf9b);color:#fff;padding:9px 14px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.18);border:0;font-weight:900}

.toast{position:fixed;left:50%;top:12px;transform:translateX(-50%);background:#111827;color:#fff;padding:8px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);font-weight:700;z-index:999;display:none}

/* å‹åˆ©å¤§å­— */
.win-banner{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;
  font-weight:900;font-size:clamp(28px,7vw,56px);color:#ff9e42;text-shadow:0 10px 24px rgba(0,0,0,.18);
  transform:scale(.6);opacity:0;transition:transform .5s ease, opacity .5s ease;z-index:9999
}
.win-banner.show{transform:scale(1);opacity:1}

/* SVG ç™¼å…‰æ¿¾é¡ */
</style>
</head>
<body>
  <h1>é«˜é›„å¸‚ï¼å¸‚ä¸­å¿ƒå€æ–°èˆŠåœ°åé…å°</h1>
  <p class="p">ğŸ“± å»ºè­°ç›´å¼è§€çœ‹æ•ˆæœæœ€ä½³</p>
  <p class="p">ğŸ‘‡ æŠŠã€ŒèˆŠåœ°åï¼‹æ‹¼éŸ³ã€æ‹–åˆ°åœ–ä¸Šçš„æ­£ç¢ºä½ç½®</p>

  <div class="wrapper">
    <div class="board">
      <div class="mapbox" id="mapbox">
        <!-- â¬‡ æŠŠ v6.2 çš„ <svg>â€¦</svg> åŸæ¨£è²¼åœ¨é€™è£¡ â¬‡ -->
        <!-- å‹™å¿…ä¿ç•™å„å€ <title>ï¼ˆä¾‹å¦‚ <title>å·¦ç‡Ÿå€</title>ï¼‰ -->
        <!-- PASTE SVG HERE -->
        <!-- â¬† æŠŠ v6.2 çš„ <svg>â€¦</svg> åŸæ¨£è²¼åœ¨é€™è£¡ â¬† -->
      </div>

      <div class="tray" id="tray"></div>
    </div>

    <div class="footer">
      <button class="btn" id="btn-restart">ğŸ” é–£è€ä¸€æ“º</button>
      <a class="btn" href="https://tsong-su.github.io/iuhi/index.html">ğŸ  è½‰å»éŠæˆ²é¦–é </a>
    </div>
  </div>

  <div class="toast" id="toast">âœ”ï¸ é…å°æˆåŠŸï¼</div>
  <div class="win-banner" id="winBanner">æœ‰å¤  gÃ¢u çš„ï¼è®šå•¦ï¼</div>

<script>
/* å¸‚ä¸­å¿ƒ 11 å€ */
const CORE = ["æ¥ æ¢“","å·¦ç‡Ÿ","é¼“å±±","ä¸‰æ°‘","é¹½åŸ•","å‰é‡‘","æ–°èˆˆ","è‹“é›…","æ——æ´¥","å‰é®","å°æ¸¯"];

/* æ–°åœ°åï¼‹èˆŠåœ°åï¼‹æ‹¼éŸ³ï¼‹åœ°åœ–æ¨™ç±¤åº§æ¨™ï¼ˆæ¨™ç±¤ä½ç½®å¯å†å¾®èª¿ï¼‰ */
const DATA = {
  "æ¥ æ¢“":{old:"æ¥ ä»”å‘", newPoj:"LÃ¢m-tsÃº",      oldPoj:"LÃ¢m-Ã¡-khenn",  label:[220,380]},
  "å·¦ç‡Ÿ":{old:"åŸ¤ä»”é ­", newPoj:"TsÃ³-iÃ¢nn",    oldPoj:"Pi-Ã¡-thÃ¢u",    label:[260,340]},
  "é¼“å±±":{old:"æ‰“é¼“å±±", newPoj:"KÃ³o-san",     oldPoj:"TÃ¡nn-kÃ³o-san", label:[240,420]},
  "ä¸‰æ°‘":{old:"ä¸‰å¡Šå", newPoj:"Sam-bÃ®n",     oldPoj:"Sann-tÃ¨-tshÃ¹", label:[300,460]},
  "é¹½åŸ•":{old:"é¹½åŸ•åŸ”", newPoj:"IÃ¢m-tiÃ¢nn",   oldPoj:"IÃ¢m-tiÃ¢nn-poo",label:[200,520]},
  "å‰é‡‘":{old:"å‰è¡¿",   newPoj:"TsiÃ¢n-kim",   oldPoj:"TsiÃ¢n-khim",   label:[260,520]},
  "æ–°èˆˆ":{old:"é€®æ¸¯åŸ”", newPoj:"Sin-hing",    oldPoj:"TÄi-kÃ¡ng-poo", label:[300,520]},
  "è‹“é›…":{old:"ç¬­ä»”å¯®", newPoj:"LÃ®ng-ngÃ¡",    oldPoj:"LÃ®ng-Ã¡-liÃ¢u",  label:[320,560]},
  "æ——æ´¥":{old:"æ——å¾Œ",   newPoj:"KÃ®-tin",      oldPoj:"KÃ®-Äu",        label:[150,640]},
  "å‰é®":{old:"å‰é®",   newPoj:"TsiÃ¢n-tÃ¬n",   oldPoj:"TsiÃ¢n-tÃ¬n",    label:[280,610]},
  "å°æ¸¯":{old:"æ¸¯ä»”å¢˜", newPoj:"SiÃ³-kÃ¡ng",    oldPoj:"KÃ¡ng-Ã¡ kÃ®nn",  label:[310,680]}
};

/* éŸ³æª”å‘½åï¼ˆä½ æŒ‡å®šçš„ä¸­æ–‡æª”å + å…©ä½æ•¸åºè™Ÿï¼‰ */
function idxOf(name){ return CORE.indexOf(name)+1; }
function pad2(n){ return String(n).padStart(2,'0'); }
function newSrc(name){ return "map_assets/"+pad2(idxOf(name))+name+"_new.mp3"; }
function oldSrc(name){ return "map_assets/"+pad2(idxOf(name))+DATA[name].old+"_old.mp3"; }

/* DOM åƒç…§ */
const mapbox = document.getElementById('mapbox');
const tray   = document.getElementById('tray');
const toast  = document.getElementById('toast');
const winBanner = document.getElementById('winBanner');

/* éŸ³æ•ˆ */
const audioNew = new Audio();
const audioOld = new Audio();
const victory  = new Audio("map_assets/victory.mp3");
const finish1  = new Audio("map_assets/finish1.mp3");

let solved = 0;

/* å°å·¥å…· */
function onlyHan(t){const m=(t||'').match(/[\u4E00-\u9FFF]+/g);return m?m.join(''):'';}
function getNameFromShape(el){
  const t = el.querySelector && el.querySelector('title');
  if(t && t.textContent) return onlyHan(t.textContent).replace(/å¸‚|é«˜é›„/,'').replace(/\s/g,'').replace(/å€$/,'');
  return onlyHan(el.getAttribute('data-name')||el.getAttribute('id')||'').replace(/å€$/,'');
}
function showToast(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none', 900); }

/* åˆå§‹åŒ–åœ°åœ–ï¼šåªé¡¯ç¤ºå¸‚ä¸­å¿ƒ 11 å€ã€åŠ æ¼¸å±¤èˆ‡æ¨™ç±¤ã€ä¸¦è‡ªå‹•æ”¾å¤§ viewBox */
function initMap(){
  const svg = mapbox.querySelector('svg'); if(!svg) return;

  // è£œä¸Š defsï¼šæŸ”å’Œæ©˜æ¼¸å±¤ï¼‹æé‚Šç™¼å…‰æ¿¾é¡
  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  const lg = document.createElementNS('http://www.w3.org/2000/svg','linearGradient'); lg.id='coreGrad'; lg.setAttribute('x1','0'); lg.setAttribute('x2','0'); lg.setAttribute('y1','0'); lg.setAttribute('y2','1');
  const s1=document.createElementNS('http://www.w3.org/2000/svg','stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','#ffcf9b');
  const s2=document.createElementNS('http://www.w3.org/2000/svg','stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','#ffb774');
  lg.appendChild(s1); lg.appendChild(s2); defs.appendChild(lg);

  const filter = document.createElementNS('http://www.w3.org/2000/svg','filter'); filter.id='glow';
  filter.innerHTML = '<feGaussianBlur stdDeviation="2.2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>';
  defs.appendChild(filter);
  svg.prepend(defs);

  // å…ˆå…¨éƒ¨éš±è—
  svg.querySelectorAll('path,polygon,polyline').forEach(el=>el.classList.add('non-core'));

  // æ¨™ä¸Š core-district
  svg.querySelectorAll('g, path, polygon, polyline').forEach(el=>{
    const t = el.querySelector && el.querySelector('title');
    if(!t) return;
    const name = onlyHan(t.textContent).replace(/å¸‚|é«˜é›„/,'').replace(/\s/g,'').replace(/å€$/,'');
    if(CORE.includes(name)){
      (el.querySelectorAll('path,polygon,polyline')||[]).forEach(p=>{
        p.classList.remove('non-core');
        p.classList.add('core-district');
        p.setAttribute('data-core-name', name);
      });
    }
  });

  // æ–°åå›ºå®šæ¨™ç±¤
  svg.querySelectorAll('text.label').forEach(n=>n.remove());
  for(const name of CORE){
    const pos = (DATA[name]&&DATA[name].label)||[0,0];
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('class','label'); t.setAttribute('x', pos[0]); t.setAttribute('y', pos[1]); t.setAttribute('text-anchor','middle');
    t.textContent = name;
    const ts = document.createElementNS('http://www.w3.org/2000/svg','tspan'); ts.setAttribute('x', pos[0]); ts.setAttribute('dy','1.2em'); ts.textContent = (DATA[name]?.newPoj)||'';
    t.appendChild(ts); svg.appendChild(t);
  }

  // è‡ªå‹•æ”¾å¤§ï¼šæŠŠ 11 å€çš„ bbox åˆä½µï¼Œè¨­æˆ viewBoxï¼ˆä¿ç•™é‚Šç•Œç•™ç™½ï¼‰
  const cores = svg.querySelectorAll('.core-district');
  if(cores.length){
    let x=1e9,y=1e9,xx=-1e9,yy=-1e9;
    cores.forEach(el=>{
      const b = el.getBBox();
      x = Math.min(x,b.x); y = Math.min(y,b.y);
      xx = Math.max(xx,b.x+b.width); yy = Math.max(yy,b.y+b.height);
    });
    const pad = Math.max((xx-x),(yy-y))*0.1;
    svg.setAttribute('viewBox', `${x-pad} ${y-pad} ${(xx-x)+pad*2} ${(yy-y)+pad*2}`);
    svg.removeAttribute('width'); svg.removeAttribute('height');
  }
}

/* ç”¢ç”Ÿ 11 å€‹æ‹–æ›³ç±¤ï¼ˆèˆŠåœ°åï¼‹æ‹¼éŸ³ï¼‰ */
function buildChips(){
  tray.innerHTML=''; solved=0;
  const items = CORE.map(n=>({name:n, old:DATA[n].old, oldPoj:DATA[n].oldPoj})).sort(()=>Math.random()-0.5);
  for(const it of items){
    const chip = document.createElement('div'); chip.className='chip'; chip.setAttribute('data-name', it.name);
    chip.innerHTML = '<div>'+it.old+'</div><div class="poj">'+(it.oldPoj||'')+'</div>';
    tray.appendChild(chip);
  }
  enableDrag();
}

/* æ‹–æ›³é…å° */
function enableDrag(){
  let dragEl=null, offsetX=0, offsetY=0, origParent=null;

  function onDown(e){
    const t = e.target.closest('.chip'); if(!t) return; e.preventDefault();
    dragEl=t; dragEl.classList.add('dragging');
    const r=dragEl.getBoundingClientRect(); offsetX=e.clientX-r.left; offsetY=e.clientY-r.top;
    origParent=dragEl.parentElement; mapbox.appendChild(dragEl);
    dragEl.style.position='absolute'; dragEl.style.zIndex=99; move(e);
    window.addEventListener('pointermove', move); window.addEventListener('pointerup', up, {once:true});
  }

  function move(e){
    if(!dragEl) return;
    const host = mapbox.getBoundingClientRect();
    let x = e.clientX - host.left - offsetX; let y = e.clientY - host.top - offsetY;
    x = Math.max(0, Math.min(host.width - dragEl.offsetWidth, x));
    y = Math.max(0, Math.min(host.height - dragEl.offsetHeight, y));
    dragEl.style.left=x+'px'; dragEl.style.top=y+'px';
  }

  function up(e){
    if(!dragEl) return; window.removeEventListener('pointermove', move);
    const name = dragEl.getAttribute('data-name');
    const r = dragEl.getBoundingClientRect(); const center = {x:r.left+r.width/2, y:r.top+r.height/2};
    const svg = mapbox.querySelector('svg'); let best=null, bestDist=1e9;

    svg.querySelectorAll('.core-district').forEach(el=>{
      const b=el.getBBox(); const pt=svg.createSVGPoint(); pt.x=b.x+b.width/2; pt.y=b.y+b.height/2;
      const s=pt.matrixTransform(el.getScreenCTM()); const d=Math.hypot(center.x-s.x, center.y-s.y);
      const n=el.getAttribute('data-core-name')||getNameFromShape(el);
      if(d<bestDist){ best={el, name:n, s}; bestDist=d; }
    });

    if(best && best.name===name && bestDist<80){
      dragEl.classList.remove('wrong'); dragEl.classList.add('correct');
      dragEl.style.left=(best.s.x - mapbox.getBoundingClientRect().left)+'px';
      dragEl.style.top=(best.s.y  - mapbox.getBoundingClientRect().top )+'px';
      dragEl.style.transform='translate(-50%,-50%)'; dragEl.onpointerdown=null;

      // é‚Šæ¡†é–ƒå…‰
      best.el.classList.add('glow'); setTimeout(()=>best.el.classList.remove('glow'), 800);

      // è‡ªå‹•æ’­æ”¾ æ–°â†’èˆŠï¼ˆé–“éš” 0.6sï¼‰
      playAudio(name);

      solved++; showToast('âœ”ï¸ é…å°æˆåŠŸï¼');
      if(solved>=CORE.length) setTimeout(()=>winSequence(), 600);
    }else{
      dragEl.classList.remove('correct'); dragEl.classList.add('wrong');
      origParent.appendChild(dragEl); dragEl.style.position=''; dragEl.style.left=''; dragEl.style.top=''; dragEl.style.transform='';
    }
    dragEl.classList.remove('dragging'); dragEl=null;
  }

  tray.addEventListener('pointerdown', onDown); mapbox.addEventListener('pointerdown', onDown);
}

/* éŸ³æª”ï¼šæ–° â†’ èˆŠï¼ˆ0.6s é–“éš”ï¼‰ */
function playAudio(name){
  audioNew.src = encodeURI(newSrc(name)); audioOld.src = encodeURI(oldSrc(name));
  audioNew.onended = ()=> setTimeout(()=>audioOld.play().catch(()=>{}), 600);
  audioNew.play().catch(()=>{});
}

/* å‹åˆ©å…©æ®µéŸ³æ•ˆ + æ–‡å­—å‹•ç•« */
function winSequence(){
  winBanner.classList.add('show');
  victory.currentTime=0; victory.play().catch(()=>{});
  setTimeout(()=>{ finish1.currentTime=0; finish1.play().catch(()=>{}); }, 600);
}

/* é‡æ–°é–‹å§‹ */
document.getElementById('btn-restart').addEventListener('click', ()=>window.location.reload());

/* å•Ÿå‹• */
window.addEventListener('load', ()=>{
  // ç­‰ SVG é€² DOM å†è™•ç†
  setTimeout(()=>{ initMap(); buildChips(); }, 60);
});
</script>
</body>
</html>
