<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>高雄市－市中心區新舊地名配對｜v8.0</title>
<style>
  :root{
    --bg: #fbf1e6;            /* 柔米色（維持） */
    --ink: #5b4636;           /* 介面文字 */
    --accent: #f39c5a;        /* 市中心主色（柔和橘） */
    --accent-stroke:#d88443;
    --nonfocus:#ececec;       /* 其他區域淡化 */
    --drop-ok:#22c55e;
    --drop-bad:#ef4444;
  }
  html,body{height:100%;}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
  }
  .wrap{max-width:1000px;margin:0 auto;padding:16px 14px 28px;}
  h1{
    margin:0 0 6px;
    font-size: clamp(20px,4.8vw,32px);
    letter-spacing: .02em;
    font-weight: 900;
  }
  .hint{
    margin:6px 0 10px;
    opacity:.9;
    font-size:clamp(13px,3.6vw,16px);
  }
  .hint .m{opacity:.9}
  .panel{
    position:relative;
    background:#fff;
    border-radius:16px;
    box-shadow: 0 8px 24px rgba(0,0,0,.06);
    padding:10px;
    min-height:56vh;
    overflow:hidden;
  }
  /* SVG 容器 */
  .mapbox{
    position:relative;
    width:100%;
    aspect-ratio: 3/4;  /* 手機直式視覺舒服 */
    background:#fff;
    border-radius:14px;
    overflow:hidden;
    opacity:0;
    transform: translateY(8px);
    animation:fadeIn .6s ease .1s forwards;
  }
  @keyframes fadeIn{
    to{opacity:1;transform:none}
  }

  /* 地圖內樣式（動態加 class） */
  .kao-center{
    fill: var(--accent);
    stroke: var(--accent-stroke);
    stroke-width: 1.4;
  }
  .kao-other{
    fill: var(--nonfocus);
    stroke: #cfcfcf;
    stroke-width: 1.1;
    opacity:.75;
  }
  .glow{
    filter: drop-shadow(0 0 6px rgba(255,160,64,.55));
    animation: ping .8s ease-out 0s 1;
  }
  @keyframes ping{
    0%{filter: drop-shadow(0 0 0 rgba(255,160,64,.0))}
    50%{filter: drop-shadow(0 0 10px rgba(255,160,64,.7))}
    100%{filter: drop-shadow(0 0 0 rgba(255,160,64,.0))}
  }

  /* 地圖上的新地名（固定） */
  .label{
    position:absolute;
    transform: translate(-50%,-50%);
    background: rgba(255,255,255,.9);
    backdrop-filter: blur(2px);
    border:1px solid #e9e9e9;
    border-radius:10px;
    padding:6px 8px;
    font-size: clamp(11px,3.3vw,13px);
    line-height:1.15;
    text-align:center;
    box-shadow: 0 2px 8px rgba(0,0,0,.05);
    pointer-events: none; /* 讓拖曳經過不被擋住 */
    white-space:nowrap;
  }
  .label b{display:block;font-weight:800;letter-spacing:.02em}
  .label span{display:block;color:#7d6a5a;font-weight:600;letter-spacing:.02em}

  /* 下方可拖曳的舊地名卡片 */
  .tray{
    margin-top:12px;
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    justify-content:center;
  }
  .chip{
    user-select:none;
    cursor:grab;
    background:#ffd9a8;
    border:2px solid #f3b777;
    color:#5a3f25;
    padding:10px 14px;
    border-radius:16px;
    box-shadow: 0 3px 10px rgba(0,0,0,.08);
    font-weight:900;
    letter-spacing:.02em;
    min-width:120px;
    text-align:center;
    transition: transform .08s ease;
  }
  .chip:active{cursor:grabbing;transform:scale(.98)}
  .chip small{display:block;font-size:.88em;font-weight:700;opacity:.9}

  .drop{
    position:absolute;
    transform: translate(-50%,-50%);
    width: 44px; height: 44px;
    border-radius: 999px;
    outline:2px dashed rgba(0,0,0,.12);
    outline-offset: 2px;
    background: rgba(255,166,0,.08);
  }
  .drop.ok{outline-color: var(--drop-ok);}
  .drop.bad{outline-color: var(--drop-bad);}
  .drop.done{
    outline:none;background:transparent;
  }

  /* 勝利動畫 */
  .gg{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.7);
    background:rgba(255,255,255,.95);
    border:2px solid #ffe1b8;border-radius:18px;
    padding:18px 22px;
    font-size:28px;font-weight:900;color:#2a8f3a;
    box-shadow:0 12px 30px rgba(0,0,0,.1);
    opacity:0;pointer-events:none;
  }
  .gg.show{animation:pop .9s ease forwards}
  @keyframes pop{
    0%{opacity:0;transform:translate(-50%,-50%) scale(.7)}
    60%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}
    100%{opacity:1;transform:translate(-50%,-50%) scale(1)}
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>高雄市－市中心區新舊地名配對</h1>
    <div class="hint">📱 建議直式觀看效果最佳</div>
    <div class="hint">👇 把「舊地名＋拼音」拖到圖上的正確位置</div>

    <div class="panel">
      <div class="mapbox" id="mapbox"></div>
      <div class="tray" id="tray"></div>
    </div>
  </div>

  <div id="gg" class="gg">有夠 gâu 的！讚啦！</div>

<script>
/* ====== 市中心 11 區資料（與你提供一致） ====== */
const CITY_CENTER = [
  { id:"01", newName:"楠梓", oldName:"楠仔坑", roman:"Lâm-á-khenn" },
  { id:"02", newName:"左營", oldName:"埤仔頭", roman:"Pi-á-thâu" },
  { id:"03", newName:"鼓山", oldName:"打鼓山", roman:"Tánn-kóo-san" },
  { id:"04", newName:"三民", oldName:"三塊厝", roman:"Sann-tè-tshù" },
  { id:"05", newName:"鹽埕", oldName:"鹽埕埔", roman:"Iâm-tiânn-poo" },
  { id:"06", newName:"前金", oldName:"前衿", roman:"Tsiân-khim" },
  { id:"07", newName:"新興", oldName:"逮港埔", roman:"Tāi-káng-poo" },
  { id:"08", newName:"苓雅", oldName:"笭仔寮", roman:"Lîng-á-liâu" },
  { id:"09", newName:"旗津", oldName:"旗後", roman:"Kî-āu" },
  { id:"10", newName:"前鎮", oldName:"前鎮", roman:"Tsiân-tìn" },
  { id:"11", newName:"小港", oldName:"港仔墘", roman:"Káng-á-kînn" },
];
const TITLES = CITY_CENTER.map(x => x.newName + "區");
function newAudioPath(it){ return `map_assets/${it.id}${it.newName}_new.mp3`; }
function oldAudioPath(it){ return `map_assets/${it.id}${it.oldName}_old.mp3`; }
const victorySnd = "map_assets/victory.mp3";
const finishSnd  = "map_assets/finish1.mp3";

let svgEl, solved = 0;

/* 進來就載 svg.txt（強制防快取） */
(async function boot(){
  try {
    const res = await fetch('svg.txt?ts=' + Date.now());
    if (!res.ok) throw new Error('fetch svg.txt fail');
    const txt = await res.text();

    const holder = document.getElementById('mapbox');
    holder.innerHTML = txt;
    svgEl = holder.querySelector('svg');
    if (!svgEl) throw new Error('no <svg> parsed');

    svgEl.style.width  = '100%';
    svgEl.style.height = '100%';
    svgEl.setAttribute('preserveAspectRatio','xMidYMid meet');

    paintAndFocus();       // 著色＋聚焦
    placeLabelsAndDrops(); // 新名標籤＋落點
    buildTray();           // 拖曳卡片
  } catch (e){
    console.error(e);
    alert('載入地圖失敗：請確認 repo 根目錄的 svg.txt 存在。');
  }
})();

/* 直接在原始節點上色；聚焦改「調整 viewBox」 */
function paintAndFocus(){
  const allPaths = svgEl.querySelectorAll('path');
  const centerPaths = [];
  allPaths.forEach(p=>{
    const t = p.querySelector('title')?.textContent?.trim() || '';
    if (TITLES.some(s => t.startsWith(s))){
      p.classList.add('kao-center');
      centerPaths.push(p);
    }else{
      p.classList.add('kao-other');
    }
  });
  if (!centerPaths.length) return;

  // 算市中心聯集 bbox
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  centerPaths.forEach(p=>{
    const b = p.getBBox();
    minX = Math.min(minX, b.x);
    minY = Math.min(minY, b.y);
    maxX = Math.max(maxX, b.x + b.width);
    maxY = Math.max(maxY, b.y + b.height);
  });
  const pad = 20;
  const x = minX - pad, y = minY - pad, w = (maxX-minX)+pad*2, h = (maxY-minY)+pad*2;

  // 以改 viewBox 方式聚焦（最穩定）
  svgEl.setAttribute('viewBox', `${x} ${y} ${w} ${h}`);

  // 閃光一次
  centerPaths.forEach(p=>p.classList.add('glow'));
  setTimeout(()=>centerPaths.forEach(p=>p.classList.remove('glow')), 900);
}

/* 工具：把 SVG 座標轉到畫面座標（放置標籤/落點） */
function svgToScreen(x,y){
  const pt = svgEl.createSVGPoint();
  pt.x = x; pt.y = y;
  return pt.matrixTransform(svgEl.getScreenCTM());
}

/* 新地名固定標籤 + 隱形落點 */
function placeLabelsAndDrops(){
  const holder = document.getElementById('mapbox');
  const make = cls => { const d=document.createElement('div'); d.className=cls; holder.appendChild(d); return d; };

  CITY_CENTER.forEach(it=>{
    const p = [...svgEl.querySelectorAll('path')].find(el=>{
      const t = el.querySelector('title')?.textContent?.trim() || '';
      return t.startsWith(it.newName+'區');
    });
    if (!p) return;
    const b = p.getBBox();
    const mid = svgToScreen(b.x + b.width/2, b.y + b.height/2);

    const lab = make('label');
    lab.style.left = mid.x + 'px';
    lab.style.top  = mid.y + 'px';
    lab.innerHTML = `<b>${it.newName}</b><span>${it.roman}</span>`;

    const drop = make('drop');
    drop.classList.add('drop');
    drop.dataset.id = it.id;
    drop.style.left = mid.x + 'px';
    drop.style.top  = mid.y + 'px';
  });
}

/* 產生拖曳卡片 */
function buildTray(){
  const tray = document.getElementById('tray');
  const shuffled = CITY_CENTER.slice().sort(()=>Math.random()-0.5);
  shuffled.forEach(it=>{
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.draggable = true;
    chip.dataset.id = it.id;
    chip.innerHTML = `${it.oldName}<small>${it.roman}</small>`;
    chip.addEventListener('dragstart', e=>{
      e.dataTransfer.setData('text/plain', it.id);
    });
    tray.appendChild(chip);
  });

  document.querySelectorAll('.drop').forEach(d=>{
    d.addEventListener('dragover', e=>e.preventDefault());
    d.addEventListener('dragenter', ()=>d.classList.add('ok'));
    d.addEventListener('dragleave', ()=>d.classList.remove('ok'));
    d.addEventListener('drop', onDrop);
  });
}

/* 正解流程：區塊閃光 + 播放 新→舊；全部完成播 victory→0.6s→finish1 */
async function onDrop(e){
  e.preventDefault();
  const dropId = e.currentTarget.dataset.id;
  const dragId = e.dataTransfer.getData('text/plain');
  if (!dropId || !dragId) return;

  if (dropId === dragId){
    e.currentTarget.classList.add('done'); e.currentTarget.classList.remove('ok');
    const chip = document.querySelector(`.chip[data-id="${dragId}"]`);
    if (chip){ chip.style.opacity='.55'; chip.style.pointerEvents='none'; }

    const it = CITY_CENTER.find(x=>x.id===dropId);
    const target = [...svgEl.querySelectorAll('path')].find(el=>{
      const t = el.querySelector('title')?.textContent?.trim() || '';
      return t.startsWith(it.newName+'區');
    });
    if (target){ target.classList.add('glow'); setTimeout(()=>target.classList.remove('glow'),800); }

    await playSeq([ newAudioPath(it), oldAudioPath(it) ]);
    solved++;
    if (solved === CITY_CENTER.length){
      const gg = document.getElementById('gg');
      gg.classList.add('show');
      await playSound("map_assets/victory.mp3");
      await new Promise(r=>setTimeout(r,600));
      await playSound("map_assets/finish1.mp3");
    }
  }else{
    e.currentTarget.classList.add('bad');
    setTimeout(()=>e.currentTarget.classList.remove('bad'), 420);
  }
}

/* 音訊工具 */
function playSound(src){
  return new Promise(res=>{
    const a = new Audio(src);
    a.addEventListener('ended', ()=>res(), {once:true});
    a.play().catch(()=>res());
  });
}
function playSeq(list){
  return list.reduce((p,src)=>p.then(()=>playSound(src)), Promise.resolve());
}
</script>
</body>
</html>
