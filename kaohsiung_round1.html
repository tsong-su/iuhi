<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>é«˜é›„å¸‚ï¼å¸‚ä¸­å¿ƒå€æ–°èˆŠåœ°åé…å°</title>
<style>
  :root{
    --bg:#f6eee6;          /* æŸ”ç±³è‰² */
    --ink:#573013;         /* å’–å•¡å¢¨è‰² */
    --accent:#e9934f;      /* æº«æ©˜ */
    --chip:#ffd9ae;
    --ok:#58b368;
    --bad:#e05d5d;
    --dim:#d9d9d9;
  }
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family: "Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif;
  }
  header{padding:20px 16px 8px;font-weight:800;letter-spacing:.04em;font-size:22px}
  .hint{display:flex;gap:.6em;align-items:center;color:#7a563e;padding:0 16px 10px;font-size:14px}
  .stage{
    display:flex;flex-direction:column;gap:14px;
    padding:0 12px 16px;max-width:980px;margin:0 auto;
  }
  .mapwrap{
    position:relative;background:white;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.06);
    height:62vh;min-height:420px;overflow:hidden;
  }
  #mapbox{width:100%;height:100%}
  /* å›ºå®šæ¨™ç±¤ */
  .label{
    position:absolute;transform:translate(-50%,-60%);
    background:rgba(255,255,255,.9);backdrop-filter:saturate(1.2) blur(2px);
    border:1.5px solid rgba(0,0,0,.08);border-radius:10px;padding:6px 10px;text-align:center;pointer-events:none;
    box-shadow:0 4px 10px rgba(0,0,0,.05);
  }
  .label b{font-size:14px;display:block}
  .label span{font-size:12px;opacity:.8}

  /* è½é»ï¼ˆçœ‹ä¸è¦‹ï¼Œåƒ…ç”¨ä¾†æ¥æ”¶ dropï¼‰ */
  .drop{
    position:absolute;width:44px;height:44px;border-radius:50%;
    transform:translate(-50%,-50%);pointer-events:auto;
    border:2px dashed transparent;transition:.15s;
  }
  .drop.ok{border-color:var(--ok);background:rgba(88,179,104,.08)}
  .drop.bad{animation:shake .35s}
  .drop.done{border-color:transparent;background:transparent}

  @keyframes shake{
    10%,90%{transform:translate(-50%,-50%) translateX(-2px)}
    20%,80%{transform:translate(-50%,-50%) translateX(4px)}
    30%,50%,70%{transform:translate(-50%,-50%) translateX(-6px)}
    40%,60%{transform:translate(-50%,-50%) translateX(6px)}
  }

  /* ä¸‹æ–¹æ‰˜ç›¤ */
  #tray{
    display:grid;grid-template-columns:repeat(2,1fr);gap:12px;
    padding-bottom:8px;
  }
  @media (min-width:520px){#tray{grid-template-columns:repeat(3,1fr)}}
  @media (min-width:760px){#tray{grid-template-columns:repeat(4,1fr)}}

  .chip{
    background:var(--chip);border:2px solid rgba(0,0,0,.08);
    border-radius:14px;padding:12px 14px;text-align:center;
    box-shadow:0 3px 10px rgba(0,0,0,.06);cursor:grab;font-weight:700;
  }
  .chip:active{cursor:grabbing}
  .chip small{display:block;font-size:12px;opacity:.9;margin-top:2px}

  /* SVG è‘—è‰²ï¼†æ·¡åŒ–ï¼†é–ƒå…‰ */
  .kao-center{fill:#f6b77e;stroke:#79543b;stroke-width:.9}
  .kao-other{fill:var(--dim);stroke:#a2a2a2;stroke-width:.7;opacity:.35}
  .glow{
    filter:drop-shadow(0 0 0 rgba(255,255,255,0));
    animation:glow 0.85s ease-out 1;
  }
  @keyframes glow{
    0%{filter:drop-shadow(0 0 0 rgba(233,147,79,0))}
    40%{filter:drop-shadow(0 0 10px rgba(233,147,79,.85))}
    100%{filter:drop-shadow(0 0 0 rgba(233,147,79,0))}
  }

  /* å®Œæˆå‹•ç•« */
  #gg{
    position:fixed;inset:auto 0 22vh 0;display:flex;justify-content:center;pointer-events:none;
    opacity:0;transform:scale(.8);transition:opacity .45s ease, transform .45s ease;
  }
  #gg.show{opacity:1;transform:scale(1)}
  #gg .msg{
    background:linear-gradient(180deg,#fff, #ffeede);
    border:2px solid rgba(0,0,0,.08);padding:12px 18px;border-radius:14px;font-weight:900;
    color:#2a7a3f;box-shadow:0 10px 24px rgba(0,0,0,.12);
    animation:pop .9s cubic-bezier(.2,1.2,.2,1) both;
  }
  @keyframes pop{
    0%{transform:scale(.6);opacity:0}
    100%{transform:scale(1);opacity:1}
  }
</style>
</head>
<body>
  <header>é«˜é›„å¸‚ï¼å¸‚ä¸­å¿ƒå€æ–°èˆŠåœ°åé…å°</header>
  <div class="hint">ğŸ“± å»ºè­°ç›´å¼è§€çœ‹æ•ˆæœæœ€ä½³</div>
  <div class="hint">ğŸ‘‰ æŠŠã€ŒèˆŠåœ°åï¼‹æ‹¼éŸ³ã€æ‹–åˆ°åœ–ä¸Šçš„æ­£ç¢ºä½ç½®</div>

  <div class="stage">
    <div class="mapwrap"><div id="mapbox"></div></div>
    <div id="tray"></div>
  </div>

  <div id="gg"><div class="msg">æœ‰å¤  gÃ¢u çš„ï¼è®šå•¦ï¼</div></div>

<script>
/* ====== å¸‚ä¸­å¿ƒ 11 å€è³‡æ–™ï¼ˆä½ çµ¦çš„æ¬Šå¨åå–®ï¼‰ ====== */
const CITY_CENTER = [
  { id:"01", newName:"æ¥ æ¢“", oldName:"æ¥ ä»”å‘", roman:"LÃ¢m-Ã¡-khenn" },
  { id:"02", newName:"å·¦ç‡Ÿ", oldName:"åŸ¤ä»”é ­", roman:"Pi-Ã¡-thÃ¢u" },
  { id:"03", newName:"é¼“å±±", oldName:"æ‰“é¼“å±±", roman:"TÃ¡nn-kÃ³o-san" },
  { id:"04", newName:"ä¸‰æ°‘", oldName:"ä¸‰å¡Šå", roman:"Sann-tÃ¨-tshÃ¹" },
  { id:"05", newName:"é¹½åŸ•", oldName:"é¹½åŸ•åŸ”", roman:"IÃ¢m-tiÃ¢nn-poo" },
  { id:"06", newName:"å‰é‡‘", oldName:"å‰è¡¿", roman:"TsiÃ¢n-khim" },
  { id:"07", newName:"æ–°èˆˆ", oldName:"é€®æ¸¯åŸ”", roman:"TÄi-kÃ¡ng-poo" },
  { id:"08", newName:"è‹“é›…", oldName:"ç¬­ä»”å¯®", roman:"LÃ®ng-Ã¡-liÃ¢u" },
  { id:"09", newName:"æ——æ´¥", oldName:"æ——å¾Œ", roman:"KÃ®-Äu" },
  { id:"10", newName:"å‰é®", oldName:"å‰é®", roman:"TsiÃ¢n-tÃ¬n" },
  { id:"11", newName:"å°æ¸¯", oldName:"æ¸¯ä»”å¢˜", roman:"KÃ¡ng-Ã¡-kÃ®nn" }
];
const TITLES = CITY_CENTER.map(x => x.newName + "å€");
function newAudio(it){ return `map_assets/${it.id}${it.newName}_new.mp3`; }
function oldAudio(it){ return `map_assets/${it.id}${it.oldName}_old.mp3`; }
const victorySnd="map_assets/victory.mp3", finishSnd="map_assets/finish1.mp3";

let svgEl, solved=0;

/* è®€å– repo æ ¹ç›®éŒ„çš„ svg.txtï¼ˆä½ å·²æ”¾å¥½ï¼‰ï¼ŒåŠ  ts å¼·åˆ¶ä¸å¿«å– */
(async function init(){
  try{
    const res = await fetch('svg.txt?ts=' + Date.now());
    if(!res.ok) throw new Error('è¼‰å…¥ svg.txt å¤±æ•—');
    const txt = await res.text();

    const box = document.getElementById('mapbox');
    box.innerHTML = txt;
    svgEl = box.querySelector('svg');
    if(!svgEl) throw new Error('svg è§£æå¤±æ•—');

    svgEl.style.width='100%';
    svgEl.style.height='100%';
    svgEl.setAttribute('preserveAspectRatio','xMidYMid meet');

    paintAndFocus();       // ä¸Šè‰² + èšç„¦å¸‚ä¸­å¿ƒ
    placeLabelsAndDrops(); // æ–°åæ¨™ç±¤ + è½é»
    buildTray();           // ç”¢ç”Ÿæ‹–æ›³å¡ç‰‡
  }catch(err){
    console.error(err);
    alert('æ‰¾ä¸åˆ° svg.txt æˆ–å…§å®¹ä¸å®Œæ•´ï¼šè«‹ç¢ºèªå®ƒåœ¨ repo æ ¹ç›®éŒ„ã€‚');
  }
})();

/* ä¸Šè‰²ï¼šå¸‚ä¸­å¿ƒåŠ äº®ï¼Œå…¶å®ƒæ·¡åŒ–ï¼›èšç„¦ï¼šç”¨ viewBoxï¼ˆæœ€ç©©å®šï¼‰ */
function paintAndFocus(){
  const paths=[...svgEl.querySelectorAll('path')];
  const center=[], others=[];
  paths.forEach(p=>{
    const t = p.querySelector('title')?.textContent?.trim()||'';
    if (TITLES.some(s=>t.startsWith(s))){
      p.classList.add('kao-center'); center.push(p);
    }else{
      p.classList.add('kao-other');  others.push(p);
    }
  });
  if (!center.length) return;

  // ç®—å¸‚ä¸­å¿ƒè¯é›† bbox
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  center.forEach(p=>{const b=p.getBBox();
    minX=Math.min(minX,b.x); minY=Math.min(minY,b.y);
    maxX=Math.max(maxX,b.x+b.width); maxY=Math.max(maxY,b.y+b.height);
  });
  const pad=20, x=minX-pad, y=minY-pad, w=(maxX-minX)+pad*2, h=(maxY-minY)+pad*2;
  svgEl.setAttribute('viewBox',`${x} ${y} ${w} ${h}`);

  // é€²å ´é–ƒå…‰
  center.forEach(p=>p.classList.add('glow'));
  setTimeout(()=>center.forEach(p=>p.classList.remove('glow')),900);
}

/* å·¥å…·ï¼šæŠŠ svg åº§æ¨™è½‰ç•«é¢åº§æ¨™ï¼Œç”¨ä¾†æ“ºæ¨™ç±¤èˆ‡è½é» */
function svgToScreen(x,y){
  const pt=svgEl.createSVGPoint(); pt.x=x; pt.y=y;
  return pt.matrixTransform(svgEl.getScreenCTM());
}

/* æ”¾æ–°åœ°åå›ºå®šæ¨™ç±¤ + è½é» */
function placeLabelsAndDrops(){
  const host=document.getElementById('mapbox');
  const mk=cls=>{const d=document.createElement('div'); d.className=cls; host.appendChild(d); return d;};

  CITY_CENTER.forEach(it=>{
    const p=[...svgEl.querySelectorAll('path')].find(el=>{
      const t=el.querySelector('title')?.textContent?.trim()||'';
      return t.startsWith(it.newName+'å€');
    });
    if(!p) return;
    const b=p.getBBox(), pt=svgToScreen(b.x+b.width/2, b.y+b.height/2);

    const lab=mk('label');
    lab.style.left=pt.x+'px'; lab.style.top=pt.y+'px';
    lab.innerHTML=`<b>${it.newName}</b><span>${it.roman}</span>`;

    const drop=mk('drop');
    drop.dataset.id=it.id;
    drop.style.left=pt.x+'px'; drop.style.top=pt.y+'px';
  });

  // è®“å®¹å™¨ç›¸å°å®šä½ï¼ˆè‹¥ svg ä½”æ»¿ï¼‰
  host.style.position='relative';
}

/* ç”¢ç”Ÿæ‹–æ›³å¡ç‰‡ */
function buildTray(){
  const tray=document.getElementById('tray');
  const shuffled=CITY_CENTER.slice().sort(()=>Math.random()-0.5);
  shuffled.forEach(it=>{
    const chip=document.createElement('div');
    chip.className='chip'; chip.draggable=true; chip.dataset.id=it.id;
    chip.innerHTML=`${it.oldName}<small>${it.roman}</small>`;
    chip.addEventListener('dragstart',e=>{
      e.dataTransfer.setData('text/plain', it.id);
    });
    tray.appendChild(chip);
  });

  document.querySelectorAll('.drop').forEach(d=>{
    d.addEventListener('dragover',e=>e.preventDefault());
    d.addEventListener('dragenter',()=>d.classList.add('ok'));
    d.addEventListener('dragleave',()=>d.classList.remove('ok'));
    d.addEventListener('drop',onDrop);
  });
}

/* åˆ¤å®šï¼šæ­£ç¢ºâ†’æ–°éŸ³æª”â†’èˆŠéŸ³æª”ï¼›å…¨éƒ¨å®Œæˆâ†’victoryâ†’0.6sâ†’finish1ï¼‹è¨Šæ¯ */
async function onDrop(e){
  e.preventDefault();
  const dropId=e.currentTarget.dataset.id;
  const dragId=e.dataTransfer.getData('text/plain');
  if(!dropId||!dragId) return;

  if(dropId===dragId){
    e.currentTarget.classList.add('done'); e.currentTarget.classList.remove('ok');
    const chip=document.querySelector(`.chip[data-id="${dragId}"]`);
    if(chip){ chip.style.opacity='.55'; chip.style.pointerEvents='none'; }

    const it=CITY_CENTER.find(x=>x.id===dropId);
    const tgt=[...svgEl.querySelectorAll('path')].find(el=>{
      const t=el.querySelector('title')?.textContent?.trim()||'';
      return t.startsWith(it.newName+'å€');
    });
    if(tgt){ tgt.classList.add('glow'); setTimeout(()=>tgt.classList.remove('glow'),800); }

    await playSeq([ newAudio(it), oldAudio(it) ]);
    solved++;
    if(solved===CITY_CENTER.length){
      const gg=document.getElementById('gg');
      gg.classList.add('show');
      await playSound(victorySnd);
      await new Promise(r=>setTimeout(r,600));
      await playSound(finishSnd);
    }
  }else{
    e.currentTarget.classList.add('bad');
    setTimeout(()=>e.currentTarget.classList.remove('bad'),420);
  }
}

/* éŸ³è¨Šå·¥å…· */
function playSound(src){
  return new Promise(res=>{
    const a=new Audio(src);
    a.addEventListener('ended',()=>res(),{once:true});
    a.play().catch(()=>res());
  });
}
function playSeq(arr){
  return arr.reduce((p,src)=>p.then(()=>playSound(src)), Promise.resolve());
}
</script>
</body>
</html>
