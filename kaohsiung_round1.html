<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>é«˜é›„å¸‚ï¼å¸‚ä¸­å¿ƒå€æ–°èˆŠåœ°åé…å°ï½œv8.0</title>
<style>
  :root{
    --bg: #fbf1e6;            /* æŸ”ç±³è‰²ï¼ˆç¶­æŒï¼‰ */
    --ink: #5b4636;           /* ä»‹é¢æ–‡å­— */
    --accent: #f39c5a;        /* å¸‚ä¸­å¿ƒä¸»è‰²ï¼ˆæŸ”å’Œæ©˜ï¼‰ */
    --accent-stroke:#d88443;
    --nonfocus:#ececec;       /* å…¶ä»–å€åŸŸæ·¡åŒ– */
    --drop-ok:#22c55e;
    --drop-bad:#ef4444;
  }
  html,body{height:100%;}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
  }
  .wrap{max-width:1000px;margin:0 auto;padding:16px 14px 28px;}
  h1{
    margin:0 0 6px;
    font-size: clamp(20px,4.8vw,32px);
    letter-spacing: .02em;
    font-weight: 900;
  }
  .hint{
    margin:6px 0 10px;
    opacity:.9;
    font-size:clamp(13px,3.6vw,16px);
  }
  .hint .m{opacity:.9}
  .panel{
    position:relative;
    background:#fff;
    border-radius:16px;
    box-shadow: 0 8px 24px rgba(0,0,0,.06);
    padding:10px;
    min-height:56vh;
    overflow:hidden;
  }
  /* SVG å®¹å™¨ */
  .mapbox{
    position:relative;
    width:100%;
    aspect-ratio: 3/4;  /* æ‰‹æ©Ÿç›´å¼è¦–è¦ºèˆ’æœ */
    background:#fff;
    border-radius:14px;
    overflow:hidden;
    opacity:0;
    transform: translateY(8px);
    animation:fadeIn .6s ease .1s forwards;
  }
  @keyframes fadeIn{
    to{opacity:1;transform:none}
  }

  /* åœ°åœ–å…§æ¨£å¼ï¼ˆå‹•æ…‹åŠ  classï¼‰ */
  .kao-center{
    fill: var(--accent);
    stroke: var(--accent-stroke);
    stroke-width: 1.4;
  }
  .kao-other{
    fill: var(--nonfocus);
    stroke: #cfcfcf;
    stroke-width: 1.1;
    opacity:.75;
  }
  .glow{
    filter: drop-shadow(0 0 6px rgba(255,160,64,.55));
    animation: ping .8s ease-out 0s 1;
  }
  @keyframes ping{
    0%{filter: drop-shadow(0 0 0 rgba(255,160,64,.0))}
    50%{filter: drop-shadow(0 0 10px rgba(255,160,64,.7))}
    100%{filter: drop-shadow(0 0 0 rgba(255,160,64,.0))}
  }

  /* åœ°åœ–ä¸Šçš„æ–°åœ°åï¼ˆå›ºå®šï¼‰ */
  .label{
    position:absolute;
    transform: translate(-50%,-50%);
    background: rgba(255,255,255,.9);
    backdrop-filter: blur(2px);
    border:1px solid #e9e9e9;
    border-radius:10px;
    padding:6px 8px;
    font-size: clamp(11px,3.3vw,13px);
    line-height:1.15;
    text-align:center;
    box-shadow: 0 2px 8px rgba(0,0,0,.05);
    pointer-events: none; /* è®“æ‹–æ›³ç¶“éä¸è¢«æ“‹ä½ */
    white-space:nowrap;
  }
  .label b{display:block;font-weight:800;letter-spacing:.02em}
  .label span{display:block;color:#7d6a5a;font-weight:600;letter-spacing:.02em}

  /* ä¸‹æ–¹å¯æ‹–æ›³çš„èˆŠåœ°åå¡ç‰‡ */
  .tray{
    margin-top:12px;
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    justify-content:center;
  }
  .chip{
    user-select:none;
    cursor:grab;
    background:#ffd9a8;
    border:2px solid #f3b777;
    color:#5a3f25;
    padding:10px 14px;
    border-radius:16px;
    box-shadow: 0 3px 10px rgba(0,0,0,.08);
    font-weight:900;
    letter-spacing:.02em;
    min-width:120px;
    text-align:center;
    transition: transform .08s ease;
  }
  .chip:active{cursor:grabbing;transform:scale(.98)}
  .chip small{display:block;font-size:.88em;font-weight:700;opacity:.9}

  .drop{
    position:absolute;
    transform: translate(-50%,-50%);
    width: 44px; height: 44px;
    border-radius: 999px;
    outline:2px dashed rgba(0,0,0,.12);
    outline-offset: 2px;
    background: rgba(255,166,0,.08);
  }
  .drop.ok{outline-color: var(--drop-ok);}
  .drop.bad{outline-color: var(--drop-bad);}
  .drop.done{
    outline:none;background:transparent;
  }

  /* å‹åˆ©å‹•ç•« */
  .gg{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.7);
    background:rgba(255,255,255,.95);
    border:2px solid #ffe1b8;border-radius:18px;
    padding:18px 22px;
    font-size:28px;font-weight:900;color:#2a8f3a;
    box-shadow:0 12px 30px rgba(0,0,0,.1);
    opacity:0;pointer-events:none;
  }
  .gg.show{animation:pop .9s ease forwards}
  @keyframes pop{
    0%{opacity:0;transform:translate(-50%,-50%) scale(.7)}
    60%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}
    100%{opacity:1;transform:translate(-50%,-50%) scale(1)}
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>é«˜é›„å¸‚ï¼å¸‚ä¸­å¿ƒå€æ–°èˆŠåœ°åé…å°</h1>
    <div class="hint">ğŸ“± å»ºè­°ç›´å¼è§€çœ‹æ•ˆæœæœ€ä½³</div>
    <div class="hint">ğŸ‘‡ æŠŠã€ŒèˆŠåœ°åï¼‹æ‹¼éŸ³ã€æ‹–åˆ°åœ–ä¸Šçš„æ­£ç¢ºä½ç½®</div>

    <div class="panel">
      <div class="mapbox" id="mapbox"></div>
      <div class="tray" id="tray"></div>
    </div>
  </div>

  <div id="gg" class="gg">æœ‰å¤  gÃ¢u çš„ï¼è®šå•¦ï¼</div>

<script>
/* -----------------------
   åŸºæœ¬è³‡æ–™ï¼ˆå¸‚ä¸­å¿ƒ 11 å€ï¼‰
------------------------*/
const CITY_CENTER = [
  { id:"01", newName:"æ¥ æ¢“", oldName:"æ¥ ä»”å‘", roman:"LÃ¢m-Ã¡-khenn" },
  { id:"02", newName:"å·¦ç‡Ÿ", oldName:"åŸ¤ä»”é ­", roman:"Pi-Ã¡-thÃ¢u" },
  { id:"03", newName:"é¼“å±±", oldName:"æ‰“é¼“å±±", roman:"TÃ¡nn-kÃ³o-san" },
  { id:"04", newName:"ä¸‰æ°‘", oldName:"ä¸‰å¡Šå", roman:"Sann-tÃ¨-tshÃ¹" },
  { id:"05", newName:"é¹½åŸ•", oldName:"é¹½åŸ•åŸ”", roman:"IÃ¢m-tiÃ¢nn-poo" },
  { id:"06", newName:"å‰é‡‘", oldName:"å‰è¡¿", roman:"TsiÃ¢n-khim" },
  { id:"07", newName:"æ–°èˆˆ", oldName:"é€®æ¸¯åŸ”", roman:"TÄi-kÃ¡ng-poo" },
  { id:"08", newName:"è‹“é›…", oldName:"ç¬­ä»”å¯®", roman:"LÃ®ng-Ã¡-liÃ¢u" },
  { id:"09", newName:"æ——æ´¥", oldName:"æ——å¾Œ", roman:"KÃ®-Äu" },
  { id:"10", newName:"å‰é®", oldName:"å‰é®", roman:"TsiÃ¢n-tÃ¬n" },
  { id:"11", newName:"å°æ¸¯", oldName:"æ¸¯ä»”å¢˜", roman:"KÃ¡ng-Ã¡-kÃ®nn" },
];
// æ–¹ä¾¿æ¯”å° <title> æ–‡å­—ï¼ˆsvg è£¡é€šå¸¸æ˜¯ã€Œå°æ¸¯å€ Xiaogang Districtã€ï¼‰
const CITY_CENTER_TITLES = CITY_CENTER.map(x => x.newName + "å€");

/* éŸ³æª”ä½ç½®ï¼ˆè«‹æ”¾åœ¨ repo çš„ map_assets/ï¼‰ */
function newAudioPath(item){ return `map_assets/${item.id}${item.newName}_new.mp3`; }
function oldAudioPath(item){ return `map_assets/${item.id}${item.oldName}_old.mp3`; }
const victorySnd = "map_assets/victory.mp3";
const finishSnd  = "map_assets/finish1.mp3";

let svgEl, svgRoot, zoomLayer;
let solved = 0;

/* -----------------------
   è¼‰å…¥ svg.txt ä¸¦æ³¨å…¥
------------------------*/
(async function boot(){
  try{
    const res = await fetch('svg.txt', {cache:'no-store'});
    const txt = await res.text();
    const holder = document.getElementById('mapbox');
    holder.innerHTML = txt;                       // ç›´æ¥æŠŠæ•´å€‹ <svg> è²¼é€²ä¾†
    svgEl  = holder.querySelector('svg');
    svgRoot= svgEl; // æ ¹ svg
    svgEl.style.width = '100%';
    svgEl.style.height = '100%';

    // å»ºä¸€å±¤åŒ…ä½å…¨éƒ¨ï¼Œæ–¹ä¾¿ transform
    zoomLayer = document.createElementNS('http://www.w3.org/2000/svg','g');
    while (svgEl.firstChild) zoomLayer.appendChild(svgEl.firstChild);
    svgEl.appendChild(zoomLayer);
    zoomLayer.setAttribute('id','zoomLayer');

    paintAndFocus();
    placeLabelsAndDrops();
    buildTray();
  }catch(e){
    console.error(e);
    alert('è®€å– svg.txt å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆåœ¨ repo æ ¹ç›®éŒ„ã€‚');
  }
})();

/* -----------------------
   è‘—è‰² & èšç„¦å¸‚ä¸­å¿ƒ
------------------------*/
function paintAndFocus(){
  // èµ°è¨ªæ‰€æœ‰ pathï¼Œä¾ title åˆ¤æ–·æ˜¯å¦å¸‚ä¸­å¿ƒ
  const paths = zoomLayer.querySelectorAll('path');
  const centerPaths = [];
  paths.forEach(p=>{
    const title = p.querySelector('title')?.textContent?.trim() || '';
    let isCenter = CITY_CENTER_TITLES.some(t => title.startsWith(t));
    if(isCenter){
      p.classList.add('kao-center');
      centerPaths.push(p);
    }else{
      p.classList.add('kao-other');
    }
  });

  // èšåˆå¸‚ä¸­å¿ƒçš„ bbox
  let minX= Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
  centerPaths.forEach(p=>{
    const b = p.getBBox();
    minX = Math.min(minX, b.x);
    minY = Math.min(minY, b.y);
    maxX = Math.max(maxX, b.x + b.width);
    maxY = Math.max(maxY, b.y + b.height);
  });
  const padding = 20; // å…§è·
  const box = { x:minX-padding, y:minY-padding, width:(maxX-minX)+padding*2, height:(maxY-minY)+padding*2 };

  // æŠŠå¸‚ä¸­å¿ƒæ”¾å¤§åˆ°æ»¿ç‰ˆ
  const vb = svgEl.viewBox.baseVal;     // å…¨åœ–åº§æ¨™ç³»
  const viewW = vb && vb.width  ? vb.width  : svgEl.getBBox().width;
  const viewH = vb && vb.height ? vb.height : svgEl.getBBox().height;

  const sx = viewW / box.width;
  const sy = viewH / box.height;
  const scale = Math.min(sx, sy) * 0.92; // è®“é‚Šç·£ç•™ä¸€é»ç©ºé–“

  const cx = box.x + box.width/2;
  const cy = box.y + box.height/2;

  // å¹³ç§»ä½¿å¸‚ä¸­å¿ƒç½®ä¸­ï¼Œå†ç¸®æ”¾
  const tx = viewW/2 - cx*scale;
  const ty = viewH/2 - cy*scale;

  zoomLayer.setAttribute('transform', `translate(${tx},${ty}) scale(${scale})`);

  // åˆå§‹é–ƒä¸€ä¸‹ï¼ˆæ•´é«”ï¼‰
  centerPaths.forEach(p=>p.classList.add('glow'));
  setTimeout(()=>centerPaths.forEach(p=>p.classList.remove('glow')), 900);
}

/* -----------------------
   åœ¨åœ°åœ–ä¸Šæ”¾ã€Œæ–°åœ°åå›ºå®šæ¨™ç±¤ã€+ã€Œéš±å½¢è½é»ã€
------------------------*/
function svgPointToClient(svg, x, y){
  const pt = svg.createSVGPoint();
  pt.x = x; pt.y = y;
  const ctm = svg.getScreenCTM();
  return pt.matrixTransform(ctm);
}

function placeLabelsAndDrops(){
  const holder = document.getElementById('mapbox');
  const mk = (cls)=>{ const d=document.createElement('div'); d.className=cls; holder.appendChild(d); return d; }

  CITY_CENTER.forEach(item=>{
    // æ‰¾å°æ‡‰ path
    const p = Array.from(zoomLayer.querySelectorAll('path'))
      .find(el => {
        const t=el.querySelector('title')?.textContent?.trim()||'';
        return t.startsWith(item.newName+'å€');
      });
    if(!p) return;

    // ç”¨ path bbox ä¸­å¿ƒç•¶åº§æ¨™
    const b = p.getBBox();
    const mid = svgPointToClient(svgEl, b.x + b.width/2, b.y + b.height/2);

    // æ–°åœ°åæ¨™ç±¤ï¼ˆå›ºå®šï¼‰
    const lab = mk('label');
    lab.style.left = mid.x+'px';
    lab.style.top  = mid.y+'px';
    lab.innerHTML = `<b>${item.newName}</b><span>${item.roman}</span>`;

    // è½é»ï¼ˆéš±å½¢åœ“å½¢ï¼Œä¾›åˆ¤å®šï¼‰
    const drop = mk('drop');
    drop.classList.add('drop');
    drop.dataset.id = item.id;
    drop.style.left = mid.x+'px';
    drop.style.top  = mid.y+'px';
  },0);
}

/* -----------------------
   ç”¢ç”Ÿå¯æ‹–æ›³çš„èˆŠåœ°åå¡ç‰‡
------------------------*/
function buildTray(){
  const tray = document.getElementById('tray');
  // éš¨æ©Ÿæ’åº
  const arr = CITY_CENTER.slice().sort(()=>Math.random()-0.5);
  arr.forEach(item=>{
    const chip = document.createElement('div');
    chip.className='chip';
    chip.setAttribute('draggable','true');
    chip.dataset.id = item.id;
    chip.innerHTML = `${item.oldName}<small>${item.roman}</small>`;
    chip.addEventListener('dragstart', onDragStart);
    tray.appendChild(chip);
  });

  // ç›£è½æ‹–æ”¾
  document.querySelectorAll('.drop').forEach(d=>{
    d.addEventListener('dragover', e=>{ e.preventDefault(); });
    d.addEventListener('dragenter', e=>{ e.preventDefault(); d.classList.add('ok'); });
    d.addEventListener('dragleave', e=>{ d.classList.remove('ok'); });
    d.addEventListener('drop', onDrop);
  });
}

let draggingId = null;
function onDragStart(e){
  draggingId = e.target.dataset.id;
  e.dataTransfer.setData('text/plain', draggingId);
}

/* æ­£è§£å¾Œï¼šæ’­æ”¾ã€Œæ–°â†’èˆŠã€ï¼Œå…¨éƒ¨å®Œæˆå† victory â†’ 0.6s â†’ finish1 */
async function handleCorrect(dropEl, chipEl){
  dropEl.classList.add('done'); dropEl.classList.remove('ok','bad');
  chipEl.style.pointerEvents='none';
  chipEl.style.opacity='.55';
  chipEl.style.transform='scale(.96)';

  const item = CITY_CENTER.find(x=>x.id===dropEl.dataset.id);

  // è®“å°æ‡‰å€å¡Šé–ƒä¸€ä¸‹
  const targetPath = Array.from(zoomLayer.querySelectorAll('path')).find(el=>{
    const t=el.querySelector('title')?.textContent?.trim()||'';
    return t.startsWith(item.newName+'å€');
  });
  if(targetPath){ targetPath.classList.add('glow'); setTimeout(()=>targetPath.classList.remove('glow'),800); }

  // æ’­æ”¾ æ–°â†’èˆŠ
  await playSeq([ newAudioPath(item), oldAudioPath(item) ]);

  solved++;
  if(solved===CITY_CENTER.length){
    // å…¨éƒ¨å®Œæˆ
    const gg = document.getElementById('gg');
    gg.classList.add('show');
    await playSound(victorySnd);
    await wait(600);
    await playSound(finishSnd);
  }
}
function onDrop(e){
  e.preventDefault();
  const dropId = e.currentTarget.dataset.id;
  const dragId = draggingId || e.dataTransfer.getData('text/plain');
  if(!dropId || !dragId) return;

  if(dropId===dragId){
    handleCorrect(e.currentTarget, document.querySelector(`.chip[data-id="${dragId}"]`));
  }else{
    e.currentTarget.classList.remove('ok');
    e.currentTarget.classList.add('bad');
    setTimeout(()=>e.currentTarget.classList.remove('bad'), 450);
  }
}

/* -----------------------
   éŸ³è¨Šå·¥å…·
------------------------*/
function playSound(src){
  return new Promise((resolve)=>{
    const a = new Audio(src);
    a.addEventListener('ended', ()=>resolve(), {once:true});
    a.play().catch(()=>resolve());
  });
}
function playSeq(list){
  return list.reduce((p,src)=>p.then(()=>playSound(src)), Promise.resolve());
}
const wait = (ms)=>new Promise(r=>setTimeout(r,ms));
</script>
</body>
</html>
