<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>高雄市－市中心區新舊地名配對（v8.2）</title>
<style>
  :root{
    --bg:#f6ecdf;          /* 柔米色 */
    --ink:#4a2e1a;         /* 深咖啡字 */
    --ink2:#6c4730;
    --accent:#e9aa6a;      /* 橘金 */
    --accent-weak:#ffdcb8;
    --ok:#22a06b;
    --shadow: 0 8px 20px rgba(0,0,0,.08);
    --shadow-soft: 0 4px 12px rgba(0,0,0,.06);
  }
  html,body{height:100%;background:var(--bg);color:var(--ink);margin:0;font-family: "Noto Sans TC", system-ui, -apple-system, "Segoe UI", Roboto, "PingFang TC", "Microsoft Jhenghei", sans-serif;}
  .wrap{max-width:1100px;margin:0 auto;padding:16px 14px 28px;}
  h1{font-size: clamp(20px, 3.8vw, 34px); margin:4px 0 10px; letter-spacing:.04em;}
  .hint{display:flex;gap:10px;align-items:center;color:var(--ink2);opacity:.9;margin:6px 0 8px;font-size:clamp(13px,2.8vw,16px)}
  .hint i{font-style:normal}
  .sub{margin:2px 0 12px; font-size:clamp(13px,2.9vw,17px)}
  .board{background:#fff; border-radius:20px; box-shadow:var(--shadow); padding:10px; height: min(68vh, 72dvh); display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden}
  /* 讓 SVG 與外框滿版 */
  #mapbox{position:relative; width:100%; height:100%;}
  #mapbox svg{width:100%; height:100%;}
  /* 其他區域淡化 */
  .dim{fill:#f3f3f3 !important; stroke:#cfcfcf !important; opacity:1}
  .centerPath{fill:url(#cityGrad); stroke:#7a5a42; stroke-width:1;}
  /* 固定的新地名文字（在 SVG 裡畫） */
  text.nameLabel{font-weight:700; fill:#6a3f1f; font-size:13px; text-anchor:middle; paint-order:stroke; stroke:#fff; stroke-width:3; stroke-linejoin:round}
  /* 放置點（看不太到，方便拖曳對準） */
  .dropDot{fill:rgba(255,165,0,.0001); cursor:copy}
  /* 下面的可拖曳舊地名磚 */
  .tray{margin-top:14px; display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
  @media (min-width:700px){ .tray{grid-template-columns:repeat(3,1fr)} }
  @media (min-width:960px){ .tray{grid-template-columns:repeat(4,1fr)} }
  .tile{
    background:var(--accent-weak);
    border:2px solid #f3c38b;
    border-radius:18px;
    padding:12px 14px;
    box-shadow:var(--shadow-soft);
    user-select:none; touch-action:none;
  }
  .zh{font-weight:800; font-size:18px;}
  .ro{margin-top:2px; font-size:14px; color:#834f27}
  .tile.dragging{opacity:.75; transform:scale(.98)}
  .tile.correct{background:#e7ffe6; border-color:#b7f0c7}
  /* 勝利標語 */
  .victory{
    position:fixed; inset:0; display:none; place-items:center; z-index:30;
    background:rgba(255,255,255,.0);
  }
  .victory.show{display:grid; animation:fade .6s ease both}
  .victory h2{
    font-size: clamp(34px, 9vw, 68px); color:#0a7c53; 
    text-shadow:0 10px 30px rgba(0,0,0,.15);
    animation:pop .9s cubic-bezier(.2,1.2,.2,1) both;
  }
  @keyframes pop{ from{transform:scale(.6); opacity:.0} 50%{transform:scale(1.08)} to{transform:scale(1); opacity:1}}
  @keyframes fade{ from{opacity:0} to{opacity:1}}
  /* 淡入地圖 */
  .appear{animation:appear .55s ease both}
  @keyframes appear{ from{opacity:0; transform:scale(.98)} to{opacity:1; transform:scale(1)}}
</style>
</head>
<body>
  <div class="wrap">
    <h1>高雄市－市中心區新舊地名配對</h1>
    <div class="hint"><i>📱</i> 建議直式觀看效果最佳</div>
    <div class="sub">👉 把「舊地名＋拼音」拖到圖上的正確位置</div>

    <div class="board">
      <div id="mapbox" class="appear"><!-- 這裡動態載入 svg.txt 並自動聚焦市中心 --></div>
    </div>

    <div id="tray" class="tray" aria-label="可拖曳的舊地名"></div>
  </div>

  <div class="victory" id="victory">
    <h2>有夠 gâu 的！讚啦！</h2>
  </div>

<script>
(()=>{
  const cityCenter = [
    { id:"01", newC:"楠梓區", oldC:"楠仔坑", newKey:"楠梓",   oldKey:"楠仔坑",  roman:"Lâm-á-khenn", audioNew:"01楠梓_new.mp3",  audioOld:"01楠仔坑_old.mp3" },
    { id:"02", newC:"左營區", oldC:"埤仔頭", newKey:"左營",   oldKey:"埤仔頭",  roman:"Pi-á-thâu",     audioNew:"02左營_new.mp3",  audioOld:"02埤仔頭_old.mp3" },
    { id:"03", newC:"鼓山區", oldC:"打鼓山", newKey:"鼓山",   oldKey:"打鼓山",  roman:"Tánn-kóo-san",  audioNew:"03鼓山_new.mp3",  audioOld:"03打鼓山_old.mp3" },
    { id:"04", newC:"三民區", oldC:"三塊厝", newKey:"三民",   oldKey:"三塊厝",  roman:"Sann-tè-tshù",  audioNew:"04三民_new.mp3",  audioOld:"04三塊厝_old.mp3" },
    { id:"05", newC:"鹽埕區", oldC:"鹽埕埔", newKey:"鹽埕",   oldKey:"鹽埕埔",  roman:"Iâm-tiânn-poo", audioNew:"05鹽埕_new.mp3",  audioOld:"05鹽埕埔_old.mp3" },
    { id:"06", newC:"前金區", oldC:"前衿",   newKey:"前金",   oldKey:"前衿",    roman:"Tsiân-khim",    audioNew:"06前金_new.mp3",  audioOld:"06前衿_old.mp3" },
    { id:"07", newC:"新興區", oldC:"逮港埔", newKey:"新興",   oldKey:"逮港埔",  roman:"Tâi-káng-poo",  audioNew:"07新興_new.mp3",  audioOld:"07逮港埔_old.mp3" },
    { id:"08", newC:"苓雅區", oldC:"笭仔寮", newKey:"苓雅",   oldKey:"笭仔寮",  roman:"Lîng-á-liâu",   audioNew:"08苓雅_new.mp3",  audioOld:"08笭仔寮_old.mp3" },
    { id:"09", newC:"旗津區", oldC:"旗後",   newKey:"旗津",   oldKey:"旗後",    roman:"Kî-āu",         audioNew:"09旗津_new.mp3",  audioOld:"09旗後_old.mp3" },
    { id:"10", newC:"前鎮區", oldC:"前鎮",   newKey:"前鎮",   oldKey:"前鎮",    roman:"Tsiân-tìn",     audioNew:"10前鎮_new.mp3",  audioOld:"10前鎮_old.mp3" },
    { id:"11", newC:"小港區", oldC:"港仔墘", newKey:"小港",   oldKey:"港仔墘",  roman:"Káng-á-kînn",   audioNew:"11小港_new.mp3",  audioOld:"11港仔墘_old.mp3" }
  ];

  const mapBox = document.getElementById('mapbox');
  const tray = document.getElementById('tray');
  const V = (p)=> new URL(`map_assets/${p}`, location.href).href;

  // 產生拖曳磚（亂序）
  function fisherYates(arr){
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  function buildTray(){
    tray.innerHTML='';
    for(const it of fisherYates([...cityCenter])){
      const div=document.createElement('div');
      div.className='tile'; div.draggable=true; div.dataset.id=it.id;
      div.innerHTML=`<div class="zh">${it.oldKey}</div><div class="ro">${it.roman}</div>`;
      tray.appendChild(div);
    }
  }

  // 載入 svg.txt → 聚焦市中心、淡化其他、加新地名標籤與 drop 點
  let topSvg, placed=0, total=cityCenter.length;
  const placedSet=new Set();

  async function loadSVG(){
    const res = await fetch('svg.txt',{cache:'no-store'});
    const text = await res.text();
    mapBox.innerHTML = text;              // 直接塞入
    topSvg = mapBox.querySelector('svg');
    if(!topSvg){ mapBox.innerHTML='<p style="padding:18px;color:#b00">找不到 SVG，請確認 svg.txt 放在網站根目錄。</p>'; return; }
    // 讓 SVG 可自適應
    topSvg.removeAttribute('width'); topSvg.removeAttribute('height');
    topSvg.setAttribute('preserveAspectRatio','xMidYMid meet');
    topSvg.style.width='100%'; topSvg.style.height='100%';

    // 找出所有 path 與其 <title>
    /** titleText(pathEl) */
    const titleText = el=>{
      const t = el.querySelector('title');
      return t ? t.textContent.trim() : '';
    };

    const paths = Array.from(topSvg.querySelectorAll('path'));
    // 依新地名決定市中心 path
    const setIDs = new Set(cityCenter.map(x=>x.newC));
    const centerPaths = paths.filter(p=> setIDs.has(titleText(p)));
    const others = paths.filter(p=> !setIDs.has(titleText(p)));

    // 標記外觀
    // 加漸層
    let defs = topSvg.querySelector('defs') || topSvg.insertBefore(document.createElementNS('http://www.w3.org/2000/svg','defs'), topSvg.firstChild);
    const grad = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
    grad.id='cityGrad'; grad.setAttribute('x1','0');grad.setAttribute('x2','0');grad.setAttribute('y1','0');grad.setAttribute('y2','1');
    grad.innerHTML='<stop offset="0%" stop-color="#ffd29f"/><stop offset="100%" stop-color="#f0a45f"/>';
    defs.appendChild(grad);

    centerPaths.forEach(p=> p.classList.add('centerPath'));
    others.forEach(p=> p.classList.add('dim'));

    // 設定 data-id 對應，方便驗證
    centerPaths.forEach(p=>{
      const t=titleText(p).replace('區','');
      const found = cityCenter.find(c=>c.newKey===t);
      if(found){ p.dataset.id=found.id; }
    });

    // 計算市中心聯合 BBox，設為 viewBox（自動聚焦＆在手機滿版）
    const bbox = unionBBox(centerPaths);
    const pad = Math.max(bbox.width, bbox.height)*0.12;
    const vb = [bbox.x-pad, bbox.y-pad, bbox.width+pad*2, bbox.height+pad*2].join(' ');
    topSvg.setAttribute('viewBox', vb);

    // 在 SVG 上加固定的新地名標籤與 drop 點
    addNameLabelsAndDrops(centerPaths);

    // 可點擊微閃爍：再次強調市中心（也可當「再聚焦」）
    topSvg.addEventListener('click', ()=>{
      topSvg.classList.remove('appear');
      void topSvg.offsetWidth; // reflow
      topSvg.classList.add('appear');
    }, {passive:true});
  }

  function unionBBox(els){
    // 需在 DOM 且可視
    let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
    els.forEach(el=>{
      const b=el.getBBox();
      minX=Math.min(minX,b.x);
      minY=Math.min(minY,b.y);
      maxX=Math.max(maxX,b.x+b.width);
      maxY=Math.max(maxY,b.y+b.height);
    });
    return {x:minX,y:minY,width:maxX-minX,height:maxY-minY};
  }

  function addNameLabelsAndDrops(centerPaths){
    const gLabel = document.createElementNS('http://www.w3.org/2000/svg','g');
    gLabel.setAttribute('id','nameLabels');
    topSvg.appendChild(gLabel);

    const gDrop = document.createElementNS('http://www.w3.org/2000/svg','g');
    gDrop.setAttribute('id','dropDots');
    topSvg.appendChild(gDrop);

    // 先依 y 排序，避免重疊，套用輕微錯位
    const items = centerPaths.map(p=>{
      const t = p.querySelector('title').textContent.trim().replace('區','');
      const found = cityCenter.find(x=>x.newKey===t);
      const b = p.getBBox();
      return {el:p, cx:b.x + b.width/2, cy:b.y + b.height/2, t, id:found?.id};
    }).sort((a,b)=> a.cy - b.cy);

    // 逐一錯位
    const dy = 12;
    for(let i=1;i<items.length;i++){
      if(Math.abs(items[i].cy - items[i-1].cy) < 18){
        items[i].cy += dy;
      }
    }

    // 畫 label 與 drop
    for(const it of items){
      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.classList.add('nameLabel');
      label.setAttribute('x', it.cx);
      label.setAttribute('y', it.cy);
      label.textContent = it.t; // 新地名（固定顯示）
      gLabel.appendChild(label);

      const drop = document.createElementNS('http://www.w3.org/2000/svg','circle');
      drop.classList.add('dropDot');
      drop.setAttribute('r','16');
      drop.setAttribute('cx', it.cx);
      drop.setAttribute('cy', it.cy+16);
      drop.dataset.id = it.id;
      gDrop.appendChild(drop);
    }
  }

  // ---- 拖曳互動（手機/桌機） ----
  let dragging=null;

  function bindDrag(){
    tray.querySelectorAll('.tile').forEach(tile=>{
      tile.addEventListener('dragstart', e=>{
        dragging=tile;
        tile.classList.add('dragging');
        e.dataTransfer.setData('text/plain', tile.dataset.id);
        e.dataTransfer.effectAllowed='move';
      });
      tile.addEventListener('dragend', ()=>{ dragging=null; tile.classList.remove('dragging'); });
    });

    mapBox.addEventListener('dragover', e=>{
      e.preventDefault();
      e.dataTransfer.dropEffect='move';
    });
    mapBox.addEventListener('drop', e=>{
      e.preventDefault();
      if(!dragging) return;
      const id = dragging.dataset.id;
      // 找最靠近的 dropDot
      const svgP = clientToSvg(e.clientX,e.clientY);
      const dots = Array.from(topSvg.querySelectorAll('.dropDot'));
      let hit=null, best=9999;
      for(const d of dots){
        const dx = svgP.x - (+d.getAttribute('cx'));
        const dy = svgP.y - (+d.getAttribute('cy'));
        const dist = Math.hypot(dx,dy);
        if(dist<best){best=dist; hit=d;}
      }
      if(hit && hit.dataset.id===id){
        onCorrect(id, dragging, hit);
      }
    }, {passive:false});

    // 手機支援（pointer）
    tray.querySelectorAll('.tile').forEach(tile=>{
      tile.addEventListener('pointerdown', e=>{
        if(e.pointerType==='mouse') return; // 由 HTML5 drag 負責
        dragging = tile; tile.setPointerCapture(e.pointerId); tile.classList.add('dragging');
      });
      tile.addEventListener('pointerup', e=>{
        if(!dragging || e.pointerType==='mouse') return;
        // 將 pointer 位置投影到 SVG
        const pt = clientToSvg(e.clientX,e.clientY);
        const dots = Array.from(topSvg.querySelectorAll('.dropDot'));
        let hit=null, best=9999;
        for(const d of dots){
          const dx = pt.x - (+d.getAttribute('cx'));
          const dy = pt.y - (+d.getAttribute('cy'));
          const dist = Math.hypot(dx,dy);
          if(dist<best){best=dist; hit=d;}
        }
        if(hit && hit.dataset.id===tile.dataset.id){
          onCorrect(tile.dataset.id, tile, hit);
        }
        dragging.classList.remove('dragging'); dragging=null;
      });
    });
  }

  function clientToSvg(cx,cy){
    const pt = topSvg.createSVGPoint();
    pt.x=cx; pt.y=cy;
    return pt.matrixTransform(topSvg.getScreenCTM().inverse());
  }

  function onCorrect(id, tile, dot){
    if(placedSet.has(id)) return;
    placedSet.add(id);
    tile.classList.add('correct');
    tile.style.pointerEvents='none';

    // 在 drop 的位置塞入舊地名小標籤（SVG text）
    const info = cityCenter.find(x=>x.id===id);
    const g = topSvg.querySelector('#nameLabels');
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.classList.add('nameLabel');
    t.setAttribute('x', dot.getAttribute('cx'));
    t.setAttribute('y', +dot.getAttribute('cy') + 18);
    t.style.fill = '#8b3f00';
    t.textContent = info.oldKey + ' · ' + info.roman;
    g.appendChild(t);

    // 播放新→舊
    playChain([V(info.audioNew), V(info.audioOld)]);

    placed++;
    if(placed===total){
      // 勝利
      setTimeout(()=>{
        playChain([V('victory.mp3'), V('finish1.mp3')]);
        const v=document.getElementById('victory');
        v.classList.add('show');
        setTimeout(()=> v.classList.remove('show'), 2000);
      }, 50);
    }
  }

  function playChain(urls){
    const audio = new Audio();
    let i=0;
    audio.addEventListener('ended', ()=>{
      i++;
      if(i<urls.length){ audio.src=urls[i]; audio.play(); }
    });
    audio.src=urls[0]; audio.play();
  }

  // 啟動
  (async function init(){
    buildTray();
    bindDrag();
    await loadSVG();
  })();
})();
</script>
</body>
</html>
