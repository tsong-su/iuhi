<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>é«˜é›„å¸‚ï¼å¸‚ä¸­å¿ƒå€æ–°èˆŠåœ°åé…å°ï¼ˆv8.2ï¼‰</title>
<style>
  :root{
    --bg:#f6ecdf;          /* æŸ”ç±³è‰² */
    --ink:#4a2e1a;         /* æ·±å’–å•¡å­— */
    --ink2:#6c4730;
    --accent:#e9aa6a;      /* æ©˜é‡‘ */
    --accent-weak:#ffdcb8;
    --ok:#22a06b;
    --shadow: 0 8px 20px rgba(0,0,0,.08);
    --shadow-soft: 0 4px 12px rgba(0,0,0,.06);
  }
  html,body{height:100%;background:var(--bg);color:var(--ink);margin:0;font-family: "Noto Sans TC", system-ui, -apple-system, "Segoe UI", Roboto, "PingFang TC", "Microsoft Jhenghei", sans-serif;}
  .wrap{max-width:1100px;margin:0 auto;padding:16px 14px 28px;}
  h1{font-size: clamp(20px, 3.8vw, 34px); margin:4px 0 10px; letter-spacing:.04em;}
  .hint{display:flex;gap:10px;align-items:center;color:var(--ink2);opacity:.9;margin:6px 0 8px;font-size:clamp(13px,2.8vw,16px)}
  .hint i{font-style:normal}
  .sub{margin:2px 0 12px; font-size:clamp(13px,2.9vw,17px)}
  .board{background:#fff; border-radius:20px; box-shadow:var(--shadow); padding:10px; height: min(68vh, 72dvh); display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden}
  /* è®“ SVG èˆ‡å¤–æ¡†æ»¿ç‰ˆ */
  #mapbox{position:relative; width:100%; height:100%;}
  #mapbox svg{width:100%; height:100%;}
  /* å…¶ä»–å€åŸŸæ·¡åŒ– */
  .dim{fill:#f3f3f3 !important; stroke:#cfcfcf !important; opacity:1}
  .centerPath{fill:url(#cityGrad); stroke:#7a5a42; stroke-width:1;}
  /* å›ºå®šçš„æ–°åœ°åæ–‡å­—ï¼ˆåœ¨ SVG è£¡ç•«ï¼‰ */
  text.nameLabel{font-weight:700; fill:#6a3f1f; font-size:13px; text-anchor:middle; paint-order:stroke; stroke:#fff; stroke-width:3; stroke-linejoin:round}
  /* æ”¾ç½®é»ï¼ˆçœ‹ä¸å¤ªåˆ°ï¼Œæ–¹ä¾¿æ‹–æ›³å°æº–ï¼‰ */
  .dropDot{fill:rgba(255,165,0,.0001); cursor:copy}
  /* ä¸‹é¢çš„å¯æ‹–æ›³èˆŠåœ°åç£š */
  .tray{margin-top:14px; display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
  @media (min-width:700px){ .tray{grid-template-columns:repeat(3,1fr)} }
  @media (min-width:960px){ .tray{grid-template-columns:repeat(4,1fr)} }
  .tile{
    background:var(--accent-weak);
    border:2px solid #f3c38b;
    border-radius:18px;
    padding:12px 14px;
    box-shadow:var(--shadow-soft);
    user-select:none; touch-action:none;
  }
  .zh{font-weight:800; font-size:18px;}
  .ro{margin-top:2px; font-size:14px; color:#834f27}
  .tile.dragging{opacity:.75; transform:scale(.98)}
  .tile.correct{background:#e7ffe6; border-color:#b7f0c7}
  /* å‹åˆ©æ¨™èª */
  .victory{
    position:fixed; inset:0; display:none; place-items:center; z-index:30;
    background:rgba(255,255,255,.0);
  }
  .victory.show{display:grid; animation:fade .6s ease both}
  .victory h2{
    font-size: clamp(34px, 9vw, 68px); color:#0a7c53; 
    text-shadow:0 10px 30px rgba(0,0,0,.15);
    animation:pop .9s cubic-bezier(.2,1.2,.2,1) both;
  }
  @keyframes pop{ from{transform:scale(.6); opacity:.0} 50%{transform:scale(1.08)} to{transform:scale(1); opacity:1}}
  @keyframes fade{ from{opacity:0} to{opacity:1}}
  /* æ·¡å…¥åœ°åœ– */
  .appear{animation:appear .55s ease both}
  @keyframes appear{ from{opacity:0; transform:scale(.98)} to{opacity:1; transform:scale(1)}}
</style>
</head>
<body>
  <div class="wrap">
    <h1>é«˜é›„å¸‚ï¼å¸‚ä¸­å¿ƒå€æ–°èˆŠåœ°åé…å°</h1>
    <div class="hint"><i>ğŸ“±</i> å»ºè­°ç›´å¼è§€çœ‹æ•ˆæœæœ€ä½³</div>
    <div class="sub">ğŸ‘‰ æŠŠã€ŒèˆŠåœ°åï¼‹æ‹¼éŸ³ã€æ‹–åˆ°åœ–ä¸Šçš„æ­£ç¢ºä½ç½®</div>

    <div class="board">
      <div id="mapbox" class="appear"><!-- é€™è£¡å‹•æ…‹è¼‰å…¥ svg.txt ä¸¦è‡ªå‹•èšç„¦å¸‚ä¸­å¿ƒ --></div>
    </div>

    <div id="tray" class="tray" aria-label="å¯æ‹–æ›³çš„èˆŠåœ°å"></div>
  </div>

  <div class="victory" id="victory">
    <h2>æœ‰å¤  gÃ¢u çš„ï¼è®šå•¦ï¼</h2>
  </div>

<script>
(()=>{
  const cityCenter = [
    { id:"01", newC:"æ¥ æ¢“å€", oldC:"æ¥ ä»”å‘", newKey:"æ¥ æ¢“",   oldKey:"æ¥ ä»”å‘",  roman:"LÃ¢m-Ã¡-khenn", audioNew:"01æ¥ æ¢“_new.mp3",  audioOld:"01æ¥ ä»”å‘_old.mp3" },
    { id:"02", newC:"å·¦ç‡Ÿå€", oldC:"åŸ¤ä»”é ­", newKey:"å·¦ç‡Ÿ",   oldKey:"åŸ¤ä»”é ­",  roman:"Pi-Ã¡-thÃ¢u",     audioNew:"02å·¦ç‡Ÿ_new.mp3",  audioOld:"02åŸ¤ä»”é ­_old.mp3" },
    { id:"03", newC:"é¼“å±±å€", oldC:"æ‰“é¼“å±±", newKey:"é¼“å±±",   oldKey:"æ‰“é¼“å±±",  roman:"TÃ¡nn-kÃ³o-san",  audioNew:"03é¼“å±±_new.mp3",  audioOld:"03æ‰“é¼“å±±_old.mp3" },
    { id:"04", newC:"ä¸‰æ°‘å€", oldC:"ä¸‰å¡Šå", newKey:"ä¸‰æ°‘",   oldKey:"ä¸‰å¡Šå",  roman:"Sann-tÃ¨-tshÃ¹",  audioNew:"04ä¸‰æ°‘_new.mp3",  audioOld:"04ä¸‰å¡Šå_old.mp3" },
    { id:"05", newC:"é¹½åŸ•å€", oldC:"é¹½åŸ•åŸ”", newKey:"é¹½åŸ•",   oldKey:"é¹½åŸ•åŸ”",  roman:"IÃ¢m-tiÃ¢nn-poo", audioNew:"05é¹½åŸ•_new.mp3",  audioOld:"05é¹½åŸ•åŸ”_old.mp3" },
    { id:"06", newC:"å‰é‡‘å€", oldC:"å‰è¡¿",   newKey:"å‰é‡‘",   oldKey:"å‰è¡¿",    roman:"TsiÃ¢n-khim",    audioNew:"06å‰é‡‘_new.mp3",  audioOld:"06å‰è¡¿_old.mp3" },
    { id:"07", newC:"æ–°èˆˆå€", oldC:"é€®æ¸¯åŸ”", newKey:"æ–°èˆˆ",   oldKey:"é€®æ¸¯åŸ”",  roman:"TÃ¢i-kÃ¡ng-poo",  audioNew:"07æ–°èˆˆ_new.mp3",  audioOld:"07é€®æ¸¯åŸ”_old.mp3" },
    { id:"08", newC:"è‹“é›…å€", oldC:"ç¬­ä»”å¯®", newKey:"è‹“é›…",   oldKey:"ç¬­ä»”å¯®",  roman:"LÃ®ng-Ã¡-liÃ¢u",   audioNew:"08è‹“é›…_new.mp3",  audioOld:"08ç¬­ä»”å¯®_old.mp3" },
    { id:"09", newC:"æ——æ´¥å€", oldC:"æ——å¾Œ",   newKey:"æ——æ´¥",   oldKey:"æ——å¾Œ",    roman:"KÃ®-Äu",         audioNew:"09æ——æ´¥_new.mp3",  audioOld:"09æ——å¾Œ_old.mp3" },
    { id:"10", newC:"å‰é®å€", oldC:"å‰é®",   newKey:"å‰é®",   oldKey:"å‰é®",    roman:"TsiÃ¢n-tÃ¬n",     audioNew:"10å‰é®_new.mp3",  audioOld:"10å‰é®_old.mp3" },
    { id:"11", newC:"å°æ¸¯å€", oldC:"æ¸¯ä»”å¢˜", newKey:"å°æ¸¯",   oldKey:"æ¸¯ä»”å¢˜",  roman:"KÃ¡ng-Ã¡-kÃ®nn",   audioNew:"11å°æ¸¯_new.mp3",  audioOld:"11æ¸¯ä»”å¢˜_old.mp3" }
  ];

  const mapBox = document.getElementById('mapbox');
  const tray = document.getElementById('tray');
  const V = (p)=> new URL(`map_assets/${p}`, location.href).href;

  // ç”¢ç”Ÿæ‹–æ›³ç£šï¼ˆäº‚åºï¼‰
  function fisherYates(arr){
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  function buildTray(){
    tray.innerHTML='';
    for(const it of fisherYates([...cityCenter])){
      const div=document.createElement('div');
      div.className='tile'; div.draggable=true; div.dataset.id=it.id;
      div.innerHTML=`<div class="zh">${it.oldKey}</div><div class="ro">${it.roman}</div>`;
      tray.appendChild(div);
    }
  }

  // è¼‰å…¥ svg.txt â†’ èšç„¦å¸‚ä¸­å¿ƒã€æ·¡åŒ–å…¶ä»–ã€åŠ æ–°åœ°åæ¨™ç±¤èˆ‡ drop é»
  let topSvg, placed=0, total=cityCenter.length;
  const placedSet=new Set();

  async function loadSVG(){
    const res = await fetch('svg.txt',{cache:'no-store'});
    const text = await res.text();
    mapBox.innerHTML = text;              // ç›´æ¥å¡å…¥
    topSvg = mapBox.querySelector('svg');
    if(!topSvg){ mapBox.innerHTML='<p style="padding:18px;color:#b00">æ‰¾ä¸åˆ° SVGï¼Œè«‹ç¢ºèª svg.txt æ”¾åœ¨ç¶²ç«™æ ¹ç›®éŒ„ã€‚</p>'; return; }
    // è®“ SVG å¯è‡ªé©æ‡‰
    topSvg.removeAttribute('width'); topSvg.removeAttribute('height');
    topSvg.setAttribute('preserveAspectRatio','xMidYMid meet');
    topSvg.style.width='100%'; topSvg.style.height='100%';

    // æ‰¾å‡ºæ‰€æœ‰ path èˆ‡å…¶ <title>
    /** titleText(pathEl) */
    const titleText = el=>{
      const t = el.querySelector('title');
      return t ? t.textContent.trim() : '';
    };

    const paths = Array.from(topSvg.querySelectorAll('path'));
    // ä¾æ–°åœ°åæ±ºå®šå¸‚ä¸­å¿ƒ path
    const setIDs = new Set(cityCenter.map(x=>x.newC));
    const centerPaths = paths.filter(p=> setIDs.has(titleText(p)));
    const others = paths.filter(p=> !setIDs.has(titleText(p)));

    // æ¨™è¨˜å¤–è§€
    // åŠ æ¼¸å±¤
    let defs = topSvg.querySelector('defs') || topSvg.insertBefore(document.createElementNS('http://www.w3.org/2000/svg','defs'), topSvg.firstChild);
    const grad = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
    grad.id='cityGrad'; grad.setAttribute('x1','0');grad.setAttribute('x2','0');grad.setAttribute('y1','0');grad.setAttribute('y2','1');
    grad.innerHTML='<stop offset="0%" stop-color="#ffd29f"/><stop offset="100%" stop-color="#f0a45f"/>';
    defs.appendChild(grad);

    centerPaths.forEach(p=> p.classList.add('centerPath'));
    others.forEach(p=> p.classList.add('dim'));

    // è¨­å®š data-id å°æ‡‰ï¼Œæ–¹ä¾¿é©—è­‰
    centerPaths.forEach(p=>{
      const t=titleText(p).replace('å€','');
      const found = cityCenter.find(c=>c.newKey===t);
      if(found){ p.dataset.id=found.id; }
    });

    // è¨ˆç®—å¸‚ä¸­å¿ƒè¯åˆ BBoxï¼Œè¨­ç‚º viewBoxï¼ˆè‡ªå‹•èšç„¦ï¼†åœ¨æ‰‹æ©Ÿæ»¿ç‰ˆï¼‰
    const bbox = unionBBox(centerPaths);
    const pad = Math.max(bbox.width, bbox.height)*0.12;
    const vb = [bbox.x-pad, bbox.y-pad, bbox.width+pad*2, bbox.height+pad*2].join(' ');
    topSvg.setAttribute('viewBox', vb);

    // åœ¨ SVG ä¸ŠåŠ å›ºå®šçš„æ–°åœ°åæ¨™ç±¤èˆ‡ drop é»
    addNameLabelsAndDrops(centerPaths);

    // å¯é»æ“Šå¾®é–ƒçˆï¼šå†æ¬¡å¼·èª¿å¸‚ä¸­å¿ƒï¼ˆä¹Ÿå¯ç•¶ã€Œå†èšç„¦ã€ï¼‰
    topSvg.addEventListener('click', ()=>{
      topSvg.classList.remove('appear');
      void topSvg.offsetWidth; // reflow
      topSvg.classList.add('appear');
    }, {passive:true});
  }

  function unionBBox(els){
    // éœ€åœ¨ DOM ä¸”å¯è¦–
    let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
    els.forEach(el=>{
      const b=el.getBBox();
      minX=Math.min(minX,b.x);
      minY=Math.min(minY,b.y);
      maxX=Math.max(maxX,b.x+b.width);
      maxY=Math.max(maxY,b.y+b.height);
    });
    return {x:minX,y:minY,width:maxX-minX,height:maxY-minY};
  }

  function addNameLabelsAndDrops(centerPaths){
    const gLabel = document.createElementNS('http://www.w3.org/2000/svg','g');
    gLabel.setAttribute('id','nameLabels');
    topSvg.appendChild(gLabel);

    const gDrop = document.createElementNS('http://www.w3.org/2000/svg','g');
    gDrop.setAttribute('id','dropDots');
    topSvg.appendChild(gDrop);

    // å…ˆä¾ y æ’åºï¼Œé¿å…é‡ç–Šï¼Œå¥—ç”¨è¼•å¾®éŒ¯ä½
    const items = centerPaths.map(p=>{
      const t = p.querySelector('title').textContent.trim().replace('å€','');
      const found = cityCenter.find(x=>x.newKey===t);
      const b = p.getBBox();
      return {el:p, cx:b.x + b.width/2, cy:b.y + b.height/2, t, id:found?.id};
    }).sort((a,b)=> a.cy - b.cy);

    // é€ä¸€éŒ¯ä½
    const dy = 12;
    for(let i=1;i<items.length;i++){
      if(Math.abs(items[i].cy - items[i-1].cy) < 18){
        items[i].cy += dy;
      }
    }

    // ç•« label èˆ‡ drop
    for(const it of items){
      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.classList.add('nameLabel');
      label.setAttribute('x', it.cx);
      label.setAttribute('y', it.cy);
      label.textContent = it.t; // æ–°åœ°åï¼ˆå›ºå®šé¡¯ç¤ºï¼‰
      gLabel.appendChild(label);

      const drop = document.createElementNS('http://www.w3.org/2000/svg','circle');
      drop.classList.add('dropDot');
      drop.setAttribute('r','16');
      drop.setAttribute('cx', it.cx);
      drop.setAttribute('cy', it.cy+16);
      drop.dataset.id = it.id;
      gDrop.appendChild(drop);
    }
  }

  // ---- æ‹–æ›³äº’å‹•ï¼ˆæ‰‹æ©Ÿ/æ¡Œæ©Ÿï¼‰ ----
  let dragging=null;

  function bindDrag(){
    tray.querySelectorAll('.tile').forEach(tile=>{
      tile.addEventListener('dragstart', e=>{
        dragging=tile;
        tile.classList.add('dragging');
        e.dataTransfer.setData('text/plain', tile.dataset.id);
        e.dataTransfer.effectAllowed='move';
      });
      tile.addEventListener('dragend', ()=>{ dragging=null; tile.classList.remove('dragging'); });
    });

    mapBox.addEventListener('dragover', e=>{
      e.preventDefault();
      e.dataTransfer.dropEffect='move';
    });
    mapBox.addEventListener('drop', e=>{
      e.preventDefault();
      if(!dragging) return;
      const id = dragging.dataset.id;
      // æ‰¾æœ€é è¿‘çš„ dropDot
      const svgP = clientToSvg(e.clientX,e.clientY);
      const dots = Array.from(topSvg.querySelectorAll('.dropDot'));
      let hit=null, best=9999;
      for(const d of dots){
        const dx = svgP.x - (+d.getAttribute('cx'));
        const dy = svgP.y - (+d.getAttribute('cy'));
        const dist = Math.hypot(dx,dy);
        if(dist<best){best=dist; hit=d;}
      }
      if(hit && hit.dataset.id===id){
        onCorrect(id, dragging, hit);
      }
    }, {passive:false});

    // æ‰‹æ©Ÿæ”¯æ´ï¼ˆpointerï¼‰
    tray.querySelectorAll('.tile').forEach(tile=>{
      tile.addEventListener('pointerdown', e=>{
        if(e.pointerType==='mouse') return; // ç”± HTML5 drag è² è²¬
        dragging = tile; tile.setPointerCapture(e.pointerId); tile.classList.add('dragging');
      });
      tile.addEventListener('pointerup', e=>{
        if(!dragging || e.pointerType==='mouse') return;
        // å°‡ pointer ä½ç½®æŠ•å½±åˆ° SVG
        const pt = clientToSvg(e.clientX,e.clientY);
        const dots = Array.from(topSvg.querySelectorAll('.dropDot'));
        let hit=null, best=9999;
        for(const d of dots){
          const dx = pt.x - (+d.getAttribute('cx'));
          const dy = pt.y - (+d.getAttribute('cy'));
          const dist = Math.hypot(dx,dy);
          if(dist<best){best=dist; hit=d;}
        }
        if(hit && hit.dataset.id===tile.dataset.id){
          onCorrect(tile.dataset.id, tile, hit);
        }
        dragging.classList.remove('dragging'); dragging=null;
      });
    });
  }

  function clientToSvg(cx,cy){
    const pt = topSvg.createSVGPoint();
    pt.x=cx; pt.y=cy;
    return pt.matrixTransform(topSvg.getScreenCTM().inverse());
  }

  function onCorrect(id, tile, dot){
    if(placedSet.has(id)) return;
    placedSet.add(id);
    tile.classList.add('correct');
    tile.style.pointerEvents='none';

    // åœ¨ drop çš„ä½ç½®å¡å…¥èˆŠåœ°åå°æ¨™ç±¤ï¼ˆSVG textï¼‰
    const info = cityCenter.find(x=>x.id===id);
    const g = topSvg.querySelector('#nameLabels');
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.classList.add('nameLabel');
    t.setAttribute('x', dot.getAttribute('cx'));
    t.setAttribute('y', +dot.getAttribute('cy') + 18);
    t.style.fill = '#8b3f00';
    t.textContent = info.oldKey + ' Â· ' + info.roman;
    g.appendChild(t);

    // æ’­æ”¾æ–°â†’èˆŠ
    playChain([V(info.audioNew), V(info.audioOld)]);

    placed++;
    if(placed===total){
      // å‹åˆ©
      setTimeout(()=>{
        playChain([V('victory.mp3'), V('finish1.mp3')]);
        const v=document.getElementById('victory');
        v.classList.add('show');
        setTimeout(()=> v.classList.remove('show'), 2000);
      }, 50);
    }
  }

  function playChain(urls){
    const audio = new Audio();
    let i=0;
    audio.addEventListener('ended', ()=>{
      i++;
      if(i<urls.length){ audio.src=urls[i]; audio.play(); }
    });
    audio.src=urls[0]; audio.play();
  }

  // å•Ÿå‹•
  (async function init(){
    buildTray();
    bindDrag();
    await loadSVG();
  })();
})();
</script>
</body>
</html>
