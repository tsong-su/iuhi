<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>è‡ºç£åŒ—éƒ¨åœ°å€éƒµç¥¨é…å°éŠæˆ²</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      text-align: center;
      background-color: #f0f0f0;
    }
    #game-container {
      position: relative;
      display: inline-block;
      max-width: 100%;
    }
    #map {
      width: 100%;
      height: auto;
      display: block;
    }
    .stamp {
      position: absolute;
      width: 80px;
      height: 80px;
      cursor: grab;
      z-index: 10;
    }
    .slot {
      position: absolute;
      width: 80px;
      height: 80px;
      border: 3px dashed red;
      pointer-events: none;
    }
    #success {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      font-weight: bold;
      color: red;
      display: none;
    }
    #home-btn {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 22px;
      border-radius: 8px;
      background-color: #007bff;
      color: white;
      text-decoration: none;
    }
    #home-btn:hover {
      background-color: #0056b3;
    }
    .marker {
      position: absolute;
      width: 10px;
      height: 10px;
      background: red;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 20;
    }
    #coords-btn {
      margin-top: 15px;
      padding: 8px 16px;
      font-size: 18px;
      border-radius: 6px;
      background-color: #28a745;
      color: white;
      cursor: pointer;
    }
    #coords-btn:hover {
      background-color: #1e7e34;
    }
  </style>
</head>
<body>
  <h1>è‡ºç£åŒ—éƒ¨åœ°å€éƒµç¥¨é…å°éŠæˆ²</h1>
  <div id="game-container">
    <img id="map" src="game4_assets/north1_map.png">
    <div id="success">æœ‰å¤ gÃ¢uï¼</div>
  </div>
  <br>
  <button id="coords-btn">è¼¸å‡º basePositions é™£åˆ—</button>
  <br>
  <a id="home-btn" href="https://tsong-su.github.io/iuhi/index.html">å›åˆ°éŠæˆ²é¦–é </a>

  <script>
    const container = document.getElementById("game-container");
    const map = document.getElementById("map");
    const success = document.getElementById("success");
    const coordsBtn = document.getElementById("coords-btn");

    let clickedCoords = []; // ğŸ‘‰ å„²å­˜é»éçš„åº§æ¨™

    // ğŸ‘‰ æ¯”ä¾‹åº§æ¨™åµæ¸¬å™¨ï¼šé»åœ–ç‰‡æ™‚æœƒè·³å‡ºæ¯”ä¾‹åº§æ¨™ + ç•«ç´…é» + å­˜åˆ°æ¸…å–®
    map.addEventListener("click", e => {
      const rect = map.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;

      alert(`æ¯”ä¾‹åº§æ¨™ x:${x.toFixed(2)}, y:${y.toFixed(2)}`);

      // åœ¨é»æ“Šä½ç½®ç•«ç´…é»
      const marker = document.createElement("div");
      marker.className = "marker";
      marker.style.left = (x * map.width) + "px";
      marker.style.top = (y * map.height) + "px";
      container.appendChild(marker);

      // å­˜å…¥æ¸…å–®
      clickedCoords.push({x: parseFloat(x.toFixed(2)), y: parseFloat(y.toFixed(2))});
    });

    // ğŸ‘‰ æŒ‰ä¸‹æŒ‰éˆ•è¼¸å‡º basePositions é™£åˆ—
    coordsBtn.addEventListener("click", () => {
      if (clickedCoords.length === 0) {
        alert("å°šæœªé»æ“Šä»»ä½•åº§æ¨™ï¼");
        return;
      }
      let list = "const basePositions = [\n";
      clickedCoords.forEach((c, i) => {
        list += `  {x:${c.x}, y:${c.y}}${i < clickedCoords.length - 1 ? "," : ""}\n`;
      });
      list += "];";
      alert(list);
      console.log("ğŸ‘‰ è¤‡è£½ä»¥ä¸‹é™£åˆ—ï¼š\n" + list);
    });

    // é è¨­å‡è³‡æ–™ï¼ˆç­‰ä½ ç”¨æ¯”ä¾‹åº§æ¨™å–ä»£ï¼‰
    const basePositions = [
      {x:0.20,y:0.30},{x:0.40,y:0.35},{x:0.60,y:0.28},
      {x:0.80,y:0.50},{x:1.00,y:0.60},{x:0.70,y:0.40},
      {x:0.30,y:0.70},{x:0.50,y:0.80},{x:0.90,y:0.20},
      {x:0.60,y:0.70},{x:0.80,y:0.80},{x:0.40,y:0.90}
    ];

    let stampsPlaced = 0;

    map.onload = () => {
      const answerPositions = basePositions.map(p => ({
        x: p.x * map.width,
        y: p.y * map.height
      }));

      answerPositions.forEach((pos, i) => {
        // å»ºç«‹æ ¼å­
        const slot = document.createElement("div");
        slot.className = "slot";
        slot.style.left = (pos.x - 40) + "px";
        slot.style.top = (pos.y - 40) + "px";
        container.appendChild(slot);

        // å»ºç«‹éƒµç¥¨
        const stamp = document.createElement("img");
        stamp.src = `game4_assets/stamp${i+1}.jpg`;
        stamp.className = "stamp";
        stamp.dataset.index = i;

        // éš¨æ©Ÿæ•£é–‹éƒµç¥¨ï¼ˆé¿å…é‡ç–Šï¼‰
        let randX, randY, overlap;
        do {
          randX = Math.random() * (map.width - 100);
          randY = Math.random() * (map.height - 100);
          overlap = [...document.querySelectorAll(".stamp")].some(s => {
            const dx = parseInt(s.style.left) - randX;
            const dy = parseInt(s.style.top) - randY;
            return Math.sqrt(dx*dx + dy*dy) < 100;
          });
        } while (overlap);

        stamp.style.left = randX + "px";
        stamp.style.top = randY + "px";
        container.appendChild(stamp);

        // åŠ å…¥æ‹–æ›³åŠŸèƒ½
        dragElement(stamp, pos, i);
      });

      function dragElement(elmnt, correctPos, index) {
        let offsetX=0, offsetY=0, mouseX=0, mouseY=0, originalX=0, originalY=0;

        elmnt.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
          e.preventDefault();
          mouseX = e.clientX;
          mouseY = e.clientY;
          originalX = elmnt.offsetLeft;
          originalY = elmnt.offsetTop;
          document.onmouseup = closeDragElement;
          document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
          offsetX = e.clientX - mouseX;
          offsetY = e.clientY - mouseY;
          elmnt.style.left = (elmnt.offsetLeft + offsetX) + "px";
          elmnt.style.top = (elmnt.offsetTop + offsetY) + "px";
          mouseX = e.clientX;
          mouseY = e.clientY;
        }

        function closeDragElement() {
          document.onmouseup = null;
          document.onmousemove = null;
          const stampX = elmnt.offsetLeft + 40;
          const stampY = elmnt.offsetTop + 40;

          const dx = stampX - correctPos.x;
          const dy = stampY - correctPos.y;
          const dist = Math.sqrt(dx*dx + dy*dy);

          if(dist < 30){
            elmnt.style.left = (correctPos.x-40)+"px";
            elmnt.style.top = (correctPos.y-40)+"px";
            elmnt.onmousedown = null;
            playSound(`game4_assets/stamp${index+1}.mp3`);
            stampsPlaced++;
            if(stampsPlaced===12){
              showSuccess();
            }
          }else{
            elmnt.style.left = originalX+"px";
            elmnt.style.top = originalY+"px";
            playSound("game4_assets/wrong.mp3");
          }
        }
      }

      function playSound(src){
        const audio = new Audio(src);
        audio.play();
      }

      function showSuccess(){
        success.style.display = "block";
        success.style.fontSize = "20px";
        let size = 20;
        const interval = setInterval(()=>{
          size += 5;
          success.style.fontSize = size+"px";
          if(size>=100){ clearInterval(interval); }
        }, 200);
      }
    }
  </script>
</body>
</html>
