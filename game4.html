<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>臺灣北部地區郵票配對遊戲</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      text-align: center;
      background-color: #f0f0f0;
      margin: 0;
      overflow-x: hidden;
    }
    h1 {
      font-size: 40px;
      margin: 20px 0;
    }
    #game-container {
      position: relative;
      width: 100%;
      max-width: 100vw;
      margin: auto;
    }
    #map {
      width: 100%;
      height: auto;
      display: block;
    }
    .stamp {
      position: absolute;
      width: 10vw;   /* 郵票大小 10% */
      height: auto;
      max-width: 150px;
      cursor: grab;
      z-index: 10;
    }
    .slot {
      position: absolute;
      border: 4px dashed red; /* 加粗，更明顯 */
      pointer-events: none;
      transform: translate(-50%, -50%);
      width: 10vw;   /* 與郵票一致 */
      max-width: 150px;
      aspect-ratio: 1 / 1;
    }
    #success {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      font-weight: bold;
      color: red;
      display: none;
    }
    #home-btn {
      margin: 30px auto;
      padding: 14px 28px;
      font-size: 26px;
      border-radius: 10px;
      background-color: #007bff;
      color: white;
      text-decoration: none;
      display: inline-block;
    }
    #home-btn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h1>臺灣北部地區郵票配對遊戲</h1>
  <div id="game-container">
    <img id="map" src="game4_assets/north2_map.png">
    <div id="success">有夠gâu！</div>
  </div>
  <br>
  <a id="home-btn" href="https://tsong-su.github.io/iuhi/index.html">回到遊戲首頁</a>

  <script>
    const container = document.getElementById("game-container");
    const map = document.getElementById("map");
    const success = document.getElementById("success");

    // 比例座標 (相對於 north2_map.png 1284x970)
    const basePositions = [
      { "x": 0.9953, "y": 0.1551 },
      { "x": 0.7589, "y": 0.0012 },
      { "x": 0.5749, "y": 0.0249 },
      { "x": 0.3782, "y": 0.1872 },
      { "x": 0.1291, "y": 0.1264 },
      { "x": 0.115,  "y": 0.3242 },
      { "x": 0.0077, "y": 0.5255 },
      { "x": 0.0435, "y": 0.9668 },
      { "x": 0.2479, "y": 0.9922 },
      { "x": 0.4791, "y": 0.9043 },
      { "x": 0.7372, "y": 0.4916 },
      { "x": 0.9173, "y": 0.4409 }
    ];

    let stampsPlaced = 0;
    let usedPositions = []; // 防止郵票重疊

    map.onload = () => {
      const mapWidth = map.clientWidth;
      const mapHeight = map.clientHeight;

      const answerPositions = basePositions.map(p => ({
        x: p.x * mapWidth,
        y: p.y * mapHeight
      }));

      answerPositions.forEach((pos, i) => {
        // 建立紅框 slot
        const slot = document.createElement("div");
        slot.className = "slot";
        slot.style.left = pos.x + "px";
        slot.style.top = pos.y + "px";
        container.appendChild(slot);

        // 建立郵票
        const stamp = document.createElement("img");
        stamp.src = `game4_assets/stamp${i+1}.jpg`;
        stamp.className = "stamp";
        stamp.dataset.index = i;

        // 隨機放置在地圖外圍，避免重疊
        const posStamp = getRandomNonOverlappingPosition(mapWidth, mapHeight, 160);
        stamp.style.left = posStamp.x + "px";
        stamp.style.top = posStamp.y + "px";
        container.appendChild(stamp);

        // 加入拖曳功能
        dragElement(stamp, pos, i);
      });

      function getRandomNonOverlappingPosition(mapW, mapH, margin) {
        let x, y, overlap;
        const maxTries = 50;
        let tries = 0;
        do {
          const side = Math.floor(Math.random()*4);
          if(side===0){ x = Math.random()*mapW; y = -margin; }
          if(side===1){ x = mapW+margin; y = Math.random()*mapH; }
          if(side===2){ x = Math.random()*mapW; y = mapH+margin; }
          if(side===3){ x = -margin; y = Math.random()*mapH; }

          overlap = usedPositions.some(p =>
            Math.abs(p.x - x) < 120 && Math.abs(p.y - y) < 120
          );
          tries++;
        } while(overlap && tries < maxTries);

        usedPositions.push({x,y});
        return {x,y};
      }

      function dragElement(elmnt, correctPos, index) {
        let offsetX=0, offsetY=0, mouseX=0, mouseY=0, originalX=0, originalY=0;

        elmnt.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
          e.preventDefault();
          mouseX = e.clientX;
          mouseY = e.clientY;
          originalX = elmnt.offsetLeft;
          originalY = elmnt.offsetTop;
          document.onmouseup = closeDragElement;
          document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
          offsetX = e.clientX - mouseX;
          offsetY = e.clientY - mouseY;
          elmnt.style.left = (elmnt.offsetLeft + offsetX) + "px";
          elmnt.style.top = (elmnt.offsetTop + offsetY) + "px";
          mouseX = e.clientX;
          mouseY = e.clientY;
        }

        function closeDragElement() {
          document.onmouseup = null;
          document.onmousemove = null;

          const stampCenterX = elmnt.offsetLeft + elmnt.offsetWidth/2;
          const stampCenterY = elmnt.offsetTop + elmnt.offsetHeight/2;

          const dx = stampCenterX - correctPos.x;
          const dy = stampCenterY - correctPos.y;
          const dist = Math.sqrt(dx*dx + dy*dy);

          if(dist < 50){ // 成功放置
            elmnt.style.left = (correctPos.x - elmnt.offsetWidth/2)+"px";
            elmnt.style.top = (correctPos.y - elmnt.offsetHeight/2)+"px";
            elmnt.onmousedown = null;
            playSound(`game4_assets/stamp${index+1}.mp3`);
            stampsPlaced++;
            if(stampsPlaced===12){
              showSuccess();
            }
          }else{
            elmnt.style.left = originalX+"px";
            elmnt.style.top = originalY+"px";
            playSound("game4_assets/wrong.mp3");
          }
        }
      }

      function playSound(src){
        const audio = new Audio(src);
        audio.play();
      }

      function showSuccess(){
        success.style.display = "block";
        success.style.fontSize = "20px";
        let size = 20;
        const interval = setInterval(()=>{
          size += 5;
          success.style.fontSize = size+"px";
          if(size>=100){ clearInterval(interval); }
        }, 200);

        playSound("game4_assets/victory.mp3");
      }
    }
  </script>
</body>
</html>
