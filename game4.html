<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>郵票配對遊戲</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #f0f0f0;
      overflow: hidden;
      font-family: "Microsoft JhengHei", sans-serif;
    }
    header {
      width: 100%;
      padding: 12px;
      background: #333;
      color: #fff;
      font-size: 28px;
      font-weight: bold;
      text-align: center;
    }
    #home-link {
      position: absolute;
      left: 10px;
      top: 10px;
      color: #fff;
      text-decoration: none;
      font-size: 20px;
    }
    #map-container {
      position: relative;
      flex: 1;
      width: 100%;
      max-height: calc(100vh - 70px);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    #map {
      max-width: 100%;
      max-height: 100%;
      display: block;
    }
    .slot {
      position: absolute;
      width: 80px;
      height: 80px;
      border: 3px dashed red;
      box-sizing: border-box;
      pointer-events: none;
    }
    .stamp {
      position: absolute;
      width: 80px;
      height: 80px;
      cursor: grab;
      z-index: 10;
    }
    #victory-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      font-weight: bold;
      color: green;
      display: none;
    }
    #controls {
      margin: 10px;
    }
    #controls button {
      font-size: 20px;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <a id="home-link" href="index.html">🏠 回到遊戲首頁</a>
    郵票配對遊戲
  </header>
  <div id="map-container">
    <img id="map" src="game4_assets/north2_map.png" alt="地圖">
    <div id="victory-message">有夠 gâu 🎉</div>
  </div>
  <div id="controls">
    <button onclick="scatterStamps()">🔄 重排郵票</button>
  </div>

  <audio id="success-sound" src="game4_assets/success.mp3"></audio>
  <audio id="error-sound" src="game4_assets/error.mp3"></audio>
  <audio id="victory-sound" src="game4_assets/victory.mp3"></audio>

  <script>
    const basePositions = [
      {x: 0.9953, y: 0.1551},
      {x: 0.7589, y: 0.0012},
      {x: 0.5749, y: 0.0249},
      {x: 0.3782, y: 0.1872},
      {x: 0.1291, y: 0.1264},
      {x: 0.115,  y: 0.3242},
      {x: 0.0077, y: 0.5255},
      {x: 0.0435, y: 0.9668},
      {x: 0.2479, y: 0.9922},
      {x: 0.4791, y: 0.9043},
      {x: 0.7372, y: 0.4916},
      {x: 0.9173, y: 0.4409}
    ];

    const map = document.getElementById('map');
    const mapContainer = document.getElementById('map-container');
    const victoryMessage = document.getElementById('victory-message');
    const successSound = document.getElementById('success-sound');
    const errorSound = document.getElementById('error-sound');
    const victorySound = document.getElementById('victory-sound');

    let slots = [];
    let stamps = [];
    let matchedCount = 0;

    function createSlots() {
      slots.forEach(s => s.remove());
      slots = [];

      const rect = map.getBoundingClientRect();
      const mapW = rect.width;
      const mapH = rect.height;
      const mapX = rect.left;
      const mapY = rect.top;

      basePositions.forEach((pos, i) => {
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.style.left = (mapX + pos.x * mapW - 40) + 'px';
        slot.style.top = (mapY + pos.y * mapH - 40) + 'px';
        slot.dataset.index = i;
        document.body.appendChild(slot);
        slots.push(slot);
      });
    }

    function scatterStamps() {
      stamps.forEach(s => s.remove());
      stamps = [];

      const containerRect = mapContainer.getBoundingClientRect();
      const margin = 100;

      basePositions.forEach((pos, i) => {
        const stamp = document.createElement('img');
        stamp.src = `game4_assets/stamp${i+1}.png`;
        stamp.className = 'stamp';
        stamp.dataset.index = i;

        let left, top;
        do {
          left = containerRect.left + margin + Math.random() * (containerRect.width - 200);
          top = containerRect.top + margin + Math.random() * (containerRect.height - 200);
        } while (
          slots.some(slot => {
            const sRect = slot.getBoundingClientRect();
            return !(left + 80 < sRect.left || left > sRect.right || top + 80 < sRect.top || top > sRect.bottom);
          })
        );

        stamp.style.left = left + 'px';
        stamp.style.top = top + 'px';

        makeDraggable(stamp);
        document.body.appendChild(stamp);
        stamps.push(stamp);
      });
    }

    function makeDraggable(stamp) {
      let offsetX, offsetY;

      stamp.onmousedown = (e) => {
        offsetX = e.clientX - stamp.offsetLeft;
        offsetY = e.clientY - stamp.offsetTop;
        document.onmousemove = (e) => {
          stamp.style.left = (e.clientX - offsetX) + 'px';
          stamp.style.top = (e.clientY - offsetY) + 'px';
        };
        document.onmouseup = () => {
          document.onmousemove = null;
          checkDrop(stamp);
        };
      };
    }

    function checkDrop(stamp) {
      const sRect = stamp.getBoundingClientRect();
      const slot = slots.find(slot => {
        const rect = slot.getBoundingClientRect();
        return !(sRect.right < rect.left || sRect.left > rect.right || sRect.bottom < rect.top || sRect.top > rect.bottom);
      });

      if (slot && slot.dataset.index === stamp.dataset.index) {
        stamp.style.left = slot.style.left;
        stamp.style.top = slot.style.top;
        stamp.onmousedown = null;
        successSound.play();
        matchedCount++;
        if (matchedCount === basePositions.length) {
          victoryMessage.style.display = 'block';
          victorySound.play();
        }
      } else {
        errorSound.play();
      }
    }

    window.addEventListener('resize', () => {
      createSlots();
    });

    map.onload = () => {
      createSlots();
      scatterStamps();
    };
  </script>
</body>
</html>
