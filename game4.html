<script>
  const gameContainer = document.getElementById("game-container");
  const map = document.getElementById("map");

  map.onerror = () => {
    gameContainer.innerHTML = `<div class="error">❌ 找不到地圖檔案：game4_assets/north2_map.png</div>`;
  };

  const frames = [];
  const coords = [
    [0.3,0.3],[0.5,0.3],[0.7,0.3],
    [0.3,0.5],[0.5,0.5],[0.7,0.5],
    [0.3,0.7],[0.5,0.7],[0.7,0.7],
    [0.4,0.9],[0.6,0.9],[0.8,0.9]
  ];

  function updateFrames() {
    const rect = map.getBoundingClientRect();
    const imgRatio = map.naturalWidth / map.naturalHeight;
    const rectRatio = rect.width / rect.height;
    let drawWidth, drawHeight, offsetX, offsetY;

    if (imgRatio > rectRatio) {
      // 寬受限
      drawWidth = rect.width;
      drawHeight = rect.width / imgRatio;
      offsetX = rect.left;
      offsetY = rect.top + (rect.height - drawHeight) / 2;
    } else {
      // 高受限
      drawHeight = rect.height;
      drawWidth = rect.height * imgRatio;
      offsetY = rect.top;
      offsetX = rect.left + (rect.width - drawWidth) / 2;
    }

    frames.forEach((f, i) => {
      const [x, y] = coords[i];
      f.style.left = `${offsetX + drawWidth * x - f.offsetWidth/2}px`;
      f.style.top = `${offsetY + drawHeight * y - f.offsetHeight/2}px`;
    });
  }

  map.onload = () => {
    coords.forEach(([x,y],i)=>{
      const frame=document.createElement("div");
      frame.className="frame";
      gameContainer.appendChild(frame);
      frames.push(frame);
    });
    updateFrames();
    window.addEventListener("resize", updateFrames);
  };

  const stamps=[];
  for(let i=1;i<=12;i++){
    const img=document.createElement("img");
    img.src=`game4_assets/stamp${i}.jpg`;
    img.className="stamp";
    img.onerror = () => {
      img.replaceWith(Object.assign(document.createElement("div"), {
        className: "error",
        innerText: `❌ 找不到圖檔：game4_assets/stamp${i}.jpg`
      }));
    };
    gameContainer.appendChild(img);
    stamps.push(img);
  }

  function shuffleStamps(){
    const stampSize = 60;
    const margin = 15;
    stamps.forEach((stamp,i)=>{
      const isLeft = i < 6;
      const col = i % 3;
      const row = Math.floor((i % 6) / 3);

      const xBase = isLeft ? 20 : window.innerWidth - (stampSize * 3 + margin * 2) - 20;
      const yBase = window.innerHeight/2 - (stampSize * 2 + margin)/2;

      const x = xBase + col * (stampSize + margin);
      const y = yBase + row * (stampSize + margin);

      stamp.style.left=`${x}px`;
      stamp.style.top=`${y}px`;
    });
  }

  function goHome(){
    window.location.href="index.html";
  }
</script>
