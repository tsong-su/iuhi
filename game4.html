<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>臺灣北部地區&注音符號郵票配對遊戲</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      margin: 10px 0;
    }
    #gameArea {
      position: relative;
      width: 800px;
      height: auto;
      margin: 10px 0;
    }
    #map {
      width: 100%;
      display: block;
    }
    .red-box {
      position: absolute;
      width: 60px;
      height: 60px;
      border: 2px dashed red;
      cursor: move;
    }
    #controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>臺灣北部地區&注音符號郵票配對遊戲</h1>

  <div id="gameArea">
    <img id="map" src="game4_assets/north_map.png" alt="臺灣北部地圖">
  </div>

  <div id="controls">
    <button id="calibrateBtn">對位校正</button>
    <button id="clearBtn">清除自訂座標</button>
    <button id="exportBtn">匯出座標</button>
    <button id="homeBtn">返回遊戲首頁</button>
  </div>

  <script>
    const boxesData = [
      { x: 86.4476, y: 17.6471 },
      { x: 68.9938, y: -4.6036 },
      { x: 47.2279, y: -4.8593 },
      { x: 5.3388,  y: 26.8542 },
      { x: 28.3368, y: 6.3939 },
      { x: -3.6961, y: 50.6394 },
      { x: 8.6242,  y: 2.3018 },
      { x: 2.8747,  y: 81.8414 },
      { x: 46.6119, y: 76.9821 },
      { x: 23.8193, y: 83.376  },
      { x: 80.6982, y: 40.665  },
      { x: 63.039,  y: 48.3376 }
    ];

    const gameArea = document.getElementById("gameArea");
    let boxes = [];
    let isCalibration = false;

    function createBoxes() {
      boxesData.forEach((pos, idx) => {
        const box = document.createElement("div");
        box.classList.add("red-box");
        box.dataset.index = idx;
        setBoxPosition(box, pos);
        gameArea.appendChild(box);
        boxes.push(box);
      });
    }

    function setBoxPosition(box, pos) {
      const map = document.getElementById("map");
      const mapRect = map.getBoundingClientRect();
      const areaRect = gameArea.getBoundingClientRect();
      const offsetX = (pos.x / 100) * map.width;
      const offsetY = (pos.y / 100) * map.height;
      box.style.left = offsetX + "px";
      box.style.top = offsetY + "px";
    }

    // 對位校正模式：紅框可拖曳
    document.getElementById("calibrateBtn").addEventListener("click", () => {
      isCalibration = !isCalibration;
      document.getElementById("calibrateBtn").textContent =
        isCalibration ? "結束校正" : "對位校正";

      boxes.forEach(box => {
        if (isCalibration) {
          box.addEventListener("mousedown", dragStart);
        } else {
          box.removeEventListener("mousedown", dragStart);
        }
      });
    });

    // 拖曳事件
    let currentBox = null;
    let offsetX, offsetY;

    function dragStart(e) {
      currentBox = e.target;
      offsetX = e.clientX - currentBox.offsetLeft;
      offsetY = e.clientY - currentBox.offsetTop;
      document.addEventListener("mousemove", dragMove);
      document.addEventListener("mouseup", dragEnd);
    }

    function dragMove(e) {
      if (!currentBox) return;
      currentBox.style.left = e.clientX - offsetX + "px";
      currentBox.style.top = e.clientY - offsetY + "px";
    }

    function dragEnd() {
      document.removeEventListener("mousemove", dragMove);
      document.removeEventListener("mouseup", dragEnd);
      currentBox = null;
    }

    // 匯出座標
    document.getElementById("exportBtn").addEventListener("click", () => {
      const map = document.getElementById("map");
      const mapRect = map.getBoundingClientRect();
      const areaRect = gameArea.getBoundingClientRect();

      const coords = boxes.map(box => {
        const x = (parseFloat(box.style.left) / map.width) * 100;
        const y = (parseFloat(box.style.top) / map.height) * 100;
        return { x: parseFloat(x.toFixed(4)), y: parseFloat(y.toFixed(4)) };
      });

      const json = JSON.stringify(coords, null, 2);
      navigator.clipboard.writeText(json).then(() => {
        alert("座標已匯出並複製到剪貼簿：\n" + json);
      });
    });

    // 清除自訂座標（回復原始）
    document.getElementById("clearBtn").addEventListener("click", () => {
      boxes.forEach((box, idx) => {
        setBoxPosition(box, boxesData[idx]);
      });
    });

    // 返回首頁
    document.getElementById("homeBtn").addEventListener("click", () => {
      window.location.href = "index.html"; // 請確認首頁檔案名稱
    });

    window.onload = createBoxes;
  </script>
</body>
</html>
