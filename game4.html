<script>
const basePositions = [
  { "x": 0.9953, "y": 0.1551 },
  { "x": 0.7589, "y": 0.0012 },
  { "x": 0.5749, "y": 0.0249 },
  { "x": 0.3782, "y": 0.1872 },
  { "x": 0.1291, "y": 0.1264 },
  { "x": 0.115,  "y": 0.3242 },
  { "x": 0.0077, "y": 0.5255 },
  { "x": 0.0435, "y": 0.9668 },
  { "x": 0.2479, "y": 0.9922 },
  { "x": 0.4791, "y": 0.9043 },
  { "x": 0.7372, "y": 0.4916 },
  { "x": 0.9173, "y": 0.4409 }
];

const map = document.getElementById("map");
const mapContainer = document.getElementById("mapContainer");
const slotsContainer = document.getElementById("slots");
const stampsContainer = document.getElementById("stamps");
const message = document.getElementById("message");

let correctCount = 0;

function renderGame() {
  slotsContainer.innerHTML = "";
  stampsContainer.innerHTML = "";
  correctCount = 0;

  const mapWidth = map.clientWidth;
  const mapHeight = map.clientHeight;
  const slotSize = mapWidth * 0.1; // 郵票&紅框 = 地圖寬度 10%

  let placedStamps = [];

  basePositions.forEach((pos, index) => {
    // 建立紅框
    const slot = document.createElement("div");
    slot.className = "slot";
    slot.style.width = slotSize + "px";
    slot.style.height = slotSize + "px";
    slot.style.left = (pos.x * mapWidth - slotSize/2) + "px";
    slot.style.top  = (pos.y * mapHeight - slotSize/2) + "px";
    slot.dataset.index = index;
    slotsContainer.appendChild(slot);

    // 建立郵票
    const stamp = document.createElement("img");
    stamp.src = `game4_assets/stamp${index+1}.jpg`;
    stamp.className = "stamp";
    stamp.style.width = slotSize + "px";
    stamp.dataset.index = index;

    // 隨機散落在地圖內（避開紅框&其他郵票）
    let randX, randY, overlap, tries = 0;
    do {
      randX = Math.random() * (mapWidth - slotSize);
      randY = Math.random() * (mapHeight - slotSize);

      overlap = false;
      // 避開紅框
      basePositions.forEach(p => {
        let slotX = p.x * mapWidth - slotSize/2;
        let slotY = p.y * mapHeight - slotSize/2;
        if (Math.abs(randX - slotX) < slotSize &&
            Math.abs(randY - slotY) < slotSize) {
          overlap = true;
        }
      });
      // 避開其他郵票
      placedStamps.forEach(s => {
        if (Math.abs(randX - s.x) < slotSize &&
            Math.abs(randY - s.y) < slotSize) {
          overlap = true;
        }
      });
      tries++;
      if (tries > 500) break;
    } while (overlap);

    stamp.style.left = randX + "px";
    stamp.style.top = randY + "px";
    placedStamps.push({x: randX, y: randY});

    stampsContainer.appendChild(stamp);
    makeDraggable(stamp, slotSize);
  });
}

function makeDraggable(stamp, slotSize) {
  let offsetX, offsetY;

  stamp.onmousedown = function(e) {
    e.preventDefault();
    offsetX = e.clientX - stamp.getBoundingClientRect().left;
    offsetY = e.clientY - stamp.getBoundingClientRect().top;

    document.onmousemove = (e) => {
      stamp.style.left = (e.clientX - map.getBoundingClientRect().left - offsetX) + "px";
      stamp.style.top  = (e.clientY - map.getBoundingClientRect().top - offsetY) + "px";
    };

    document.onmouseup = () => {
      document.onmousemove = null;
      document.onmouseup = null;
      checkDrop(stamp, slotSize);
    };
  };
}

function checkDrop(stamp, slotSize) {
  const slot = [...document.querySelectorAll(".slot")]
    .find(s => s.dataset.index === stamp.dataset.index);

  const stampRect = stamp.getBoundingClientRect();
  const slotRect = slot.getBoundingClientRect();

  if (Math.abs(stampRect.left - slotRect.left) < slotSize/2 &&
      Math.abs(stampRect.top - slotRect.top) < slotSize/2) {
    // 正確
    stamp.style.left = slot.offsetLeft + "px";
    stamp.style.top  = slot.offsetTop  + "px";
    new Audio(`game4_assets/stamp${Number(stamp.dataset.index)+1}.mp3`).play();
    stamp.onmousedown = null;
    correctCount++;

    if (correctCount === basePositions.length) {
      message.style.display = "block";
      new Audio("game4_assets/victory.mp3").play();
    }
  } else {
    // 錯誤
    new Audio("game4_assets/wrong.mp3").play();
  }
}

window.addEventListener("resize", renderGame);
window.addEventListener("load", renderGame);
</script>
