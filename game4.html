<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>臺灣北部地圖&注音符號郵票配對遊戲</title>
  <style>
    body {
      margin: 0;
      text-align: center;
      background: #fff;
    }

    h1 {
      font-size: 28px;
      margin: 10px 0;
      color: #333;
    }

    #game-container {
      position: relative;
      width: 100vw;
      height: 80vh;
      overflow: hidden;
      margin: auto;
    }

    #map {
      max-height: 70%;
      max-width: 100%;
      display: block;
      margin: auto;
    }

    .frame {
      position: absolute;
      border: 3px dashed red;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .stamp {
      position: absolute;
      cursor: grab;
      user-select: none;
      z-index: 10;
    }

    #buttons {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 20;
    }

    #size-buttons {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      z-index: 20;
    }

    #victory-message {
      display: none;
      font-size: 36px;
      color: red;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 30;
    }
  </style>
</head>
<body>
  <h1>臺灣北部地圖&注音符號郵票配對遊戲</h1>
  <div id="game-container">
    <img id="map" src="game4_assets/north2_map.png" alt="地圖">

    <div id="buttons">
      <button onclick="shuffleStamps()">🔄 重排郵票</button>
      <button onclick="location.reload()">🏠 回到遊戲首頁</button>
    </div>

    <div id="size-buttons">
      <button onclick="resizeStamps(1.1)">➕ 放大郵票</button>
      <button onclick="resizeStamps(0.9)">➖ 縮小郵票</button>
    </div>

    <div id="victory-message">🎉 有夠 gâu 🎉</div>
  </div>

  <audio id="success-sound" src="game4_assets/victory.mp3"></audio>
  <audio id="error-sound" src="game4_assets/error.mp3"></audio>

  <script>
    const basePositions = [
      {x: 0.92, y: 0.18}, {x: 0.76, y: 0.05}, {x: 0.58, y: 0.08},
      {x: 0.36, y: 0.20}, {x: 0.15, y: 0.15}, {x: 0.12, y: 0.35},
      {x: 0.05, y: 0.55}, {x: 0.08, y: 0.90}, {x: 0.28, y: 0.95},
      {x: 0.50, y: 0.85}, {x: 0.72, y: 0.50}, {x: 0.90, y: 0.45}
    ];

    const container = document.getElementById("game-container");
    const map = document.getElementById("map");
    const successSound = document.getElementById("success-sound");
    const errorSound = document.getElementById("error-sound");
    const victoryMessage = document.getElementById("victory-message");

    let stamps = [];
    let placedCount = 0;
    let frameScale = 0.08; // 預設比例

    function createFramesAndStamps() {
      stamps = [];
      placedCount = 0;
      container.querySelectorAll(".frame, .stamp").forEach(el => el.remove());

      const containerRect = container.getBoundingClientRect();
      const frameSize = containerRect.width * frameScale;

      basePositions.forEach((pos, i) => {
        const frame = document.createElement("div");
        frame.className = "frame";
        frame.style.width = `${frameSize}px`;
        frame.style.height = `${frameSize}px`;
        frame.style.left = `${pos.x * containerRect.width}px`;
        frame.style.top = `${pos.y * containerRect.height}px`;
        container.appendChild(frame);

        const stamp = document.createElement("img");
        stamp.src = `game4_assets/stamp${i+1}.jpg`;
        stamp.className = "stamp";
        stamp.style.width = `${frameSize}px`;
        stamp.style.height = `${frameSize}px`;
        container.appendChild(stamp);

        stamps.push({el: stamp, frame: frame, original: {x:0,y:0}});
      });

      shuffleStamps();
    }

    function shuffleStamps() {
      const containerRect = container.getBoundingClientRect();
      const frameSize = containerRect.width * frameScale;
      const mapRect = map.getBoundingClientRect();

      stamps.forEach(({el, original}) => {
        let x, y;
        if (Math.random() > 0.5) {
          x = Math.random() * (mapRect.left - frameSize - 10);
        } else {
          x = mapRect.right + Math.random() * (containerRect.width - mapRect.right - frameSize - 10);
        }
        y = mapRect.top + Math.random() * (mapRect.height - frameSize);

        x -= containerRect.left;
        y -= containerRect.top;

        el.style.left = `${x}px`;
        el.style.top = `${y}px`;
        original.x = x;
        original.y = y;

        enableDrag(el, original);
      });
    }

    function enableDrag(stamp, original) {
      let offsetX, offsetY;
      const obj = stamps.find(s => s.el === stamp);

      stamp.onmousedown = function(e) {
        e.preventDefault();
        offsetX = e.clientX - stamp.offsetLeft;
        offsetY = e.clientY - stamp.offsetTop;

        document.onmousemove = function(e) {
          stamp.style.left = `${e.clientX - offsetX}px`;
          stamp.style.top = `${e.clientY - offsetY}px`;
        };

        document.onmouseup = function() {
          document.onmousemove = null;
          document.onmouseup = null;

          const frameRect = obj.frame.getBoundingClientRect();
          const stampRect = stamp.getBoundingClientRect();

          if (!(stampRect.right < frameRect.left ||
                stampRect.left > frameRect.right ||
                stampRect.bottom < frameRect.top ||
                stampRect.top > frameRect.bottom)) {
            successSound.play();
            stamp.style.left = obj.frame.style.left;
            stamp.style.top = obj.frame.style.top;
            stamp.style.pointerEvents = "none";
            placedCount++;
            if (placedCount === stamps.length) {
              victoryMessage.style.display = "block";
            }
          } else {
            errorSound.play();
            stamp.style.left = `${original.x}px`;
            stamp.style.top = `${original.y}px`;
          }
        };
      };
    }

    function resizeStamps(factor) {
      frameScale *= factor;
      createFramesAndStamps();
    }

    // 初始建立
    createFramesAndStamps();

    // 視窗縮放時自動更新
    window.addEventListener("resize", createFramesAndStamps);
  </script>
</body>
</html>
