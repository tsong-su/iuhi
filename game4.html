<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>è‡ºç£åŒ—éƒ¨åœ°åœ–&æ³¨éŸ³ç¬¦è™Ÿéƒµç¥¨é…å°éŠæˆ²</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      overflow: hidden;
      font-family: "Microsoft JhengHei", sans-serif;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }
    #controls button {
      margin-right: 8px;
      padding: 6px 12px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background: #ff6666;
      color: white;
      cursor: pointer;
    }
    #game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    #map {
      max-width: 70%;
      max-height: 70%;
      object-fit: contain;
      display: block;
    }
    .frame {
      position: absolute;
      border: 3px dashed red;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .stamp {
      position: absolute;
      width: 6vw;
      height: auto;
      cursor: grab;
      z-index: 5;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button onclick="shuffleStamps()">ğŸ”„ é‡æ’éƒµç¥¨</button>
    <button onclick="location.href='index.html'">ğŸ  å›åˆ°éŠæˆ²é¦–é </button>
  </div>

  <div id="game-container">
    <img id="map" src="game4_assets/north2_map.png" alt="map">
  </div>

  <!-- éŸ³æ•ˆ -->
  <audio id="correct-sound" src="game4_assets/correct.mp3"></audio>
  <audio id="wrong-sound" src="game4_assets/wrong.mp3"></audio>

  <script>
    const basePositions = [
      {x:0.9953, y:0.1551},
      {x:0.7589, y:0.0012},
      {x:0.5749, y:0.0249},
      {x:0.3782, y:0.1872},
      {x:0.1291, y:0.1264},
      {x:0.115 , y:0.3242},
      {x:0.0077, y:0.5255},
      {x:0.0435, y:0.9668},
      {x:0.2479, y:0.9922},
      {x:0.4791, y:0.9043},
      {x:0.7372, y:0.4916},
      {x:0.9173, y:0.4409}
    ];

    const map = document.getElementById("map");
    const container = document.getElementById("game-container");
    const correctSound = document.getElementById("correct-sound");
    const wrongSound = document.getElementById("wrong-sound");
    const stampSizeVW = 6;

    function createFrames() {
      const rect = map.getBoundingClientRect();
      basePositions.forEach((pos, i) => {
        const frame = document.createElement("div");
        frame.className = "frame";
        frame.style.width = stampSizeVW + "vw";
        frame.style.height = stampSizeVW + "vw";

        // ç´…æ¡†å¾€å¤–å¾®èª¿ (x,y å„å†å¤–æ¨ä¸€é»)
        frame.style.left = (rect.left + pos.x * rect.width + 15) + "px";
        frame.style.top  = (rect.top  + pos.y * rect.height + 15) + "px";

        frame.dataset.index = i;
        container.appendChild(frame);
      });
    }

    function createStamps() {
      for (let i=0; i<12; i++) {
        const stamp = document.createElement("img");
        stamp.src = `game4_assets/stamp${i+1}.jpg`;
        stamp.className = "stamp";
        stamp.dataset.index = i;
        container.appendChild(stamp);
        makeDraggable(stamp);
      }
      shuffleStamps();
    }

    function shuffleStamps() {
      const stamps = document.querySelectorAll(".stamp");
      const containerWidth = container.clientWidth;
      const containerHeight = container.clientHeight;
      const stampWidth = containerWidth * stampSizeVW / 100;
      const stampHeight = stampWidth;

      stamps.forEach(stamp => {
        let x = Math.random() * (containerWidth - stampWidth);
        let y = Math.random() * (containerHeight - stampHeight);
        stamp.style.left = x + "px";
        stamp.style.top  = y + "px";
      });
    }

    function makeDraggable(stamp) {
      let offsetX, offsetY, isDragging = false;

      stamp.addEventListener("mousedown", e => {
        isDragging = true;
        offsetX = e.clientX - stamp.offsetLeft;
        offsetY = e.clientY - stamp.offsetTop;
        stamp.style.zIndex = 10;
      });

      document.addEventListener("mousemove", e => {
        if (!isDragging) return;
        stamp.style.left = (e.clientX - offsetX) + "px";
        stamp.style.top  = (e.clientY - offsetY) + "px";
      });

      document.addEventListener("mouseup", e => {
        if (!isDragging) return;
        isDragging = false;
        stamp.style.zIndex = 5;

        // æª¢æŸ¥æ˜¯å¦æ”¾åˆ°æ­£ç¢ºç´…æ¡†
        const frames = document.querySelectorAll(".frame");
        let matched = false;
        frames.forEach(frame => {
          const fRect = frame.getBoundingClientRect();
          const sRect = stamp.getBoundingClientRect();
          if (isOverlap(fRect, sRect)) {
            if (stamp.dataset.index === frame.dataset.index) {
              // å¸é™„åˆ°ç´…æ¡†ä¸­å¿ƒ
              stamp.style.left = (frame.offsetLeft - stamp.offsetWidth/2 + frame.offsetWidth/2) + "px";
              stamp.style.top  = (frame.offsetTop  - stamp.offsetHeight/2 + frame.offsetHeight/2) + "px";
              stamp.style.pointerEvents = "none";
              correctSound.currentTime = 0;
              correctSound.play();
            } else {
              wrongSound.currentTime = 0;
              wrongSound.play();
            }
            matched = true;
          }
        });
      });
    }

    function isOverlap(r1, r2) {
      return !(r2.left > r1.right || 
               r2.right < r1.left || 
               r2.top > r1.bottom || 
               r2.bottom < r1.top);
    }

    map.onload = () => {
      createFrames();
      createStamps();
    };

    window.addEventListener("resize", () => {
      document.querySelectorAll(".frame").forEach(f => f.remove());
      createFrames();
    });
  </script>
</body>
</html>
