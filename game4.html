<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>臺灣北部地圖&注音符號郵票配對遊戲</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --map-w: clamp(420px, 35vw, 620px); /* 地圖固定寬度（配角） */
    --stamp: 80px;                      /* 郵票固定邊長（主角） */
    --frame: 56px;                      /* 紅框比郵票小一些 */
    --gap: clamp(20px, 6vw, 56px);      /* 地圖與左右郵票距離 */
  }
  *{box-sizing:border-box}
  body{
    margin:0; height:100vh; display:flex; flex-direction:column;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial;
    background:#f7f7f9; color:#222; overflow:hidden; /* 100% 視窗內完整塞入 */
  }
  header{ text-align:center; padding:12px 8px 4px; }
  header h1{ margin:0; font-size:24px; letter-spacing:.5px; }

  /* 舞台：左右郵票 + 中間地圖 */
  .stage{
    flex:1; display:flex; align-items:center; justify-content:center;
    gap:var(--gap); padding:10px 12px;
  }

  /* 左右郵票欄（2排×3） */
  .rack{
    display:grid; grid-template-columns: repeat(3, var(--stamp));
    grid-auto-rows: var(--stamp); gap:14px; place-content:center; place-items:center;
    padding:14px; border-radius:16px; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.07);
  }
  .stamp{
    width:var(--stamp); height:var(--stamp); object-fit:cover; user-select:none;
    cursor:grab; border-radius:8px; filter: drop-shadow(0 3px 8px rgba(0,0,0,.2));
    transition: transform .12s ease;
    touch-action:none; /* 手機指標事件更穩定 */
  }
  .stamp:active{ cursor:grabbing; transform:scale(1.03); }

  /* 地圖（配角） */
  .map-wrap{
    position:relative; width:var(--map-w); aspect-ratio: 1760 / 1415;  /* 以原始標註比 1760×1415 */
    border-radius:18px; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.08);
    display:flex; align-items:center; justify-content:center; overflow:visible;
  }
  #map{ width:100%; height:auto; display:block; border-radius:12px; }

  /* 紅框（答案框） */
  .frame{
    position:absolute; width:var(--frame); height:var(--frame);
    border:2px dashed #e74c3c; border-radius:8px; pointer-events:none; /* 不擋拖曳 */
    transform:translate(-50%, -50%);  /* 以中心點對齊 */
  }
  .frame.filled{ border-color:#2ecc71; border-style:solid; }

  /* 放對位置的郵票會「鎖定」進框 */
  .stamp.locked{
    cursor:default; filter: drop-shadow(0 1px 4px rgba(0,0,0,.15));
  }

  /* 控制列（單行） */
  .controls{
    display:flex; justify-content:center; gap:14px; padding:10px 0 14px;
  }
  .btn{
    border:0; border-radius:10px; padding:10px 16px; font-size:15px; cursor:pointer;
    color:#fff; background:#27ae60; box-shadow:0 4px 10px rgba(39,174,96,.25);
  }
  .btn.reset{ background:#e74c3c; box-shadow:0 4px 10px rgba(231,76,60,.25); }
</style>
</head>
<body>
  <header><h1>臺灣北部地圖&注音符號郵票配對遊戲</h1></header>

  <main class="stage">
    <!-- 左側 6 張 -->
    <section id="rack-left" class="rack" aria-label="左側郵票欄"></section>

    <!-- 地圖 -->
    <section class="map-wrap" aria-label="地圖">
      <img id="map" src="game4_assets/north2_map.png" alt="臺灣北部地圖" />
      <!-- 紅框容器（由 JS 依百分比座標產生） -->
      <div id="frames"></div>
    </section>

    <!-- 右側 6 張 -->
    <section id="rack-right" class="rack" aria-label="右側郵票欄"></section>
  </main>

  <div class="controls">
    <button class="btn reset" id="btnReset">重新開始</button>
    <button class="btn" id="btnHome">回到遊戲首頁</button>
  </div>

  <!-- 音效 -->
  <audio id="sfx-wrong" src="game4_assets/wrong.mp3" preload="auto"></audio>
  <audio id="sfx-victory" src="game4_assets/victory.mp3" preload="auto"></audio>

<script>
/* ------------------------- 可調整區（請依需要修改） ------------------------- */

/** 紅框中心點座標（以 1760×1415 為基準，單位：百分比）
 *  這 12 組來自你先前提供的 x,y，已換算成百分比，因此地圖大小怎麼變都能對位。
 */
const FRAME_POS = [
  {x: 58.8636, y:10.2473},
  {x: 51.4205, y: 5.6537},
  {x: 45.7955, y: 5.8657},
  {x: 40.0000, y:10.1767},
  {x: 33.6932, y: 8.1979},
  {x: 33.6932, y:12.7208},
  {x: 30.9091, y:17.1731},
  {x: 32.2159, y:27.9859},
  {x: 37.5568, y:28.6926},
  {x: 43.2386, y:26.5724},
  {x: 49.6023, y:16.6784},
  {x: 54.2614, y:15.5477},
];

/** 紅框序號 -> 正確郵票編號 的答案對照（不再用縣市名字）
 *  你先前提供：1→stamp3、2→stamp7、3→stamp1
 *  下面先把前三筆照做，其餘先暫放「同號」（方便你之後改）。
 *  需要更動時，只改 right 這個數字即可，例如 5: 12 代表「第 5 個紅框要放 stamp12.jpg」
 */
const ANSWER_MAP = {
  1:3, 2:7, 3:1,
  4:4, 5:5, 6:6,
  7:7, 8:8, 9:9,
  10:10, 11:11, 12:12
};

/** 郵票固定 12 張（左右各 6 張，2 排 × 3） */
const STAMP_FILES = Array.from({length:12}, (_,i)=>`game4_assets/stamp${i+1}.jpg`);

/* ----------------------------- 遊戲主程式 ----------------------------- */

const map = document.getElementById('map');
const framesWrap = document.getElementById('frames');
const rackLeft = document.getElementById('rack-left');
const rackRight = document.getElementById('rack-right');
const sfxWrong = document.getElementById('sfx-wrong');
const sfxVictory = document.getElementById('sfx-victory');

let frames = [];            // 紅框 DOM 陣列
let stamps = [];            // 郵票 DOM 陣列
let placedCount = 0;        // 已正確放置數

/** 產生紅框（依百分比座標） */
function renderFrames(){
  framesWrap.innerHTML = '';
  frames = FRAME_POS.map((p, idx)=>{
    const f = document.createElement('div');
    f.className = 'frame';
    f.dataset.index = (idx+1); // 1..12
    // 把百分比座標換算到 map 元素的 CSS 百分比
    f.style.left = `${p.x}%`;
    f.style.top  = `${p.y}%`;
    framesWrap.appendChild(f);
    return f;
  });
}

/** 產生左右郵票（固定 2×3） */
function renderStamps(){
  const leftSix  = STAMP_FILES.slice(0,6);
  const rightSix = STAMP_FILES.slice(6,12);

  rackLeft.innerHTML = '';
  rackRight.innerHTML = '';

  function make(imgSrc, id){
    const img = document.createElement('img');
    img.className = 'stamp';
    img.src = imgSrc;
    img.alt = `stamp${id}`;
    img.dataset.stamp = String(id); // 1..12
    rack.appendChild(img);
    enableDrag(img);
    stamps.push(img);
  }

  // 左 6
  var rack = rackLeft;
  leftSix.forEach((src, i)=> make(src, i+1));
  // 右 6
  rack = rackRight;
  rightSix.forEach((src, i)=> make(src, i+7));
}

/** 拖曳（pointer 事件） */
function enableDrag(el){
  let startX=0, startY=0, origX=0, origY=0, dragging=false;

  el.addEventListener('pointerdown', (e)=>{
    if(el.classList.contains('locked')) return;
    dragging = true;
    el.setPointerCapture(e.pointerId);
    const rect = el.getBoundingClientRect();
    startX = e.clientX;
    startY = e.clientY;
    origX = rect.left + window.scrollX;
    origY = rect.top  + window.scrollY;
    el.style.position = 'fixed';
    el.style.left = `${origX}px`;
    el.style.top  = `${origY}px`;
    el.style.zIndex = 9999;
  });

  el.addEventListener('pointermove', (e)=>{
    if(!dragging) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    el.style.left = `${origX + dx}px`;
    el.style.top  = `${origY + dy}px`;
  });

  function endDrag(e){
    if(!dragging) return;
    dragging = false;
    el.releasePointerCapture(e.pointerId);

    // 檢查是否落在某個紅框的合理範圍（以中心距離判定）
    const target = hitFrame(e.clientX, e.clientY);
    if(target){
      const frameIdx = Number(target.dataset.index);  // 1..12
      const want = ANSWER_MAP[frameIdx];              // 正解 stamp 編號
      const have = Number(el.dataset.stamp);

      if(want === have && !target.classList.contains('filled')){
        // 放對：鎖進紅框中心
        lockIntoFrame(el, target);
        playStampSound(have);
        placedCount++;
        if(placedCount === frames.length) sfxVictory.play();
        return;
      }
    }

    // 沒框或放錯：彈回原架子位置
    sfxWrong.currentTime = 0; sfxWrong.play();
    el.style.position = ''; el.style.left=''; el.style.top=''; el.style.zIndex='';
  }

  el.addEventListener('pointerup', endDrag);
  el.addEventListener('pointercancel', endDrag);
}

/** 找出離指標最近且足夠近的紅框 */
function hitFrame(x, y){
  let best=null, bestD=1e9;
  for(const f of frames){
    if(f.classList.contains('filled')) continue;
    const r = f.getBoundingClientRect();
    const cx = (r.left + r.right)/2;
    const cy = (r.top  + r.bottom)/2;
    const d = Math.hypot(cx-x, cy-y);
    if(d < bestD){ bestD=d; best=f; }
  }
  // 距離閾值：紅框對角的一半再加一點緩衝
  const side = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--frame'));
  return (bestD < (side*0.75)) ? best : null;
}

/** 把郵票鎖到紅框中心 */
function lockIntoFrame(el, frame){
  const fr = frame.getBoundingClientRect();
  const x = (fr.left+fr.right)/2;
  const y = (fr.top+fr.bottom)/2;
  el.style.position = 'fixed';
  el.style.left = `${x - el.offsetWidth/2}px`;
  el.style.top  = `${y - el.offsetHeight/2}px`;
  el.classList.add('locked');
  frame.classList.add('filled');
}

/** 播放 stampN.mp3（若缺檔不影響遊戲） */
function playStampSound(n){
  const a = new Audio(`game4_assets/stamp${n}.mp3`);
  a.play().catch(()=>{});
}

/** 重置遊戲 */
function resetGame(){
  placedCount = 0;
  frames.forEach(f=>f.classList.remove('filled'));
  stamps.forEach(s=>{
    s.classList.remove('locked');
    s.style.position=''; s.style.left=''; s.style.top=''; s.style.zIndex='';
  });
}

/* 事件：按鈕 */
document.getElementById('btnHome').addEventListener('click', ()=> {
  // 直接回首頁
  window.location.href = 'index.html';
});
document.getElementById('btnReset').addEventListener('click', resetGame);

/* 初始化 */
map.addEventListener('load', ()=> {
  renderFrames();
  renderStamps();
});
</script>
</body>
</html>
