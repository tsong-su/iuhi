<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>臺灣北部地圖&注音符號郵票配對遊戲</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      overflow: hidden;
      font-family: "Microsoft JhengHei", sans-serif;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }
    #controls button {
      margin-right: 8px;
      padding: 6px 12px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background: #ff6666;
      color: white;
      cursor: pointer;
    }
    #game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    #map {
      max-width: 70%;
      max-height: 70%;
      object-fit: contain;
      display: block;
    }
    .frame {
      position: absolute;
      border: 3px dashed red;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .stamp {
      position: absolute;
      width: 6vw;
      height: auto;
      cursor: grab;
      z-index: 5;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button onclick="shuffleStamps()">🔄 重排郵票</button>
    <button onclick="location.href='index.html'">🏠 回到遊戲首頁</button>
  </div>

  <div id="game-container">
    <img id="map" src="game4_assets/north2_map.png" alt="map">
  </div>

  <!-- 音效 -->
  <audio id="correct-sound" src="game4_assets/correct.mp3"></audio>
  <audio id="wrong-sound" src="game4_assets/wrong.mp3"></audio>

  <script>
    const basePositions = [
      {x:0.9953, y:0.1551},
      {x:0.7589, y:0.0012},
      {x:0.5749, y:0.0249},
      {x:0.3782, y:0.1872},
      {x:0.1291, y:0.1264},
      {x:0.115 , y:0.3242},
      {x:0.0077, y:0.5255},
      {x:0.0435, y:0.9668},
      {x:0.2479, y:0.9922},
      {x:0.4791, y:0.9043},
      {x:0.7372, y:0.4916},
      {x:0.9173, y:0.4409}
    ];

    const map = document.getElementById("map");
    const container = document.getElementById("game-container");
    const correctSound = document.getElementById("correct-sound");
    const wrongSound = document.getElementById("wrong-sound");
    const stampSizeVW = 6;

    function createFrames() {
      const rect = map.getBoundingClientRect();
      basePositions.forEach((pos, i) => {
        const frame = document.createElement("div");
        frame.className = "frame";
        frame.style.width = stampSizeVW + "vw";
        frame.style.height = stampSizeVW + "vw";
        frame.style.left = (rect.left + pos.x * rect.width) + "px";
        frame.style.top  = (rect.top  + pos.y * rect.height) + "px";
        frame.dataset.index = i;
        container.appendChild(frame);
      });
    }

    function createStamps() {
      for (let i=0; i<12; i++) {
        const stamp = document.createElement("img");
        stamp.src = `game4_assets/stamp${i+1}.jpg`;
        stamp.className = "stamp";
        stamp.draggable = true;
        stamp.dataset.index = i;
        container.appendChild(stamp);
      }
      shuffleStamps();
    }

    function shuffleStamps() {
      const stamps = document.querySelectorAll(".stamp");
      const containerWidth = container.clientWidth;
      const containerHeight = container.clientHeight;
      const stampWidth = containerWidth * stampSizeVW / 100;
      const stampHeight = stampWidth; // 假設正方形

      stamps.forEach(stamp => {
        let x = Math.random() * (containerWidth - stampWidth);
        let y = Math.random() * (containerHeight - stampHeight);
        stamp.style.left = x + "px";
        stamp.style.top  = y + "px";
      });
    }

    function enableDragAndDrop() {
      let dragged = null;

      document.querySelectorAll(".stamp").forEach(stamp => {
        stamp.addEventListener("dragstart", e => {
          dragged = e.target;
        });
      });

      document.querySelectorAll(".frame").forEach(frame => {
        frame.addEventListener("dragover", e => e.preventDefault());
        frame.addEventListener("drop", e => {
          e.preventDefault();
          if (dragged && dragged.dataset.index === frame.dataset.index) {
            frame.style.border = "3px solid green";
            dragged.style.left = frame.style.left;
            dragged.style.top  = frame.style.top;
            dragged.draggable = false; // 吸附後不可再拖曳
            correctSound.currentTime = 0;
            correctSound.play();
          } else {
            wrongSound.currentTime = 0;
            wrongSound.play();
          }
        });
      });
    }

    map.onload = () => {
      createFrames();
      createStamps();
      enableDragAndDrop();
    };

    window.addEventListener("resize", () => {
      // 視窗縮放時重建紅框，確保不位移
      document.querySelectorAll(".frame").forEach(f => f.remove());
      createFrames();
    });
  </script>
</body>
</html>
