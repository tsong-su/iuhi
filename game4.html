<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>臺灣北部地區郵票配對遊戲</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      text-align: center;
      background-color: #f0f0f0;
      margin: 0;
      padding: 0;
    }
    #game-container {
      position: relative;
      display: inline-block;
      width: 100%;
      max-width: 1000px; /* 預設最大寬度 */
    }
    #map {
      width: 100%;
      height: auto;
      display: block;
    }
    .stamp {
      position: absolute;
      width: 80px;
      height: 80px;
      cursor: grab;
      z-index: 10;
    }
    .slot {
      position: absolute;
      width: 80px;
      height: 80px;
      border: 2px dashed rgba(0,0,0,0.3);
      pointer-events: none;
    }
    #success {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      font-weight: bold;
      color: red;
      display: none;
      z-index: 50;
    }
    #home-btn {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 22px;
      border-radius: 8px;
      background-color: #007bff;
      color: white;
      text-decoration: none;
      display: inline-block;
    }
    #home-btn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h1>臺灣北部地區郵票配對遊戲</h1>
  <div id="game-container">
    <img id="map" src="game4_assets/north_map.png">
    <div id="success">有夠gâu！</div>
  </div>
  <br>
  <a id="home-btn" href="https://tsong-su.github.io/iuhi/index.html">回到遊戲首頁</a>

  <script>
    const container = document.getElementById("game-container");
    const map = document.getElementById("map");
    const success = document.getElementById("success");

    // north_map.png 原圖大小
    const baseWidth = 1760;
    const baseHeight = 1415;

    // 答案座標 (請根據實際圖修正)
    const basePositions = [
      {x:200,y:300},{x:400,y:350},{x:600,y:280},
      {x:800,y:500},{x:1000,y:600},{x:1200,y:400},
      {x:1400,y:700},{x:1600,y:300},{x:1700,y:500},
      {x:600,y:800},{x:900,y:900},{x:1500,y:1000}
    ];

    let stampsPlaced = 0;
    let stamps = [];

    // 當地圖載入完成
    map.onload = () => {
      initGame();
      window.addEventListener("resize", resizeGame);
    };

    function initGame() {
      stampsPlaced = 0;
      stamps = [];

      // 清掉舊元素
      document.querySelectorAll(".slot, .stamp").forEach(el => el.remove());

      resizeGame();
    }

    function resizeGame() {
      const scaleX = map.clientWidth / baseWidth;
      const scaleY = map.clientHeight / baseHeight;

      // 清掉舊的格子
      document.querySelectorAll(".slot").forEach(el => el.remove());

      basePositions.forEach((p, i) => {
        const pos = { x: p.x * scaleX, y: p.y * scaleY };

        // 建立格子
        const slot = document.createElement("div");
        slot.className = "slot";
        slot.style.left = (pos.x - 40) + "px";
        slot.style.top = (pos.y - 40) + "px";
        container.appendChild(slot);

        // 如果第一次才建立郵票
        if (!stamps[i]) {
          const stamp = document.createElement("img");
          stamp.src = `game4_assets/stamp${i+1}.jpg`;
          stamp.className = "stamp";
          stamp.dataset.index = i;
          container.appendChild(stamp);
          stamps[i] = { el: stamp, correct: pos };
          dragElement(stamp, pos, i);
        } else {
          stamps[i].correct = pos;
        }
      });

      scatterStamps(); // 每次縮放重新分散
    }

    // 郵票隨機分散（避免重疊）
    function scatterStamps() {
      const usedPositions = [];
      stamps.forEach((s, i) => {
        let randX, randY, valid = false;
        while (!valid) {
          randX = Math.random() * (map.clientWidth - 100);
          randY = Math.random() * (map.clientHeight - 100);
          valid = true;
          for (let pos of usedPositions) {
            const dx = randX - pos.x;
            const dy = randY - pos.y;
            if (Math.sqrt(dx*dx + dy*dy) < 120) {
              valid = false;
              break;
            }
          }
        }
        usedPositions.push({x: randX, y: randY});
        s.el.style.left = randX + "px";
        s.el.style.top = randY + "px";
      });
    }

    // 拖曳功能
    function dragElement(elmnt, correctPos, index) {
      let offsetX=0, offsetY=0, mouseX=0, mouseY=0, originalX=0, originalY=0;

      elmnt.onmousedown = dragMouseDown;

      function dragMouseDown(e) {
        e.preventDefault();
        mouseX = e.clientX;
        mouseY = e.clientY;
        originalX = elmnt.offsetLeft;
        originalY = elmnt.offsetTop;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
      }

      function elementDrag(e) {
        offsetX = e.clientX - mouseX;
        offsetY = e.clientY - mouseY;
        elmnt.style.left = (elmnt.offsetLeft + offsetX) + "px";
        elmnt.style.top = (elmnt.offsetTop + offsetY) + "px";
        mouseX = e.clientX;
        mouseY = e.clientY;
      }

      function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
        const stampX = elmnt.offsetLeft + 40;
        const stampY = elmnt.offsetTop + 40;
        const dx = stampX - stamps[index].correct.x;
        const dy = stampY - stamps[index].correct.y;
        const dist = Math.sqrt(dx*dx + dy*dy);

        if(dist < 30){
          elmnt.style.left = (stamps[index].correct.x-40)+"px";
          elmnt.style.top = (stamps[index].correct.y-40)+"px";
          elmnt.onmousedown = null;
          playSound(`game4_assets/stamp${index+1}.mp3`);
          stampsPlaced++;
          if(stampsPlaced===stamps.length){
            showSuccess();
          }
        }else{
          elmnt.style.left = originalX+"px";
          elmnt.style.top = originalY+"px";
          playSound("game4_assets/wrong.mp3");
        }
      }
    }

    function playSound(src){
      const audio = new Audio(src);
      audio.play();
    }

    function showSuccess(){
      success.style.display = "block";
      success.style.fontSize = "20px";
      let size = 20;
      const interval = setInterval(()=>{
        size += 5;
        success.style.fontSize = size+"px";
        if(size>=100){ clearInterval(interval); }
      }, 200);
    }
  </script>
</body>
</html>
