<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>è‡ºç£åŒ—éƒ¨åœ°åœ–&æ³¨éŸ³ç¬¦è™Ÿéƒµç¥¨é…å°éŠæˆ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* åœ°åœ–æ•´é«”å¤§å°ï¼ˆé…è§’ï¼‰ */
      --map-size: 60vmin;
      /* éƒµç¥¨èˆ‡ç´…æ¡†å¤§å°ï¼ˆä¸»è§’ï¼‰ */
      --slot-size: 6.2vmin;
      /* ç´…æ¡†æ¨£å¼ */
      --slot-border: 3px dashed red;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      height: 100%;
      background: #f9f9f9;
      font-family: "Microsoft JhengHei", system-ui, -apple-system, Arial, sans-serif;
      overflow: hidden; /* ä¿è­‰ã€Œå®Œæ•´å¡å…¥è¦–çª—ã€ */
    }

    /* èˆå°ï¼šå…¨è¢å¹•ã€ç½®ä¸­åœ°åœ– */
    #stage {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    /* å·¦ä¸Šæ§åˆ¶å€ */
    #leftTop {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 8px;
      z-index: 50;
    }
    #leftTop a, #leftTop button{
      appearance: none;
      border: none;
      border-radius: 10px;
      padding: 8px 14px;
      font-size: 16px;
      background: #0d6efd;
      color: #fff;
      cursor: pointer;
      text-decoration: none;
      box-shadow: 0 2px 6px rgba(0,0,0,.12);
    }
    #leftTop a:hover, #leftTop button:hover{
      filter: brightness(0.95);
    }

    /* åœ°åœ–åŒ…è£¹å±¤ï¼šç”¨ä¾†ç™¾åˆ†æ¯”å®šä½ç´…æ¡† */
    #mapWrap{
      position: relative;
      width: var(--map-size);
      /* é«˜åº¦ç”±åœ–ç‰‡æ’èµ· */
      display: inline-block;
      isolation: isolate; /* åˆ†å±¤ç©©å®š z-index */
    }
    #map{
      display: block;
      width: 100%;
      height: auto;
      object-fit: contain;
      user-drag: none;
      -webkit-user-drag: none;
      pointer-events: none; /* é¿å…æ‹–æ›³æ™‚é¸åˆ°åœ–ç‰‡ */
    }
    /* ç´…æ¡†è¦†è“‹å±¤ï¼Œè·Ÿè‘— mapWrap å°ºå¯¸ï¼…ç¸®æ”¾ */
    #overlay{
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
    .slot{
      position: absolute;
      width: var(--slot-size);
      height: var(--slot-size);
      border: var(--slot-border);
      border-radius: 8px;
      transform: translate(-50%, -50%);
      /* é€é JS è¿½åŠ ï¼štranslate(+shiftX, +shiftY) åšå‘å¤–å¹³ç§» */
    }

    /* éƒµç¥¨ï¼šç›¸å°æ•´å€‹è¦–çª—çµ•å°å®šä½ï¼Œç¢ºä¿å®Œæ•´å¯è¦‹ */
    .stamp{
      position: absolute;
      width: var(--slot-size);
      height: var(--slot-size);
      object-fit: cover;
      border-radius: 6px;
      cursor: grab;
      z-index: 30; /* é«˜æ–¼ç´…æ¡†ï¼Œä½†ä¸é®æ§ä»¶ */
      touch-action: none;  /* æ‰‹æ©Ÿå¹³æ¿å¯ç²¾æº–æ‹–æ›³ */
      user-select: none;
    }

    /* å®Œæˆè¨Šæ¯ */
    #msg{
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      font-size: clamp(28px, 5vmin, 64px);
      color: #28a745;
      font-weight: 800;
      text-shadow: 0 2px 8px rgba(0,0,0,.2);
      pointer-events: none;
      opacity: 0;
      transition: opacity .25s ease;
      z-index: 60;
    }
    #msg.show{ opacity: 1; }
  </style>
</head>
<body>
  <div id="stage">
    <div id="leftTop">
      <a href="https://tsong-su.github.io/iuhi/index.html">ğŸ  å›åˆ°éŠæˆ²é¦–é </a>
      <button id="shuffleBtn" type="button">ğŸ”„ é‡æ’éƒµç¥¨</button>
    </div>

    <div id="mapWrap">
      <img id="map" src="game4_assets/north2_map.png" alt="åŒ—éƒ¨åœ°åœ–" />
      <div id="overlay"></div>
    </div>

    <div id="msg">æœ‰å¤  gÃ¢uï¼</div>
  </div>

  <!-- éŸ³æ•ˆï¼ˆéŒ¯èª¤ & å‹åˆ©ï¼‰-->
  <audio id="wrong" src="game4_assets/wrong.mp3" preload="auto"></audio>
  <audio id="victory" src="game4_assets/victory.mp3" preload="auto"></audio>

  <script>
    /* ====== å¯èª¿åƒæ•¸ ====== */
    // ç´…æ¡†å‘å¤–å¹³ç§»ï¼ˆpxï¼‰ã€‚æ•¸å€¼è¶Šå¤§ï¼Œç´…æ¡†è¶Šå¾€ã€Œé é›¢åœ°åœ–ä¸­å¿ƒçš„æ–¹å‘ã€å¤–æ¨
    const frameOffsetPx = 18;

    // åº§æ¨™ï¼ˆç™¾åˆ†æ¯”ï¼ŒåŸºæ–¼ north2_map.pngï¼‰
    const basePositions = [
      {x: 0.9953, y: 0.1551},
      {x: 0.7589, y: 0.0012},
      {x: 0.5749, y: 0.0249},
      {x: 0.3782, y: 0.1872},
      {x: 0.1291, y: 0.1264},
      {x: 0.115 , y: 0.3242},
      {x: 0.0077, y: 0.5255},
      {x: 0.0435, y: 0.9668},
      {x: 0.2479, y: 0.9922},
      {x: 0.4791, y: 0.9043},
      {x: 0.7372, y: 0.4916},
      {x: 0.9173, y: 0.4409}
    ];

    /* ====== DOM åƒç…§ ====== */
    const stage = document.getElementById('stage');
    const mapWrap = document.getElementById('mapWrap');
    const map = document.getElementById('map');
    const overlay = document.getElementById('overlay');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const msg = document.getElementById('msg');
    const wrongSfx = document.getElementById('wrong');
    const victorySfx = document.getElementById('victory');

    let placedCount = 0;
    let stamps = [];
    let slots = [];

    /* ====== åˆå§‹åŒ– ====== */
    map.addEventListener('load', () => {
      buildSlots();
      buildStamps();
      layoutStampsInGutters();
      window.addEventListener('resize', onResize);
    });

    shuffleBtn.addEventListener('click', () => {
      // åªé‡æ’å°šæœªæ”¾å¥½çš„éƒµç¥¨
      stamps.filter(s => !s.placed).forEach(s => { s.el.style.transition = 'none'; });
      layoutStampsInGutters();
      setTimeout(() => {
        stamps.forEach(s => s.el.style.transition = '');
      }, 50);
    });

    /* ====== å»ºç«‹ç´…æ¡†ï¼ˆä»¥ç™¾åˆ†æ¯”å®šä½ï¼Œä¸æœƒä½ç§»ï¼‰ ====== */
    function buildSlots(){
      overlay.innerHTML = '';
      slots = basePositions.map((p, i) => {
        const div = document.createElement('div');
        div.className = 'slot';
        div.dataset.index = i;
        // ç™¾åˆ†æ¯”å®šä½ï¼ˆç²¾æº–è·Ÿéš¨åœ–ç‰‡ç¸®æ”¾ï¼‰
        div.style.left = (p.x * 100) + '%';
        div.style.top  = (p.y * 100) + '%';
        overlay.appendChild(div);
        return { el: div, i, p };
      });
      // åˆæ¬¡ä¾æ“šåœ°åœ–å°ºå¯¸è³¦äºˆã€Œå‘å¤–å¹³ç§»ã€
      applyOutwardShift();
    }

    /* æ ¹æ“š mapWrap çš„ä¸­å¿ƒï¼Œå°‡æ¯å€‹ç´…æ¡†æ²¿è‘—ã€Œç”±ä¸­å¿ƒâ†’ç´…æ¡†ã€çš„æ–¹å‘å¤–æ¨ frameOffsetPx */
    function applyOutwardShift(){
      const r = overlay.getBoundingClientRect();
      const cx = r.width / 2;
      const cy = r.height / 2;

      slots.forEach(s => {
        // è¨ˆç®—è©² slot çš„åƒç´ åº§æ¨™ï¼ˆæœªå¹³ç§»å‰ï¼‰
        const px = s.p.x * r.width;
        const py = s.p.y * r.height;
        let dx = px - cx;
        let dy = py - cy;
        const len = Math.hypot(dx, dy) || 1;
        dx = dx / len * frameOffsetPx;
        dy = dy / len * frameOffsetPx;
        // å°‡ px å¹³ç§»è½‰æˆ CSS åƒç´ 
        s.el.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
      });
      // ä¿éšœç´…æ¡†å®Œæ•´åœ¨è¦–çª—å…§ï¼ˆè‹¥å¤ªé é‚Šï¼Œå¾€å…§æ”¶ä¸€é»ï¼‰
      clampSlotsInsideStage();
    }

    function clampSlotsInsideStage(){
      const stageRect = stage.getBoundingClientRect();
      const slotSizePx = vminToPx(getComputedStyle(document.documentElement).getPropertyValue('--slot-size'));
      const half = slotSizePx / 2;

      slots.forEach(s => {
        const rect = s.el.getBoundingClientRect();
        let shiftX = 0, shiftY = 0;
        if (rect.left < stageRect.left + 2) shiftX = (stageRect.left + 2) - rect.left;
        if (rect.right > stageRect.right - 2) shiftX = (stageRect.right - 2) - rect.right;
        if (rect.top < stageRect.top + 2) shiftY = (stageRect.top + 2) - rect.top;
        if (rect.bottom > stageRect.bottom - 2) shiftY = (stageRect.bottom - 2) - rect.bottom;

        if (shiftX !== 0 || shiftY !== 0){
          // ç–ŠåŠ ä¿®æ­£åˆ° transform
          const tr = s.el.style.transform || 'translate(-50%, -50%)';
          s.el.style.transform = `translate(calc(-50% + ${shiftX}px), calc(-50% + ${shiftY}px)) ${tr.includes('translate(')?'':''
            }`;
          // ç‚ºé¿å…éå¢èª¤å·®ï¼Œç°¡åŒ–ï¼šç›´æ¥æŠŠ shift ç–ŠåŠ åˆ°ç¾æœ‰çš„ dx/dy çµæœ
        }
      });
    }

    /* vmin è½‰ pxï¼ˆç”¨æ–¼å¹¾ä½•åˆ¤æ–·ï¼‰ */
    function vminToPx(v){
      const num = parseFloat(v);
      const unit = (v || '').toString().trim().endsWith('vmin');
      if (!unit) return num; // å·²æ˜¯ px
      const vmin = Math.min(window.innerWidth, window.innerHeight) / 100;
      return num * vmin;
    }

    /* ====== å»ºç«‹éƒµç¥¨ï¼ˆä¸»è§’ï¼‰ ====== */
    function buildStamps(){
      // æ¸…æ‰èˆŠçš„
      stamps.forEach(s => s.el.remove());
      stamps = [];
      placedCount = 0;
      hideVictory();

      for (let i = 0; i < basePositions.length; i++){
        const img = document.createElement('img');
        img.className = 'stamp';
        img.src = `game4_assets/stamp${i+1}.jpg`;
        img.alt = `stamp${i+1}`;
        img.draggable = false; // æˆ‘å€‘ç”¨ pointer äº‹ä»¶è‡ªè£½æ‹–æ›³
        img.dataset.index = i;
        stage.appendChild(img);

        const stamp = { el: img, i, placed: false };
        stamps.push(stamp);
        enablePointerDrag(stamp);
      }
    }

    /* ====== éƒµç¥¨åˆ†æ•£åˆ°å››å‘¨ç•™ç™½ï¼ˆé¿å…å£“ä½åœ°åœ–èˆ‡ç´…æ¡†ï¼‰ ====== */
    function layoutStampsInGutters(){
      const stageRect = stage.getBoundingClientRect();
      const mapRect = mapWrap.getBoundingClientRect();
      const size = vminToPx(getComputedStyle(document.documentElement).getPropertyValue('--slot-size'));
      const margin = 6;               // èˆ‡é‚Šç•Œ/å½¼æ­¤çš„æœ€å°é–“è·
      const triesMax = 200;           // æ¯å¼µæœ€å¤šå˜—è©¦æ¬¡æ•¸

      // å››å€‹ gutterï¼ˆä¿è­‰å¯è¦‹ï¼‰
      const gutters = [
        // ä¸Šæ–¹
        { x: mapRect.left, y: stageRect.top + 4, w: mapRect.width, h: Math.max(10, mapRect.top - stageRect.top - 8) },
        // ä¸‹æ–¹
        { x: mapRect.left, y: mapRect.bottom + 4, w: mapRect.width, h: Math.max(10, stageRect.bottom - mapRect.bottom - 8) },
        // å·¦å´
        { x: stageRect.left + 4, y: stageRect.top + 4, w: Math.max(10, mapRect.left - stageRect.left - 8), h: stageRect.height - 8 },
        // å³å´
        { x: mapRect.right + 4, y: stageRect.top + 4, w: Math.max(10, stageRect.right - mapRect.right - 8), h: stageRect.height - 8 }
      ].filter(g => g.w >= size + margin && g.h >= size + margin);

      const placed = [];

      stamps.forEach(s => {
        if (s.placed) return; // å·²æ”¾å¥½çš„ä¸é‡æ’
        let ok = false, tries = 0;
        while(!ok && tries++ < triesMax){
          const g = gutters[Math.floor(Math.random() * gutters.length)];
          const x = g.x + margin + Math.random() * (g.w - size - margin*2);
          const y = g.y + margin + Math.random() * (g.h - size - margin*2);
          const rect = { left: x, top: y, right: x + size, bottom: y + size };

          ok = placed.every(p => !isOverlap(rect, p, 0.6*size));
          if (ok){
            s.el.style.left = `${x}px`;
            s.el.style.top  = `${y}px`;
            placed.push(rect);
          }
        }
        // è‹¥å››å‘¨ç©ºé–“ä¸è¶³ï¼Œä¿åº•ï¼šæ”¾å³ä¸‹è§’é å…§ä½ç½®
        if (!ok){
          const x = Math.min(stageRect.right - size - margin, mapRect.right + 10);
          const y = Math.min(stageRect.bottom - size - margin, mapRect.bottom + 10);
          s.el.style.left = `${x}px`;
          s.el.style.top  = `${y}px`;
        }
      });
    }

    function isOverlap(a, b, pad=0){
      return !(
        a.right < b.left - pad ||
        a.left  > b.right + pad ||
        a.bottom < b.top - pad ||
        a.top > b.bottom + pad
      );
    }

    /* ====== æŒ‡æ¨™äº‹ä»¶æ‹–æ›³ï¼ˆæ»‘é¼ /è§¸æ§é€šåƒï¼‰ ====== */
    function enablePointerDrag(stamp){
      let downX=0, downY=0, startLeft=0, startTop=0, dragging=false;

      const onDown = (e)=>{
        if (stamp.placed) return;
        dragging = true;
        const p = getPoint(e);
        downX = p.x; downY = p.y;
        const rect = stamp.el.getBoundingClientRect();
        startLeft = rect.left;
        startTop  = rect.top;
        stamp.el.style.cursor = 'grabbing';
        stamp.el.style.zIndex = 40;
        stamp.el.setPointerCapture?.(e.pointerId);
      };

      const onMove = (e)=>{
        if (!dragging) return;
        const p = getPoint(e);
        const nx = startLeft + (p.x - downX);
        const ny = startTop  + (p.y - downY);
        stamp.el.style.left = `${nx}px`;
        stamp.el.style.top  = `${ny}px`;
      };

      const onUp = async (e)=>{
        if (!dragging) return;
        dragging = false;
        stamp.el.style.cursor = 'grab';
        stamp.el.style.zIndex = 30;

        // åˆ¤æ–·æ˜¯å¦å°åˆ°æ­£ç¢ºç´…æ¡†ä¸­å¿ƒ
        const sRect = stamp.el.getBoundingClientRect();
        const sCx = (sRect.left + sRect.right) / 2;
        const sCy = (sRect.top  + sRect.bottom) / 2;

        const slot = slots[stamp.i];
        const slotRect = slot.el.getBoundingClientRect();
        const slotCx = (slotRect.left + slotRect.right) / 2;
        const slotCy = (slotRect.top  + slotRect.bottom) / 2;

        // ä»¥æ§½å¯¬çš„ä¸€åŠåšå¸é™„åŠå¾‘
        const snapRadius = slotRect.width * 0.55;
        const dist = Math.hypot(sCx - slotCx, sCy - slotCy);

        if (dist <= snapRadius){
          // å¸é™„åˆ°ç´…æ¡†ä¸­å¿ƒ
          stamp.el.style.left = `${slotCx - sRect.width/2}px`;
          stamp.el.style.top  = `${slotCy - sRect.height/2}px`;
          stamp.placed = true;
          // æ’­æ”¾å°æ‡‰éŸ³æª”ï¼ˆstamp1~12.mp3ï¼‰ï¼Œè‹¥å¤±æ•—å‰‡ç•¥é
          try {
            const audio = new Audio(`game4_assets/stamp${stamp.i+1}.mp3`);
            await audio.play();
          } catch(e){}
          placedCount++;
          if (placedCount === basePositions.length) showVictory();
        }else{
          // éŒ¯èª¤éŸ³æ•ˆ
          try { wrongSfx.currentTime = 0; await wrongSfx.play(); } catch(e){}
        }
      };

      stamp.el.addEventListener('pointerdown', onDown);
      window.addEventListener('pointermove', onMove);
      window.addEventListener('pointerup', onUp);
    }

    function getPoint(e){
      return ('touches' in e) ? { x:e.touches[0].clientX, y:e.touches[0].clientY } : { x:e.clientX, y:e.clientY };
    }

    /* ====== å®Œæˆè¨Šæ¯ ====== */
    function showVictory(){
      msg.classList.add('show');
      try { victorySfx.currentTime = 0; victorySfx.play(); } catch(e){}
    }
    function hideVictory(){
      msg.classList.remove('show');
    }

    /* ====== è¦–çª—æ”¹è®Šæ™‚ï¼Œä¿æŒä¸€åˆ‡å°é½Š ====== */
    function onResize(){
      // é‡æ–°å¥—ç”¨ç´…æ¡†å‘å¤–å¹³ç§»ï¼ˆä¾æ“šæ–°å°ºå¯¸ï¼‰
      applyOutwardShift();
      // æœªæ”¾å¥½çš„éƒµç¥¨ï¼Œç¶­æŒåœ¨å¯è¦–å€åŸŸï¼ˆé¿å…è¶…å‡ºï¼‰
      layoutStampsInGutters();
    }
  </script>
</body>
</html>
