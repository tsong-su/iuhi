<script>
/* ========== 0) 目標 SVG 抓取（相容 v1 結構） ========== */
const STAGE = document.querySelector('svg#stage') || document.querySelector('svg');
const ROOT  = (document.getElementById('svgRoot')) || STAGE;
if(!STAGE||!ROOT){ console.warn('[map] 找不到 SVG 畫布'); }

/* ========== 1) 資料：四群與 新/舊/拼音（拼音僅在彈窗出現） ========== */
const GROUPS = {
  center: ["楠梓","左營","鼓山","三民","鹽埕","前金","新興","苓雅","旗津","前鎮","小港"],
  east:   ["大樹","大寮","林園","大社","仁武","鳥松","鳳山"],
  north:  ["茄萣","永安","彌陀","梓官","湖內","路竹","岡山","橋頭","阿蓮","田寮","燕巢"],
  mount:  ["內門","旗山","杉林","美濃","甲仙","六龜","那瑪夏","桃源","茂林"]
};
const COLOR = { center:'#f87171', east:'#c4b5fd', north:'#9FDF72', mount:'#99f6e4' };
const whichGroup = n => GROUPS.center.includes(n)?'center':GROUPS.east.includes(n)?'east':GROUPS.north.includes(n)?'north':GROUPS.mount.includes(n)?'mount':null;

/* 新/舊名稱 + 台語拼音（拼音只在彈窗用） */
const D = {
  "楠梓":{old:"楠仔坑",      pyNew:"Lâm-tsú",        pyOld:"Lâm-á-khenn"},
  "左營":{old:"埤仔頭",      pyNew:"Tsó-iânn",       pyOld:"Pi-á-thâu"},
  "鼓山":{old:"打狗山",      pyNew:"Kóo-san",        pyOld:"Tánn-kóo-san"},
  "三民":{old:"三塊厝",      pyNew:"Sam-bîn",        pyOld:"Sann-tè-tshù"},
  "鹽埕":{old:"鹽埕埔",      pyNew:"Iâm-tiânn",      pyOld:"Iâm-tiânn-poo"},
  "前金":{old:"前衿",        pyNew:"Tsiân-kim",      pyOld:"Tsiân-khim"},
  "新興":{old:"逮港埔",      pyNew:"Sin-hing",       pyOld:"Tāi-káng-poo"},
  "苓雅":{old:"笭仔寮",      pyNew:"Lîng-ngá",       pyOld:"Lîng-á-liâu"},
  "旗津":{old:"旗後",        pyNew:"Kî-tin",         pyOld:"Kî-āu"},
  "前鎮":{old:"前鎮",        pyNew:"Tsiân-tìn",      pyOld:"Tsiân-tìn"},
  "小港":{old:"港仔墘",      pyNew:"Sió-káng",       pyOld:"Káng-á kînn"},
  "大樹":{old:"大樹跤",      pyNew:"Tuā-tshiū",      pyOld:"Tuā-tshiū-kha"},
  "大寮":{old:"大藔",        pyNew:"Tuā-liâu",       pyOld:"Tuā-liâu"},
  "林園":{old:"頂林仔邊",    pyNew:"Lîm-hn̂g",        pyOld:"Tíng-nâ-á-pinn"},
  "大社":{old:"三奶壇",      pyNew:"Tuā-siā",        pyOld:"Sam-nái-tuânn"},
  "仁武":{old:"仁武庄",      pyNew:"Jîn-bú",         pyOld:"Jîn-bú-tsng"},
  "鳥松":{old:"鳥松跤",      pyNew:"Tsiáu-tshîng",   pyOld:"Tsiáu-tshîng-kha"},
  "鳳山":{old:"下埤頭",      pyNew:"Hōng-suann",     pyOld:"Ē-pi-thâu"},
  "茄萣":{old:"茄苳萣仔",    pyNew:"Ka-tiānn",       pyOld:"Ka-tang-tiānn-á"},
  "永安":{old:"烏樹林",      pyNew:"Íng-an",         pyOld:"Oo-tshiū-nâ"},
  "彌陀":{old:"彌陀港",      pyNew:"Mî-tô",          pyOld:"Bî-lô-káng"},
  "梓官":{old:"梓官",        pyNew:"Tsú-kuann",      pyOld:"Tsú-kuann"},
  "湖內":{old:"大湖",        pyNew:"Ôo-lāi",         pyOld:"Tuā-ôo"},
  "路竹":{old:"半路竹",      pyNew:"Lōo-tik",        pyOld:"Puànn-lōo-tik"},
  "岡山":{old:"阿公店",      pyNew:"Kong-san",       pyOld:"A-kong-tiàm"},
  "橋頭":{old:"橋仔頭",      pyNew:"Kiô-thâu",       pyOld:"Kiô-á-thâu"},
  "阿蓮":{old:"阿嗹社",      pyNew:"A-lian",         pyOld:"A-lian-siā"},
  "田寮":{old:"田藔",        pyNew:"Tshân-liâu",     pyOld:"Tshân-liâu"},
  "燕巢":{old:"援剿右",      pyNew:"Iàn-tsâu",       pyOld:"Uān-tsâu-iū"},
  "內門":{old:"羅漢內門",    pyNew:"Lāi-bûn",        pyOld:"Lô-hàn-lāi-bûn"},
  "旗山":{old:"蕃薯藔",      pyNew:"Kî-san",         pyOld:"Han-tsî-liâu"},
  "杉林":{old:"楠梓仙",      pyNew:"Sam-nâ",         pyOld:"Lâm-tsú-sian"},
  "美濃":{old:"瀰濃",        pyNew:"Bi-long",        pyOld:"Bî-long"},
  "甲仙":{old:"阿里關",      pyNew:"Kah-sian",       pyOld:"A-lí-kuan"},
  "六龜":{old:"六龜里社",    pyNew:"La̍k-ku",         pyOld:"La̍k-ku-lí-siā"},
  "那瑪夏":{old:"蚊子只",     pyNew:"Na-má-siah",     pyOld:"Mangacun/Báng-á-tsí"},
  "桃源":{old:"雅爾",        pyNew:"Thô-guân",       pyOld:"Ngani/Ngá-ní"},
  "茂林":{old:"多納",        pyNew:"Bōo-lîm",        pyOld:"Tō-na"}
};
/* 音檔編號表（01~38） */
const ORDER = [
  "楠梓","左營","鼓山","三民","鹽埕","前金","新興","苓雅","旗津","前鎮","小港",
  "大樹","大寮","林園","大社","仁武","鳥松","鳳山",
  "茄萣","永安","彌陀","梓官","湖內","路竹","岡山","橋頭","阿蓮","田寮","燕巢",
  "內門","旗山","杉林","美濃","甲仙","六龜","那瑪夏","桃源","茂林"
];
const IDX = Object.fromEntries(ORDER.map((n,i)=>[n,String(i+1).padStart(2,'0')]));

/* ========== 2) 工具 ========== */
const pureName = s => (s||'').replace(/區.*$/,'').replace(/\s*\(.+?\)\s*$/,'').replace(/\s*[A-Za-z].*$/,'').trim();
const unionBBox = (acc,b)=>!acc?b:{x:Math.min(acc.x,b.x),y:Math.min(acc.y,b.y),width:Math.max(acc.x+acc.width,b.x+b.width)-Math.min(acc.x,b.x),height:Math.max(acc.y+acc.height,b.y+b.height)-Math.min(acc.y,b.y)};
function bboxOf(container){
  let bb=null; container.querySelectorAll('path,polygon').forEach(el=>{ try{const b=el.getBBox(); if(b.width>0&&b.height>0) bb=unionBBox(bb,b);}catch(_){}}); return bb;
}
function fitFull(){
  const bb = bboxOf(ROOT) || {x:0,y:0,width:1143.062,height:1440.995};
  const pad=0.06, x=bb.x-bb.width*pad, y=bb.y-bb.height*pad, w=bb.width*(1+2*pad), h=bb.height*(1+2*pad);
  STAGE.setAttribute('viewBox',[x,y,w,h].join(' '));
}

/* ========== 3) 啟動：上色 → 產生新/舊「雙行」標籤 → 點擊浮窗（含拼音與音檔） ========== */
(function init(){
  if(!STAGE||!ROOT) return;

  // A) 先保持你 v1 的完整圖，不刪任何東西（原檔沒有黑框，就不會動它）。
  //    若之後你看到黑框，代表那是外部資源或新檔加入，我再幫你定點移除。

  // B) 隱藏原 SVG 裡舊的 <text>（避免與我們的雙行標籤重疊）
  ROOT.querySelectorAll('text').forEach(t=>t.setAttribute('display','none'));

  // C) 依四群上色，並綁定點擊。
  const zones=[];
  ROOT.querySelectorAll('path,polygon').forEach(el=>{
    const t = el.querySelector('title');
    let name = pureName(t && t.textContent);
    if(!name) return;
    const g = whichGroup(name); if(!g) return;
    el.setAttribute('fill', COLOR[g]);
    el.setAttribute('stroke', '#ffffff');
    el.setAttribute('stroke-width','1');
    el.style.transition='filter .25s ease';
    el.addEventListener('mouseenter', ()=>el.style.filter='brightness(1.12)'); 
    el.addEventListener('mouseleave', ()=>el.style.filter='');

    el.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      // 點擊回饋（外框亮度漸強淡出）
      el.style.animation='none'; void el.offsetWidth; el.style.animation='ringPulse 1s ease';
      showTip(name, el);
    });

    zones.push({name, el});
  });

  // D) 在地圖上建立「雙行標籤」層：上新（紅）、下舊（黑）。**不顯示拼音**
  let layer = STAGE.querySelector('#labelsLayer');
  if(!layer){
    layer = document.createElementNS('http://www.w3.org/2000/svg','g');
    layer.setAttribute('id','labelsLayer');
    STAGE.appendChild(layer);
  }
  layer.innerHTML='';
  zones.forEach(({name,el})=>{
    const info = D[name]; if(!info) return;
    try{
      const b = el.getBBox();
      const cx = b.x + b.width/2;
      const cy = b.y + b.height/2;

      // 新地名（紅）
      const t1 = document.createElementNS('http://www.w3.org/2000/svg','text');
      t1.setAttribute('x', cx);
      t1.setAttribute('y', cy - 4);
      t1.setAttribute('class','label label-new');
      t1.textContent = name;

      // 舊地名（黑）
      const t2 = document.createElementNS('http://www.w3.org/2000/svg','text');
      t2.setAttribute('x', cx);
      t2.setAttribute('y', cy + 14);
      t2.setAttribute('class','label label-old');
      t2.textContent = info.old || '';

      layer.appendChild(t1);
      layer.appendChild(t2);
    }catch(_){}
  });

  // E) 一開啟就全圖
  fitFull();

  // F) 點空白關閉彈窗
  document.addEventListener('click', ()=>{const tp=document.getElementById('tip'); if(tp) tp.classList.remove('show');},{capture:true});
})();

/* ========== 4) 標籤樣式（注入 CSS） ========== */
const style = document.createElement('style');
style.textContent = `
  @keyframes ringPulse{ 0%{filter:brightness(1);stroke-width:1} 40%{filter:brightness(1.55);stroke-width:2.5} 100%{filter:brightness(1);stroke-width:1} }
  .label{ font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,Arial; font-size:13px;
          paint-order:stroke; stroke:#fff; stroke-width:3px; stroke-linejoin:round; text-anchor:middle; pointer-events:none; }
  .label-new{ fill:#b91c1c; font-weight:700; }
  .label-old{ fill:#111827; font-weight:600; }
`;
document.head.appendChild(style);

/* ========== 5) 浮窗：貼旁邊、邊界避讓、顯示拼音與播放鍵 ========== */
/* 你的 v1 應該已有這些元素（若沒有可在頁面加上）：#tip, #tipNew, #tipOld, #tipPyNew, #tipPyOld, #btnPlayNew, #btnPlayOld, #aud */
const tip = document.getElementById('tip');
const tNew = document.getElementById('tipNew');
const tOld = document.getElementById('tipOld');
const tPyN = document.getElementById('tipPyNew');
const tPyO = document.getElementById('tipPyOld');
const btnN = document.getElementById('btnPlayNew');
const btnO = document.getElementById('btnPlayOld');
const aud  = document.getElementById('aud');

function showTip(name, elem){
  const d = D[name] || {};
  // 顯示：新（含括號拼音）、舊（含括號拼音）
  tNew.textContent = d.pyNew ? `${name}（${d.pyNew}）` : name;
  tOld.textContent = d.old ? (d.pyOld ? `${d.old}（${d.pyOld}）` : d.old) : '';
  tPyN.textContent = d.pyNew || '';
  tPyO.textContent = d.pyOld || '';

  // 音檔：map_assets/sounds/01楠梓_new.mp3 / 01楠仔坑_old.mp3
  const idx = IDX[name];
  const newSrc = idx ? `map_assets/sounds/${idx}${name}_new.mp3` : '';
  const oldSrc = (idx && d.old) ? `map_assets/sounds/${idx}${d.old}_old.mp3` : '';
  btnN.disabled = !newSrc; btnO.disabled = !oldSrc;
  btnN.onclick = ()=> play(newSrc);
  btnO.onclick = ()=> play(oldSrc);

  placeTip(elem); tip.classList.add('show');
  const closeOnce = (ev)=>{ if(!tip.contains(ev.target)) { tip.classList.remove('show'); window.removeEventListener('click',closeOnce,true);} };
  setTimeout(()=>window.addEventListener('click',closeOnce,true),0);
}

function play(src){ if(!src) return; aud.pause(); aud.src=src; aud.play().catch(()=>{}); }

/* 自動避讓：根據被點區塊所在象限，往外偏移；再做邊界裁切 */
function placeTip(el){
  const host = STAGE.getBoundingClientRect();
  const r = el.getBoundingClientRect();
  const cx = r.left + r.width/2, cy = r.top + r.height/2;
  const onLeft = cx < (host.left + host.width/2);
  const onTop  = cy < (host.top  + host.height/2);
  let dx = onLeft ? +110 : -110;
  let dy = onTop  ? +46  : -46;
  let left = cx - host.left + dx + window.scrollX;
  let top  = cy - host.top  + dy + window.scrollY;
  const pad=12, w=tip.offsetWidth||260, h=tip.offsetHeight||140;
  left = Math.max(pad, Math.min(left, host.width - pad));
  top  = Math.max(pad, Math.min(top,  host.height- pad));
  tip.style.left = left+'px'; tip.style.top = top+'px';
}
</script>
