<script>
/* ========== 0) 安全抓取目標 SVG ========== */
const STAGE = document.querySelector('svg#stage') || document.querySelector('svg');
const ROOT  = (document.getElementById('svgRoot')) || STAGE;
if (!STAGE || !ROOT) { console.warn('[map hotfix] 未找到 SVG 畫布'); }

/* ========== 1) 四群與顏色（北區加深） ========== */
const GROUPS = {
  center: ["楠梓","左營","鼓山","三民","鹽埕","前金","新興","苓雅","旗津","前鎮","小港"],
  east:   ["大樹","大寮","林園","大社","仁武","鳥松","鳳山"],
  north:  ["茄萣","永安","彌陀","梓官","湖內","路竹","岡山","橋頭","阿蓮","田寮","燕巢"],
  mount:  ["內門","旗山","杉林","美濃","甲仙","六龜","那瑪夏","桃源","茂林"]
};
const COLOR = { center:'#f87171', east:'#c4b5fd', north:'#9FDF72', mount:'#99f6e4' };
const whichGroup = n => GROUPS.center.includes(n)?'center':GROUPS.east.includes(n)?'east':GROUPS.north.includes(n)?'north':GROUPS.mount.includes(n)?'mount':null;

/* ========== 2) 內建資料（新/舊＋拼音） ========== */
const D = {
  "楠梓":{old:"楠仔坑",      pyNew:"Lâm-tsú",        pyOld:"Lâm-á-khenn"},
  "左營":{old:"埤仔頭",      pyNew:"Tsó-iânn",       pyOld:"Pi-á-thâu"},
  "鼓山":{old:"打狗山",      pyNew:"Kóo-san",        pyOld:"Tánn-kóo-san"},
  "三民":{old:"三塊厝",      pyNew:"Sam-bîn",        pyOld:"Sann-tè-tshù"},
  "鹽埕":{old:"鹽埕埔",      pyNew:"Iâm-tiânn",      pyOld:"Iâm-tiânn-poo"},
  "前金":{old:"前衿",        pyNew:"Tsiân-kim",      pyOld:"Tsiân-khim"},
  "新興":{old:"逮港埔",      pyNew:"Sin-hing",       pyOld:"Tāi-káng-poo"},
  "苓雅":{old:"笭仔寮",      pyNew:"Lîng-ngá",       pyOld:"Lîng-á-liâu"},
  "旗津":{old:"旗後",        pyNew:"Kî-tin",         pyOld:"Kî-āu"},
  "前鎮":{old:"前鎮",        pyNew:"Tsiân-tìn",      pyOld:"Tsiân-tìn"},
  "小港":{old:"港仔墘",      pyNew:"Sió-káng",       pyOld:"Káng-á kînn"},
  "大樹":{old:"大樹跤",      pyNew:"Tuā-tshiū",      pyOld:"Tuā-tshiū-kha"},
  "大寮":{old:"大藔",        pyNew:"Tuā-liâu",       pyOld:"Tuā-liâu"},
  "林園":{old:"頂林仔邊",    pyNew:"Lîm-hn̂g",        pyOld:"Tíng-nâ-á-pinn"},
  "大社":{old:"三奶壇",      pyNew:"Tuā-siā",        pyOld:"Sam-nái-tuânn"},
  "仁武":{old:"仁武庄",      pyNew:"Jîn-bú",         pyOld:"Jîn-bú-tsng"},
  "鳥松":{old:"鳥松跤",      pyNew:"Tsiáu-tshîng",   pyOld:"Tsiáu-tshîng-kha"},
  "鳳山":{old:"下埤頭",      pyNew:"Hōng-suann",     pyOld:"Ē-pi-thâu"},
  "茄萣":{old:"茄苳萣仔",    pyNew:"Ka-tiānn",       pyOld:"Ka-tang-tiānn-á"},
  "永安":{old:"烏樹林",      pyNew:"Íng-an",         pyOld:"Oo-tshiū-nâ"},
  "彌陀":{old:"彌陀港",      pyNew:"Mî-tô",          pyOld:"Bî-lô-káng"},
  "梓官":{old:"梓官",        pyNew:"Tsú-kuann",      pyOld:"Tsú-kuann"},
  "湖內":{old:"大湖",        pyNew:"Ôo-lāi",         pyOld:"Tuā-ôo"},
  "路竹":{old:"半路竹",      pyNew:"Lōo-tik",        pyOld:"Puànn-lōo-tik"},
  "岡山":{old:"阿公店",      pyNew:"Kong-san",       pyOld:"A-kong-tiàm"},
  "橋頭":{old:"橋仔頭",      pyNew:"Kiô-thâu",       pyOld:"Kiô-á-thâu"},
  "阿蓮":{old:"阿嗹社",      pyNew:"A-lian",         pyOld:"A-lian-siā"},
  "田寮":{old:"田藔",        pyNew:"Tshân-liâu",     pyOld:"Tshân-liâu"},
  "燕巢":{old:"援剿右",      pyNew:"Iàn-tsâu",       pyOld:"Uān-tsâu-iū"},
  "內門":{old:"羅漢內門",    pyNew:"Lāi-bûn",        pyOld:"Lô-hàn-lāi-bûn"},
  "旗山":{old:"蕃薯藔",      pyNew:"Kî-san",         pyOld:"Han-tsî-liâu"},
  "杉林":{old:"楠梓仙",      pyNew:"Sam-nâ",         pyOld:"Lâm-tsú-sian"},
  "美濃":{old:"瀰濃",        pyNew:"Bi-long",        pyOld:"Bî-long"},
  "甲仙":{old:"阿里關",      pyNew:"Kah-sian",       pyOld:"A-lí-kuan"},
  "六龜":{old:"六龜里社",    pyNew:"La̍k-ku",         pyOld:"La̍k-ku-lí-siā"},
  "那瑪夏":{old:"蚊子只",     pyNew:"Na-má-siah",     pyOld:"Mangacun/Báng-á-tsí"},
  "桃源":{old:"雅爾",        pyNew:"Thô-guân",       pyOld:"Ngani/Ngá-ní"},
  "茂林":{old:"多納",        pyNew:"Bōo-lîm",        pyOld:"Tō-na"}
};

/* ========== 3) 工具：取名、BBox、全圖 ========== */
function pureName(raw){
  return (raw||'')
    .replace(/區.*$/,'')
    .replace(/\s*\(.+?\)\s*$/,'')
    .replace(/\s*[A-Za-z].*$/,'')
    .trim();
}
function unionBBox(acc,b){
  if(!acc) return b;
  const x = Math.min(acc.x,b.x), y=Math.min(acc.y,b.y);
  const r = Math.max(acc.x+acc.width,  b.x+b.width);
  const t = Math.max(acc.y+acc.height, b.y+b.height);
  return {x, y, width:r-x, height:t-y};
}
function bboxOfPaths(container){
  let bb=null;
  container.querySelectorAll('path,polygon').forEach(el=>{
    try{ const b=el.getBBox(); if(b.width>0&&b.height>0) bb=unionBBox(bb,b);}catch(_){}
  });
  return bb;
}
function fitFull(container=ROOT){
  const bb = bboxOfPaths(container) || {x:0,y:0,width:1143.062,height:1440.995};
  const pad=0.06, x=bb.x-bb.width*pad, y=bb.y-bb.height*pad, w=bb.width*(1+2*pad), h=bb.height*(1+2*pad);
  STAGE.setAttribute('viewBox', [x,y,w,h].join(' '));
}

/* ========== 4) 啟動：清框→上色→標籤→互動→全圖 ========== */
(function init(){
  if(!STAGE||!ROOT) return;

  // 4-1 去除「黑粗框 / 巨型底圖」
  const vb = STAGE.viewBox.baseVal || {width:1143.062,height:1440.995};
  const total = (vb.width||1143.062)*(vb.height||1440.995);
  let biggest = null, biggestA = 0;
  ROOT.querySelectorAll('rect,path,polygon').forEach(el=>{
    try{
      const b=el.getBBox(); const a=b.width*b.height;
      const hasTitle = !!(el.querySelector && el.querySelector('title'));
      const sw = parseFloat(el.getAttribute('stroke-width')||'0');
      const st = (el.getAttribute('stroke')||'').toLowerCase();
      const blackish = (st==='black'||st==='#000'||st==='#000000'||st.includes('rgb(0, 0, 0)'));
      if(!hasTitle && a>biggestA){ biggestA=a; biggest=el; }
      if(blackish && sw>=4) el.remove();                          // 黑粗線直接刪
      else if(!hasTitle && a/total>0.50) el.remove();             // 巨型無 title 直接刪
    }catch(_){}
  });
  // 如果還有最大面積殘留，也刪
  if(biggest && biggest.isConnected) biggest.remove();

  // 4-2 隱藏原 SVG 內文（v1 內若有 <text>），改用置中「新地名」標籤
  ROOT.querySelectorAll('text').forEach(t=>t.setAttribute('display','none'));

  // 4-3 著色 + 綁定
  const zones=[];
  ROOT.querySelectorAll('path,polygon').forEach(el=>{
    const t = el.querySelector('title');
    let name = pureName(t && t.textContent);
    if(!name) return;
    const g = whichGroup(name); if(!g) return;

    el.setAttribute('fill', COLOR[g]);
    el.setAttribute('stroke', '#ffffff');
    el.setAttribute('stroke-width','1');
    el.style.transition='filter .25s ease';
    el.addEventListener('mouseenter', ()=>el.style.filter='brightness(1.12)');
    el.addEventListener('mouseleave', ()=>el.style.filter='');

    el.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      // 外框閃爍回饋（1s）
      el.style.animation='none'; el.offsetWidth; el.style.animation='ringPulse 1s ease';
      showTip(name, el);
    });
    zones.push({name,el});
  });

  // 4-4 初始「新地名」標籤（置於區塊中心）
  let labels = STAGE.querySelector('#labelsLayer');
  if(!labels){ labels = document.createElementNS('http://www.w3.org/2000/svg','g'); labels.setAttribute('id','labelsLayer'); STAGE.appendChild(labels); }
  labels.innerHTML='';
  zones.forEach(({name,el})=>{
    try{
      const b = el.getBBox();
      const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
      tx.setAttribute('x', b.x+b.width/2);
      tx.setAttribute('y', b.y+b.height/2);
      tx.setAttribute('class','label');
      tx.textContent = name;
      labels.appendChild(tx);
    }catch(_){}
  });

  // 4-5 全圖顯示（不放大）
  fitFull(ROOT);

  // 4-6 點空白收合
  document.addEventListener('click', ()=>{ const tp=document.getElementById('tip'); if(tp) tp.classList.remove('show'); }, {capture:true});

  // 4-7 修正工具列字級（避免超大）
  document.querySelectorAll('.toolbar .btn, .footerbar .btn, .btn').forEach(b=>{ b.style.fontSize='14px'; });

})();

/* ========== 5) 浮窗（貼旁邊＋邊界避讓） ========== */
/* 你 v1 的 DOM：#tip, #tipNew, #tipOld, #tipPyNew, #tipPyOld, #btnPlayNew, #btnPlayOld, #aud */
const tip = document.getElementById('tip');
const tNew = document.getElementById('tipNew');
const tOld = document.getElementById('tipOld');
const tPyN = document.getElementById('tipPyNew');
const tPyO = document.getElementById('tipPyOld');
const btnN = document.getElementById('btnPlayNew');
const btnO = document.getElementById('btnPlayOld');
const aud  = document.getElementById('aud');

function showTip(name, elem){
  const d = D[name] || {};
  tNew.textContent = d.pyNew ? `${name}（${d.pyNew}）` : name;
  tOld.textContent = d.old ? (d.pyOld ? `${d.old}（${d.pyOld}）` : d.old) : '';
  tPyN.textContent = d.pyNew || '';
  tPyO.textContent = d.pyOld || '';

  // 音檔（若未放檔案，按鈕自動禁用）
  const idx = indexOf(name);
  const newSrc = idx ? `map_assets/sounds/${idx}${name}_new.mp3` : '';
  const oldSrc = (idx && d.old) ? `map_assets/sounds/${idx}${d.old}_old.mp3` : '';
  btnN.disabled = !newSrc; btnO.disabled = !oldSrc;
  btnN.onclick = ()=> play(newSrc);
  btnO.onclick = ()=> play(oldSrc);

  placeTip(elem);
  tip.classList.add('show');
}
function play(src){ if(!src) return; aud.pause(); aud.src=src; aud.play().catch(()=>{}); }
function indexOf(name){
  const order=["楠梓","左營","鼓山","三民","鹽埕","前金","新興","苓雅","旗津","前鎮","小港","大樹","大寮","林園","大社","仁武","鳥松","鳳山","茄萣","永安","彌陀","梓官","湖內","路竹","岡山","橋頭","阿蓮","田寮","燕巢","內門","旗山","杉林","美濃","甲仙","六龜","那瑪夏","桃源","茂林"];
  const i = order.indexOf(name); return i<0?null:String(i+1).padStart(2,'0');
}
function placeTip(el){
  const host = STAGE.getBoundingClientRect();
  const r = el.getBoundingClientRect();
  const cx = r.left + r.width/2, cy = r.top + r.height/2;
  const onLeft = cx < (host.left + host.width/2);
  const onTop  = cy < (host.top  + host.height/2);
  let dx = onLeft ? +100 : -100;
  let dy = onTop  ? +40  : -40;
  let left = cx - host.left + dx + window.scrollX;
  let top  = cy - host.top  + dy + window.scrollY;
  const pad=12, w=tip.offsetWidth||260, h=tip.offsetHeight||140;
  left = Math.max(pad, Math.min(left, host.width - pad));
  top  = Math.max(pad, Math.min(top,  host.height- pad));
  tip.style.left = left+'px'; tip.style.top = top+'px';
}

/* ========== 6) 點擊回饋動畫（CSS 動態注入，避免你去改 v1 的 <style>） ========== */
const style = document.createElement('style');
style.textContent = `
  @keyframes ringPulse{
    0%{filter:brightness(1);stroke-width:1}
    40%{filter:brightness(1.55);stroke-width:2.5}
    100%{filter:brightness(1);stroke-width:1}
  }
  .label{
    font-size:14px; fill:#b91c1c; font-weight:700; text-anchor:middle; pointer-events:none;
    paint-order:stroke; stroke:#fff; stroke-width:3px; stroke-linejoin:round;
  }
`;
document.head.appendChild(style);
</script>
