<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>é«˜é›„å¸‚38å€æ–°èˆŠåœ°åäº’å‹•åœ°åœ– v5.2</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#111827; --muted:#6b7280; --bg:#f8fafc;
    --red:#f87171;      /* å¸‚ä¸­å¿ƒ */
    --purple:#c4b5fd;   /* æ±å€   */
    --ylg:#9FDF72;      /* åŒ—å€(åŠ æ·±) */
    --cyan:#99f6e4;     /* å±±å€   */
    --card:rgba(255,255,255,.96);
    --stroke:#ffffff;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,Arial}
  .app{display:flex;flex-direction:column;min-height:100vh}
  header{padding:12px 16px 6px}
  h1{margin:0 0 6px;font-size:18px}
  .hint{margin:0;color:var(--muted);font-size:14px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:8px 12px}
  .btn{padding:8px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer;font-size:13px}
  .btn[data-active="1"]{outline:2px solid #11182722}
  .btn.center{background:var(--red);color:#111}
  .btn.east{background:var(--purple);color:#111}
  .btn.north{background:var(--ylg);color:#111}
  .btn.mount{background:var(--cyan);color:#111}
  .mapwrap{position:relative;flex:1;min-height:0;border-top:1px solid #e5e7eb}
  /* æ»¿ç‰ˆ SVG ç•«å¸ƒ */
  svg#stage{display:block;width:100vw;height:calc(100vh - 160px);background:#fff}
  @media (max-width:768px){ svg#stage{height:calc(100vh - 178px)} }

  /* æµ®çª—ï¼ˆè‡ªå‹•é¿é–‹å€å¡Šï¼‰ */
  .tip{
    position:absolute;min-width:240px;max-width:86vw;pointer-events:auto;z-index:10;
    background:var(--card);backdrop-filter:saturate(140%) blur(6px);
    border:1px solid rgba(0,0,0,.06);border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.18);
    padding:12px;opacity:0;transform:translate(-50%,-10px) scale(.98);
    transition:opacity .22s ease, transform .22s ease;
  }
  .tip.show{opacity:1;transform:translate(-50%,-14px) scale(1)}
  .tip h3{margin:0 0 2px;color:#b91c1c;font-size:16px;font-weight:700}
  .tip h4{margin:0 0 6px;color:#111827;font-size:15px;font-weight:600}
  .py{margin:0;color:#334155;font-size:14px;line-height:1.25}
  .btns{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
  .btnplay{padding:6px 10px;font-size:13px;border-radius:10px;border:1px solid #d1d5db;background:#ffffff;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
  .btnplay svg{width:14px;height:14px}
  .btnplay[disabled]{opacity:.45;cursor:not-allowed}

  /* é»æ“Šå›é¥‹ï¼šå¤–æ¡†äº®åº¦æ¼¸å¼·å†æ·¡å‡ºï¼ˆ1sï¼‰ */
  @keyframes ringPulse {
    0%{filter:brightness(1);stroke-width:1}
    40%{filter:brightness(1.55);stroke-width:2.5}
    100%{filter:brightness(1);stroke-width:1}
  }
  .pulse{animation:ringPulse 1s ease}

  /* å€å¡Š hover */
  .hoverable{transition:filter .25s ease}
  .hoverable:hover{filter:brightness(1.12)}

  /* ç½®æ–¼åœ°åœ–ä¸Šçš„æ–°åœ°åæ¨™ç±¤ï¼ˆåˆå§‹å°±é¡¯ç¤ºï¼‰ */
  .label{
    font-size:14px; fill:#b91c1c; font-weight:700; text-anchor:middle; pointer-events:none;
    paint-order:stroke; stroke:#fff; stroke-width:3px; stroke-linejoin:round;
  }
  @media (max-width:768px){ .label{font-size:13px} }

  /* åº•éƒ¨å·¥å…·åˆ— */
  .footerbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;padding:10px 12px}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>é«˜é›„å¸‚38å€æ–°èˆŠåœ°åäº’å‹•åœ°åœ–</h1>
    <p class="hint">ğŸ“± å»ºè­°ç›´å¼è§€çœ‹æ•ˆæœæœ€ä½³</p>
  </header>

  <div class="toolbar">
    <button class="btn center" data-group="center">å¸‚ä¸­å¿ƒ</button>
    <button class="btn east"   data-group="east">å¸‚éƒŠâ€“æ±</button>
    <button class="btn north"  data-group="north">å¸‚éƒŠâ€“åŒ—</button>
    <button class="btn mount"  data-group="mount">å±±å€</button>
  </div>

  <div class="mapwrap">
    <!-- æµ®çª— -->
    <div id="tip" class="tip" role="dialog" aria-live="polite">
      <h3 id="tipNew"></h3>
      <h4 id="tipOld"></h4>
      <p id="tipPyNew" class="py"></p>
      <p id="tipPyOld" class="py"></p>
      <div class="btns">
        <button id="btnPlayNew" class="btnplay">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> æ–°åœ°å
        </button>
        <button id="btnPlayOld" class="btnplay">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> èˆŠåœ°å
        </button>
      </div>
      <audio id="aud" preload="none"></audio>
    </div>

    <!-- ä¸»ç•«å¸ƒï¼ˆå…§å«ï¼šè¼‰å…¥çš„ SVGã€å‹•æ…‹æ¨™ç±¤å±¤ï¼‰ -->
    <svg id="stage" viewBox="0 0 1143.062 1440.995" preserveAspectRatio="xMidYMid meet" aria-label="é«˜é›„å¸‚è¡Œæ”¿å€äº’å‹•åœ°åœ–">
      <g id="svgRoot"></g>
      <g id="labelsLayer"></g>
    </svg>
  </div>

  <div class="footerbar">
    <button id="btnReset" class="btn">ğŸ”„ å…¨éƒ¨é¡¯ç¤º</button>
  </div>
</div>

<script>
/* =========================
   1) è¨­å®šèˆ‡è³‡æ–™
========================= */
const SVG_URL = 'map_assets/Blank_Kaohsiung_map.svg';

const GROUPS = {
  center: ["æ¥ æ¢“","å·¦ç‡Ÿ","é¼“å±±","ä¸‰æ°‘","é¹½åŸ•","å‰é‡‘","æ–°èˆˆ","è‹“é›…","æ——æ´¥","å‰é®","å°æ¸¯"],
  east:   ["å¤§æ¨¹","å¤§å¯®","æ—åœ’","å¤§ç¤¾","ä»æ­¦","é³¥æ¾","é³³å±±"],
  north:  ["èŒ„è£","æ°¸å®‰","å½Œé™€","æ¢“å®˜","æ¹–å…§","è·¯ç«¹","å²¡å±±","æ©‹é ­","é˜¿è“®","ç”°å¯®","ç‡•å·¢"],
  mount:  ["å…§é–€","æ——å±±","æ‰æ—","ç¾æ¿ƒ","ç”²ä»™","å…­é¾œ","é‚£ç‘ªå¤","æ¡ƒæº","èŒ‚æ—"]
};
const COLOR = { center:'var(--red)', east:'var(--purple)', north:'var(--ylg)', mount:'var(--cyan)' };

/* æ–°ï¼èˆŠåœ°åï¼‹å°èªæ‹¼éŸ³ï¼ˆæµ®çª—åŒæ™‚é¡¯ç¤ºæ¼¢å­—èˆ‡æ‹¬è™Ÿç¾…é¦¬å­—ï¼‰*/
const D = {
  "æ¥ æ¢“":{old:"æ¥ ä»”å‘",      pyNew:"LÃ¢m-tsÃº",        pyOld:"LÃ¢m-Ã¡-khenn"},
  "å·¦ç‡Ÿ":{old:"åŸ¤ä»”é ­",      pyNew:"TsÃ³-iÃ¢nn",       pyOld:"Pi-Ã¡-thÃ¢u"},
  "é¼“å±±":{old:"æ‰“ç‹—å±±",      pyNew:"KÃ³o-san",        pyOld:"TÃ¡nn-kÃ³o-san"},
  "ä¸‰æ°‘":{old:"ä¸‰å¡Šå",      pyNew:"Sam-bÃ®n",        pyOld:"Sann-tÃ¨-tshÃ¹"},
  "é¹½åŸ•":{old:"é¹½åŸ•åŸ”",      pyNew:"IÃ¢m-tiÃ¢nn",      pyOld:"IÃ¢m-tiÃ¢nn-poo"},
  "å‰é‡‘":{old:"å‰è¡¿",        pyNew:"TsiÃ¢n-kim",      pyOld:"TsiÃ¢n-khim"},
  "æ–°èˆˆ":{old:"é€®æ¸¯åŸ”",      pyNew:"Sin-hing",       pyOld:"TÄi-kÃ¡ng-poo"},
  "è‹“é›…":{old:"ç¬­ä»”å¯®",      pyNew:"LÃ®ng-ngÃ¡",       pyOld:"LÃ®ng-Ã¡-liÃ¢u"},
  "æ——æ´¥":{old:"æ——å¾Œ",        pyNew:"KÃ®-tin",         pyOld:"KÃ®-Äu"},
  "å‰é®":{old:"å‰é®",        pyNew:"TsiÃ¢n-tÃ¬n",      pyOld:"TsiÃ¢n-tÃ¬n"},
  "å°æ¸¯":{old:"æ¸¯ä»”å¢˜",      pyNew:"SiÃ³-kÃ¡ng",       pyOld:"KÃ¡ng-Ã¡ kÃ®nn"},
  "å¤§æ¨¹":{old:"å¤§æ¨¹è·¤",      pyNew:"TuÄ-tshiÅ«",      pyOld:"TuÄ-tshiÅ«-kha"},
  "å¤§å¯®":{old:"å¤§è—”",        pyNew:"TuÄ-liÃ¢u",       pyOld:"TuÄ-liÃ¢u"},
  "æ—åœ’":{old:"é ‚æ—ä»”é‚Š",    pyNew:"LÃ®m-hnÌ‚g",        pyOld:"TÃ­ng-nÃ¢-Ã¡-pinn"},
  "å¤§ç¤¾":{old:"ä¸‰å¥¶å£‡",      pyNew:"TuÄ-siÄ",        pyOld:"Sam-nÃ¡i-tuÃ¢nn"},
  "ä»æ­¦":{old:"ä»æ­¦åº„",      pyNew:"JÃ®n-bÃº",         pyOld:"JÃ®n-bÃº-tsng"},
  "é³¥æ¾":{old:"é³¥æ¾è·¤",      pyNew:"TsiÃ¡u-tshÃ®ng",   pyOld:"TsiÃ¡u-tshÃ®ng-kha"},
  "é³³å±±":{old:"ä¸‹åŸ¤é ­",      pyNew:"HÅng-suann",     pyOld:"Ä’-pi-thÃ¢u"},
  "èŒ„è£":{old:"èŒ„è‹³è£ä»”",    pyNew:"Ka-tiÄnn",       pyOld:"Ka-tang-tiÄnn-Ã¡"},
  "æ°¸å®‰":{old:"çƒæ¨¹æ—",      pyNew:"Ãng-an",         pyOld:"Oo-tshiÅ«-nÃ¢"},
  "å½Œé™€":{old:"å½Œé™€æ¸¯",      pyNew:"MÃ®-tÃ´",          pyOld:"BÃ®-lÃ´-kÃ¡ng"},
  "æ¢“å®˜":{old:"æ¢“å®˜",        pyNew:"TsÃº-kuann",      pyOld:"TsÃº-kuann"},
  "æ¹–å…§":{old:"å¤§æ¹–",        pyNew:"Ã”o-lÄi",         pyOld:"TuÄ-Ã´o"},
  "è·¯ç«¹":{old:"åŠè·¯ç«¹",      pyNew:"LÅo-tik",        pyOld:"PuÃ nn-lÅo-tik"},
  "å²¡å±±":{old:"é˜¿å…¬åº—",      pyNew:"Kong-san",       pyOld:"A-kong-tiÃ m"},
  "æ©‹é ­":{old:"æ©‹ä»”é ­",      pyNew:"KiÃ´-thÃ¢u",       pyOld:"KiÃ´-Ã¡-thÃ¢u"},
  "é˜¿è“®":{old:"é˜¿å—¹ç¤¾",      pyNew:"A-lian",         pyOld:"A-lian-siÄ"},
  "ç”°å¯®":{old:"ç”°è—”",        pyNew:"TshÃ¢n-liÃ¢u",     pyOld:"TshÃ¢n-liÃ¢u"},
  "ç‡•å·¢":{old:"æ´å‰¿å³",      pyNew:"IÃ n-tsÃ¢u",       pyOld:"UÄn-tsÃ¢u-iÅ«"},
  "å…§é–€":{old:"ç¾…æ¼¢å…§é–€",    pyNew:"LÄi-bÃ»n",        pyOld:"LÃ´-hÃ n-lÄi-bÃ»n"},
  "æ——å±±":{old:"è•ƒè–¯è—”",      pyNew:"KÃ®-san",         pyOld:"Han-tsÃ®-liÃ¢u"},
  "æ‰æ—":{old:"æ¥ æ¢“ä»™",      pyNew:"Sam-nÃ¢",         pyOld:"LÃ¢m-tsÃº-sian"},
  "ç¾æ¿ƒ":{old:"ç€°æ¿ƒ",        pyNew:"Bi-long",        pyOld:"BÃ®-long"},
  "ç”²ä»™":{old:"é˜¿é‡Œé—œ",      pyNew:"Kah-sian",       pyOld:"A-lÃ­-kuan"},
  "å…­é¾œ":{old:"å…­é¾œé‡Œç¤¾",    pyNew:"LaÌk-ku",         pyOld:"LaÌk-ku-lÃ­-siÄ"},
  "é‚£ç‘ªå¤":{old:"èšŠå­åª",     pyNew:"Na-mÃ¡-siah",     pyOld:"Mangacun/BÃ¡ng-Ã¡-tsÃ­"},
  "æ¡ƒæº":{old:"é›…çˆ¾",        pyNew:"ThÃ´-guÃ¢n",       pyOld:"Ngani/NgÃ¡-nÃ­"},
  "èŒ‚æ—":{old:"å¤šç´",        pyNew:"BÅo-lÃ®m",        pyOld:"TÅ-na"}
};

/* å€åŸŸæ’­æ”¾ç·¨è™Ÿï¼ˆ01~38ï¼‰ */
const ORDER = [
  "æ¥ æ¢“","å·¦ç‡Ÿ","é¼“å±±","ä¸‰æ°‘","é¹½åŸ•","å‰é‡‘","æ–°èˆˆ","è‹“é›…","æ——æ´¥","å‰é®","å°æ¸¯",
  "å¤§æ¨¹","å¤§å¯®","æ—åœ’","å¤§ç¤¾","ä»æ­¦","é³¥æ¾","é³³å±±",
  "èŒ„è£","æ°¸å®‰","å½Œé™€","æ¢“å®˜","æ¹–å…§","è·¯ç«¹","å²¡å±±","æ©‹é ­","é˜¿è“®","ç”°å¯®","ç‡•å·¢",
  "å…§é–€","æ——å±±","æ‰æ—","ç¾æ¿ƒ","ç”²ä»™","å…­é¾œ","é‚£ç‘ªå¤","æ¡ƒæº","èŒ‚æ—"
];
const IDX = Object.fromEntries(ORDER.map((n,i)=>[n,String(i+1).padStart(2,'0')]));

/* =========================
   2) å…ƒä»¶æŠ“å–
========================= */
const stage  = document.getElementById('stage');
const root   = document.getElementById('svgRoot');
const labels = document.getElementById('labelsLayer');
const tip    = document.getElementById('tip');
const tNew   = document.getElementById('tipNew');
const tOld   = document.getElementById('tipOld');
const tPyN   = document.getElementById('tipPyNew');
const tPyO   = document.getElementById('tipPyOld');
const btnN   = document.getElementById('btnPlayNew');
const btnO   = document.getElementById('btnPlayOld');
const aud    = document.getElementById('aud');
const btnReset = document.getElementById('btnReset');
const grpBtns  = document.querySelectorAll('.toolbar .btn');

/* =========================
   3) è¼‰å…¥ SVG â†’ å‰”é™¤é»‘æ¡† â†’ è‘—è‰² â†’ ç¶å®š â†’ ç”¢ç”Ÿæ¨™ç±¤
========================= */
let allZones = [];
let fullBBox = null;

loadSVG().catch(err=>{
  root.innerHTML = `<text x="20" y="40" fill="#b91c1c" font-size="16">è¼‰å…¥ SVG å¤±æ•—ï¼Œè«‹æª¢æŸ¥ï¼š${SVG_URL}</text>`;
});

async function loadSVG(){
  const res = await fetch(SVG_URL, {mode:'cors'});
  const txt = await res.text();
  root.innerHTML = txt;

  // è‹¥åµŒå…¥æœ‰ <svg> å†å–å®ƒçš„ viewBoxï¼Œé¿å…åªé¡¯ç¤ºä¸€è§’
  const innerSVG = root.querySelector('svg');
  if(innerSVG && !innerSVG.getAttribute('viewBox')){
    const w = parseFloat(innerSVG.getAttribute('width'))  || 1143.062;
    const h = parseFloat(innerSVG.getAttribute('height')) || 1440.995;
    innerSVG.setAttribute('viewBox', `0 0 ${w} ${h}`);
  }

  // 1) å‰”é™¤é»‘ç²—æ¡†èˆ‡å·¨å‹èƒŒæ™¯ï¼ˆç„¡ <title> ä¸”é¢ç© >50% / é»‘è‰²ç²—ç·š >=4pxï¼‰
  const vb = stage.viewBox.baseVal;
  const total = (vb && vb.width*vb.height) || (1143.062*1440.995);
  root.querySelectorAll('rect,path,polygon').forEach(el=>{
    try{
      const bb = el.getBBox();
      const area = bb.width*bb.height;
      const strokeW = parseFloat(el.getAttribute('stroke-width')||'0');
      const stroke  = (el.getAttribute('stroke')||'').toLowerCase();
      const hasTitle = !!(el.querySelector && el.querySelector('title'));
      const looksFrame = (stroke==='black' || stroke==='#000' || stroke==='#000000' || stroke.includes('rgb(0, 0, 0)')) && strokeW>=4;
      if( (!hasTitle && area/total>0.5) || looksFrame ){
        el.remove();
      }
    }catch(_){}
  });

  // 2) éš±è—å…§å»º <text>ï¼Œé¿å…é‡ç–Š
  root.querySelectorAll('text').forEach(t=>t.setAttribute('display','none'));

  // 3) è‘—è‰²ã€ç¶å®š
  allZones = [];
  root.querySelectorAll('path,polygon').forEach(el=>{
    const t = el.querySelector('title');
    let name = t && t.textContent ? t.textContent.trim() : '';
    name = name.replace(/å€.*$/,'').replace(/\s*\(.+?\)\s*$/,'').replace(/\s*[A-Za-z].*$/,'');
    if(!name) return;
    const grp = whichGroup(name);
    if(!grp) return;

    el.classList.add('hoverable');
    el.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue(
      {center:'--red', east:'--purple', north:'--ylg', mount:'--cyan'}[grp]
    ).trim());
    el.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--stroke').trim());
    el.setAttribute('stroke-width', '1');

    el.addEventListener('click', e=>{
      e.stopPropagation();
      // é»æ“Šé«˜äº®å‹•ç•«
      el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse');
      showTip(name, el);
    });

    allZones.push({name, grp, el});
  });

  // 4) ç”¢ç”Ÿåˆå§‹ã€Œæ–°åœ°åã€æ¨™ç±¤ï¼ˆç½®ä¸­ï¼‰
  renderLabels();

  // 5) è¨ˆç®—å…¨åœ– bboxï¼Œè¨­å®šä¸€é–‹å³å…¨åœ–
  fullBBox = unionBBoxOf(root);
  fitTo(fullBBox, 1.0); // å…¨åœ–
}

/* å‹•æ…‹æ¨™ç±¤ï¼šæ”¾åœ¨ labelsLayerï¼ˆSVG <text> æœƒéš¨ç¸®æ”¾ç§»å‹•ï¼‰ */
function renderLabels(){
  labels.innerHTML = '';
  for(const {name, el} of allZones){
    const bb = el.getBBox();
    const x = bb.x + bb.width/2;
    const y = bb.y + bb.height/2;
    const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
    tx.setAttribute('x', x);
    tx.setAttribute('y', y);
    tx.setAttribute('class','label');
    tx.textContent = name;  // åˆå§‹åªé¡¯ç¤ºã€Œæ–°åœ°åã€
    labels.appendChild(tx);
  }
}

/* =========================
   4) æµ®çª—ï¼šè‡ªå‹•é¿é–‹è¢«é»å€å¡Šï¼Œå«æ‹¬è™Ÿç¾…é¦¬æ‹¼éŸ³ï¼Œé›™éŸ³æª”æ’­æ”¾
========================= */
function showTip(name, elem){
  const d = D[name] || {};
  tNew.textContent = name + (d.pyNew ? `ï¼ˆ${d.pyNew}ï¼‰` : '');
  tOld.textContent = (d.old || '') + (d.pyOld ? `ï¼ˆ${d.pyOld}ï¼‰` : '');
  tPyN.textContent = d.pyNew || '';
  tPyO.textContent = d.pyOld || '';

  // è¨­å®šéŸ³æª”
  const idx = IDX[name];
  const newSrc = idx ? `map_assets/sounds/${idx}${name}_new.mp3` : '';
  const oldSrc = (idx && d.old) ? `map_assets/sounds/${idx}${d.old}_old.mp3` : '';
  btnN.disabled = !newSrc;
  btnO.disabled = !oldSrc;
  btnN.onclick = ()=> play(newSrc);
  btnO.onclick = ()=> play(oldSrc);

  // è¨ˆç®—æµ®çª—ä½ç½®ï¼ˆé¿é–‹é‚Šç•Œèˆ‡å€å¡Šï¼‰
  placeTipBeside(elem);
  tip.classList.add('show');
  // é»ç©ºç™½è™•é—œé–‰
  const closeOnce = (ev)=>{ if(!tip.contains(ev.target)) { tip.classList.remove('show'); window.removeEventListener('click',closeOnce,true);} };
  setTimeout(()=>window.addEventListener('click',closeOnce,true),0);
}

function play(src){
  aud.pause(); aud.src = src; aud.play().catch(()=>{});
}

/* è°æ˜å®šä½ï¼šä¾æ‰€åœ¨è±¡é™é¸æ“‡å·¦/å³ã€ä¸Š/ä¸‹ï¼Œé¿å…é®ä½è¢«é»å€å¡Šèˆ‡è¶…å‡ºè¦–çª— */
function placeTipBeside(elem){
  const hostRect = stage.getBoundingClientRect();
  const r = elem.getBoundingClientRect();
  const cx = r.left + r.width/2;
  const cy = r.top  + r.height/2;

  const onLeft = cx < (hostRect.left + hostRect.width/2);
  const onTop  = cy < (hostRect.top  + hostRect.height/2);

  // é è¨­ä½ç§»ï¼ˆä¸é®ä½ï¼‰
  let dx = onLeft ? +100 : -100;
  let dy = onTop  ? +40  : -40;

  let left = cx - hostRect.left + dx + window.scrollX;
  let top  = cy - hostRect.top  + dy + window.scrollY;

  // é‚Šç•Œé˜²è­·
  const pad = 12;
  const w = tip.offsetWidth || 260;
  const h = tip.offsetHeight || 140;
  const maxL = hostRect.width  - pad;
  const maxT = hostRect.height - pad;

  left = Math.max(pad, Math.min(left, maxL));
  top  = Math.max(pad, Math.min(top,  maxT));

  tip.style.left = left + 'px';
  tip.style.top  = top  + 'px';
}

/* =========================
   5) å››ç¾¤åˆ†é ï¼šé¡¯ç¤ºè©²ç¾¤ã€å…¶ä»–éš±è—ï¼›ä¸¦æ”¾å¤§ 1.6 å€ï¼›å¯æ‹–æ›³ç§»å‹•
========================= */
let curGroup = null;     // null=å…¨åœ–
let curViewBox = {...stage.viewBox.baseVal}; // ç”¨æ–¼æ‹–æ›³

grpBtns.forEach(b=>{
  b.addEventListener('click', ()=>{
    const g = b.dataset.group; curGroup = g;
    grpBtns.forEach(x=>x.dataset.active = (x===b?'1':'0'));
    showOnlyGroup(g);
  });
});

btnReset.addEventListener('click', ()=>{
  curGroup = null;
  grpBtns.forEach(x=>x.dataset.active='0');
  // å…¨éƒ¨é¡¯ç¤º
  allZones.forEach(z=>{ z.el.style.display=''; });
  fitTo(fullBBox, 1.0);
});

/* é¡¯ç¤ºå–®ä¸€ç¾¤çµ„ï¼Œä¸¦æ”¾å¤§ 1.6x */
function showOnlyGroup(g){
  const targets = allZones.filter(z=>z.grp===g);
  const others  = allZones.filter(z=>z.grp!==g);
  targets.forEach(z=>z.el.style.display='');
  others.forEach(z=>z.el.style.display='none');

  const bb = unionBBox(targets.map(z=>z.el.getBBox()));
  fitTo(bb, 1.6); // æ”¾å¤§ 1.6 å€
}

/* æ› viewBox ä»¥é”åˆ°æ”¾å¤§/ç¸®å°èˆ‡ç½®ä¸­ */
function fitTo(bb, scale){
  const pad = 0.06;
  const x = bb.x - bb.width*pad;
  const y = bb.y - bb.height*pad;
  const w = bb.width*(1+2*pad);
  const h = bb.height*(1+2*pad);
  // æ”¾å¤§ï¼šç¸®å° viewBox å°ºå¯¸
  const vw = w/scale;
  const vh = h/scale;
  const cx = x + w/2;
  const cy = y + h/2;
  const vx = cx - vw/2;
  const vy = cy - vh/2;

  stage.setAttribute('viewBox', [vx,vy,vw,vh].join(' '));
  curViewBox = {x:vx,y:vy,width:vw,height:vh};
}

/* æ‹–æ›³ç§»å‹•ï¼ˆæ»‘é¼ èˆ‡è§¸æ§ï¼‰ */
let dragging=false, last={x:0,y:0};
stage.addEventListener('pointerdown', e=>{
  dragging=true; last={x:e.clientX, y:e.clientY}; stage.setPointerCapture(e.pointerId);
});
stage.addEventListener('pointermove', e=>{
  if(!dragging) return;
  const dx = e.clientX - last.x;
  const dy = e.clientY - last.y;
  last = {x:e.clientX, y:e.clientY};
  // ä¾ç›®å‰ viewBox å°ºå¯¸æ›ç®—æ‹–ç§»é‡ï¼ˆæ¯åƒç´ ç›¸ç•¶çš„åœ°åœ–å–®ä½ï¼‰
  const rect = stage.getBoundingClientRect();
  const kx = curViewBox.width / rect.width;
  const ky = curViewBox.height/ rect.height;
  curViewBox.x -= dx * kx;
  curViewBox.y -= dy * ky;
  stage.setAttribute('viewBox', [curViewBox.x,curViewBox.y,curViewBox.width,curViewBox.height].join(' '));
});
stage.addEventListener('pointerup',   ()=>dragging=false);
stage.addEventListener('pointercancel',()=>dragging=false);

/* =========================
   6) å·¥å…·å‡½æ•¸
========================= */
function whichGroup(n){
  if(GROUPS.center.includes(n)) return 'center';
  if(GROUPS.east.includes(n))   return 'east';
  if(GROUPS.north.includes(n))  return 'north';
  if(GROUPS.mount.includes(n))  return 'mount';
  return null;
}
function unionBBoxOf(container){
  let bb=null;
  container.querySelectorAll('path,polygon').forEach(el=>{
    try{ const b=el.getBBox(); if(b && b.width>0 && b.height>0) bb = bb? unionBBox(bb,b):b; }catch(_){}
  });
  return bb || {x:0,y:0,width:1143.062,height:1440.995};
}
function unionBBox(list){
  return list.reduce((acc,b)=>acc?{
    x:Math.min(acc.x,b.x),
    y:Math.min(acc.y,b.y),
    width:Math.max(acc.x+acc.width,b.x+b.width)-Math.min(acc.x,b.x),
    height:Math.max(acc.y+acc.height,b.y+b.height)-Math.min(acc.y,b.y)
  }:b, null);
}
</script>
</body>
</html>
