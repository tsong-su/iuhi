<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>高雄市38區新舊地名互動地圖</title>
<style>
  :root{
    --ink:#111827; --muted:#6b7280; --bg:#fafafa;
    --red:#f87171; --purple:#c4b5fd; --ylg:#bbf7d0; --cyan:#99f6e4;
    --card:rgba(255,255,255,.94);
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,Arial}
  header{padding:14px 16px 6px}
  h1{margin:0 0 6px;font-size:20px}
  .hint{margin:0;color:var(--muted);font-size:14px}
  .legend{display:flex;flex-wrap:wrap;gap:8px;padding:8px 12px 2px}
  .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:999px;padding:4px 10px 4px 6px;background:#fff}
  .dot{width:14px;height:14px;border-radius:50%}
  .wrap{padding:8px 12px 16px}
  .mapbox{position:relative;border:1px solid #e5e7eb;border-radius:14px;background:#fff;box-shadow:0 8px 22px rgba(0,0,0,.08);overflow:hidden}
  /* SVG 尺寸：手機直式也能一屏看到全圖 */
  svg{display:block;width:100%;height:calc(100vh - 210px);max-height:1000px}
  @media (max-width:768px){ svg{height:calc(100vh - 230px)} }

  /* 浮窗 */
  .tip{
    position:absolute;min-width:230px;max-width:86vw;pointer-events:auto;
    background:var(--card);backdrop-filter:saturate(140%) blur(6px);
    border:1px solid rgba(0,0,0,.06);border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.16);
    padding:12px;opacity:0;transform:translate(-50%,-10px) scale(.98);
    transition:opacity .22s ease, transform .22s ease;
  }
  .tip.show{opacity:1;transform:translate(-50%,-14px) scale(1)}
  .tip h3{margin:0 0 2px;color:#b91c1c;font-size:16px;font-weight:700}
  .tip h4{margin:0 0 6px;color:#111827;font-size:15px;font-weight:600}
  .py{margin:0;color:#4b5563;font-size:14px;line-height:1.2}
  .btns{margin-top:8px;display:flex;gap:8px}
  .btn{
    padding:6px 10px;font-size:13px;border-radius:10px;border:1px solid #d1d5db;background:#ffffff;cursor:pointer;
    display:inline-flex;align-items:center;gap:6px
  }
  .btn svg{width:14px;height:14px}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  /* 點擊回饋：亮度漸強再淡出（1 秒） */
  @keyframes pulseBright {
    0% { filter:brightness(1);   }
    50%{ filter:brightness(1.45);}
    100%{filter:brightness(1);   }
  }
  .pulse-1s{ animation:pulseBright 1s ease; }

  /* hover 提亮 */
  .hoverable{ transition:filter .25s ease }
  .hoverable:hover{ filter:brightness(1.15) }
</style>
</head>
<body>
<header>
  <h1>高雄市38區新舊地名互動地圖</h1>
  <p class="hint">📱 建議直式觀看效果最佳</p>
</header>

<div class="legend">
  <span class="chip"><span class="dot" style="background:var(--red)"></span>市中心</span>
  <span class="chip"><span class="dot" style="background:var(--purple)"></span>市郊–東</span>
  <span class="chip"><span class="dot" style="background:var(--ylg)"></span>市郊–北</span>
  <span class="chip"><span class="dot" style="background:var(--cyan)"></span>山區</span>
</div>

<div class="wrap">
  <div class="mapbox">
    <div id="tip" class="tip" role="dialog" aria-live="polite">
      <h3 id="tipNew"></h3>
      <h4 id="tipOld"></h4>
      <p id="tipPyNew" class="py"></p>
      <p id="tipPyOld" class="py"></p>
      <div class="btns">
        <button id="btnPlayNew" class="btn">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> 新地名
        </button>
        <button id="btnPlayOld" class="btn">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> 舊地名
        </button>
      </div>
      <audio id="aud" preload="none"></audio>
    </div>

    <!-- 你的 SVG 將被插入到 #svgRoot 中（從 map_assets/Blank_Kaohsiung_map.svg 載入） -->
    <svg id="stage" viewBox="0 0 1143.062 1440.995" preserveAspectRatio="xMidYMid meet" aria-label="高雄市行政區互動地圖">
      <g id="svgRoot"></g>
    </svg>
  </div>
</div>

<script>
/* 1) 設定：你的 SVG 來源（與本檔同層的 map_assets 內） */
const SVG_URL = 'map_assets/Blank_Kaohsiung_map.svg';

/* 2) 四群定義與色系 */
const GROUPS = {
  center: ["楠梓","左營","鼓山","三民","鹽埕","前金","新興","苓雅","旗津","前鎮","小港"],
  east:   ["大樹","大寮","林園","大社","仁武","鳥松","鳳山"],
  north:  ["茄萣","永安","彌陀","梓官","湖內","路竹","岡山","橋頭","阿蓮","田寮","燕巢"],
  mount:  ["內門","旗山","杉林","美濃","甲仙","六龜","那瑪夏","桃源","茂林"]
};
const COLOR = { center:'var(--red)', east:'var(--purple)', north:'var(--ylg)', mount:'var(--cyan)' };

/* 3) 38 區資料（新／舊地名＋兩行台語拼音） */
const DATA = {
  "楠梓":{old:"楠仔坑",      pyNew:"Lâm-tsú",        pyOld:"Lâm-á-khenn"},
  "左營":{old:"埤仔頭",      pyNew:"Tsó-iânn",       pyOld:"Pi-á-thâu"},
  "鼓山":{old:"打狗山",      pyNew:"Kóo-san",        pyOld:"Tánn-kóo-san"},
  "三民":{old:"三塊厝",      pyNew:"Sam-bîn",        pyOld:"Sann-tè-tshù"},
  "鹽埕":{old:"鹽埕埔",      pyNew:"Iâm-tiânn",      pyOld:"Iâm-tiânn-poo"},
  "前金":{old:"前衿",        pyNew:"Tsiân-kim",      pyOld:"Tsiân-khim"},
  "新興":{old:"逮港埔",      pyNew:"Sin-hing",       pyOld:"Tāi-káng-poo"},
  "苓雅":{old:"笭仔寮",      pyNew:"Lîng-ngá",       pyOld:"Lîng-á-liâu"},
  "旗津":{old:"旗後",        pyNew:"Kî-tin",         pyOld:"Kî-āu"},
  "前鎮":{old:"前鎮",        pyNew:"Tsiân-tìn",      pyOld:"Tsiân-tìn"},
  "小港":{old:"港仔墘",      pyNew:"Sió-káng",       pyOld:"Káng-á kînn"},
  "大樹":{old:"大樹跤",      pyNew:"Tuā-tshiū",      pyOld:"Tuā-tshiū-kha"},
  "大寮":{old:"大藔",        pyNew:"Tuā-liâu",       pyOld:"Tuā-liâu"},
  "林園":{old:"頂林仔邊",    pyNew:"Lîm-hn̂g",        pyOld:"Tíng-nâ-á-pinn"},
  "大社":{old:"三奶壇",      pyNew:"Tuā-siā",        pyOld:"Sam-nái-tuânn"},
  "仁武":{old:"仁武庄",      pyNew:"Jîn-bú",         pyOld:"Jîn-bú-tsng"},
  "鳥松":{old:"鳥松跤",      pyNew:"Tsiáu-tshîng",   pyOld:"Tsiáu-tshîng-kha"},
  "鳳山":{old:"下埤頭",      pyNew:"Hōng-suann",     pyOld:"Ē-pi-thâu"},
  "茄萣":{old:"茄苳萣仔",    pyNew:"Ka-tiānn",       pyOld:"Ka-tang-tiānn-á"},
  "永安":{old:"烏樹林",      pyNew:"Íng-an",         pyOld:"Oo-tshiū-nâ"},
  "彌陀":{old:"彌陀港",      pyNew:"Mî-tô",          pyOld:"Bî-lô-káng"},
  "梓官":{old:"梓官",        pyNew:"Tsú-kuann",      pyOld:"Tsú-kuann"},
  "湖內":{old:"大湖",        pyNew:"Ôo-lāi",         pyOld:"Tuā-ôo"},
  "路竹":{old:"半路竹",      pyNew:"Lōo-tik",        pyOld:"Puànn-lōo-tik"},
  "岡山":{old:"阿公店",      pyNew:"Kong-san",       pyOld:"A-kong-tiàm"},
  "橋頭":{old:"橋仔頭",      pyNew:"Kiô-thâu",       pyOld:"Kiô-á-thâu"},
  "阿蓮":{old:"阿嗹社",      pyNew:"A-lian",         pyOld:"A-lian-siā"},
  "田寮":{old:"田藔",        pyNew:"Tshân-liâu",     pyOld:"Tshân-liâu"},
  "燕巢":{old:"援剿右",      pyNew:"Iàn-tsâu",       pyOld:"Uān-tsâu-iū"},
  "內門":{old:"羅漢內門",    pyNew:"Lāi-bûn",        pyOld:"Lô-hàn-lāi-bûn"},
  "旗山":{old:"蕃薯藔",      pyNew:"Kî-san",         pyOld:"Han-tsî-liâu"},
  "杉林":{old:"楠梓仙",      pyNew:"Sam-nâ",         pyOld:"Lâm-tsú-sian"},
  "美濃":{old:"瀰濃",        pyNew:"Bi-long",        pyOld:"Bî-long"},
  "甲仙":{old:"阿里關",      pyNew:"Kah-sian",       pyOld:"A-lí-kuan"},
  "六龜":{old:"六龜里社",    pyNew:"La̍k-ku",         pyOld:"La̍k-ku-lí-siā"},
  "那瑪夏":{old:"蚊子只",     pyNew:"Na-má-siah",     pyOld:"Mangacun/Báng-á-tsí"},
  "桃源":{old:"雅爾",        pyNew:"Thô-guân",       pyOld:"Ngani/Ngá-ní"},
  "茂林":{old:"多納",        pyNew:"Bōo-lîm",        pyOld:"Tō-na"}
};

/* 4) 音檔對應：區域編號（01～38），用於組檔名 */
const ORDER = [
  // 市中心 01–11
  "楠梓","左營","鼓山","三民","鹽埕","前金","新興","苓雅","旗津","前鎮","小港",
  // 東區 12–18
  "大樹","大寮","林園","大社","仁武","鳥松","鳳山",
  // 北區 19–29
  "茄萣","永安","彌陀","梓官","湖內","路竹","岡山","橋頭","阿蓮","田寮","燕巢",
  // 山區 30–38
  "內門","旗山","杉林","美濃","甲仙","六龜","那瑪夏","桃源","茂林"
];
const indexOfName = Object.fromEntries(ORDER.map((n,i)=>[n, String(i+1).padStart(2,'0')]));

/* 5) DOM 參照 */
const svgRoot = document.getElementById('svgRoot');
const stage   = document.getElementById('stage');
const tip     = document.getElementById('tip');
const elNew   = document.getElementById('tipNew');
const elOld   = document.getElementById('tipOld');
const elPyN   = document.getElementById('tipPyNew');
const elPyO   = document.getElementById('tipPyOld');
const btnNew  = document.getElementById('btnPlayNew');
const btnOld  = document.getElementById('btnPlayOld');
const aud     = document.getElementById('aud');

/* 6) 載入 SVG → 去黑框 → 上色 → 綁定 */
loadSVG().catch(err=>{
  svgRoot.innerHTML = `<text x="20" y="40" fill="#b91c1c" font-size="16">載入 SVG 失敗，請檢查路徑：${SVG_URL}</text>`;
});

async function loadSVG(){
  const res = await fetch(SVG_URL, {mode:'cors'});
  const txt = await res.text();
  svgRoot.innerHTML = txt;

  // 若原檔沒 viewBox，補上（避免手機只見一角）
  const rootSvg = svgRoot.querySelector('svg');
  if(rootSvg && !rootSvg.getAttribute('viewBox')){
    const w = parseFloat(rootSvg.getAttribute('width'))  || 1143.062;
    const h = parseFloat(rootSvg.getAttribute('height')) || 1440.995;
    rootSvg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  }

  // 移除大面積/黑粗框（無 <title> 的大 path/rect/polygon，或黑色粗描邊）
  const vb = (rootSvg||stage).viewBox.baseVal;
  const totalArea = (vb && vb.width*vb.height) || (1143.062*1440.995) || 1;

  svgRoot.querySelectorAll('rect,path,polygon').forEach(el=>{
    try{
      const bb = el.getBBox();
      const area = bb.width*bb.height;
      const strokeW = parseFloat(el.getAttribute('stroke-width') || '0');
      const stroke  = (el.getAttribute('stroke')||'').toLowerCase();
      const titled = !!(el.querySelector && el.querySelector('title'));
      const looksFrame = (stroke==='black' || stroke==='#000' || stroke==='#000000' || stroke.includes('rgb(0, 0, 0)')) && strokeW>=5;
      if ((area/totalArea>0.25 && !titled) || looksFrame) el.remove();
    }catch(_){}
  });

  // 隱藏原 SVG 內的文字（避免與浮窗重疊）
  svgRoot.querySelectorAll('text').forEach(t=>t.setAttribute('display','none'));

  // 著色＋互動
  const zones = svgRoot.querySelectorAll('path,polygon');
  zones.forEach(z=>{
    const t = z.querySelector('title');
    let name = t && t.textContent ? t.textContent.trim() : '';
    // 只取中文區名（去掉尾註/英文）
    name = name.replace(/區.*$/,'').replace(/\s*\(.+?\)\s*$/,'').replace(/\s*[A-Za-z].*$/,'');
    if(!name) return;

    const group = whichGroup(name);
    if(!group) return;

    // 著色與基本互動
    z.classList.add('hoverable');
    z.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue(
      {center:'--red', east:'--purple', north:'--ylg', mount:'--cyan'}[group]
    ).trim());
    z.setAttribute('stroke','#ffffff');
    z.setAttribute('stroke-width','1');

    // 點擊：浮窗顯示＋亮度漸強再淡出 1 秒
    z.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      // 動畫回饋
      z.classList.remove('pulse-1s'); // 先移除以便重播
      void z.offsetWidth;             // 觸發 reflow
      z.classList.add('pulse-1s');

      showTooltip(name, z);
    }, {passive:true});
  });

  // 點空白處關閉
  document.addEventListener('click', hideTooltip, {capture:true});
  window.addEventListener('resize', hideTooltip);
}

/* 判斷分群 */
function whichGroup(n){
  if(GROUPS.center.includes(n)) return 'center';
  if(GROUPS.east.includes(n))   return 'east';
  if(GROUPS.north.includes(n))  return 'north';
  if(GROUPS.mount.includes(n))  return 'mount';
  return null;
}

/* 浮窗生成與定位（貼著該行政區旁邊） */
function showTooltip(name, elem){
  const d = DATA[name] || {};
  elNew.textContent = name;           // 新地名（紅）
  elOld.textContent = d.old || "";    // 舊地名（黑）
  elPyN.textContent = d.pyNew || "";  // 拼音（新）
  elPyO.textContent = d.pyOld || "";  // 拼音（舊）

  // audio 準備（依 01–38 編號 + 名稱）
  const idx = indexOfName[name];
  const newPath = `map_assets/sounds/${idx}${name}_new.mp3`;
  const oldName = d.old || '';
  const oldPath = `map_assets/sounds/${idx}${oldName}_old.mp3`;

  btnNew.disabled = false;
  btnOld.disabled = false;

  btnNew.onclick = ()=> playAudio(newPath);
  btnOld.onclick = ()=> playAudio(oldPath);

  // 定位：用元素的 getBoundingClientRect + scroll 校正
  const hostRect = stage.getBoundingClientRect();
  const r = elem.getBoundingClientRect();
  const cx = r.left + r.width/2;
  const cy = r.top  + r.height/2;
  const left = cx - hostRect.left + window.scrollX;
  let   top  = cy - hostRect.top  + window.scrollY - 14;

  // 避免貼到視窗邊緣（簡易防護）
  const pad = 12;
  const vw = window.innerWidth, vh = window.innerHeight;
  const tRect = tip.getBoundingClientRect();
  const tipW = tRect.width || 240, tipH = tRect.height || 120;

  const L = Math.max(pad, Math.min(left, hostRect.width - pad));
  const T = Math.max(pad, Math.min(top,  hostRect.height - pad));

  tip.style.left = `${L}px`;
  tip.style.top  = `${T}px`;
  tip.classList.add('show');
}

function hideTooltip(){
  tip.classList.remove('show');
}

/* 音檔播放（若檔案尚未放入，會安靜 fail，不影響互動） */
function playAudio(src){
  aud.pause();
  aud.src = src;
  aud.play().catch(()=>{/* 沒檔案就不播，不跳錯 */});
}
</script>
</body>
</html>
