<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>é«˜é›„å¸‚38å€æ–°èˆŠåœ°åäº’å‹•åœ°åœ–ï¼ˆv4.1 ç¸«åˆç‰ˆï¼‰</title>
<style>
  :root{
    --ink:#111827; --muted:#6b7280; --bg:#fafafa;
    --red:#f87171; --purple:#c4b5fd; --ylg:#bbf7d0; --cyan:#99f6e4;
    --card:rgba(255,255,255,.94);
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,Arial}
  header{padding:14px 16px 6px}
  h1{margin:0 0 6px 0;font-size:20px}
  .hint{margin:0;color:var(--muted);font-size:14px}
  .toolbar{padding:8px 12px;display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer;font-size:13px}
  .legend{display:flex;flex-wrap:wrap;gap:8px;padding:6px 12px 2px}
  .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:999px;padding:4px 10px 4px 6px}
  .dot{width:14px;height:14px;border-radius:50%}
  .mapwrap{position:relative;margin:8px 12px 16px;border:1px solid #e5e7eb;border-radius:14px;background:#fff;box-shadow:0 8px 22px rgba(0,0,0,.08);overflow:hidden}
  svg{display:block;width:100%;height:calc(100vh - 200px);max-height:1000px}
  @media (max-width:768px){ svg{height:calc(100vh - 220px)} }
  /* æµ®çª— */
  .tip{position:absolute;min-width:220px;max-width:86vw;pointer-events:none;
       background:var(--card);backdrop-filter:saturate(140%) blur(6px);
       border:1px solid rgba(0,0,0,.06);border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.16);
       padding:12px;opacity:0;transform:translate(-50%,-10px) scale(.98);
       transition:opacity .22s ease, transform .22s ease;}
  .tip.show{opacity:1;transform:translate(-50%,-14px) scale(1)}
  .tip h3{margin:0 0 2px;color:#b91c1c;font-size:16px;font-weight:700}
  .tip h4{margin:0 0 6px;color:#111827;font-size:15px;font-weight:600}
  .py{margin:0;color:#4b5563;font-size:14px;line-height:1.25}
  .btns{margin-top:8px;display:flex;gap:8px}
  .btnaudio{pointer-events:auto;padding:6px 10px;font-size:13px;border-radius:10px;border:1px dashed #cbd5e1;background:#f3f4f6;color:#9ca3af;cursor:not-allowed}
  /* hover æäº® */
  .hoverable{transition:filter .25s ease}
  .hoverable:hover{filter:brightness(1.15)}
</style>
</head>
<body>
<header>
  <h1>é«˜é›„å¸‚38å€æ–°èˆŠåœ°åäº’å‹•åœ°åœ–</h1>
  <p class="hint">ğŸ“± å»ºè­°ç›´å¼è§€çœ‹æ•ˆæœæœ€ä½³</p>
</header>

<div class="legend">
  <span class="chip"><span class="dot" style="background:var(--red)"></span>å¸‚ä¸­å¿ƒ</span>
  <span class="chip"><span class="dot" style="background:var(--purple)"></span>å¸‚éƒŠâ€“æ±</span>
  <span class="chip"><span class="dot" style="background:var(--ylg)"></span>å¸‚éƒŠâ€“åŒ—</span>
  <span class="chip"><span class="dot" style="background:var(--cyan)"></span>å±±å€</span>
</div>

<div class="toolbar">
  <button id="btnStitch" class="btn">ä¸€éµç¸«åˆå››å¤§å€å¡Š</button>
  <button id="btnFit" class="btn">å…¨åœ–é¡¯ç¤º</button>
  <button id="btnReset" class="btn">é‡ç½®ä½ç½®</button>
</div>

<div class="mapwrap">
  <div id="tip" class="tip" role="dialog" aria-live="polite"></div>
  <svg id="stage" viewBox="0 0 1143.062 1440.995" preserveAspectRatio="xMidYMid meet" aria-label="é«˜é›„å¸‚è¡Œæ”¿å€äº’å‹•åœ°åœ–">
    <g id="root"></g>
  </svg>
</div>

<script>
/* ====== 0) è¨­å®š ====== */
/* è‹¥ SVG èˆ‡æœ¬æª”åŒå±¤ï¼šæ”¹ç‚º 'map_assets/Blank_Kaohsiung_map.svg' */
const SVG_URL = 'map_assets/Blank_Kaohsiung_map.svg';

/* å››ç¾¤ */
const GROUPS = {
  center: ["æ¥ æ¢“","å·¦ç‡Ÿ","é¼“å±±","ä¸‰æ°‘","é¹½åŸ•","å‰é‡‘","æ–°èˆˆ","è‹“é›…","æ——æ´¥","å‰é®","å°æ¸¯"],
  east:   ["å¤§æ¨¹","å¤§å¯®","æ—åœ’","å¤§ç¤¾","ä»æ­¦","é³¥æ¾","é³³å±±"],
  north:  ["èŒ„è£","æ°¸å®‰","å½Œé™€","æ¢“å®˜","æ¹–å…§","è·¯ç«¹","å²¡å±±","æ©‹é ­","é˜¿è“®","ç”°å¯®","ç‡•å·¢"],
  mount:  ["å…§é–€","æ——å±±","æ‰æ—","ç¾æ¿ƒ","ç”²ä»™","å…­é¾œ","é‚£ç‘ªå¤","æ¡ƒæº","èŒ‚æ—"]
};
const COLOR = { center:'var(--red)', east:'var(--purple)', north:'var(--ylg)', mount:'var(--cyan)' };

/* ä½ çš„æœ€çµ‚è³‡æ–™ï¼ˆæ–°åœ°åâ†’èˆŠåœ°åï¼‹å…©è¡Œå°èªæ‹¼éŸ³ï¼‰ */
const DATA = {
  "æ¥ æ¢“":{old:"æ¥ ä»”å‘", pyNew:"LÃ¢m-tsÃº", pyOld:"LÃ¢m-Ã¡-khenn"},
  "å·¦ç‡Ÿ":{old:"åŸ¤ä»”é ­", pyNew:"TsÃ³-iÃ¢nn", pyOld:"Pi-Ã¡-thÃ¢u"},
  "é¼“å±±":{old:"æ‰“ç‹—å±±", pyNew:"KÃ³o-san", pyOld:"TÃ¡nn-kÃ³o-san"},
  "ä¸‰æ°‘":{old:"ä¸‰å¡Šå", pyNew:"Sam-bÃ®n", pyOld:"Sann-tÃ¨-tshÃ¹"},
  "é¹½åŸ•":{old:"é¹½åŸ•åŸ”", pyNew:"IÃ¢m-tiÃ¢nn", pyOld:"IÃ¢m-tiÃ¢nn-poo"},
  "å‰é‡‘":{old:"å‰è¡¿",   pyNew:"TsiÃ¢n-kim", pyOld:"TsiÃ¢n-khim"},
  "æ–°èˆˆ":{old:"é€®æ¸¯åŸ”", pyNew:"Sin-hing",  pyOld:"TÄi-kÃ¡ng-poo"},
  "è‹“é›…":{old:"ç¬­ä»”å¯®", pyNew:"LÃ®ng-ngÃ¡",  pyOld:"LÃ®ng-Ã¡-liÃ¢u"},
  "æ——æ´¥":{old:"æ——å¾Œ",   pyNew:"KÃ®-tin",    pyOld:"KÃ®-Äu"},
  "å‰é®":{old:"å‰é®",   pyNew:"TsiÃ¢n-tÃ¬n", pyOld:"TsiÃ¢n-tÃ¬n"},
  "å°æ¸¯":{old:"æ¸¯ä»”å¢˜", pyNew:"SiÃ³-kÃ¡ng",  pyOld:"KÃ¡ng-Ã¡ kÃ®nn"},
  "å¤§æ¨¹":{old:"å¤§æ¨¹è·¤", pyNew:"TuÄ-tshiÅ«", pyOld:"TuÄ-tshiÅ«-kha"},
  "å¤§å¯®":{old:"å¤§è—”",   pyNew:"TuÄ-liÃ¢u",  pyOld:"TuÄ-liÃ¢u"},
  "æ—åœ’":{old:"é ‚æ—ä»”é‚Š", pyNew:"LÃ®m-hnÌ‚g", pyOld:"TÃ­ng-nÃ¢-Ã¡-pinn"},
  "å¤§ç¤¾":{old:"ä¸‰å¥¶å£‡",  pyNew:"TuÄ-siÄ",   pyOld:"Sam-nÃ¡i-tuÃ¢nn"},
  "ä»æ­¦":{old:"ä»æ­¦åº„",  pyNew:"JÃ®n-bÃº",    pyOld:"JÃ®n-bÃº-tsng"},
  "é³¥æ¾":{old:"é³¥æ¾è·¤",  pyNew:"TsiÃ¡u-tshÃ®ng", pyOld:"TsiÃ¡u-tshÃ®ng-kha"},
  "é³³å±±":{old:"ä¸‹åŸ¤é ­",  pyNew:"HÅng-suann",   pyOld:"Ä’-pi-thÃ¢u"},
  "èŒ„è£":{old:"èŒ„è‹³è£ä»”", pyNew:"Ka-tiÄnn",   pyOld:"Ka-tang-tiÄnn-Ã¡"},
  "æ°¸å®‰":{old:"çƒæ¨¹æ—",   pyNew:"Ãng-an",     pyOld:"Oo-tshiÅ«-nÃ¢"},
  "å½Œé™€":{old:"å½Œé™€æ¸¯",   pyNew:"MÃ®-tÃ´",      pyOld:"BÃ®-lÃ´-kÃ¡ng"},
  "æ¢“å®˜":{old:"æ¢“å®˜",     pyNew:"TsÃº-kuann",  pyOld:"TsÃº-kuann"},
  "æ¹–å…§":{old:"å¤§æ¹–",     pyNew:"Ã”o-lÄi",     pyOld:"TuÄ-Ã´o"},
  "è·¯ç«¹":{old:"åŠè·¯ç«¹",   pyNew:"LÅo-tik",    pyOld:"PuÃ nn-lÅo-tik"},
  "å²¡å±±":{old:"é˜¿å…¬åº—",   pyNew:"Kong-san",   pyOld:"A-kong-tiÃ m"},
  "æ©‹é ­":{old:"æ©‹ä»”é ­",   pyNew:"KiÃ´-thÃ¢u",   pyOld:"KiÃ´-Ã¡-thÃ¢u"},
  "é˜¿è“®":{old:"é˜¿å—¹ç¤¾",   pyNew:"A-lian",     pyOld:"A-lian-siÄ"},
  "ç”°å¯®":{old:"ç”°è—”",     pyNew:"TshÃ¢n-liÃ¢u", pyOld:"TshÃ¢n-liÃ¢u"},
  "ç‡•å·¢":{old:"æ´å‰¿å³",   pyNew:"IÃ n-tsÃ¢u",   pyOld:"UÄn-tsÃ¢u-iÅ«"},
  "å…§é–€":{old:"ç¾…æ¼¢å…§é–€", pyNew:"LÄi-bÃ»n",    pyOld:"LÃ´-hÃ n-lÄi-bÃ»n"},
  "æ——å±±":{old:"è•ƒè–¯è—”",   pyNew:"KÃ®-san",     pyOld:"Han-tsÃ®-liÃ¢u"},
  "æ‰æ—":{old:"æ¥ æ¢“ä»™",   pyNew:"Sam-nÃ¢",     pyOld:"LÃ¢m-tsÃº-sian"},
  "ç¾æ¿ƒ":{old:"ç€°æ¿ƒ",     pyNew:"Bi-long",    pyOld:"BÃ®-long"},
  "ç”²ä»™":{old:"é˜¿é‡Œé—œ",   pyNew:"Kah-sian",   pyOld:"A-lÃ­-kuan"},
  "å…­é¾œ":{old:"å…­é¾œé‡Œç¤¾", pyNew:"LaÌk-ku",     pyOld:"LaÌk-ku-lÃ­-siÄ"},
  "é‚£ç‘ªå¤":{old:"èšŠå­åª",  pyNew:"Na-mÃ¡-siah", pyOld:"Mangacun/BÃ¡ng-Ã¡-tsÃ­"},
  "æ¡ƒæº":{old:"é›…çˆ¾",     pyNew:"ThÃ´-guÃ¢n",   pyOld:"Ngani/NgÃ¡-nÃ­"},
  "èŒ‚æ—":{old:"å¤šç´",     pyNew:"BÅo-lÃ®m",    pyOld:"TÅ-na"}
};

/* ====== 1) DOM ====== */
const stage = document.getElementById('stage');
const root = document.getElementById('root');
const tip = document.getElementById('tip');
const btnFit = document.getElementById('btnFit');
const btnReset = document.getElementById('btnReset');
const btnStitch = document.getElementById('btnStitch');

/* ====== 2) è¼‰å…¥ SVGï¼Œæ¸…æ‰é»‘ç²—æ¡†ï¼Œè‘—è‰²èˆ‡ç¶å®š ====== */
let originalInner = "", stitched = false, transformCache = new Map();

async function loadSVG(){
  const res = await fetch(SVG_URL, {mode:'cors'});
  const text = await res.text();
  root.innerHTML = text;
  originalInner = root.innerHTML;

  // 2-1 æ¸…é™¤é»‘ç²—æ¡†ï¼ˆå¤§ rect æˆ–è¦†è“‹é¢ç©éå¤§çš„ pathã€polygonï¼Œå…¨åˆªï¼‰
  const vb = stage.viewBox.baseVal;
  const total = vb.width*vb.height || 1;
  root.querySelectorAll('rect,path,polygon').forEach(el=>{
    try{
      const bb = el.getBBox(); const area = bb.width*bb.height;
      const strokeW = parseFloat(el.getAttribute('stroke-width')||'0');
      const stroke = (el.getAttribute('stroke')||"").toLowerCase();
      const titled = !!(el.querySelector && el.querySelector('title'));
      const looksFrame = (stroke==='black' || stroke==='#000' || stroke==='#000000' || stroke.indexOf('rgb(0,0,0)')>=0) && strokeW>=5;
      if((area/total>0.25 && !titled) || looksFrame){
        el.remove();
      }
    }catch(_){}
  });

  // 2-2 è‘—è‰² + äº’å‹•
  const zones = root.querySelectorAll('path,polygon');
  zones.forEach(z=>{
    const t = z.querySelector('title');
    const raw = t && t.textContent ? t.textContent.trim() : "";
    const name = raw.replace(/å€.*$/,''); // å–ä¸­æ–‡å€åï¼ˆå»æ‰ã€Œå€â€¦ã€å°¾è¨»ï¼‰
    if(!name) return;
    const g = whichGroup(name);
    if(!g) return;
    // è‘—è‰²
    z.classList.add('hoverable');
    z.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue(
      {center:'--red',east:'--purple',north:'--ylg',mount:'--cyan'}[g]
    ).trim());
    z.setAttribute('stroke','#ffffff'); z.setAttribute('stroke-width','1');

    // é»æ“Š â†’ æµ®çª—è²¼æ—é‚Šï¼ˆç”¨ getBoundingClientRect + scroll æ‹¿çµ•å°ä½ç½®ï¼‰
    z.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      showTipFor(name, z);
    });
  });

  fitAll();
}

function whichGroup(n){
  if(GROUPS.center.includes(n)) return 'center';
  if(GROUPS.east.includes(n))   return 'east';
  if(GROUPS.north.includes(n))  return 'north';
  if(GROUPS.mount.includes(n))  return 'mount';
  return null;
}

function showTipFor(name, elem){
  const d = DATA[name];
  const html = d ? `
    <h3>${name}</h3>
    <h4>${d.old}</h4>
    <p class="py">${d.pyNew}</p>
    <p class="py">${d.pyOld}</p>
    <div class="btns">
      <button class="btnaudio" aria-disabled="true">â–¶ æ–°åœ°å</button>
      <button class="btnaudio" aria-disabled="true">â–¶ èˆŠåœ°å</button>
    </div>
  ` : `<h3>${name}</h3><h4>ï¼ˆæš«ç„¡å°ç…§è³‡æ–™ï¼‰</h4>`;
  tip.innerHTML = html;

  // åº§æ¨™ï¼šå€å¡Šä¸­å¿ƒ â†’ ç•«é¢åº§æ¨™ â†’ è²¼æ—é‚Š
  const r = elem.getBoundingClientRect();
  const host = stage.getBoundingClientRect();
  const cx = r.left + r.width/2;
  const cy = r.top  + r.height/2;

  tip.style.left = (cx - host.left + window.scrollX) + 'px';
  tip.style.top  = (cy - host.top  + window.scrollY - 12) + 'px';
  tip.classList.add('show');

  // é»åˆ¥è™•é—œé–‰
  const hide=()=>{ tip.classList.remove('show'); window.removeEventListener('click',hide,true); };
  setTimeout(()=>window.addEventListener('click',hide,{once:true,capture:true}),0);
}

/* ====== 3) è¦–çª—ï¼šå…¨åœ–é¡¯ç¤º / é‡ç½® ====== */
function unionBBox(a,b){
  const x = Math.min(a.x, b.x), y = Math.min(a.y, b.y);
  const r = Math.max(a.x+a.width,  b.x+b.width);
  const t = Math.max(a.y+a.height, b.y+b.height);
  return {x, y, width:r-x, height:t-y};
}
function bboxOf(target){
  let bb=null;
  target.querySelectorAll('path,polygon').forEach(el=>{
    try{ const b=el.getBBox(); if(b && b.width>0 && b.height>0){ bb=bb?unionBBox(bb,b):b; } }catch(_){}
  });
  return bb;
}
function fitAll(){
  const bb = bboxOf(root);
  if(!bb){ return; }
  const pad=0.06;
  const x = bb.x - bb.width*pad;
  const y = bb.y - bb.height*pad;
  const w = bb.width*(1+2*pad);
  const h = bb.height*(1+2*pad);
  stage.setAttribute('viewBox', [x,y,w,h].join(' '));
}
btnFit.addEventListener('click', fitAll);

btnReset.addEventListener('click', ()=>{
  // é‚„åŸæ‰€æœ‰è®Šæ›
  transformCache.forEach((val, node)=> node.setAttribute('transform', val));
  transformCache.clear();
  root.innerHTML = originalInner;
  loadSVG();
});

/* ====== 4) ä¸€éµç¸«åˆï¼ˆè‡ªå‹•æŠŠå››å¤§å¡Šæ’å›ä¸€å¼µå®Œæ•´åœ°åœ–ï¼‰ ======
   åšæ³•ï¼šåµæ¸¬å››ç¾¤å„è‡ª bboxï¼Œå°‡å…¶å¹³ç§»ï¼Œè®“ï¼šåŒ—å€åœ¨ä¸Šã€å±±å€åœ¨å³ä¸Šã€ä¸­å¿ƒåœ¨å·¦ä¸‹ã€æ±å€åœ¨å³ä¸‹ï¼Œå½¼æ­¤ç›¸é„°ä¸”ä¸é‡ç–Šã€‚
   ä¸æ”¹è®Šå„å€å…§éƒ¨å½¢ç‹€ï¼Œåªåšç¾¤çµ„å±¤ç´š translateã€‚ */
function oneClickStitch(){
  // å…ˆå»ºç«‹å››å€‹ wrapperï¼ŒæŠŠè©²ç¾¤çš„ path/polygonæ›é€²å»ï¼ˆåƒ…åœ¨æœ¬åœ°è‡¨æ™‚ç¾¤çµ„å±¤ï¼‰
  const mkWrap = (id)=>{ let g=root.querySelector('#'+id); if(!g){ g=document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('id',id); root.appendChild(g);} return g; }
  const wrap = {
    center: mkWrap('wrap_center'),
    east:   mkWrap('wrap_east'),
    north:  mkWrap('wrap_north'),
    mount:  mkWrap('wrap_mount')
  };

  // åˆ†æ´¾å…ƒç´ åˆ°ç¾¤çµ„ï¼ˆä¾ title ä¸­æ–‡å€ååˆ¤æ–·ï¼‰
  root.querySelectorAll('path,polygon').forEach(el=>{
    const t = el.querySelector('title');
    const name = t && t.textContent ? t.textContent.trim().replace(/å€.*$/,'') : "";
    const grp = whichGroup(name);
    if(!grp) return;
    // è¨˜éŒ„åŸ transformï¼Œä¹‹å¾Œ reset ç”¨
    if(!transformCache.has(el.parentNode)) transformCache.set(el.parentNode, el.parentNode.getAttribute('transform')||'');
    wrap[grp].appendChild(el);
  });

  // å–å››ç¾¤ bbox
  const bbC = bboxOf(wrap.center), bbE = bboxOf(wrap.east), bbN = bboxOf(wrap.north), bbM = bboxOf(wrap.mount);
  if(!(bbC&&bbE&&bbN&&bbM)){ fitAll(); return; }

  // ä»¥å¸‚ä¸­å¿ƒç‚ºåŸºæº–ï¼ŒæŠŠå…¶ä»–ä¸‰ç¾¤ã€Œè²¼é½Šã€åˆ°åˆç†ä½ç½®ï¼ˆé¿å…é‡ç–Šï¼Œç•™ 12px é–“éš™ï¼‰
  const gap = 12;

  // å…ˆæŠŠå››ç¾¤å¹³ç§»åˆ°åŸé»é™„è¿‘ï¼ˆå»æ‰æœ€å° x,yï¼‰
  const minX = Math.min(bbC.x, bbE.x, bbN.x, bbM.x);
  const minY = Math.min(bbC.y, bbE.y, bbN.y, bbM.y);
  const shift = (g,bb)=> g.setAttribute('transform', `translate(${-(minX)} ${-(minY)})`);
  shift(wrap.center, bbC); shift(wrap.east, bbE); shift(wrap.north, bbN); shift(wrap.mount, bbM);

  // é‡æ–°è¨ˆ bbox
  const _bbC = bboxOf(wrap.center), _bbE=bboxOf(wrap.east), _bbN=bboxOf(wrap.north), _bbM=bboxOf(wrap.mount);

  // ä½ˆå±€ï¼šåŒ—å€åœ¨ä¸Šï¼Œå±±å€åœ¨å³ä¸Šï¼Œä¸­å¿ƒåœ¨å·¦ä¸‹ï¼Œæ±å€åœ¨å³ä¸‹
  // å·¦ä¸Šè§’ç½®åŒ—å€ (0,0)
  wrap.north.setAttribute('transform', `translate(${-_bbN.x} ${-_bbN.y})`);

  // å±±å€é åŒ—å€å³å´
  const mountX = (_bbN.x + _bbN.width + gap) - _bbM.x;
  const mountY = (-_bbM.y); // å°é½Šä¸Šç·£
  wrap.mount.setAttribute('transform', `translate(${mountX} ${mountY})`);

  // å¸‚ä¸­å¿ƒæ”¾åŒ—å€ä¸‹æ–¹ï¼ˆç•¥é å·¦ï¼‰
  const centerX = (-_bbC.x);
  const centerY = (_bbN.y + _bbN.height + gap) - _bbC.y;
  wrap.center.setAttribute('transform', `translate(${centerX} ${centerY})`);

  // æ±å€æ”¾å¸‚ä¸­å¿ƒå³å´
  const eastX = (_bbC.x + _bbC.width + gap) - _bbE.x;
  const eastY = centerY; // èˆ‡å¸‚ä¸­å¿ƒå°é½Š
  wrap.east.setAttribute('transform', `translate(${eastX} ${eastY})`);

  stitched = true;
  fitAll();
}

btnStitch.addEventListener('click', oneClickStitch);

/* ====== å•Ÿå‹• ====== */
loadSVG();
</script>
</body>
</html>
