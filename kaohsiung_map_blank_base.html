<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>高雄市38區新舊地名互動地圖（v4.1 縫合版）</title>
<style>
  :root{
    --ink:#111827; --muted:#6b7280; --bg:#fafafa;
    --red:#f87171; --purple:#c4b5fd; --ylg:#bbf7d0; --cyan:#99f6e4;
    --card:rgba(255,255,255,.94);
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,Arial}
  header{padding:14px 16px 6px}
  h1{margin:0 0 6px 0;font-size:20px}
  .hint{margin:0;color:var(--muted);font-size:14px}
  .toolbar{padding:8px 12px;display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer;font-size:13px}
  .legend{display:flex;flex-wrap:wrap;gap:8px;padding:6px 12px 2px}
  .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:999px;padding:4px 10px 4px 6px}
  .dot{width:14px;height:14px;border-radius:50%}
  .mapwrap{position:relative;margin:8px 12px 16px;border:1px solid #e5e7eb;border-radius:14px;background:#fff;box-shadow:0 8px 22px rgba(0,0,0,.08);overflow:hidden}
  svg{display:block;width:100%;height:calc(100vh - 200px);max-height:1000px}
  @media (max-width:768px){ svg{height:calc(100vh - 220px)} }
  /* 浮窗 */
  .tip{position:absolute;min-width:220px;max-width:86vw;pointer-events:none;
       background:var(--card);backdrop-filter:saturate(140%) blur(6px);
       border:1px solid rgba(0,0,0,.06);border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.16);
       padding:12px;opacity:0;transform:translate(-50%,-10px) scale(.98);
       transition:opacity .22s ease, transform .22s ease;}
  .tip.show{opacity:1;transform:translate(-50%,-14px) scale(1)}
  .tip h3{margin:0 0 2px;color:#b91c1c;font-size:16px;font-weight:700}
  .tip h4{margin:0 0 6px;color:#111827;font-size:15px;font-weight:600}
  .py{margin:0;color:#4b5563;font-size:14px;line-height:1.25}
  .btns{margin-top:8px;display:flex;gap:8px}
  .btnaudio{pointer-events:auto;padding:6px 10px;font-size:13px;border-radius:10px;border:1px dashed #cbd5e1;background:#f3f4f6;color:#9ca3af;cursor:not-allowed}
  /* hover 提亮 */
  .hoverable{transition:filter .25s ease}
  .hoverable:hover{filter:brightness(1.15)}
</style>
</head>
<body>
<header>
  <h1>高雄市38區新舊地名互動地圖</h1>
  <p class="hint">📱 建議直式觀看效果最佳</p>
</header>

<div class="legend">
  <span class="chip"><span class="dot" style="background:var(--red)"></span>市中心</span>
  <span class="chip"><span class="dot" style="background:var(--purple)"></span>市郊–東</span>
  <span class="chip"><span class="dot" style="background:var(--ylg)"></span>市郊–北</span>
  <span class="chip"><span class="dot" style="background:var(--cyan)"></span>山區</span>
</div>

<div class="toolbar">
  <button id="btnStitch" class="btn">一鍵縫合四大區塊</button>
  <button id="btnFit" class="btn">全圖顯示</button>
  <button id="btnReset" class="btn">重置位置</button>
</div>

<div class="mapwrap">
  <div id="tip" class="tip" role="dialog" aria-live="polite"></div>
  <svg id="stage" viewBox="0 0 1143.062 1440.995" preserveAspectRatio="xMidYMid meet" aria-label="高雄市行政區互動地圖">
    <g id="root"></g>
  </svg>
</div>

<script>
/* ====== 0) 設定 ====== */
/* 若 SVG 與本檔同層：改為 'map_assets/Blank_Kaohsiung_map.svg' */
const SVG_URL = 'map_assets/Blank_Kaohsiung_map.svg';

/* 四群 */
const GROUPS = {
  center: ["楠梓","左營","鼓山","三民","鹽埕","前金","新興","苓雅","旗津","前鎮","小港"],
  east:   ["大樹","大寮","林園","大社","仁武","鳥松","鳳山"],
  north:  ["茄萣","永安","彌陀","梓官","湖內","路竹","岡山","橋頭","阿蓮","田寮","燕巢"],
  mount:  ["內門","旗山","杉林","美濃","甲仙","六龜","那瑪夏","桃源","茂林"]
};
const COLOR = { center:'var(--red)', east:'var(--purple)', north:'var(--ylg)', mount:'var(--cyan)' };

/* 你的最終資料（新地名→舊地名＋兩行台語拼音） */
const DATA = {
  "楠梓":{old:"楠仔坑", pyNew:"Lâm-tsú", pyOld:"Lâm-á-khenn"},
  "左營":{old:"埤仔頭", pyNew:"Tsó-iânn", pyOld:"Pi-á-thâu"},
  "鼓山":{old:"打狗山", pyNew:"Kóo-san", pyOld:"Tánn-kóo-san"},
  "三民":{old:"三塊厝", pyNew:"Sam-bîn", pyOld:"Sann-tè-tshù"},
  "鹽埕":{old:"鹽埕埔", pyNew:"Iâm-tiânn", pyOld:"Iâm-tiânn-poo"},
  "前金":{old:"前衿",   pyNew:"Tsiân-kim", pyOld:"Tsiân-khim"},
  "新興":{old:"逮港埔", pyNew:"Sin-hing",  pyOld:"Tāi-káng-poo"},
  "苓雅":{old:"笭仔寮", pyNew:"Lîng-ngá",  pyOld:"Lîng-á-liâu"},
  "旗津":{old:"旗後",   pyNew:"Kî-tin",    pyOld:"Kî-āu"},
  "前鎮":{old:"前鎮",   pyNew:"Tsiân-tìn", pyOld:"Tsiân-tìn"},
  "小港":{old:"港仔墘", pyNew:"Sió-káng",  pyOld:"Káng-á kînn"},
  "大樹":{old:"大樹跤", pyNew:"Tuā-tshiū", pyOld:"Tuā-tshiū-kha"},
  "大寮":{old:"大藔",   pyNew:"Tuā-liâu",  pyOld:"Tuā-liâu"},
  "林園":{old:"頂林仔邊", pyNew:"Lîm-hn̂g", pyOld:"Tíng-nâ-á-pinn"},
  "大社":{old:"三奶壇",  pyNew:"Tuā-siā",   pyOld:"Sam-nái-tuânn"},
  "仁武":{old:"仁武庄",  pyNew:"Jîn-bú",    pyOld:"Jîn-bú-tsng"},
  "鳥松":{old:"鳥松跤",  pyNew:"Tsiáu-tshîng", pyOld:"Tsiáu-tshîng-kha"},
  "鳳山":{old:"下埤頭",  pyNew:"Hōng-suann",   pyOld:"Ē-pi-thâu"},
  "茄萣":{old:"茄苳萣仔", pyNew:"Ka-tiānn",   pyOld:"Ka-tang-tiānn-á"},
  "永安":{old:"烏樹林",   pyNew:"Íng-an",     pyOld:"Oo-tshiū-nâ"},
  "彌陀":{old:"彌陀港",   pyNew:"Mî-tô",      pyOld:"Bî-lô-káng"},
  "梓官":{old:"梓官",     pyNew:"Tsú-kuann",  pyOld:"Tsú-kuann"},
  "湖內":{old:"大湖",     pyNew:"Ôo-lāi",     pyOld:"Tuā-ôo"},
  "路竹":{old:"半路竹",   pyNew:"Lōo-tik",    pyOld:"Puànn-lōo-tik"},
  "岡山":{old:"阿公店",   pyNew:"Kong-san",   pyOld:"A-kong-tiàm"},
  "橋頭":{old:"橋仔頭",   pyNew:"Kiô-thâu",   pyOld:"Kiô-á-thâu"},
  "阿蓮":{old:"阿嗹社",   pyNew:"A-lian",     pyOld:"A-lian-siā"},
  "田寮":{old:"田藔",     pyNew:"Tshân-liâu", pyOld:"Tshân-liâu"},
  "燕巢":{old:"援剿右",   pyNew:"Iàn-tsâu",   pyOld:"Uān-tsâu-iū"},
  "內門":{old:"羅漢內門", pyNew:"Lāi-bûn",    pyOld:"Lô-hàn-lāi-bûn"},
  "旗山":{old:"蕃薯藔",   pyNew:"Kî-san",     pyOld:"Han-tsî-liâu"},
  "杉林":{old:"楠梓仙",   pyNew:"Sam-nâ",     pyOld:"Lâm-tsú-sian"},
  "美濃":{old:"瀰濃",     pyNew:"Bi-long",    pyOld:"Bî-long"},
  "甲仙":{old:"阿里關",   pyNew:"Kah-sian",   pyOld:"A-lí-kuan"},
  "六龜":{old:"六龜里社", pyNew:"La̍k-ku",     pyOld:"La̍k-ku-lí-siā"},
  "那瑪夏":{old:"蚊子只",  pyNew:"Na-má-siah", pyOld:"Mangacun/Báng-á-tsí"},
  "桃源":{old:"雅爾",     pyNew:"Thô-guân",   pyOld:"Ngani/Ngá-ní"},
  "茂林":{old:"多納",     pyNew:"Bōo-lîm",    pyOld:"Tō-na"}
};

/* ====== 1) DOM ====== */
const stage = document.getElementById('stage');
const root = document.getElementById('root');
const tip = document.getElementById('tip');
const btnFit = document.getElementById('btnFit');
const btnReset = document.getElementById('btnReset');
const btnStitch = document.getElementById('btnStitch');

/* ====== 2) 載入 SVG，清掉黑粗框，著色與綁定 ====== */
let originalInner = "", stitched = false, transformCache = new Map();

async function loadSVG(){
  const res = await fetch(SVG_URL, {mode:'cors'});
  const text = await res.text();
  root.innerHTML = text;
  originalInner = root.innerHTML;

  // 2-1 清除黑粗框（大 rect 或覆蓋面積過大的 path、polygon，全刪）
  const vb = stage.viewBox.baseVal;
  const total = vb.width*vb.height || 1;
  root.querySelectorAll('rect,path,polygon').forEach(el=>{
    try{
      const bb = el.getBBox(); const area = bb.width*bb.height;
      const strokeW = parseFloat(el.getAttribute('stroke-width')||'0');
      const stroke = (el.getAttribute('stroke')||"").toLowerCase();
      const titled = !!(el.querySelector && el.querySelector('title'));
      const looksFrame = (stroke==='black' || stroke==='#000' || stroke==='#000000' || stroke.indexOf('rgb(0,0,0)')>=0) && strokeW>=5;
      if((area/total>0.25 && !titled) || looksFrame){
        el.remove();
      }
    }catch(_){}
  });

  // 2-2 著色 + 互動
  const zones = root.querySelectorAll('path,polygon');
  zones.forEach(z=>{
    const t = z.querySelector('title');
    const raw = t && t.textContent ? t.textContent.trim() : "";
    const name = raw.replace(/區.*$/,''); // 取中文區名（去掉「區…」尾註）
    if(!name) return;
    const g = whichGroup(name);
    if(!g) return;
    // 著色
    z.classList.add('hoverable');
    z.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue(
      {center:'--red',east:'--purple',north:'--ylg',mount:'--cyan'}[g]
    ).trim());
    z.setAttribute('stroke','#ffffff'); z.setAttribute('stroke-width','1');

    // 點擊 → 浮窗貼旁邊（用 getBoundingClientRect + scroll 拿絕對位置）
    z.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      showTipFor(name, z);
    });
  });

  fitAll();
}

function whichGroup(n){
  if(GROUPS.center.includes(n)) return 'center';
  if(GROUPS.east.includes(n))   return 'east';
  if(GROUPS.north.includes(n))  return 'north';
  if(GROUPS.mount.includes(n))  return 'mount';
  return null;
}

function showTipFor(name, elem){
  const d = DATA[name];
  const html = d ? `
    <h3>${name}</h3>
    <h4>${d.old}</h4>
    <p class="py">${d.pyNew}</p>
    <p class="py">${d.pyOld}</p>
    <div class="btns">
      <button class="btnaudio" aria-disabled="true">▶ 新地名</button>
      <button class="btnaudio" aria-disabled="true">▶ 舊地名</button>
    </div>
  ` : `<h3>${name}</h3><h4>（暫無對照資料）</h4>`;
  tip.innerHTML = html;

  // 座標：區塊中心 → 畫面座標 → 貼旁邊
  const r = elem.getBoundingClientRect();
  const host = stage.getBoundingClientRect();
  const cx = r.left + r.width/2;
  const cy = r.top  + r.height/2;

  tip.style.left = (cx - host.left + window.scrollX) + 'px';
  tip.style.top  = (cy - host.top  + window.scrollY - 12) + 'px';
  tip.classList.add('show');

  // 點別處關閉
  const hide=()=>{ tip.classList.remove('show'); window.removeEventListener('click',hide,true); };
  setTimeout(()=>window.addEventListener('click',hide,{once:true,capture:true}),0);
}

/* ====== 3) 視窗：全圖顯示 / 重置 ====== */
function unionBBox(a,b){
  const x = Math.min(a.x, b.x), y = Math.min(a.y, b.y);
  const r = Math.max(a.x+a.width,  b.x+b.width);
  const t = Math.max(a.y+a.height, b.y+b.height);
  return {x, y, width:r-x, height:t-y};
}
function bboxOf(target){
  let bb=null;
  target.querySelectorAll('path,polygon').forEach(el=>{
    try{ const b=el.getBBox(); if(b && b.width>0 && b.height>0){ bb=bb?unionBBox(bb,b):b; } }catch(_){}
  });
  return bb;
}
function fitAll(){
  const bb = bboxOf(root);
  if(!bb){ return; }
  const pad=0.06;
  const x = bb.x - bb.width*pad;
  const y = bb.y - bb.height*pad;
  const w = bb.width*(1+2*pad);
  const h = bb.height*(1+2*pad);
  stage.setAttribute('viewBox', [x,y,w,h].join(' '));
}
btnFit.addEventListener('click', fitAll);

btnReset.addEventListener('click', ()=>{
  // 還原所有變換
  transformCache.forEach((val, node)=> node.setAttribute('transform', val));
  transformCache.clear();
  root.innerHTML = originalInner;
  loadSVG();
});

/* ====== 4) 一鍵縫合（自動把四大塊排回一張完整地圖） ======
   做法：偵測四群各自 bbox，將其平移，讓：北區在上、山區在右上、中心在左下、東區在右下，彼此相鄰且不重疊。
   不改變各區內部形狀，只做群組層級 translate。 */
function oneClickStitch(){
  // 先建立四個 wrapper，把該群的 path/polygon掛進去（僅在本地臨時群組層）
  const mkWrap = (id)=>{ let g=root.querySelector('#'+id); if(!g){ g=document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('id',id); root.appendChild(g);} return g; }
  const wrap = {
    center: mkWrap('wrap_center'),
    east:   mkWrap('wrap_east'),
    north:  mkWrap('wrap_north'),
    mount:  mkWrap('wrap_mount')
  };

  // 分派元素到群組（依 title 中文區名判斷）
  root.querySelectorAll('path,polygon').forEach(el=>{
    const t = el.querySelector('title');
    const name = t && t.textContent ? t.textContent.trim().replace(/區.*$/,'') : "";
    const grp = whichGroup(name);
    if(!grp) return;
    // 記錄原 transform，之後 reset 用
    if(!transformCache.has(el.parentNode)) transformCache.set(el.parentNode, el.parentNode.getAttribute('transform')||'');
    wrap[grp].appendChild(el);
  });

  // 取四群 bbox
  const bbC = bboxOf(wrap.center), bbE = bboxOf(wrap.east), bbN = bboxOf(wrap.north), bbM = bboxOf(wrap.mount);
  if(!(bbC&&bbE&&bbN&&bbM)){ fitAll(); return; }

  // 以市中心為基準，把其他三群「貼齊」到合理位置（避免重疊，留 12px 間隙）
  const gap = 12;

  // 先把四群平移到原點附近（去掉最小 x,y）
  const minX = Math.min(bbC.x, bbE.x, bbN.x, bbM.x);
  const minY = Math.min(bbC.y, bbE.y, bbN.y, bbM.y);
  const shift = (g,bb)=> g.setAttribute('transform', `translate(${-(minX)} ${-(minY)})`);
  shift(wrap.center, bbC); shift(wrap.east, bbE); shift(wrap.north, bbN); shift(wrap.mount, bbM);

  // 重新計 bbox
  const _bbC = bboxOf(wrap.center), _bbE=bboxOf(wrap.east), _bbN=bboxOf(wrap.north), _bbM=bboxOf(wrap.mount);

  // 佈局：北區在上，山區在右上，中心在左下，東區在右下
  // 左上角置北區 (0,0)
  wrap.north.setAttribute('transform', `translate(${-_bbN.x} ${-_bbN.y})`);

  // 山區靠北區右側
  const mountX = (_bbN.x + _bbN.width + gap) - _bbM.x;
  const mountY = (-_bbM.y); // 對齊上緣
  wrap.mount.setAttribute('transform', `translate(${mountX} ${mountY})`);

  // 市中心放北區下方（略靠左）
  const centerX = (-_bbC.x);
  const centerY = (_bbN.y + _bbN.height + gap) - _bbC.y;
  wrap.center.setAttribute('transform', `translate(${centerX} ${centerY})`);

  // 東區放市中心右側
  const eastX = (_bbC.x + _bbC.width + gap) - _bbE.x;
  const eastY = centerY; // 與市中心對齊
  wrap.east.setAttribute('transform', `translate(${eastX} ${eastY})`);

  stitched = true;
  fitAll();
}

btnStitch.addEventListener('click', oneClickStitch);

/* ====== 啟動 ====== */
loadSVG();
</script>
</body>
</html>
