<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>高雄市38區新舊地名互動地圖 v5.2</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#111827; --muted:#6b7280; --bg:#f8fafc;
    --red:#f87171;      /* 市中心 */
    --purple:#c4b5fd;   /* 東區   */
    --ylg:#9FDF72;      /* 北區(加深) */
    --cyan:#99f6e4;     /* 山區   */
    --card:rgba(255,255,255,.96);
    --stroke:#ffffff;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,Arial}
  .app{display:flex;flex-direction:column;min-height:100vh}
  header{padding:12px 16px 6px}
  h1{margin:0 0 6px;font-size:18px}
  .hint{margin:0;color:var(--muted);font-size:14px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:8px 12px}
  .btn{padding:8px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer;font-size:13px}
  .btn[data-active="1"]{outline:2px solid #11182722}
  .btn.center{background:var(--red);color:#111}
  .btn.east{background:var(--purple);color:#111}
  .btn.north{background:var(--ylg);color:#111}
  .btn.mount{background:var(--cyan);color:#111}
  .mapwrap{position:relative;flex:1;min-height:0;border-top:1px solid #e5e7eb}
  /* 滿版 SVG 畫布 */
  svg#stage{display:block;width:100vw;height:calc(100vh - 160px);background:#fff}
  @media (max-width:768px){ svg#stage{height:calc(100vh - 178px)} }

  /* 浮窗（自動避開區塊） */
  .tip{
    position:absolute;min-width:240px;max-width:86vw;pointer-events:auto;z-index:10;
    background:var(--card);backdrop-filter:saturate(140%) blur(6px);
    border:1px solid rgba(0,0,0,.06);border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.18);
    padding:12px;opacity:0;transform:translate(-50%,-10px) scale(.98);
    transition:opacity .22s ease, transform .22s ease;
  }
  .tip.show{opacity:1;transform:translate(-50%,-14px) scale(1)}
  .tip h3{margin:0 0 2px;color:#b91c1c;font-size:16px;font-weight:700}
  .tip h4{margin:0 0 6px;color:#111827;font-size:15px;font-weight:600}
  .py{margin:0;color:#334155;font-size:14px;line-height:1.25}
  .btns{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
  .btnplay{padding:6px 10px;font-size:13px;border-radius:10px;border:1px solid #d1d5db;background:#ffffff;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
  .btnplay svg{width:14px;height:14px}
  .btnplay[disabled]{opacity:.45;cursor:not-allowed}

  /* 點擊回饋：外框亮度漸強再淡出（1s） */
  @keyframes ringPulse {
    0%{filter:brightness(1);stroke-width:1}
    40%{filter:brightness(1.55);stroke-width:2.5}
    100%{filter:brightness(1);stroke-width:1}
  }
  .pulse{animation:ringPulse 1s ease}

  /* 區塊 hover */
  .hoverable{transition:filter .25s ease}
  .hoverable:hover{filter:brightness(1.12)}

  /* 置於地圖上的新地名標籤（初始就顯示） */
  .label{
    font-size:14px; fill:#b91c1c; font-weight:700; text-anchor:middle; pointer-events:none;
    paint-order:stroke; stroke:#fff; stroke-width:3px; stroke-linejoin:round;
  }
  @media (max-width:768px){ .label{font-size:13px} }

  /* 底部工具列 */
  .footerbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;padding:10px 12px}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>高雄市38區新舊地名互動地圖</h1>
    <p class="hint">📱 建議直式觀看效果最佳</p>
  </header>

  <div class="toolbar">
    <button class="btn center" data-group="center">市中心</button>
    <button class="btn east"   data-group="east">市郊–東</button>
    <button class="btn north"  data-group="north">市郊–北</button>
    <button class="btn mount"  data-group="mount">山區</button>
  </div>

  <div class="mapwrap">
    <!-- 浮窗 -->
    <div id="tip" class="tip" role="dialog" aria-live="polite">
      <h3 id="tipNew"></h3>
      <h4 id="tipOld"></h4>
      <p id="tipPyNew" class="py"></p>
      <p id="tipPyOld" class="py"></p>
      <div class="btns">
        <button id="btnPlayNew" class="btnplay">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> 新地名
        </button>
        <button id="btnPlayOld" class="btnplay">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> 舊地名
        </button>
      </div>
      <audio id="aud" preload="none"></audio>
    </div>

    <!-- 主畫布（內含：載入的 SVG、動態標籤層） -->
    <svg id="stage" viewBox="0 0 1143.062 1440.995" preserveAspectRatio="xMidYMid meet" aria-label="高雄市行政區互動地圖">
      <g id="svgRoot"></g>
      <g id="labelsLayer"></g>
    </svg>
  </div>

  <div class="footerbar">
    <button id="btnReset" class="btn">🔄 全部顯示</button>
  </div>
</div>

<script>
/* =========================
   1) 設定與資料
========================= */
const SVG_URL = 'map_assets/Blank_Kaohsiung_map.svg';

const GROUPS = {
  center: ["楠梓","左營","鼓山","三民","鹽埕","前金","新興","苓雅","旗津","前鎮","小港"],
  east:   ["大樹","大寮","林園","大社","仁武","鳥松","鳳山"],
  north:  ["茄萣","永安","彌陀","梓官","湖內","路竹","岡山","橋頭","阿蓮","田寮","燕巢"],
  mount:  ["內門","旗山","杉林","美濃","甲仙","六龜","那瑪夏","桃源","茂林"]
};
const COLOR = { center:'var(--red)', east:'var(--purple)', north:'var(--ylg)', mount:'var(--cyan)' };

/* 新／舊地名＋台語拼音（浮窗同時顯示漢字與括號羅馬字）*/
const D = {
  "楠梓":{old:"楠仔坑",      pyNew:"Lâm-tsú",        pyOld:"Lâm-á-khenn"},
  "左營":{old:"埤仔頭",      pyNew:"Tsó-iânn",       pyOld:"Pi-á-thâu"},
  "鼓山":{old:"打狗山",      pyNew:"Kóo-san",        pyOld:"Tánn-kóo-san"},
  "三民":{old:"三塊厝",      pyNew:"Sam-bîn",        pyOld:"Sann-tè-tshù"},
  "鹽埕":{old:"鹽埕埔",      pyNew:"Iâm-tiânn",      pyOld:"Iâm-tiânn-poo"},
  "前金":{old:"前衿",        pyNew:"Tsiân-kim",      pyOld:"Tsiân-khim"},
  "新興":{old:"逮港埔",      pyNew:"Sin-hing",       pyOld:"Tāi-káng-poo"},
  "苓雅":{old:"笭仔寮",      pyNew:"Lîng-ngá",       pyOld:"Lîng-á-liâu"},
  "旗津":{old:"旗後",        pyNew:"Kî-tin",         pyOld:"Kî-āu"},
  "前鎮":{old:"前鎮",        pyNew:"Tsiân-tìn",      pyOld:"Tsiân-tìn"},
  "小港":{old:"港仔墘",      pyNew:"Sió-káng",       pyOld:"Káng-á kînn"},
  "大樹":{old:"大樹跤",      pyNew:"Tuā-tshiū",      pyOld:"Tuā-tshiū-kha"},
  "大寮":{old:"大藔",        pyNew:"Tuā-liâu",       pyOld:"Tuā-liâu"},
  "林園":{old:"頂林仔邊",    pyNew:"Lîm-hn̂g",        pyOld:"Tíng-nâ-á-pinn"},
  "大社":{old:"三奶壇",      pyNew:"Tuā-siā",        pyOld:"Sam-nái-tuânn"},
  "仁武":{old:"仁武庄",      pyNew:"Jîn-bú",         pyOld:"Jîn-bú-tsng"},
  "鳥松":{old:"鳥松跤",      pyNew:"Tsiáu-tshîng",   pyOld:"Tsiáu-tshîng-kha"},
  "鳳山":{old:"下埤頭",      pyNew:"Hōng-suann",     pyOld:"Ē-pi-thâu"},
  "茄萣":{old:"茄苳萣仔",    pyNew:"Ka-tiānn",       pyOld:"Ka-tang-tiānn-á"},
  "永安":{old:"烏樹林",      pyNew:"Íng-an",         pyOld:"Oo-tshiū-nâ"},
  "彌陀":{old:"彌陀港",      pyNew:"Mî-tô",          pyOld:"Bî-lô-káng"},
  "梓官":{old:"梓官",        pyNew:"Tsú-kuann",      pyOld:"Tsú-kuann"},
  "湖內":{old:"大湖",        pyNew:"Ôo-lāi",         pyOld:"Tuā-ôo"},
  "路竹":{old:"半路竹",      pyNew:"Lōo-tik",        pyOld:"Puànn-lōo-tik"},
  "岡山":{old:"阿公店",      pyNew:"Kong-san",       pyOld:"A-kong-tiàm"},
  "橋頭":{old:"橋仔頭",      pyNew:"Kiô-thâu",       pyOld:"Kiô-á-thâu"},
  "阿蓮":{old:"阿嗹社",      pyNew:"A-lian",         pyOld:"A-lian-siā"},
  "田寮":{old:"田藔",        pyNew:"Tshân-liâu",     pyOld:"Tshân-liâu"},
  "燕巢":{old:"援剿右",      pyNew:"Iàn-tsâu",       pyOld:"Uān-tsâu-iū"},
  "內門":{old:"羅漢內門",    pyNew:"Lāi-bûn",        pyOld:"Lô-hàn-lāi-bûn"},
  "旗山":{old:"蕃薯藔",      pyNew:"Kî-san",         pyOld:"Han-tsî-liâu"},
  "杉林":{old:"楠梓仙",      pyNew:"Sam-nâ",         pyOld:"Lâm-tsú-sian"},
  "美濃":{old:"瀰濃",        pyNew:"Bi-long",        pyOld:"Bî-long"},
  "甲仙":{old:"阿里關",      pyNew:"Kah-sian",       pyOld:"A-lí-kuan"},
  "六龜":{old:"六龜里社",    pyNew:"La̍k-ku",         pyOld:"La̍k-ku-lí-siā"},
  "那瑪夏":{old:"蚊子只",     pyNew:"Na-má-siah",     pyOld:"Mangacun/Báng-á-tsí"},
  "桃源":{old:"雅爾",        pyNew:"Thô-guân",       pyOld:"Ngani/Ngá-ní"},
  "茂林":{old:"多納",        pyNew:"Bōo-lîm",        pyOld:"Tō-na"}
};

/* 區域播放編號（01~38） */
const ORDER = [
  "楠梓","左營","鼓山","三民","鹽埕","前金","新興","苓雅","旗津","前鎮","小港",
  "大樹","大寮","林園","大社","仁武","鳥松","鳳山",
  "茄萣","永安","彌陀","梓官","湖內","路竹","岡山","橋頭","阿蓮","田寮","燕巢",
  "內門","旗山","杉林","美濃","甲仙","六龜","那瑪夏","桃源","茂林"
];
const IDX = Object.fromEntries(ORDER.map((n,i)=>[n,String(i+1).padStart(2,'0')]));

/* =========================
   2) 元件抓取
========================= */
const stage  = document.getElementById('stage');
const root   = document.getElementById('svgRoot');
const labels = document.getElementById('labelsLayer');
const tip    = document.getElementById('tip');
const tNew   = document.getElementById('tipNew');
const tOld   = document.getElementById('tipOld');
const tPyN   = document.getElementById('tipPyNew');
const tPyO   = document.getElementById('tipPyOld');
const btnN   = document.getElementById('btnPlayNew');
const btnO   = document.getElementById('btnPlayOld');
const aud    = document.getElementById('aud');
const btnReset = document.getElementById('btnReset');
const grpBtns  = document.querySelectorAll('.toolbar .btn');

/* =========================
   3) 載入 SVG → 剔除黑框 → 著色 → 綁定 → 產生標籤
========================= */
let allZones = [];
let fullBBox = null;

loadSVG().catch(err=>{
  root.innerHTML = `<text x="20" y="40" fill="#b91c1c" font-size="16">載入 SVG 失敗，請檢查：${SVG_URL}</text>`;
});

async function loadSVG(){
  const res = await fetch(SVG_URL, {mode:'cors'});
  const txt = await res.text();
  root.innerHTML = txt;

  // 若嵌入有 <svg> 再取它的 viewBox，避免只顯示一角
  const innerSVG = root.querySelector('svg');
  if(innerSVG && !innerSVG.getAttribute('viewBox')){
    const w = parseFloat(innerSVG.getAttribute('width'))  || 1143.062;
    const h = parseFloat(innerSVG.getAttribute('height')) || 1440.995;
    innerSVG.setAttribute('viewBox', `0 0 ${w} ${h}`);
  }

  // 1) 剔除黑粗框與巨型背景（無 <title> 且面積 >50% / 黑色粗線 >=4px）
  const vb = stage.viewBox.baseVal;
  const total = (vb && vb.width*vb.height) || (1143.062*1440.995);
  root.querySelectorAll('rect,path,polygon').forEach(el=>{
    try{
      const bb = el.getBBox();
      const area = bb.width*bb.height;
      const strokeW = parseFloat(el.getAttribute('stroke-width')||'0');
      const stroke  = (el.getAttribute('stroke')||'').toLowerCase();
      const hasTitle = !!(el.querySelector && el.querySelector('title'));
      const looksFrame = (stroke==='black' || stroke==='#000' || stroke==='#000000' || stroke.includes('rgb(0, 0, 0)')) && strokeW>=4;
      if( (!hasTitle && area/total>0.5) || looksFrame ){
        el.remove();
      }
    }catch(_){}
  });

  // 2) 隱藏內建 <text>，避免重疊
  root.querySelectorAll('text').forEach(t=>t.setAttribute('display','none'));

  // 3) 著色、綁定
  allZones = [];
  root.querySelectorAll('path,polygon').forEach(el=>{
    const t = el.querySelector('title');
    let name = t && t.textContent ? t.textContent.trim() : '';
    name = name.replace(/區.*$/,'').replace(/\s*\(.+?\)\s*$/,'').replace(/\s*[A-Za-z].*$/,'');
    if(!name) return;
    const grp = whichGroup(name);
    if(!grp) return;

    el.classList.add('hoverable');
    el.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue(
      {center:'--red', east:'--purple', north:'--ylg', mount:'--cyan'}[grp]
    ).trim());
    el.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--stroke').trim());
    el.setAttribute('stroke-width', '1');

    el.addEventListener('click', e=>{
      e.stopPropagation();
      // 點擊高亮動畫
      el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse');
      showTip(name, el);
    });

    allZones.push({name, grp, el});
  });

  // 4) 產生初始「新地名」標籤（置中）
  renderLabels();

  // 5) 計算全圖 bbox，設定一開即全圖
  fullBBox = unionBBoxOf(root);
  fitTo(fullBBox, 1.0); // 全圖
}

/* 動態標籤：放在 labelsLayer（SVG <text> 會隨縮放移動） */
function renderLabels(){
  labels.innerHTML = '';
  for(const {name, el} of allZones){
    const bb = el.getBBox();
    const x = bb.x + bb.width/2;
    const y = bb.y + bb.height/2;
    const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
    tx.setAttribute('x', x);
    tx.setAttribute('y', y);
    tx.setAttribute('class','label');
    tx.textContent = name;  // 初始只顯示「新地名」
    labels.appendChild(tx);
  }
}

/* =========================
   4) 浮窗：自動避開被點區塊，含括號羅馬拼音，雙音檔播放
========================= */
function showTip(name, elem){
  const d = D[name] || {};
  tNew.textContent = name + (d.pyNew ? `（${d.pyNew}）` : '');
  tOld.textContent = (d.old || '') + (d.pyOld ? `（${d.pyOld}）` : '');
  tPyN.textContent = d.pyNew || '';
  tPyO.textContent = d.pyOld || '';

  // 設定音檔
  const idx = IDX[name];
  const newSrc = idx ? `map_assets/sounds/${idx}${name}_new.mp3` : '';
  const oldSrc = (idx && d.old) ? `map_assets/sounds/${idx}${d.old}_old.mp3` : '';
  btnN.disabled = !newSrc;
  btnO.disabled = !oldSrc;
  btnN.onclick = ()=> play(newSrc);
  btnO.onclick = ()=> play(oldSrc);

  // 計算浮窗位置（避開邊界與區塊）
  placeTipBeside(elem);
  tip.classList.add('show');
  // 點空白處關閉
  const closeOnce = (ev)=>{ if(!tip.contains(ev.target)) { tip.classList.remove('show'); window.removeEventListener('click',closeOnce,true);} };
  setTimeout(()=>window.addEventListener('click',closeOnce,true),0);
}

function play(src){
  aud.pause(); aud.src = src; aud.play().catch(()=>{});
}

/* 聰明定位：依所在象限選擇左/右、上/下，避免遮住被點區塊與超出視窗 */
function placeTipBeside(elem){
  const hostRect = stage.getBoundingClientRect();
  const r = elem.getBoundingClientRect();
  const cx = r.left + r.width/2;
  const cy = r.top  + r.height/2;

  const onLeft = cx < (hostRect.left + hostRect.width/2);
  const onTop  = cy < (hostRect.top  + hostRect.height/2);

  // 預設位移（不遮住）
  let dx = onLeft ? +100 : -100;
  let dy = onTop  ? +40  : -40;

  let left = cx - hostRect.left + dx + window.scrollX;
  let top  = cy - hostRect.top  + dy + window.scrollY;

  // 邊界防護
  const pad = 12;
  const w = tip.offsetWidth || 260;
  const h = tip.offsetHeight || 140;
  const maxL = hostRect.width  - pad;
  const maxT = hostRect.height - pad;

  left = Math.max(pad, Math.min(left, maxL));
  top  = Math.max(pad, Math.min(top,  maxT));

  tip.style.left = left + 'px';
  tip.style.top  = top  + 'px';
}

/* =========================
   5) 四群分頁：顯示該群、其他隱藏；並放大 1.6 倍；可拖曳移動
========================= */
let curGroup = null;     // null=全圖
let curViewBox = {...stage.viewBox.baseVal}; // 用於拖曳

grpBtns.forEach(b=>{
  b.addEventListener('click', ()=>{
    const g = b.dataset.group; curGroup = g;
    grpBtns.forEach(x=>x.dataset.active = (x===b?'1':'0'));
    showOnlyGroup(g);
  });
});

btnReset.addEventListener('click', ()=>{
  curGroup = null;
  grpBtns.forEach(x=>x.dataset.active='0');
  // 全部顯示
  allZones.forEach(z=>{ z.el.style.display=''; });
  fitTo(fullBBox, 1.0);
});

/* 顯示單一群組，並放大 1.6x */
function showOnlyGroup(g){
  const targets = allZones.filter(z=>z.grp===g);
  const others  = allZones.filter(z=>z.grp!==g);
  targets.forEach(z=>z.el.style.display='');
  others.forEach(z=>z.el.style.display='none');

  const bb = unionBBox(targets.map(z=>z.el.getBBox()));
  fitTo(bb, 1.6); // 放大 1.6 倍
}

/* 換 viewBox 以達到放大/縮小與置中 */
function fitTo(bb, scale){
  const pad = 0.06;
  const x = bb.x - bb.width*pad;
  const y = bb.y - bb.height*pad;
  const w = bb.width*(1+2*pad);
  const h = bb.height*(1+2*pad);
  // 放大：縮小 viewBox 尺寸
  const vw = w/scale;
  const vh = h/scale;
  const cx = x + w/2;
  const cy = y + h/2;
  const vx = cx - vw/2;
  const vy = cy - vh/2;

  stage.setAttribute('viewBox', [vx,vy,vw,vh].join(' '));
  curViewBox = {x:vx,y:vy,width:vw,height:vh};
}

/* 拖曳移動（滑鼠與觸控） */
let dragging=false, last={x:0,y:0};
stage.addEventListener('pointerdown', e=>{
  dragging=true; last={x:e.clientX, y:e.clientY}; stage.setPointerCapture(e.pointerId);
});
stage.addEventListener('pointermove', e=>{
  if(!dragging) return;
  const dx = e.clientX - last.x;
  const dy = e.clientY - last.y;
  last = {x:e.clientX, y:e.clientY};
  // 依目前 viewBox 尺寸換算拖移量（每像素相當的地圖單位）
  const rect = stage.getBoundingClientRect();
  const kx = curViewBox.width / rect.width;
  const ky = curViewBox.height/ rect.height;
  curViewBox.x -= dx * kx;
  curViewBox.y -= dy * ky;
  stage.setAttribute('viewBox', [curViewBox.x,curViewBox.y,curViewBox.width,curViewBox.height].join(' '));
});
stage.addEventListener('pointerup',   ()=>dragging=false);
stage.addEventListener('pointercancel',()=>dragging=false);

/* =========================
   6) 工具函數
========================= */
function whichGroup(n){
  if(GROUPS.center.includes(n)) return 'center';
  if(GROUPS.east.includes(n))   return 'east';
  if(GROUPS.north.includes(n))  return 'north';
  if(GROUPS.mount.includes(n))  return 'mount';
  return null;
}
function unionBBoxOf(container){
  let bb=null;
  container.querySelectorAll('path,polygon').forEach(el=>{
    try{ const b=el.getBBox(); if(b && b.width>0 && b.height>0) bb = bb? unionBBox(bb,b):b; }catch(_){}
  });
  return bb || {x:0,y:0,width:1143.062,height:1440.995};
}
function unionBBox(list){
  return list.reduce((acc,b)=>acc?{
    x:Math.min(acc.x,b.x),
    y:Math.min(acc.y,b.y),
    width:Math.max(acc.x+acc.width,b.x+b.width)-Math.min(acc.x,b.x),
    height:Math.max(acc.y+acc.height,b.y+b.height)-Math.min(acc.y,b.y)
  }:b, null);
}
</script>
</body>
</html>
