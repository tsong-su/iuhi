<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>臺灣中部地區&注音符號郵票配對遊戲</title>
<style>
  body{
    margin:0;
    padding:0;
    font-family:Arial, sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    height:100vh;
    overflow:hidden;
    background:#fff;
  }
  header{ text-align:center; margin:10px 0; }
  header h1{ margin:0; font-size:20px; color: #4CAF50; }
  header p{ margin:4px 0 10px 0; font-size:16px; color: #2196F3; font-weight: bold; }

  .game-container{
    display:flex;
    justify-content:center;
    align-items:center; /* 新增：垂直置中 */
    flex:1;
    width:100%;
    max-width:1200px; /* 限制最大寬度，避免超寬 */
    padding:10px;
  }

  /* 兩側：直排 4 排 × 橫排 2 張 */
  .stamp-container{
    display:grid;
    grid-template-columns: repeat(2, minmax(100px, 120px));
    grid-template-rows: repeat(4, minmax(100px, 120px));
    gap:10px;
    justify-content:center;
    align-content:center;
    margin-top:120px;
    flex:1;
  }
  .stamp-wrapper{
    position: relative;
    width: 120px;
    height: 120px;
  }
  .stamp{
    width:120px;
    height:120px;
    object-fit:cover;
    border:2px solid #333;
    border-radius:8px;
    cursor:grab;
  }
  .stamp-number {
    position: absolute;
    bottom: 5px;
    right: 5px;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 14px;
    z-index: 5;
  }

  .map-area{
    position:relative;
    margin:0 20px;
    flex:0 1 auto;
    width: 60%; /* 讓地圖佔據更大比例 */
    max-width: 600px; /* 限制地圖最大寬度 */
    display: flex; /* 新增：讓地圖置中 */
    justify-content: center; /* 新增：讓地圖置中 */
  }
  .map{
    max-width: 100%;
    height:auto;
    display:block;
  }
  
  #victory-text{
    position:absolute;
    top:40%;
    left:50%;
    transform:translate(-50%,-50%) scale(0);
    font-size:48px;
    font-weight:bold;
    color: #FFEB3B;
    z-index:10;
    pointer-events:none;
    transition:transform 1s ease;
    text-shadow:0 2px 6px rgba(0,0,0,.25);
  }

  .controls{
    width:100%;
    text-align:center;
    padding:10px 0;
    background:#f8f8f8;
    border-top:1px solid #ccc;
  }
  .controls button{
    margin:0 10px;
    padding:8px 16px;
    font-size:14px;
    cursor:pointer;
    border-radius:20px;
    border: none;
    color: #fff;
    font-weight: bold;
    transition: background 0.3s ease;
  }

  .reload-button { background: #FF5722; }
  .reload-button:hover { background: #E64A19; }
  
  .home-button { background: #4CAF50; }
  .home-button:hover { background: #388E3C; }
  
  .next-button { background: #00BCD4; }
  .next-button:hover { background: #0097A7; }
  
  .tool-button { background: #9E9E9E; }
  .tool-button:hover { background: #757575; }

  /* 校正模式的方框樣式 */
  .calibration-box {
    position: absolute;
    width: 80px;
    height: 80px;
    border: 2px dashed red;
    box-sizing: border-box;
    cursor: grab;
    display: none; /* 預設隱藏 */
    z-index: 100;
  }
  .calibration-box-number {
    position: absolute;
    top: -15px;
    left: 50%;
    transform: translateX(-50%);
    background: red;
    color: white;
    padding: 0 5px;
    border-radius: 4px;
    font-size: 12px;
  }
</style>
</head>
<body>
<header>
  <h1>臺灣中部地區&注音符號郵票配對遊戲</h1>
  <p>耍法：kā郵票suá 到對應縣市的格仔內</p>
</header>

<div class="game-container">
  <div class="stamp-container" id="left-stamps"></div>
  <div class="map-area" id="map-area">
    <img src="/iuhi/game4_assets/north1_map.png" alt="地圖" class="map" id="map">
    <div id="victory-text">有夠gâu</div>
  </div>
  <div class="stamp-container" id="right-stamps"></div>
</div>

<div class="controls">
  <button class="reload-button" onclick="location.reload()">閣耍一擺</button>
  <button class="home-button" onclick="window.location.href='/iuhi/index.html'">回到遊戲首頁</button>
  <button class="tool-button" onclick="toggleCalibration()">對位校正</button>
  <button class="tool-button" onclick="exportCoords()">匯出座標</button>
</div>

<script>
  const left = document.getElementById('left-stamps');
  const right = document.getElementById('right-stamps');
  const mapArea = document.getElementById('map-area');
  const mapImg = document.getElementById('map');
  const victoryText = document.getElementById('victory-text');

  // 您匯出座標後請貼到此處
  const coords = [];
  
  const answerKey = {
    1: 13, 2: 14, 3: 15, 4: 16, 5: 17, 6: 18, 7: 19, 8: 20
  };

  let correctCount = 0;
  let redBoxes = [];

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function createStamps() {
    left.innerHTML = '';
    right.innerHTML = '';
    
    const allStampIds = Array.from({ length: 8 }, (_, i) => i + 13);
    const shuffledIds = shuffle(allStampIds);

    for (let i = 0; i < 8; i++) {
      const stampWrapper = document.createElement('div');
      stampWrapper.className = 'stamp-wrapper';

      const img = document.createElement('img');
      img.className = 'stamp';
      img.draggable = true;
      img.dataset.id = shuffledIds[i];
      img.src = `/iuhi/game4_assets/stamp${shuffledIds[i]}.jpg`;

      const stampNumber = document.createElement('div');
      stampNumber.className = 'stamp-number';
      stampNumber.innerText = '#' + (i + 1);

      stampWrapper.appendChild(img);
      stampWrapper.appendChild(stampNumber);

      if (i < 4) {
        left.appendChild(stampWrapper);
      } else {
        right.appendChild(stampWrapper);
      }
    }
  }

  mapImg.onload = () => {
    redBoxes = coords.map((pt, index) => ({
      left: pt.x,
      top: pt.y,
      matched: false
    }));
  };

  createStamps();

  let dragging = null;
  document.addEventListener('dragstart', e => {
    if(e.target.classList.contains('stamp') && e.target.draggable){
      dragging = e.target;
    }
  });
  document.addEventListener('dragend', () => { dragging = null; });

  mapArea.addEventListener('dragover', e => e.preventDefault());
  mapArea.addEventListener('drop', e => {
    e.preventDefault();
    if(!dragging) return;
    const stampId = parseInt(dragging.dataset.id, 10);
    const mapRect = mapArea.getBoundingClientRect();
    const dropX = e.clientX;
    const dropY = e.clientY;
    const stampCenterX = dropX;
    const stampCenterY = dropY;
    let matched = false;

    for(let i = 0; i < redBoxes.length; i++){
      const box = redBoxes[i];
      if(box.matched) continue;
      const boxLeft = mapRect.left + (box.left / 100) * mapRect.width - 40;
      const boxTop = mapRect.top + (box.top / 100) * mapRect.height - 40;
      const boxRight = boxLeft + 80;
      const boxBottom = boxTop + 80;
      const inside = (stampCenterX >= boxLeft && stampCenterX <= boxRight && stampCenterY >= boxTop && stampCenterY <= boxBottom);

      if(inside){
        if(answerKey[i+1] === stampId){
          box.matched = true;
          matched = true;
          correctCount++;
          const pxLeft = (box.left / 100) * mapArea.clientWidth - 40;
          const pxTop = (box.top / 100) * mapArea.clientHeight - 40;
          dragging.style.position = 'absolute';
          dragging.style.width = '80px';
          dragging.style.height = '80px';
          dragging.style.left = pxLeft + 'px';
          dragging.style.top = pxTop + 'px';
          dragging.style.cursor = 'default';
          dragging.draggable = false;
          dragging.style.pointerEvents = 'none';
          mapArea.appendChild(dragging);
          new Audio(`/iuhi/game4_assets/stamp${stampId}.mp3`).play();
        }
        break;
      }
    }

    if(!matched){
      new Audio('/iuhi/game4_assets/wrong1.mp3').play();
    }

    if(correctCount === 8){
      setTimeout(() => {
        new Audio('/iuhi/game4_assets/victory1.mp3').play();
        victoryText.style.transform = 'translate(-50%,-50%) scale(1)';
        setTimeout(() => {
          victoryText.style.transform = 'translate(-50%,-50%) scale(0)';
        }, 4000);
      }, 1500);
    }
  });

  let isCalibrating = false;
  let calibrationBoxes = [];
  function toggleCalibration() {
    isCalibrating = !isCalibrating;
    const toolButtons = document.querySelectorAll('.tool-button');
    const allStamps = document.querySelectorAll('.stamp');

    if (isCalibrating) {
        toolButtons.forEach(btn => btn.disabled = true);
        alert('對位校正模式已開啟。\n地圖上會出現 8 個紅色方框，請拖曳它們到正確的位置。');
        
        // 隱藏郵票，以免干擾拖曳
        allStamps.forEach(stamp => stamp.style.visibility = 'hidden');

        // 建立 8 個可拖曳的校正方框
        calibrationBoxes = coords.map((point, index) => {
            const box = document.createElement('div');
            box.className = 'calibration-box';
            box.dataset.index = index;
            box.style.left = `${point.x}%`;
            box.style.top = `${point.y}%`;
            box.style.display = 'block';
            
            const number = document.createElement('div');
            number.className = 'calibration-box-number';
            number.innerText = '#' + (index + 1);
            box.appendChild(number);

            mapArea.appendChild(box);
            return box;
        });

        setupCalibrationDrag();
    } else {
        toolButtons.forEach(btn => btn.disabled = false);
        calibrationBoxes.forEach(box => box.remove());
        calibrationBoxes = [];
        allStamps.forEach(stamp => stamp.style.visibility = 'visible');
        alert('對位校正模式已關閉。');
    }
  }

  function setupCalibrationDrag() {
    calibrationBoxes.forEach(box => {
      let isDragging = false;
      let offsetX, offsetY;
      
      box.addEventListener('mousedown', e => {
        isDragging = true;
        offsetX = e.clientX - box.getBoundingClientRect().left;
        offsetY = e.clientY - box.getBoundingClientRect().top;
        box.style.cursor = 'grabbing';
      });

      document.addEventListener('mousemove', e => {
        if (!isDragging) return;
        const mapRect = mapArea.getBoundingClientRect();
        let newX = e.clientX - mapRect.left - offsetX;
        let newY = e.clientY - mapRect.top - offsetY;

        // 邊界限制
        newX = Math.max(0, Math.min(newX, mapRect.width - box.offsetWidth));
        newY = Math.max(0, Math.min(newY, mapRect.height - box.offsetHeight));

        box.style.left = `${(newX / mapRect.width) * 100}%`;
        box.style.top = `${(newY / mapRect.height) * 100}%`;
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
        box.style.cursor = 'grab';
      });
    });
  }

  function exportCoords() {
    if(!isCalibrating || calibrationBoxes.length === 0){
        alert('請先開啟「對位校正」模式，並拖曳方框來設定座標！');
        return;
    }
    const mapRect = mapArea.getBoundingClientRect();
    const newCoords = calibrationBoxes.map(box => {
        const boxRect = box.getBoundingClientRect();
        const x = ((boxRect.left - mapRect.left) / mapRect.width) * 100;
        const y = ((boxRect.top - mapRect.top) / mapRect.height) * 100;
        return { x: parseFloat(x.toFixed(4)), y: parseFloat(y.toFixed(4)) };
    });

    const coordsStr = JSON.stringify(newCoords, null, 2)
      .replace(/"x":/g, 'x:')
      .replace(/"y":/g, 'y:')
      .replace(/"/g, '');
      
    navigator.clipboard.writeText(`const coords = ${coordsStr};`)
      .then(() => alert('新座標已成功複製到剪貼簿。'))
      .catch(err => alert('複製失敗，請手動複製。\n' + err));
  }
</script>
</body>
</html>
