<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>郵票配對遊戲 - 校正工具</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f9f9f9;
    }
    #map-container {
      position: relative;
      width: 80%;
      margin: 0 auto;
      border: 2px solid #333;
      background: #fff;
    }
    #map {
      width: 100%;
      display: block;
    }
    .calibration-box {
      position: absolute;
      width: 50px;
      height: 50px;
      border: 2px dashed red;
      cursor: move;
    }
    #controls {
      margin: 20px 0;
      text-align: center;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #4CAF50;
      color: #fff;
    }
    button:hover {
      background: #45a049;
    }
    #coords-output {
      margin-top: 20px;
      padding: 10px;
      background: #eee;
      white-space: pre-wrap;
      border-radius: 8px;
      font-family: monospace;
      display: none;
    }
  </style>
</head>
<body>

  <h2 style="text-align:center;">郵票配對遊戲 - 校正工具</h2>
  
  <div id="map-container">
    <img id="map" src="north_map.png" alt="地圖">
  </div>

  <div id="controls">
    <button onclick="toggleCalibration()">🔧 開啟 / 關閉 校正模式</button>
    <button onclick="exportCoords()">📤 匯出座標</button>
    <button onclick="copyCoords()">📋 複製座標</button>
  </div>

  <div id="coords-output"></div>

  <script>
    const mapContainer = document.getElementById('map-container');
    const coordsOutput = document.getElementById('coords-output');
    let isCalibrating = false;

    // 開關校正模式
    function toggleCalibration() {
      isCalibrating = !isCalibrating;
      if (isCalibrating) {
        alert('校正模式已開啟，點擊地圖可新增拖曳方框');
        mapContainer.addEventListener('click', addCalibrationBox);
      } else {
        alert('校正模式已關閉');
        mapContainer.removeEventListener('click', addCalibrationBox);
      }
    }

    // 新增紅色方框
    function addCalibrationBox(e) {
      if (e.target.id === 'map') {
        const box = document.createElement('div');
        box.className = 'calibration-box';
        box.style.left = `${(e.offsetX / mapContainer.clientWidth) * 100}%`;
        box.style.top = `${(e.offsetY / mapContainer.clientHeight) * 100}%`;

        // 拖曳功能
        box.onmousedown = function(event) {
          event.preventDefault();
          const shiftX = event.clientX - box.getBoundingClientRect().left;
          const shiftY = event.clientY - box.getBoundingClientRect().top;

          function moveAt(pageX, pageY) {
            const relX = (pageX - mapContainer.getBoundingClientRect().left - shiftX) / mapContainer.clientWidth * 100;
            const relY = (pageY - mapContainer.getBoundingClientRect().top - shiftY) / mapContainer.clientHeight * 100;
            box.style.left = `${Math.max(0, Math.min(100, relX))}%`;
            box.style.top = `${Math.max(0, Math.min(100, relY))}%`;
          }

          function onMouseMove(e) {
            moveAt(e.pageX, e.pageY);
          }

          document.addEventListener('mousemove', onMouseMove);
          document.onmouseup = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.onmouseup = null;
          };
        };
        box.ondragstart = () => false;
        mapContainer.appendChild(box);
      }
    }

    // 匯出座標（自動複製）
    function exportCoords() {
      if (!isCalibrating) {
        alert('請先開啟校正模式，才能匯出座標！');
        return;
      }
      const calibrationBoxes = document.querySelectorAll('.calibration-box');
      if (calibrationBoxes.length === 0) {
        alert('請先新增至少一個方框！');
        return;
      }
      const newCoords = Array.from(calibrationBoxes).map(box => {
        const x = parseFloat(box.style.left) || 0;
        const y = parseFloat(box.style.top) || 0;
        return { x, y };
      });
      const coordsStr = `const coords = ${JSON.stringify(newCoords, null, 2)};`;
      coordsOutput.innerText = coordsStr;
      coordsOutput.style.display = 'block';
      // 自動複製
      navigator.clipboard.writeText(coordsStr).then(() => {
        alert('座標已匯出並自動複製到剪貼簿！');
      }).catch(err => {
        console.error(err);
        alert('自動複製失敗，請用下方的「複製座標」按鈕手動複製');
      });
      window.scrollTo(0, document.body.scrollHeight);
    }

    // 手動複製
    function copyCoords() {
      if (coordsOutput.innerText.trim() === '') {
        alert('目前沒有座標可以複製！');
        return;
      }
      navigator.clipboard.writeText(coordsOutput.innerText).then(() => {
        alert('座標已複製！');
      }).catch(err => {
        console.error(err);
        alert('手動複製失敗，請手動選取文字複製');
      });
    }
  </script>
</body>
</html>
