<script>
  const left = document.getElementById('left-stamps');
  const right = document.getElementById('right-stamps');
  const mapArea = document.getElementById('map-area');
  const mapImg = document.getElementById('map');
  const victoryText = document.getElementById('victory-text');
  const coordsOutput = document.getElementById('coords-output');

  // æ‚¨åŒ¯å‡ºåº§æ¨™å¾Œè«‹è²¼åˆ°æ­¤è™•
  const coords = [];
  
  // éƒµç¥¨IDèˆ‡ç¸£å¸‚ä½ç½®çš„æ­£ç¢ºç­”æ¡ˆå°æ‡‰
  const answerKey = {
    1: 15, 2: 17, 3: 19, 4: 16,
    5: 13, 6: 20, 7: 14, 8: 18
  };

  let correctCount = 0;
  let redBoxes = [];
  let isCalibrating = false;

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function createStamps() {
    left.innerHTML = '';
    right.innerHTML = '';
    
    const allStampIds = Array.from({ length: 8 }, (_, i) => i + 13);
    const shuffledIds = shuffle(allStampIds);

    for (let i = 0; i < 8; i++) {
      const stampWrapper = document.createElement('div');
      stampWrapper.className = 'stamp-wrapper';

      const img = document.createElement('img');
      img.className = 'stamp';
      img.draggable = true;
      img.dataset.id = shuffledIds[i];
      img.src = `https://tsong-su.github.io/iuhi/game4_assets/stamp${shuffledIds[i]}.jpg`;

      const stampNumber = document.createElement('div');
      stampNumber.className = 'stamp-number';
      stampNumber.innerText = `#${i + 1}`;

      stampWrapper.appendChild(img);
      stampWrapper.appendChild(stampNumber);

      if (i < 4) {
        left.appendChild(stampWrapper);
      } else {
        right.appendChild(stampWrapper);
      }
    }
  }

  mapImg.onload = () => {
    redBoxes = coords.map((pt, index) => ({
      left: pt.x,
      top: pt.y,
      matched: false
    }));
  };

  createStamps();

  let dragging = null;
  document.addEventListener('dragstart', e => {
    if(!isCalibrating && e.target.classList.contains('stamp') && e.target.draggable){
      dragging = e.target;
    }
  });
  document.addEventListener('dragend', () => { dragging = null; });

  mapArea.addEventListener('dragover', e => e.preventDefault());
  mapArea.addEventListener('drop', e => {
    e.preventDefault();
    if(!dragging) return;
    const stampId = parseInt(dragging.dataset.id, 10);
    const mapRect = mapArea.getBoundingClientRect();
    const dropX = e.clientX;
    const dropY = e.clientY;
    const stampCenterX = dropX;
    const stampCenterY = dropY;
    let matched = false;

    for(let i = 0; i < redBoxes.length; i++){
      const box = redBoxes[i];
      if(box.matched) continue;
      const boxLeft = mapRect.left + (box.left / 100) * mapRect.width - 40;
      const boxTop = mapRect.top + (box.top / 100) * mapRect.height - 40;
      const boxRight = boxLeft + 80;
      const boxBottom = boxTop + 80;
      const inside = (stampCenterX >= boxLeft && stampCenterX <= boxRight && stampCenterY >= boxTop && stampCenterY <= boxBottom);

      if(inside){
        const correspondingStampId = answerKey[i+1];
        if(correspondingStampId === stampId){
          box.matched = true;
          matched = true;
          correctCount++;
          const pxLeft = (box.left / 100) * mapArea.clientWidth - 40;
          const pxTop = (box.top / 100) * mapArea.clientHeight - 40;
          dragging.style.position = 'absolute';
          dragging.style.width = '80px';
          dragging.style.height = '80px';
          dragging.style.left = pxLeft + 'px';
          dragging.style.top = pxTop + 'px';
          dragging.style.cursor = 'default';
          dragging.draggable = false;
          dragging.style.pointerEvents = 'none';
          mapArea.appendChild(dragging);
          new Audio(`https://tsong-su.github.io/iuhi/game4_assets/stamp${stampId}.mp3`).play();
        }
        break;
      }
    }

    if(!matched){
      new Audio('https://tsong-su.github.io/iuhi/game4_assets/wrong1.mp3').play();
    }

    if(correctCount === 8){
      setTimeout(() => {
        new Audio('https://tsong-su.github.io/iuhi/game4_assets/victory1.mp3').play();
        victoryText.style.transform = 'translate(-50%,-50%) scale(1)';
        setTimeout(() => {
          victoryText.style.transform = 'translate(-50%,-50%) scale(0)';
        }, 4000);
      }, 1500);
    }
  });

  function toggleCalibration() {
    isCalibrating = !isCalibrating;
    const toolButtons = document.querySelectorAll('.tool-button');
    const allStamps = document.querySelectorAll('.stamp');

    if (isCalibrating) {
      toolButtons.forEach(btn => btn.disabled = true);
      alert('å°ä½æ ¡æ­£æ¨¡å¼å·²é–‹å•Ÿã€‚\nåœ°åœ–ä¸Šæœƒå‡ºç¾ 8 å€‹ç´…è‰²æ–¹æ¡†ï¼Œè«‹æ‹–æ›³å®ƒå€‘åˆ°æ­£ç¢ºçš„ä½ç½®ã€‚');

      if (document.querySelectorAll('.calibration-box').length === 0) {
        const initialCoords = [
          { x: 30, y: 10 }, { x: 70, y: 10 },
          { x: 10, y: 30 }, { x: 90, y: 30 },
          { x: 20, y: 50 }, { x: 80, y: 50 },
          { x: 40, y: 70 }, { x: 60, y: 70 }
        ];
        
        for (let i = 0; i < 8; i++) {
          const box = document.createElement('div');
          box.className = 'calibration-box';
          box.dataset.index = i;
          
          const number = document.createElement('div');
          number.className = 'calibration-box-number';
          number.innerText = `#${i + 1}`;
          box.appendChild(number);
          
          box.style.left = `${coords[i] ? coords[i].x : initialCoords[i].x}%`;
          box.style.top = `${coords[i] ? coords[i].y : initialCoords[i].y}%`;

          mapArea.appendChild(box);
          setupCalibrationDrag(box);
        }
      }
      
      allStamps.forEach(stamp => {
        stamp.draggable = false;
        stamp.style.cursor = 'default';
      });

      document.querySelectorAll('.calibration-box').forEach(box => box.style.display = 'block');

    } else {
      toolButtons.forEach(btn => btn.disabled = false);
      allStamps.forEach(stamp => {
        stamp.draggable = true;
        stamp.style.cursor = 'grab';
      });
      document.querySelectorAll('.calibration-box').forEach(box => box.style.display = 'none');
      alert('å°ä½æ ¡æ­£æ¨¡å¼å·²é—œé–‰ã€‚');
    }
  }

  function setupCalibrationDrag(box) {
    let isDragging = false;
    let offsetX, offsetY;
    
    box.addEventListener('mousedown', e => {
      isDragging = true;
      offsetX = e.clientX - box.getBoundingClientRect().left;
      offsetY = e.clientY - box.getBoundingClientRect().top;
      box.style.cursor = 'grabbing';
    });

    document.addEventListener('mousemove', e => {
      if (!isDragging) return;
      const mapRect = mapArea.getBoundingClientRect();
      let newX = e.clientX - mapRect.left - offsetX;
      let newY = e.clientY - mapRect.top - offsetY;

      newX = Math.max(0, Math.min(newX, mapRect.width - box.offsetWidth));
      newY = Math.max(0, Math.min(newY, mapRect.height - box.offsetHeight));

      box.style.left = `${(newX / mapRect.width) * 100}%`;
      box.style.top = `${(newY / mapRect.height) * 100}%`;
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
      box.style.cursor = 'grab';
    });
  }

  // âœ… åŒ¯å‡ºåº§æ¨™ï¼šè‡ªå‹•è¤‡è£½ + æ‰‹å‹•è¤‡è£½æŒ‰éˆ•
  function exportCoords() {
    if(!isCalibrating){
      alert('è«‹å…ˆé–‹å•Ÿã€Œå°ä½æ ¡æ­£ã€æ¨¡å¼ï¼Œæ‰èƒ½åŒ¯å‡ºåº§æ¨™ï¼');
      return;
    }
    
    const calibrationBoxes = document.querySelectorAll('.calibration-box');
    if(calibrationBoxes.length === 0){
      alert('è«‹å…ˆæ‹–æ›³æ–¹æ¡†ä¾†è¨­å®šåº§æ¨™ï¼');
      return;
    }

    const newCoords = Array.from(calibrationBoxes).map(box => {
      const x = parseFloat(box.style.left) || 0;
      const y = parseFloat(box.style.top) || 0;
      return { x, y };
    });

    const coordsStr = `const coords = ${JSON.stringify(newCoords, null, 2)};`;
    
    coordsOutput.innerText = coordsStr;
    coordsOutput.style.display = 'block';

    // ğŸ”¥ è‡ªå‹•è¤‡è£½åˆ°å‰ªè²¼ç°¿
    navigator.clipboard.writeText(coordsStr).then(() => {
      alert('åº§æ¨™å·²åŒ¯å‡ºä¸¦è‡ªå‹•è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\næ‚¨ä¹Ÿå¯ä»¥åœ¨é é¢ä¸‹æ–¹çœ‹åˆ°çµæœã€‚');
    }).catch(err => {
      alert('åº§æ¨™å·²é¡¯ç¤ºåœ¨é é¢ä¸‹æ–¹ï¼Œä½†è‡ªå‹•è¤‡è£½å¤±æ•—ï¼Œè«‹ç”¨ä¸‹æ–¹ã€ŒğŸ“‹ è¤‡è£½åº§æ¨™ã€æŒ‰éˆ•ã€‚');
      console.error(err);
    });

    // å¦‚æœé‚„æ²’æœ‰æ‰‹å‹•è¤‡è£½æŒ‰éˆ•ï¼Œå»ºç«‹ä¸€å€‹
    if(!document.getElementById('copy-btn')){
      const copyBtn = document.createElement('button');
      copyBtn.id = 'copy-btn';
      copyBtn.innerText = 'ğŸ“‹ è¤‡è£½åº§æ¨™';
      copyBtn.style.marginTop = '10px';
      copyBtn.style.padding = '6px 12px';
      copyBtn.style.borderRadius = '6px';
      copyBtn.style.cursor = 'pointer';
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(coordsStr).then(() => {
          alert('åº§æ¨™å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        });
      };
      coordsOutput.insertAdjacentElement('afterend', copyBtn);
    }

    window.scrollTo(0, document.body.scrollHeight);
  }
</script>
