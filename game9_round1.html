<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>果子圖片 & 台語果子名配對 - 第1回</title>
  <style>
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; padding:0; background:#fffbe6; font-family: "Noto Sans", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    header { text-align:center; padding:10px 12px 6px; color:#cc5500; font-size:1.25rem; font-weight:600; }
    /* 內容區：留出底部按鈕高度（避免被遮住） */
    main { padding:8px; padding-bottom:86px; max-width:1100px; margin:0 auto; }

    /* grid：手機 3 欄、≥600px 為 4 欄 */
    #game {
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
      width:100%;
    }
    @media (min-width:600px) {
      #game { grid-template-columns: repeat(4, 1fr); }
    }

    /* 卡片 */
    .card {
      background:#fff;
      border:1.6px solid #d6d6d6;
      border-radius:10px;
      height:110px;               /* 固定高度，讓文字能垂直置中 */
      display:flex;
      align-items:center;         /* 垂直置中 */
      justify-content:center;     /* 讓文字水平置中 */
      padding:8px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, border-color .12s ease, opacity .12s ease;
    }
    .card:active { transform: scale(0.98); }

    /* 圖片卡內樣式 */
    .card.img-card img {
      max-width:72px;
      max-height:72px;
      width:auto;
      height:auto;
      display:block;
      border-radius:6px;
    }

    /* 文字卡內樣式 */
    .card.text-card {
      font-size:1.08rem;         /* 文字稍大，置中呈現 */
      line-height:1.1;
      padding-left:10px;
      padding-right:10px;
      word-break:break-word;
    }

    /* 選取樣式 */
    .card.selected { border-color:#007bff; box-shadow:0 2px 6px rgba(0,123,255,0.12); }

    /* 成功配對 */
    .card.matched {
      opacity:0.45;
      pointer-events:none;
      border-color:#28a745;
      transform: none;
    }

    /* 錯誤短暫提示（套用後會在 JS 用 setTimeout 移除）*/
    .card.wrong {
      border-color:#e63946 !important;
      box-shadow:0 0 0 3px rgba(230,57,70,0.08);
    }

    /* 勝利文字 */
    #message {
      display:none;
      text-align:center;
      margin-top:12px;
      font-size:1.9rem;
      color:#1b8a3e;
      font-weight:700;
      animation: pop 700ms ease forwards;
    }
    @keyframes pop { from { transform: scale(.6); opacity:0 } to { transform:scale(1); opacity:1 } }

    /* 固定底部按鈕列 */
    #bottomBar {
      position:fixed;
      left:0; right:0; bottom:0;
      background:#fff8dc;
      border-top:1px solid #e0d7c0;
      padding:10px 8px;
      display:flex;
      justify-content:space-around;
      gap:10px;
      z-index:1200;
    }
    #bottomBar button {
      flex:1;
      min-width:80px;
      max-width:220px;
      background:#ffb347;
      color:#fff;
      border:none;
      padding:10px 12px;
      border-radius:8px;
      font-size:1rem;
      cursor:pointer;
    }
    #bottomBar button.secondary { background:#7a7a7a; }
  </style>
</head>
<body>
  <header>果子圖片 & 台語果子名配對 — 第1回（8題）</header>

  <main>
    <div id="game" aria-live="polite"></div>
    <div id="message">有夠 gâu！🎉</div>
  </main>

  <div id="bottomBar">
    <button id="restartBtn">🔄 再玩一次</button>
    <button id="nextBtn">⏭ 下一回</button>
    <button id="homeBtn" class="secondary">⬅ 回首頁</button>
  </div>

  <audio id="wrongSound" src="game9_assets/wrong1.mp3" preload="auto"></audio>
  <audio id="victorySound" src="game9_assets/victory2.mp3" preload="auto"></audio>

  <script>
    // --- 設定 ---
    const JSON_PATH = 'game9_assets/fruits_part1.json'; // 由此讀取
    const ROUND_COUNT = 8; // 第1回取前8筆

    const gameDiv = document.getElementById('game');
    const messageDiv = document.getElementById('message');
    const wrongSound = document.getElementById('wrongSound');
    const victorySound = document.getElementById('victorySound');

    const restartBtn = document.getElementById('restartBtn');
    const nextBtn = document.getElementById('nextBtn');
    const homeBtn = document.getElementById('homeBtn');

    let fruits = [];      // 會放前 8 筆物件
    let cards = [];       // 將包含 16 張卡（8 圖 + 8 文）
    let selected = [];    // 暫存被選的兩張
    let matchedPairs = 0;

    // 重新開始
    restartBtn.addEventListener('click', () => {
      init(); // 重新載入卡牌（會打亂顯示）
    });
    nextBtn.addEventListener('click', () => {
      // 如果尚未製作第二回，先跳轉佔位頁（你可改為 game9_round2.html）
      location.href = 'game9_round2.html';
    });
    homeBtn.addEventListener('click', () => location.href = 'index.html');

    // 載入 JSON（從 repo 的 game9_assets）
    fetch(JSON_PATH)
      .then(r => r.ok ? r.json() : Promise.reject('JSON 讀取失敗'))
      .then(all => {
        // 確保是陣列
        if (!Array.isArray(all)) {
          console.error('fruits_part1.json 不是陣列！', all);
          return;
        }
        // 取前 ROUND_COUNT 筆（如果不足會取到末尾）
        fruits = all.slice(0, ROUND_COUNT);
        init();
      })
      .catch(err => {
        console.error('讀取 fruits_part1.json 錯誤：', err);
        // fallback: 可以在這裡提示使用者，或內建簡單假資料
        alert('無法讀取水果資料 (fruits_part1.json)。請確認檔案在 game9_assets/ 裡。');
      });

    function init() {
      // 重設
      gameDiv.innerHTML = '';
      messageDiv.style.display = 'none';
      selected = [];
      matchedPairs = 0;
      cards = [];

      // 建立卡牌資料（每個 fruit 產生一張圖卡與一張文字卡）
      fruits.forEach(f => {
        // 圖片卡（會用 id 對應 game9_assets/{id}.png）
        cards.push({
          id: f.id,
          type: 'img',
          data: f
        });
        // 文字卡（顯示 taiwanese）
        cards.push({
          id: f.id,
          type: 'text',
          data: f
        });
      });

      // 打亂顯示順序
      shuffle(cards);

      // 產生 DOM 卡片
      cards.forEach((cardObj, idx) => {
        const el = document.createElement('div');
        el.className = 'card ' + (cardObj.type === 'img' ? 'img-card' : 'text-card');
        el.dataset.id = cardObj.id;
        el.dataset.type = cardObj.type;
        el.setAttribute('role','button');
        el.setAttribute('tabindex','0');

        if (cardObj.type === 'img') {
          const img = document.createElement('img');
          // 圖片檔名以 json 的 id 欄位為準，例如 id = "fruit1" -> game9_assets/fruit1.png
          img.src = `game9_assets/${cardObj.id}.png`;
          img.alt = cardObj.data.chinese || cardObj.data.taiwanese || cardObj.id;
          // 若圖片載入失敗，不會中斷遊戲
          img.onerror = () => { img.style.opacity = 0.5; img.alt = '圖片無法載入'; };
          el.appendChild(img);
        } else {
          const span = document.createElement('span');
          span.textContent = cardObj.data.taiwanese || cardObj.data.chinese || cardObj.id;
          el.appendChild(span);
        }

        // 點擊 / 鍵盤操作都可
        el.addEventListener('click', () => onSelect(el, cardObj));
        el.addEventListener('keydown', ev => {
          if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); onSelect(el, cardObj); }
        });

        gameDiv.appendChild(el);
      });
    }

    function onSelect(el, cardObj) {
      // 已配對或已選兩張時忽略
      if (el.classList.contains('matched') || selected.length === 2) return;

      // 若已選取同一張就取消選
      if (el.classList.contains('selected')) {
        el.classList.remove('selected');
        selected = selected.filter(s => s.el !== el);
        return;
      }

      // 選取
      el.classList.add('selected');
      selected.push({ el, card: cardObj });

      // 若選到兩張就判斷
      if (selected.length === 2) {
        const [a,b] = selected;
        // 不允許同類型配對（兩張都是圖或兩張都是字視為錯誤）
        if (a.card.id === b.card.id && a.card.type !== b.card.type) {
          // 成功
          a.el.classList.add('matched');
          b.el.classList.add('matched');
          // 移除 selected 樣式
          a.el.classList.remove('selected');
          b.el.classList.remove('selected');
          // 播放該水果的台語發音（使用 json 中的 audio）
          const audioSrc = a.card.data.audio || b.card.data.audio;
          if (audioSrc) {
            try { new Audio(audioSrc).play(); } catch(e){ console.warn('播放語音錯誤', e); }
          }
          matchedPairs += 1;
          // 若全部配完
          if (matchedPairs === fruits.length) {
            // 顯示勝利、播音樂
            messageDiv.style.display = 'block';
            try { victorySound.currentTime = 0; victorySound.play(); } catch(e){ }
          }
        } else {
          // 失敗：播錯誤音 + 紅框提示
          try { wrongSound.currentTime = 0; wrongSound.play(); } catch(e){ }
          a.el.classList.add('wrong');
          b.el.classList.add('wrong');
          // 0.7s 後回復樣式
          setTimeout(() => {
            a.el.classList.remove('wrong');
            b.el.classList.remove('wrong');
            a.el.classList.remove('selected');
            b.el.classList.remove('selected');
          }, 700);
        }
        // 清空選擇暫存
        selected = [];
      }
    }

    function shuffle(arr) {
      // Fisher-Yates
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
  </script>
</body>
</html>
