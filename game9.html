<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è¯å°æ°´æœèªè©é…å°</title>
<style>
  :root{
    --header-h:14vh;
    --footer-h:11vh;
    --grid-h: calc((100vh - var(--header-h) - var(--footer-h) - 22px) / 2);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:"Microsoft JhengHei", "Noto Sans TC", sans-serif;
    background: linear-gradient(180deg,#fffaf0 0%, #fff3df 100%);
    color:#222;
    min-height:100vh; display:flex; flex-direction:column; align-items:center;
  }

  header{
    height:var(--header-h);
    width:100%;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    padding:8px 12px; text-align:center;
  }

  .title-row{
    display:flex; align-items:center; gap:10px;
    font-size:clamp(18px,4.2vw,28px);
    font-weight:800;
    color:#ff6f00; /* äº®éº—è‰²ç³» */
  }
  .title-row img{ width:44px; height:44px; object-fit:contain; }

  .subtitle{
    margin-top:6px;
    font-size:clamp(12px,2.2vw,16px);
    color:#1565c0; /* ä¸æ˜¯é»‘è‰²ï¼Œå®¹æ˜“è¾¨è­˜ */
  }
  .view-hint{
    margin-top:4px;
    font-size:clamp(14px,3vw,18px);
    color:#d81b60;
    font-weight:800;
  }

  main{ width:100%; display:flex; flex-direction:column; align-items:center; gap:8px; padding:6px 0; }

  .grid-area{
    width:100%;
    max-width:720px;
    height:var(--grid-h);
    display:grid;
    grid-template-columns:repeat(4,1fr);
    grid-template-rows:repeat(4,1fr);
    gap:8px;
    padding: 0 4%;
  }

  .cell{
    border-radius:14px;
    border:2px solid rgba(0,0,0,0.12);
    display:flex; align-items:center; justify-content:center;
    padding:6px;
    text-align:center;
    cursor:pointer;
    transition: transform .12s ease, box-shadow .12s ease;
    user-select:none;
    overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
    font-weight:700;
    font-size: clamp(14px, 2.6vw, 20px);
    min-height: 44px;
  }
  .cell:active{ transform: translateY(2px); }

  /* initial zone colors to distinguish top/bottom */
  #grid-cn .cell{ background: #e3f2fd; color:#0b2340; }
  #grid-tw .cell{ background: #fff0f6; color:#2b1f2f; }

  .cell.selected{ outline:4px solid rgba(33,150,243,0.85); outline-offset:-6px; }
  .cell.matched{ pointer-events:none; color:#fff; }

  footer{
    height:var(--footer-h);
    width:100%;
    display:flex; align-items:center; justify-content:center; gap:12px; padding:8px;
  }

  button.btn {
    padding:10px 14px; border-radius:10px; border:none; font-weight:800; font-size:clamp(13px,2.2vw,16px);
    cursor:pointer; color:#fff;
  }
  /* order & colors per your spec/order */
  #btn-restart{ background:#ffb74d } /* é–£è€ä¸€æ“º */
  #btn-next{ background:#4fc3f7 }    /* å¾Œä¸€å› */
  #btn-home{ background:#81c784 }    /* è½‰å»éŠæˆ²é ­é  */

  /* victory text */
  #victory {
    position: fixed; left:50%; top:44%; transform:translate(-50%,-50%) scale(.2);
    font-size: clamp(28px,6vw,48px); color:#e91e63; font-weight:900; opacity:0;
    transition: all .45s cubic-bezier(.2,.9,.2,1);
    pointer-events:none;
  }
  #victory.show { transform:translate(-50%,-50%) scale(1.2); opacity:1; }

  @media (min-width:900px){
    :root{ --header-h:12vh; --footer_h:10vh; }
  }
</style>
</head>
<body>
  <header>
    <div class="title-row">
      <img id="leftImg" src="game9_assets/fruit_left.png" alt="left fruit">
      <div id="titleText">è¯å°æ°´æœèªè©é…å° - ç¬¬1å›</div>
      <img id="rightImg" src="game9_assets/fruit_right.png" alt="right fruit">
    </div>
    <div class="subtitle" id="subtitle">tshiÌh è¯æ–‡æŠ‘æ˜¯å°èªæ”æœƒä½¿ï¼Œé…å°æˆåŠŸæœƒæœ‰å°èªè²éŸ³æª”å–”ï¼</div>
    <div class="view-hint">ğŸ“± å»ºè­°ç›´å¼è§€çœ‹æ•ˆæœæœ€ä½³</div>
  </header>

  <main>
    <!-- top: ä¸­æ–‡ -->
    <div id="grid-cn" class="grid-area" aria-label="è¯èªæ ¼å­"></div>
    <!-- bottom: å°èª -->
    <div id="grid-tw" class="grid-area" aria-label="å°èªæ ¼å­"></div>
    <div id="victory">æœ‰å¤  gÃ¢uï¼</div>
  </main>

  <footer>
    <button id="btn-restart" class="btn">é–£è€ä¸€æ“º</button>
    <button id="btn-next" class="btn">å¾Œä¸€å›</button>
    <button id="btn-home" class="btn">è½‰å»éŠæˆ²é ­é </button>
  </footer>

  <!-- sounds -->
  <audio id="wrongAudio" src="game9_assets/wrong.mp3" preload="auto"></audio>
  <audio id="victoryAudio" src="game9_assets/victory.mp3" preload="auto"></audio>

<script>
/* Robust game9.html
 - toggles rounds 1 & 2 (starts at 1)
 - loads fruits_part{round}.json (array or {fruits:[]})
 - filters out id 15 for round1 and id 32 for round2 (also filters by name content as double-check)
 - displays top 4x4 chinese, bottom 4x4 taiwanese (both 16)
 - on match: both get pair color (16 vivid colors), play pair audio (if any)
 - final match: play pair audio (once) -> wait 1s -> play victory audio and show "æœ‰å¤  gÃ¢u" animation
 - on mismatch: play wrongAudio
 - click shows outline; matched cells are disabled
*/

const ROUND_FILES = {1:'game9_assets/fruits_part1.json', 2:'game9_assets/fruits_part2.json'};
const EXCLUDE_ID = {1:15, 2:32};
const COLOR_PALETTE = [
  "#FF5733","#FF8D1A","#FFC300","#DAF7A6",
  "#33FF57","#1AFF8D","#33FFF6","#3380FF",
  "#8D33FF","#FF33F6","#FF3380","#FF6666",
  "#66FF66","#66FFFF","#6666FF","#FFCC00"
];

const gridCn = document.getElementById('grid-cn');
const gridTw = document.getElementById('grid-tw');
const leftImg = document.getElementById('leftImg');
const rightImg = document.getElementById('rightImg');
const titleText = document.getElementById('titleText');
const victoryEl = document.getElementById('victory');
const wrongAudio = document.getElementById('wrongAudio');
const victoryAudio = document.getElementById('victoryAudio');

let round = 1;            // current round (1 or 2)
let pairs = [];           // array of {id, chinese, taiwanese, audio, color}
let selected = null;      // {el, id, type}
let matchedCount = 0;
let playingFinalFlow = false;

// randomize header images (4 variants)
(function pickHeaderImgs(){
  const leftOpts = ['fruit_left.png','fruit_left1.png'];
  const rightOpts = ['fruit_right.png','fruit_right1.png'];
  leftImg.src = 'game9_assets/' + leftOpts[Math.floor(Math.random()*leftOpts.length)];
  rightImg.src = 'game9_assets/' + rightOpts[Math.floor(Math.random()*rightOpts.length)];
})();

// utility: robustly extract array from JSON
function extractArray(json){
  if(Array.isArray(json)) return json;
  if(json.fruits && Array.isArray(json.fruits)) return json.fruits;
  if(json.items && Array.isArray(json.items)) return json.items;
  if(json.data && Array.isArray(json.data)) return json.data;
  // fallback: gather values that are arrays
  for(const k in json) if(Array.isArray(json[k])) return json[k];
  return []; // empty fallback
}

// utility: robust field getter
function pickFirst(obj, keys){
  for(const k of keys){
    if(obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== '') return String(obj[k]).trim();
  }
  return null;
}

function parsePairEntry(entry, idx){
  // find id
  const id = entry.id ?? entry.ID ?? entry.index ?? (idx+1);
  // chinese: try multiple keys or split name by '/'
  let chinese = pickFirst(entry, ['chinese','zh','name','title','text','Chinese','cn']);
  let taiwanese = pickFirst(entry, ['taiwanese','tai','tw','taiwaneseName','taiwanese_name','Taiwanese','tw_name']);
  if(!chinese && chinese !== "") chinese = null;
  if(!taiwanese && taiwanese !== "") taiwanese = null;

  // if only name exists and contains a slash like "æå­/æä»”", split it
  if(!taiwanese && chinese && chinese.includes('/')){
    const parts = chinese.split('/').map(s=>s.trim());
    if(parts.length >= 2){
      const c = parts[0]; const t = parts[1];
      chinese = c; taiwanese = t;
    }
  }
  // alternatively if name like "è¥¿ç“œ (å°èª: ...)" not handled; user JSON should be normal
  // last fallback names
  if(!chinese) chinese = `æ°´æœ${idx+1}`;
  if(!taiwanese) taiwanese = `å°èª${idx+1}`;

  // audio detection
  let audio = pickFirst(entry, ['audio','Audio','audioSrc','sound','audioPath']);
  if(audio){
    // if relative path not starting with http or /, try to keep as-is
    audio = String(audio);
  } else {
    audio = null;
  }

  return { id, chinese, taiwanese, audio };
}

// load round data (1 or 2)
async function loadRound(r){
  round = (r===1?1:2);
  titleText.textContent = `è¯å°æ°´æœèªè©é…å° - ç¬¬${round}å›`;
  victoryEl.classList.remove('show');
  matchedCount = 0;
  selected = null;
  playingFinalFlow = false;
  pairs = [];

  const file = ROUND_FILES[round];
  try{
    const res = await fetch(file, {cache:'no-cache'});
    if(!res.ok) throw new Error('fetch failed');
    const json = await res.json();
    let arr = extractArray(json);

    // filter out specified excluded id OR name content (double safety)
    const excludedId = EXCLUDE_ID[round];
    arr = arr.filter((it, idx) => {
      const idVal = (it && (it.id ?? it.ID ?? (idx+1)));
      const cn = (pickFirst(it, ['chinese','zh','name','title','text']) || '').toString();
      const tw = (pickFirst(it, ['taiwanese','tai','tw','taiwaneseName']) || '').toString();
      // exclude by id OR name match
      if(idVal !== undefined && idVal !== null && Number(idVal) === Number(excludedId)) return false;
      if(round===1 && (cn.includes('æå­') || tw.includes('æä»”'))) return false;
      if(round===2 && (cn.includes('é»‘çç ') || tw.includes('çƒçœŸç '))) return false;
      return true;
    });

    // ensure we take exactly 16 pairs (if >16 slice, if <16 still proceed)
    if(arr.length > 16) arr = arr.slice(0,16);

    // build pairs with robust parsing
    pairs = arr.map((it,i)=> {
      const parsed = parsePairEntry(it,i);
      parsed.color = COLOR_PALETTE[i % COLOR_PALETTE.length];
      return parsed;
    });

    // if by any chance pairs.length < 16, we still render what we have (won't crash)
    renderGrids();
  }catch(err){
    console.error('loadRound error', err);
    gridCn.innerHTML = '<div style="padding:16px;color:#a00">ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¢ºèª game9_assets ä¸­çš„ JSON æª”æ¡ˆå­˜åœ¨ã€‚</div>';
    gridTw.innerHTML = '';
  }
}

function renderGrids(){
  // clear
  gridCn.innerHTML = ''; gridTw.innerHTML = '';
  matchedCount = 0; selected = null; victoryEl.classList.remove('show');

  // build chinese list in order
  pairs.forEach(p=>{
    const d = document.createElement('div');
    d.className = 'cell';
    d.textContent = p.chinese;
    d.dataset.pairId = String(p.id);
    d.dataset.type = 'cn';
    d.addEventListener('click', ()=>onCellClick(d));
    gridCn.appendChild(d);
  });

  // build taiwanese shuffled
  const shuffled = pairs.slice().sort(()=>Math.random()-0.5);
  shuffled.forEach(p=>{
    const d = document.createElement('div');
    d.className = 'cell';
    d.textContent = p.taiwanese;
    d.dataset.pairId = String(p.id);
    d.dataset.type = 'tw';
    d.addEventListener('click', ()=>onCellClick(d));
    gridTw.appendChild(d);
  });
}

function onCellClick(el){
  if(playingFinalFlow) return; // prevent interactions during final flow
  if(el.classList.contains('matched')) return;
  // selection
  if(!selected){
    selected = { el, id: el.dataset.pairId, type: el.dataset.type };
    el.classList.add('selected');
    return;
  }
  // if clicking same element, ignore/deselect
  if(selected.el === el){
    el.classList.remove('selected');
    selected = null;
    return;
  }
  // second selection
  el.classList.add('selected');
  const first = selected;
  const second = { el, id: el.dataset.pairId, type: el.dataset.type };

  // must be different types (cn vs tw)
  if(first.id === second.id && first.type !== second.type){
    // correct match
    const pairIndex = pairs.findIndex(p=> String(p.id) === String(first.id));
    const pair = pairs[pairIndex];
    const color = pair.color || COLOR_PALETTE[pairIndex % COLOR_PALETTE.length];
    first.el.classList.add('matched');
    second.el.classList.add('matched');
    first.el.style.background = color;
    second.el.style.background = color;
    first.el.style.color = '#fff';
    second.el.style.color = '#fff';
    matchedCount++;

    // play pair audio (if exists)
    const audioSrc = pair.audio;
    // final-match handling
    if(matchedCount === pairs.length){
      // final flow: play last matched audio (if any) then wait 1s then victory
      if(audioSrc){
        playingFinalFlow = true;
        const a = new Audio(audioSrc);
        a.play().catch(()=>{});
        a.addEventListener('ended', ()=> {
          setTimeout(()=> {
            victoryAudio.currentTime = 0;
            victoryAudio.play().catch(()=>{});
            victoryEl.classList.add('show');
            setTimeout(()=>{ playingFinalFlow=false; }, 2500);
          }, 1000);
        });
        // fallback: if audio can't play end event, also set a timeout safety
        setTimeout(()=> {
          if(!victoryEl.classList.contains('show')){
            setTimeout(()=> { victoryAudio.play().catch(()=>{}); victoryEl.classList.add('show'); }, 1000);
          }
        }, 5000);
      } else {
        // no pair audio: wait 1s then victory
        setTimeout(()=> { victoryAudio.play().catch(()=>{}); victoryEl.classList.add('show'); }, 1000);
      }
    } else {
      // non-final: play pair audio if any (no additional waiting)
      if(audioSrc){
        const a = new Audio(audioSrc);
        a.play().catch(()=>{});
      }
    }
  } else {
    // wrong match
    try{ wrongAudio.currentTime = 0; wrongAudio.play().catch(()=>{}); }catch(e){}
    // visually indicate mismatch briefly
    first.el.classList.add('shake');
    second.el.classList.add('shake');
    setTimeout(()=> {
      first.el.classList.remove('shake');
      second.el.classList.remove('shake');
      first.el.classList.remove('selected');
      second.el.classList.remove('selected');
    }, 380);
  }

  // clear selection unless matched (we already flag matched)
  if(first.el && !first.el.classList.contains('matched')) first.el.classList.remove('selected');
  if(second.el && !second.el.classList.contains('matched')) second.el.classList.remove('selected');
  selected = null;
}

/* BUTTONS */
document.getElementById('btn-restart').addEventListener('click', ()=> loadRound(round));
document.getElementById('btn-next').addEventListener('click', ()=> {
  round = (round===1?2:1); loadRound(round);
});
document.getElementById('btn-home').addEventListener('click', ()=> { location.href = 'index.html'; });

/* initial load */
loadRound(1);
</script>
</body>
</html>
